<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaGhaS Money Tracker</title>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS for Modern, Sleek UI -->
    <style>
        :root {
        --color-primary: #4A90E2; 
        --color-primary-dark: #3A7BC8;
        --color-secondary: #50E3C2; 
        --color-accent: #F5A623; 
        --color-success: #2ECC71; 
        --color-danger: #E74C3C; 
        --color-warning: #F39C12; 
        --color-info: #3498DB; 

        --color-bg-primary: #F7F9FC; 
        --color-bg-secondary: #FFFFFF; 
        --color-text-primary: #2C3E50; 
        --color-text-secondary: #8FA1B3; 
        --color-border: #E6ECF3; 
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

        /* --- Global & Typography --- */
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            overscroll-behavior-y: none;
        }

        h1, h2, h3, h4, h5 {
            font-weight: 600;
        }

        /* --- App Container & Layout --- */
        #appContainer {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px; 
            margin: 0 auto;
            background-color: var(--color-bg-secondary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
        }

        .app-header {
            padding: 1rem 1.25rem;
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            z-index: 100;
        }
        .app-header.rtitle {
            display: none; 
        }
        .app-header #appTitle {
            font-size: 1.5rem;
            margin: 0;
            color: var(--color-primary);
        }

        /* --- View Container (Handles Scrolling) --- */
        .view-container {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 1.25rem;
            padding-bottom: 80px; 
        }

        .view {
            display: none; 
        }
        .view.active {
            display: block; 
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 600px; 
            margin: 0 auto;
            height: 65px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.5rem;
            width: 100%; 
        }
        .nav-item i {
            font-size: 1.25rem;
            margin-bottom: 4px;
        }
        .nav-item.active {
            color: var(--color-primary);
            font-weight: 500;
        }
        .nav-item:hover:not(.active) {
            color: var(--color-primary-dark);
        }

        /* --- Floating Action Button (FAB) --- */
        .fab {
            position: absolute;
            bottom: 85px; 
            right: 25px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.75rem;
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 999;
        }
        .fab:hover {
            transform: scale(1.05) rotate(15deg);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.6);
        }

        /* --- Custom Styles for Login/PIN Screen --- */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-primary);
            color: white;
            display: flex; 
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }
        #loginForm, #pinSetupForm, #pinResetForm {
            max-width: 300px;
            width: 100%;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .pin-input {
            font-family: monospace;
            font-size: 2rem;
            text-align: center;
            letter-spacing: 0.5rem;
            font-weight: 700;
            width: 100%;
            max-width: 180px;
            margin: 0 auto 15px;
            border-radius: 8px;
        }
        #pinError, #pinSetupError, #pinResetError {
            color: var(--color-accent);
            font-weight: 500;
            margin-top: 10px;
        }
        .link-button {
            background: none;
            border: none;
            color: white;
            text-decoration: underline;
            padding: 0;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* --- Modern Card Styling --- */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.25rem;
            overflow: hidden; 
        }
        .card-header {
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            font-weight: 600;
            color: var(--color-text-primary);
            padding: 0.75rem 1.25rem;
        }
        .card-body {
            padding: 1.25rem;
        }
        .list-group-item {
            border-color: var(--color-border);
        }

        /* --- Specific Card Styles --- */
        .total-balance-card {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            text-align: center;
        }
        .total-balance-card h2 {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        .balance-amount {
            font-size: 2.25rem;
            font-weight: 700;
        }

        /* Balance List Styling */
        .account-balance-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--color-border);
            align-items: center;
        }
        .account-balance-item:last-child {
            border-bottom: none;
        }
        .account-name {
            font-weight: 500;
        }
        .account-value {
            font-weight: 700;
        }
        .hidden-balance i {
            font-size: 1rem;
            color: var(--color-text-secondary);
        }
        
        /* --- Modern Form Controls --- */
        .form-control, .custom-select {
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }
        .form-control:focus, .custom-select:focus {
            background-color: var(--color-bg-secondary);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
            outline: none;
        }
        .form-control::placeholder {
            color: var(--color-text-secondary);
            opacity: 0.8;
        }
        .form-group label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        /* --- Modern Button Styling --- */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
            border-width: 2px;
        }
        .btn-sm {
            border-radius: 6px;
            padding: 0.25rem 0.75rem;
        }
        .btn-block {
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }
        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            border-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .btn-outline-secondary {
            color: var(--color-text-secondary);
            border-color: var(--color-border);
        }
        .btn-outline-secondary:hover {
            color: var(--color-text-primary);
            background-color: var(--color-bg-primary);
            border-color: var(--color-border);
        }
        .btn-success { background-color: var(--color-success); border-color: var(--color-success); }
        .btn-danger { background-color: var(--color-danger); border-color: var(--color-danger); }
        .btn-warning { background-color: var(--color-warning); border-color: var(--color-warning); }
        .btn-info { background-color: var(--color-info); border-color: var(--color-info); }
        
        .btn-outline-warning { color: var(--color-warning); border-color: var(--color-warning); }
        .btn-outline-warning:hover { background-color: var(--color-warning); color: white; }
        .btn-outline-info { color: var(--color-info); border-color: var(--color-info); }
        .btn-outline-info:hover { background-color: var(--color-info); color: white; }
        .btn-outline-success { color: var(--color-success); border-color: var(--color-success); }
        .btn-outline-success:hover { background-color: var(--color-success); color: white; }

        /* --- Modern Modal Styling --- */
        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            border-bottom: 1px solid var(--color-border);
        }
        .modal-header .close {
            opacity: 0.8;
            transition: all 0.2s ease;
        }
        .modal-header .close:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .modal-body {
            padding: 1.5rem;
        }

        /* --- Category Chip Selection --- */
        .category-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 0.5rem;
        }
        .category-chip {
            cursor: pointer;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .category-chip.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* --- Settings Category Management Chips --- */
        .mgmt-category-chip {
            display: inline-flex;
            align-items: center;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 0.2rem 0.6rem;
            font-size: 0.8rem;
            margin: 0.3rem 0.3rem 0 0;
            transition: all 0.2s ease;
        }
        .remove-chip-btn {
            background: none;
            border: none;
            color: var(--color-danger);
            font-weight: 700;
            margin-left: 5px;
            padding: 0;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }
        
        /* --- Transaction List Styling --- */
        .transaction-list .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-left: 4px solid transparent;
            border-radius: 0;
        }
        .transaction-list .list-group-item.transaction-income {
            border-left-color: var(--color-success);
        }
        .transaction-list .list-group-item.transaction-spend {
            border-left-color: var(--color-danger);
        }
        .transaction-list .list-group-item.transaction-transfer {
            border-left-color: var(--color-info);
        }
        .transaction-list .list-group-item.transaction-loan {
            border-left-color: var(--color-warning);
        }
        .list-item-icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
        }
        .list-item-details {
            flex-grow: 1;
        }
        .list-item-details .sub-info {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }
        .list-item-details .account-info, .list-item-details .loan-details-info {
            font-size: 0.8rem;
            font-weight: 500;
        }
        .list-item-amount-actions {
            text-align: right;
            white-space: nowrap;
        }
        .list-item-amount-actions .amount {
            font-weight: 600;
            display: block;
        }
        .list-item-amount-actions .amount.lent {
            color: var(--color-warning);
        }
        .item-actions {
            margin-top: 5px;
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        .item-actions .action-btn {
            padding: 0.1rem 0.3rem;
            font-size: 0.8rem;
        }
        .status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.1em 0.4em;
            border-radius: 4px;
            color: white;
            margin-left: 5px;
        }
        .status-loan-outstanding { background-color: var(--color-warning); }
        .status-loan-returned { background-color: var(--color-success); }
        .status-active, .status-secret { background-color: var(--color-success); }
        .status-redeemed { background-color: var(--color-danger); }
        .status-inactive { background-color: var(--color-text-secondary); }
        
        .filtered-total-item {
            font-size: 0.8rem;
            padding: 0 0.5rem;
            display: inline-block;
        }
        .filtered-total-net {
            font-weight: bold;
        }

        /* Investment List Styling */
        .investment-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            padding-right: 4rem; 
        }
        .investment-item .main-info {
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 0.25rem;
        }
        .investment-item .sub-info, .investment-item .investment-details {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            width: 100%;
        }
        .investment-item .list-item-amount {
            position: absolute;
            top: 10px;
            right: 10px;
            line-height: 1.2;
            text-align: right;
            font-size: 0.9rem;
        }
        .investment-item .current-value-label {
            display: block;
        }
        .investment-item .investment-details.profit {
            color: var(--color-success);
            font-weight: 600;
        }
        .investment-item .investment-details.loss {
            color: var(--color-danger);
            font-weight: 600;
        }
        .investment-item-actions {
            width: 100%;
            display: flex;
            gap: 5px;
            margin-top: 0.5rem;
            justify-content: flex-end;
        }
        .investment-item.redeemed-investment {
            opacity: 0.7;
            background-color: #fffaf0;
        }

        /* Settings Account List */
        .account-list-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        .account-list-item .account-actions {
            display: flex;
            gap: 5px;
        }
        .account-list-item .badge {
            margin-left: 5px;
        }

    </style>
</head>
<body>
    
    <!-- PIN Setup / Login / Reset Screen (Client-Side Security) -->
    <div id="loginScreen">
        <h4 id="loginTitle" class="mb-4">Welcome to RaGhaS Money Tracker</h4>
        <p class="small text-white-50" id="loginMessage"></p>
        
        <!-- PIN Login Form -->
        <div id="pinLoginForm" style="display: none;">
            <form id="loginForm" class="p-3">
                <p class="h5 mb-3">Enter 6-Digit PIN</p>
                <input type="password" class="form-control pin-input" id="pinInput" maxlength="6" pattern="\d{6}" placeholder="••••••" required>
                <button type="submit" class="btn btn-block btn-secondary mt-3">Unlock App</button>
                <div id="pinError" class="small mt-2"></div>
                <button type="button" class="link-button" id="forgotPinButton">Forgot PIN?</button>
            </form>
        </div>

        <!-- PIN Setup Form -->
        <div id="pinSetupFormWrapper" style="display: none;">
            <form id="pinSetupForm" class="p-3">
                <p class="h5 mb-3">Setup Your 6-Digit PIN</p>
                <input type="password" class="form-control pin-input mb-3" id="newPinInput" maxlength="6" pattern="\d{6}" placeholder="New PIN" required>
                <input type="password" class="form-control pin-input" id="confirmPinInput" maxlength="6" pattern="\d{6}" placeholder="Confirm PIN" required>
                <div class="form-group mt-3">
                    <label for="securityQuestionSelect" class="small">Security Question</label>
                    <select class="custom-select" id="securityQuestionSelect" required>
                        <option value="" disabled selected>Select Question</option>
                        <option value="pet">What was your first pet's name?</option>
                        <option value="city">In which city were you born?</option>
                        <option value="mother">What is your mother's middle name?</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="securityAnswerInput" class="small">Answer (Case Insensitive)</label>
                    <input type="text" class="form-control" id="securityAnswerInput" required>
                </div>
                <button type="submit" class="btn btn-block btn-success mt-3">Set PIN and Continue</button>
                <div id="pinSetupError" class="small mt-2"></div>
            </form>
        </div>

        <!-- PIN Reset Form -->
        <div id="pinResetFormWrapper" style="display: none;">
            <form id="pinResetForm" class="p-3">
                <p class="h5 mb-3" id="resetQuestionDisplay"></p>
                <div class="form-group">
                    <label for="resetSecurityAnswerInput" class="small">Your Answer</label>
                    <input type="text" class="form-control" id="resetSecurityAnswerInput" required>
                </div>
                <div class="form-group">
                    <label for="newPinResetInput" class="small">New 6-Digit PIN</label>
                    <input type="password" class="form-control pin-input" id="newPinResetInput" maxlength="6" pattern="\d{6}" placeholder="New PIN" required>
                </div>
                <button type="submit" class="btn btn-block btn-warning mt-3">Reset PIN</button>
                <div id="pinResetError" class="small mt-2"></div>
                <button type="button" class="link-button" id="backToLoginButton">Back to Login</button>
            </form>
        </div>
    </div>

	<div>
		<header class="app-header rtitle"><h1 id="appname">RaGhaS Money Expense Tracker</h1></header>
	</div>
    <!-- Main application container -->
    <div id="appContainer" style="display: none;">
        
        <header class="app-header rtitle"><h1 id="appname">RaGhaS Money Expense Tracker/Tool</h1></header>
        <header class="app-header"><h1 id="appTitle">Dashboard</h1></header>
        
        <div class="view-container">
            
            <!-- Home View -->
            <div class="view active" id="homeView">
                <div class="card total-balance-card">
                    <div class="card-body">
                        <h2>Total Balance</h2>
                        <div class="balance-amount" id="totalBalance">₹0.00</div>
                    </div>
                </div>
                <div class="balance-visibility-toggle mb-3 text-center">
                    <button class="btn btn-outline-secondary btn-sm" id="toggleBalanceVisibility">
                        <i class="fas fa-eye-slash"></i> Show Amounts
                    </button>
                </div>
                <div class="card account-balances-card">
                    <div class="card-header">
                        Account Balances
                        <button class="btn btn-sm btn-outline-secondary float-right" id="toggleShowSecretAccountsHome" title="Show Secret Accounts Visibility">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                    <div class="card-body" id="accountBalancesList">
                        <p class="text-center text-muted">No accounts added yet.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Recent Transactions</div>
                    <ul class="list-group list-group-flush" id="recentTransactionsListHome">
                        <li class="list-group-item text-center text-muted">No recent transactions.</li>
                    </ul>
                </div>
                <div class="card">
                    <div class="card-header">Investment Portfolio Overview</div>
                    <div class="card-body" id="investmentSummaryHome">
                        <p class="text-center text-muted">No active investments yet.</p>
                    </div>
                </div>
            </div>
            
            <!-- Transactions View -->
            <div class="view" id="transactionsView">
                <div class="card">
                    <div class="card-header">Transaction History</div>
                    <div class="card-body">
                        <div class="new-filter-controls">
                            <div class="search-filter-group">
                                <input id="txSearchInput" type="text" placeholder="Search description, category..." class="form-control" />
                                <input id="txAmountFilter" type="number" placeholder="Amount (₹)" class="form-control" step="0.01" />
                            </div>
                            <div class="select-filters-group">
                                <select id="txMonthFilter" class="custom-select"><option value="">All Months</option></select>
                                <select id="txYearFilter" class="custom-select"><option value="">All Years</option></select>
                                <select id="txTypeFilter" class="custom-select">
                                    <option value="">All Types</option>
                                    <option value="income">Income</option>
                                    <option value="spend">Spend</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="loan">Loan/Receivable</option>
                                    <option value="loan_outstanding">Loan (Outstanding)</option>
                                    <option value="loan_returned">Loan (Returned)</option>
                                    <option value="investment_purchase">Investment Purchase</option>
                                    <option value="investment_sale">Investment Sale</option>
                                </select>
                                <button class="btn btn-sm btn-secondary" id="txClearFiltersBtn"><i class="fas fa-times"></i> Clear</button>
                            </div>
                        </div>
                        <div id="filteredTotalsContainer" style="display: none;" class="mb-3 text-center d-flex justify-content-center flex-wrap" style="gap: 1rem;">
                            <!-- Filtered totals will be shown here by JS -->
                        </div>
                        <ul class="list-group list-group-flush transaction-list" id="transactionList">
                            <li class="list-group-item text-center text-muted" id="noTransactionsMessage">No transactions yet.</li>
                            <!-- Transactions will be populated here by JS -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Charts View -->
            <div class="view" id="chartsView">
                <!-- NEW FILTER SECTION -->
                <div class="card mb-3">
                    <div class="card-header">Date Filter</div>
                    <div class="card-body">
                        <div id="chartFilterButtons" class="d-flex flex-wrap justify-content-center" style="gap: 0.5rem; margin-bottom: 0.75rem;">
                            <button class="btn btn-sm btn-primary chart-filter-btn active" data-range="all">All Time</button>
                            <button class="btn btn-sm btn-outline-primary chart-filter-btn" data-range="month">Current Month</button>
                            <button class="btn btn-sm btn-outline-primary chart-filter-btn" data-range="3months">Last 3 Months</button>
                            <button class="btn btn-sm btn-outline-primary chart-filter-btn" data-range="6months">Last 6 Months</button>
                            <button class="btn btn-sm btn-outline-primary chart-filter-btn" data-range="year">Last 1 Year</button>
                            <button class="btn btn-sm btn-outline-secondary chart-filter-btn" data-range="custom">Custom Range</button>
                        </div>
                        <div id="customDateRangeInputs" style="display: none;" class="form-row align-items-end" style="gap: 0.5rem;">
                            <div class="col-5">
                                <label for="chartStartDate" class="small mb-0">Start Date</label>
                                <input type="date" class="form-control form-control-sm" id="chartStartDate">
                            </div>
                            <div class="col-5">
                                <label for="chartEndDate" class="small mb-0">End Date</label>
                                <input type="date" class="form-control form-control-sm" id="chartEndDate">
                            </div>
                            <div class="col-2">
                                <button id="applyCustomDateRangeBtn" class="btn btn-sm btn-primary btn-block"><i class="fas fa-check"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END NEW FILTER SECTION -->
                <div class="card">
                    <div class="card-header">Income vs. Spend Overview</div>
                    <div class="card-body chart-container">
                        <canvas id="incomeSpendChart"></canvas>
                        <p id="noIncomeSpendData" class="text-center text-muted" style="display:block;">Not enough data.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Monthly Spend Trend</div>
                    <div class="card-body chart-container">
                        <canvas id="monthlySpendChartCanvas"></canvas>
                        <p id="noMonthlySpendData" class="text-center text-muted" style="display:block;">Not enough spend data.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Investment Portfolio Distribution</div>
                    <div class="card-body chart-container">
                        <canvas id="investmentPortfolioChart"></canvas>
                        <p id="noInvestmentPortfolioData" class="text-center text-muted" style="display:block;">No active investments.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Spend Category Breakdown</div>
                    <div class="card-body chart-container">
                        <canvas id="spendCategoryChart"></canvas>
                        <p id="noSpendDataForCategoryChart" class="text-center text-muted" style="display:block;">Not enough spend data.</p>
                    </div>
                </div>
            </div>
            
            <!-- Investments View -->
            <div class="view" id="investmentsView">
                <div class="card">
                    <div class="card-header">Manage Investments</div>
                    <div class="card-body investment-actions d-flex flex-wrap justify-content-center" style="gap: 0.5rem;">
                        <button class="btn btn-outline-warning btn-sm open-investment-modal" data-type="stock" data-toggle="modal" data-target="#investmentModal"><i class="fas fa-chart-line"></i> Add Stock</button>
                        <button class="btn btn-outline-info btn-sm open-investment-modal" data-type="mf" data-toggle="modal" data-target="#investmentModal"><i class="fas fa-umbrella-beach"></i> Add MF</button>
                        <button class="btn btn-outline-success btn-sm open-investment-modal" data-type="fd" data-toggle="modal" data-target="#investmentModal"><i class="fas fa-piggy-bank"></i> Add FD</button>
                        <button class="btn btn-outline-primary btn-sm open-investment-modal" data-type="postal" data-toggle="modal" data-target="#investmentModal"><i class="fas fa-envelope"></i> Add Postal</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">My Investments Portfolio</div>
                    <ul class="list-group list-group-flush investment-list" id="investmentList">
                        <li class="list-group-item text-center text-muted" id="noInvestmentsMessage">No investments yet.</li>
                        <!-- Investments will be populated here by JS -->
                    </ul>
                </div>
            </div>

            <!-- Settings View -->
            <div class="view" id="settingsView">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        Manage Accounts
                        <button id="toggleAccountManagementBtn" class="btn btn-sm btn-outline-secondary" title="Hide Account Section">
                            <i class="fas fa-eye-slash"></i> Hide
                        </button>
                    </div>
                    <div id="accountManagementContent" class="card-body">
                        <form id="addAccountForm" class="mb-3">
                            <div class="form-row" style="gap: 0.5rem 0;">
                                <div class="col-sm-5 mb-2 mb-sm-0">
                                    <input type="text" class="form-control form-control-sm" id="newAccountName" placeholder="Account Name" required>
                                </div>
                                <div class="col-sm-4 mb-2 mb-sm-0">
                                    <input type="text" class="form-control form-control-sm" id="newAccountId" placeholder="Short ID (e.g., icici_sav)" required>
                                </div>
                                <div class="col-sm-3">
                                    <button type="submit" class="btn btn-primary btn-sm btn-block">Add</button>
                                </div>
                            </div>
                        </form>
                        <div id="accountsListContainer">
                            <p class="text-muted text-center" id="noAccountsMessageSettings">No accounts added yet.</p>
                            <!-- Accounts list will be populated here by JS -->
                        </div>
                        <div class="form-group mt-3">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="showSecretAccountsToggleSettings">
                                <label class="custom-control-label" for="showSecretAccountsToggleSettings">Show Secret Accounts</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        Manage Categories
                        <button id="toggleCategoryManagementBtn" class="btn btn-sm btn-outline-secondary" title="Hide Category Section">
                            <i class="fas fa-eye-slash"></i> Hide
                        </button>
                    </div>
                    <div id="categoryManagementContent" class="card-body">
                        <h5>Spend Categories</h5>
                        <form id="addSpendCategoryForm" class="form-inline mb-3">
                            <input type="text" class="form-control form-control-sm mr-2 flex-grow-1" id="newSpendCategoryName" placeholder="New Spend Category" required>
                            <button type="submit" class="btn btn-success btn-sm">Add</button>
                        </form>
                        <div id="spendCategoriesListContainer" class="category-management-chips-container d-flex flex-wrap" style="gap: 5px;">
                            <!-- Spend categories will be populated here by JS -->
                        </div>
                        <hr>
                        <h5>Income Categories</h5>
                        <form id="addIncomeCategoryForm" class="form-inline mb-3">
                            <input type="text" class="form-control form-control-sm mr-2 flex-grow-1" id="newIncomeCategoryName" placeholder="New Income Category" required>
                            <button type="submit" class="btn btn-success btn-sm">Add</button>
                        </form>
                        <div id="incomeCategoriesListContainer" class="category-management-chips-container d-flex flex-wrap" style="gap: 5px;">
                            <!-- Income categories will be populated here by JS -->
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">Data Management</div>
                    <div class="card-body settings-actions" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn btn-info btn-block" id="exportDataBtn"><i class="fas fa-file-export"></i> Export Data</button>
                        <button class="btn btn-warning btn-block" id="importDataTriggerBtn"><i class="fas fa-file-import"></i> Import Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <button class="btn btn-danger btn-block mt-3" id="resetDataBtn"><i class="fas fa-trash-restore"></i> Reset All Data</button>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">App Info</div>
                    <div class="card-body">
                        <p class="text-muted text-center" id="appVersionInfo">RaGhaS Money Tracker - AET v3.10</p>
                        <p class="text-muted text-center">&copy; 2024-2025.</p>
                    </div>
                </div>
            </div>
        </div> <!-- End .view-container -->

        <!-- Floating Action Button -->
        <div class="fab" id="openTransactionModalFab" data-toggle="modal" data-target="#transactionModal">
            <i class="fas fa-plus"></i>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-view="homeView" data-title="Dashboard"><i class="fas fa-home"></i> Home</div>
            <div class="nav-item" data-view="transactionsView" data-title="Transactions"><i class="fas fa-list-alt"></i> Transactions</div>
            <div class="nav-item" data-view="chartsView" data-title="Charts"><i class="fas fa-chart-pie"></i> Charts</div>
            <div class="nav-item" data-view="investmentsView" data-title="Investments"><i class="fas fa-piggy-bank"></i> Investments</div>
            <div class="nav-item" data-view="settingsView" data-title="Settings"><i class="fas fa-cog"></i> Settings</div>
        </nav>

    </div> <!-- End #appContainer -->

    <!-- =================================================================== -->
    <!--                        MODALS (Dialogs)                             -->
    <!-- =================================================================== -->

    <!-- Transaction Modal (Add/Edit) -->
    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalTitle">Add New Transaction</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <input type="hidden" id="editingTransactionId">
                        <div class="form-group">
                            <label for="transactionType">Type</label>
                            <select class="custom-select" id="transactionType" required>
                                <option value="income">Income</option>
                                <option value="spend">Spend</option>
                                <option value="transfer">Transfer</option>
                                <option value="loan">Loan/Receivable</option>
                            </select>
                        </div>
                        
                        <div class="form-group form-group-spend-category-chips" style="display:none;">
                            <label>Spend Category</label>
                            <div class="category-chips-container" id="spendCategoryChipsContainer">
                                <!-- Spend category chips populated by JS -->
                            </div>
                        </div>
                        <div class="form-group form-group-income-category-chips" style="display:none;">
                            <label>Income Category</label>
                            <div class="category-chips-container" id="incomeCategoryChipsContainer">
                                <!-- Income category chips populated by JS -->
                            </div>
                        </div>
                        
                        <div class="form-group form-group-account">
                            <label for="transactionAccount" id="transactionAccountLabel">Account</label>
                            <select class="custom-select" id="transactionAccount" required></select>
                        </div>
                        
                        <div class="form-group form-group-transfer" style="display:none;">
                            <label for="transferFromAccount">From Account</label>
                            <select class="custom-select" id="transferFromAccount"></select>
                        </div>
                        <div class="form-group form-group-transfer" style="display:none;">
                            <label for="transferToAccount">To Account</label>
                            <select class="custom-select" id="transferToAccount"></select>
                        </div>
                        
                        <div class="form-group">
                            <label for="transactionDescription" id="transactionDescriptionLabel">Description</label>
                            <input type="text" class="form-control" id="transactionDescription" placeholder="e.g., Salary, Coffee, Loan to John">
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount" id="transactionAmountLabel">Amount (₹)</label>
                            <input type="number" class="form-control" id="transactionAmount" placeholder="0.00" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate" id="transactionDateLabel">Date</label>
                            <input type="date" class="form-control" id="transactionDate" required>
                        </div>
                        
                        <input type="hidden" id="selectedCategoryInput">
                        <button type="submit" class="btn btn-primary btn-block" id="transactionSubmitBtn">Add Transaction</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Record Loan Return Modal -->
    <div class="modal fade" id="recordLoanReturnModal" tabindex="-1" aria-labelledby="recordLoanReturnModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recordLoanReturnModalLabel">Record Loan Return/Refund</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="recordLoanReturnForm">
                         <input type="hidden" id="originalLoanIdToReturn">
                        <p>Recording return for loan: "<strong id="loanReturnDescription"></strong>"</p>
                        <p>Original amount lent: <strong id="originalLoanAmountDisplay"></strong></p>
                        <div class="form-group">
                             <label for="loanReturnDateInput">Return Date</label>
                            <input type="date" class="form-control" id="loanReturnDateInput" required>
                        </div>
                        <div class="form-group">
                             <label for="loanReturnAmountInput">Amount Returned (₹)</label>
                            <input type="number" class="form-control" id="loanReturnAmountInput" step="0.01" min="0.01" required>
                        </div>
                         <div class="form-group">
                            <label for="loanReturnAccountSelect">Deposit to Account</label>
                            <select class="custom-select" id="loanReturnAccountSelect" required></select>
                        </div>
                         <button type="submit" class="btn btn-success btn-block">Record Return</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Investment Modal (Add/Edit) -->
    <div class="modal fade" id="investmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Investment</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="investmentForm">
                        <input type="hidden" id="investmentId">
                        <div class="form-group">
                            <label for="investmentType">Type</label>
                            <select class="custom-select" id="investmentType" required>
                                <option value="stock">Stock</option>
                                <option value="mf">Mutual Fund</option>
                                <option value="fd">Fixed Deposit</option>
                                <option value="postal">Postal</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="investmentDescription">Description</label><input type="text" class="form-control" id="investmentDescription" required></div>
                        <div class="form-group"><label for="investmentDate">Date</label><input type="date" class="form-control" id="investmentDate" required></div>
                        <div class="form-group"><label for="investmentAmount">Amount Invested (₹)</label><input type="number" class="form-control" id="investmentAmount" step="0.01" min="0.01" required></div>
                        <div class="form-group"><label for="investmentSourceAccount">Source Account</label><select class="custom-select" id="investmentSourceAccount" required></select></div>
                        <div class="form-group"><label for="investmentMaturity">Maturity Info (Optional)</label><input type="text" class="form-control" id="investmentMaturity"></div>
                        <button type="submit" class="btn btn-success btn-block">Save Investment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Investment Value Modal -->
    <div class="modal fade" id="updateInvestmentValueModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Investment Value</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="updateInvestmentValueForm">
                        <input type="hidden" id="updateValueInvestmentId">
                        <p>Investment: <strong id="updateValueInvestmentName"></strong></p>
                        <div class="form-group">
                            <label for="investmentCurrentValue">New Current Value (₹)</label>
                            <input type="number" class="form-control" id="investmentCurrentValue" step="0.01" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Update Value</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Redeem Investment Modal -->
    <div class="modal fade" id="redeemInvestmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Redeem Investment</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="redeemInvestmentForm">
                        <input type="hidden" id="redeemInvestmentId">
                        <p>Investment: <strong id="redeemInvestmentName"></strong></p>
                        <p>Initial Cost: <strong id="redeemInvestmentInitialCost"></strong></p>
                        <div class="form-group">
                            <label for="investmentRedeemedAmount">Amount Received from Redemption (₹)</label>
                            <input type="number" class="form-control" id="investmentRedeemedAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="investmentRedemptionDate">Redemption Date</label>
                            <input type="date" class="form-control" id="investmentRedemptionDate" required>
                        </div>
                        <div class="form-group">
                            <label for="redemptionDepositAccount">Deposit to Account</label>
                            <select class="custom-select" id="redemptionDepositAccount" required></select>
                        </div>
                        <div id="redeemProfitLossInfo" class="profit-loss-info text-center mb-2">
                            <!-- Profit/loss info shown here by JS -->
                        </div>
                        <button type="submit" class="btn btn-success btn-block">Confirm Redemption</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- JavaScript Dependencies -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <!-- Popper.js (Required for Bootstrap tooltips and popovers) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Chart.js (for the charts view) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Application Logic -->
    <script>
    // Module pattern for better organization and scope control
    (function() {
        "use strict";

        // ====================================================================
        // 1. CONFIGURATION & STATE
        // ====================================================================

        const APP_VERSION = "AET v3.11"; // Updated version
        const LOCAL_STORAGE_PREFIX = `RAGHAS_${APP_VERSION}_`;
        
        // Local Storage Keys
        const LS_KEYS = {
            ACCOUNTS: `${LOCAL_STORAGE_PREFIX}accounts`,
            TRANSACTIONS: `${LOCAL_STORAGE_PREFIX}transactions`,
            INVESTMENTS: `${LOCAL_STORAGE_PREFIX}investments`,
            SPEND_CATEGORIES: `${LOCAL_STORAGE_PREFIX}spend_categories`,
            INCOME_CATEGORIES: `${LOCAL_STORAGE_PREFIX}income_categories`,
            PIN: `${LOCAL_STORAGE_PREFIX}pin`,
            SECURITY_Q: `${LOCAL_STORAGE_PREFIX}security_q`,
            SECURITY_A: `${LOCAL_STORAGE_PREFIX}security_a`,
            SHOW_SECRET: `${LOCAL_STORAGE_PREFIX}show_secret`,
            CATEGORY_MGMT_VISIBLE: `${LOCAL_STORAGE_PREFIX}category_mgmt_visible`,
            ACCOUNT_MGMT_VISIBLE: `${LOCAL_STORAGE_PREFIX}account_mgmt_visible`,
            BALANCES_VISIBLE: `${LOCAL_STORAGE_PREFIX}balances_visible`,
        };

        // Core State
        let isAuthenticated = false; // Initialized to false for PIN lock
        let accounts = [];
        let spendCategories = [];
        let incomeCategories = [];
        let transactions = [];
        let investments = [];
        let showSecretAccounts = false;
        let balancesVisible = false;
        let accountManagementVisible = true;
        let categoryManagementVisible = true;
        
        // Accounting definitions
        const investmentRelatedCategories = ['Investment Expense', 'Investment Income', 'Loan Receivable'];
        const investmentTypeNames = { stock: 'Stock', mf: 'Mutual Fund', fd: 'Fixed Deposit', postal: 'Postal' };
        
        const securityQuestions = {
            'pet': "What was your first pet's name?",
            'city': "In which city were you born?",
            'mother': "What is your mother's middle name?"
        };

        // Chart State
        let chartDateRange = 'all'; 
        let chartStartDate = null;
        let chartEndDate = null;
        let spendCategoryChartInstance = null;
        let incomeSpendChartInstance = null;
        let investmentPortfolioChartInstance = null;
        let monthlySpendChartInstance = null;
        
        let lastFocusedElementBeforeModal; // Used for accessibility/focus

        // Centralized DOM Access (Initial state, will be populated on DOMContentLoaded)
        const D = {}; 

        // ====================================================================
        // 2. UTILITY & DATA FUNCTIONS (Load/Save/Format)
        // ====================================================================

        function populateDOMElements() {
            // General App/Views
            D.appContainer = document.getElementById('appContainer');
            D.appTitle = document.getElementById('appTitle');
            D.views = document.querySelectorAll('.view');
            D.navItems = document.querySelectorAll('.bottom-nav .nav-item');
            
            // Security
            D.loginScreen = document.getElementById('loginScreen');
            D.loginTitle = document.getElementById('loginTitle');
            D.loginMessage = document.getElementById('loginMessage');
            D.pinSetupFormWrapper = document.getElementById('pinSetupFormWrapper');
            D.pinLoginForm = document.getElementById('pinLoginForm');
            D.pinResetFormWrapper = document.getElementById('pinResetFormWrapper');
            D.pinInput = document.getElementById('pinInput');
            D.pinError = document.getElementById('pinError');
            D.pinSetupError = document.getElementById('pinSetupError');
            D.pinResetError = document.getElementById('pinResetError');
            D.securityQuestionSelect = document.getElementById('securityQuestionSelect');
            D.pinSetupForm = document.getElementById('pinSetupForm');
            D.loginForm = document.getElementById('loginForm');
            D.pinResetForm = document.getElementById('pinResetForm');
            D.resetQuestionDisplay = document.getElementById('resetQuestionDisplay');
            D.newPinInput = document.getElementById('newPinInput');
            D.confirmPinInput = document.getElementById('confirmPinInput');
            D.securityAnswerInput = document.getElementById('securityAnswerInput');
            D.resetSecurityAnswerInput = document.getElementById('resetSecurityAnswerInput');
            D.newPinResetInput = document.getElementById('newPinResetInput');
            D.forgotPinButton = document.getElementById('forgotPinButton');
            D.backToLoginButton = document.getElementById('backToLoginButton');
            
            // Transactions/Forms
            D.transactionForm = document.getElementById('transactionForm');
            D.transactionType = document.getElementById('transactionType');
            D.editingTransactionId = document.getElementById('editingTransactionId');
            D.selectedCategoryInput = document.getElementById('selectedCategoryInput');
            D.transactionAccountEl = document.getElementById('transactionAccount');
            D.transferFromAccountEl = document.getElementById('transferFromAccount');
            D.transferToAccountEl = document.getElementById('transferToAccount');
            D.transactionAmountEl = document.getElementById('transactionAmount');
            D.transactionDateEl = document.getElementById('transactionDate');
            D.transactionDescriptionEl = document.getElementById('transactionDescription');
            D.accountGroup = document.querySelector('#transactionModal .form-group-account');
            D.transferGroupEls = document.querySelectorAll('#transactionModal .form-group-transfer');
            D.spendCategoryChipsGroup = document.querySelector('#transactionModal .form-group-spend-category-chips');
            D.incomeCategoryChipsGroup = document.querySelector('#transactionModal .form-group-income-category-chips');
            D.spendCategoryChipsContainerEl = document.getElementById('spendCategoryChipsContainer');
            D.incomeCategoryChipsContainerEl = document.getElementById('incomeCategoryChipsContainer');
            D.transactionAccountLabelEl = document.getElementById('transactionAccountLabel');
            D.transactionAmountLabelEl = document.getElementById('transactionAmountLabel');
            D.transactionDescriptionLabelEl = document.getElementById('transactionDescriptionLabel');

            // Modals
            D.transactionModalJQ = $('#transactionModal');
            D.transactionModalTitleEl = document.getElementById('transactionModalTitle');
            D.transactionSubmitBtnEl = document.getElementById('transactionSubmitBtn');
            D.investmentModalJQ = $('#investmentModal');
            D.updateInvestmentValueForm = document.getElementById('updateInvestmentValueForm');
            D.redeemInvestmentForm = document.getElementById('redeemInvestmentForm');
            D.recordLoanReturnForm = document.getElementById('recordLoanReturnForm');
            
            // Lists & Balances
            D.totalBalance = document.getElementById('totalBalance');
            D.accountBalancesList = document.getElementById('accountBalancesList');
            D.transactionList = document.getElementById('transactionList');
            D.filteredTotalsContainer = document.getElementById('filteredTotalsContainer');
            D.noTransactionsMessageEl = document.getElementById('noTransactionsMessage');
            D.investmentListEl = document.getElementById('investmentList');
            D.noInvestmentsMessageEl = document.getElementById('noInvestmentsMessage');

            // Filters
            D.txSearchInput = document.getElementById('txSearchInput');
            D.txAmountFilter = document.getElementById('txAmountFilter');
            D.txMonthFilter = document.getElementById('txMonthFilter');
            D.txYearFilter = document.getElementById('txYearFilter');
            D.txTypeFilter = document.getElementById('txTypeFilter');
            D.txClearFiltersBtn = document.getElementById('txClearFiltersBtn');

            // Other UI Elements
            D.toggleBalanceVisibilityBtn = document.getElementById('toggleBalanceVisibility');
            D.openTransactionModalFab = document.getElementById('openTransactionModalFab');
            D.appVersionInfoEl = document.getElementById('appVersionInfo');

            // Settings Elements
            D.accountManagementContentEl = document.getElementById('accountManagementContent');
            D.toggleAccountManagementBtn = document.getElementById('toggleAccountManagementBtn');
            D.categoryManagementContentEl = document.getElementById('categoryManagementContent');
            D.toggleCategoryManagementBtn = document.getElementById('toggleCategoryManagementBtn');
            D.addSpendCategoryForm = document.getElementById('addSpendCategoryForm');
            D.newSpendCategoryName = document.getElementById('newSpendCategoryName');
            D.spendCategoriesListContainerEl = document.getElementById('spendCategoriesListContainer');
            D.addIncomeCategoryForm = document.getElementById('addIncomeCategoryForm');
            D.newIncomeCategoryName = document.getElementById('newIncomeCategoryName');
            D.incomeCategoriesListContainerEl = document.getElementById('incomeCategoriesListContainer');
            D.accountsListContainerEl = document.getElementById('accountsListContainer');
            D.noAccountsMessageSettingsEl = document.getElementById('noAccountsMessageSettings');
            D.showSecretAccountsToggleSettingsEl = document.getElementById('showSecretAccountsToggleSettings');
            D.toggleShowSecretAccountsHomeBtn = document.getElementById('toggleShowSecretAccountsHome');

            // Chart Elements
            D.chartFilterButtonsContainer = document.getElementById('chartFilterButtons');
            D.chartStartDateEl = document.getElementById('chartStartDate');
            D.chartEndDateEl = document.getElementById('chartEndDate');
            D.applyCustomDateRangeBtn = document.getElementById('applyCustomDateRangeBtn');
            D.customDateRangeInputsEl = document.getElementById('customDateRangeInputs');

            // Loan Return Modal Elements
            D.originalLoanIdToReturnEl = document.getElementById('originalLoanIdToReturn');
            D.loanReturnDescriptionEl = document.getElementById('loanReturnDescription');
            D.originalLoanAmountDisplayEl = document.getElementById('originalLoanAmountDisplay');
            D.loanReturnDateInputEl = document.getElementById('loanReturnDateInput');
            D.loanReturnAmountInputEl = document.getElementById('loanReturnAmountInput');
            D.loanReturnAccountSelectEl = document.getElementById('loanReturnAccountSelect');
        }

        function saveState() {
            if (!isAuthenticated) return;
            localStorage.setItem(LS_KEYS.TRANSACTIONS, JSON.stringify(transactions));
            localStorage.setItem(LS_KEYS.INVESTMENTS, JSON.stringify(investments));
            localStorage.setItem(LS_KEYS.ACCOUNTS, JSON.stringify(accounts));
            localStorage.setItem(LS_KEYS.SPEND_CATEGORIES, JSON.stringify(spendCategories));
            localStorage.setItem(LS_KEYS.INCOME_CATEGORIES, JSON.stringify(incomeCategories));
            localStorage.setItem(LS_KEYS.SHOW_SECRET, JSON.stringify(showSecretAccounts));
            localStorage.setItem(LS_KEYS.CATEGORY_MGMT_VISIBLE, JSON.stringify(categoryManagementVisible));
            localStorage.setItem(LS_KEYS.ACCOUNT_MGMT_VISIBLE, JSON.stringify(accountManagementVisible));
            localStorage.setItem(LS_KEYS.BALANCES_VISIBLE, JSON.stringify(balancesVisible));
        }

        function loadState() {
            // Load structure first
            accounts = JSON.parse(localStorage.getItem(LS_KEYS.ACCOUNTS)) || [{ id: 'cash', name: 'Cash', status: 'active' }, { id: 'sbi', name: 'SBI', status: 'active' }];
            transactions = JSON.parse(localStorage.getItem(LS_KEYS.TRANSACTIONS)) || [];
            investments = JSON.parse(localStorage.getItem(LS_KEYS.INVESTMENTS)) || [];
            
            // Load categories with defaults
            spendCategories = JSON.parse(localStorage.getItem(LS_KEYS.SPEND_CATEGORIES)) || ['Bills & Recharges', 'CC Bills', 'Cloths', 'Education', 'Entertainment', 'EMI', 'Foods & Drinks' ,'Fuel', 'Gifts', 'Groceries', 'Homes & Utilities', 'Health & Medicine', 'Insurance', 'Investment Expense', 'Labs & Tests', 'Maintenance', 'Travel', 'Shopping', 'Parties', 'Vacation', 'Personal Care', 'Rent', 'Subscriptions', 'Others' ];
            incomeCategories = JSON.parse(localStorage.getItem(LS_KEYS.INCOME_CATEGORIES)) || ["Salary", "In-hand Cash", "Savings", "Earnings", "Investment Income", "Gifts Received", "Refunds", "Other Income", "Loan Receivable"];
            
            // Load UI state
            showSecretAccounts = JSON.parse(localStorage.getItem(LS_KEYS.SHOW_SECRET)) || false;
            balancesVisible = JSON.parse(localStorage.getItem(LS_KEYS.BALANCES_VISIBLE)) || false;
            categoryManagementVisible = JSON.parse(localStorage.getItem(LS_KEYS.CATEGORY_MGMT_VISIBLE)) !== null ? JSON.parse(localStorage.getItem(LS_KEYS.CATEGORY_MGMT_VISIBLE)) : true;
            accountManagementVisible = JSON.parse(localStorage.getItem(LS_KEYS.ACCOUNT_MGMT_VISIBLE)) !== null ? JSON.parse(localStorage.getItem(LS_KEYS.ACCOUNT_MGMT_VISIBLE)) : true;
        }

        function formatDate(dateString) { 
            return dateString ? new Date(dateString).toISOString().slice(0, 10) : '';
        }
        function displayDate(dateString) { 
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        function formatCurrency(amount) { 
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
        }
        function setDefaultDate(dateElement) { 
            if(dateElement && !dateElement.value) dateElement.valueAsDate = new Date();
        }
        function getAccountNameById(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            return account ? account.name : `[Unknown Account: ${accountId}]`;
        }
        function getVisibleAccounts() {
            return accounts.filter(acc => acc.status === 'active' || (acc.status === 'secret' && showSecretAccounts));
        }
        
        // --- Dropdown Population Functions ---
        function populateAccountDropdown(selectElement, selectedValue = "") {
            if (!selectElement) return;
            const visibleAccounts = getVisibleAccounts();
            selectElement.innerHTML = '<option value="">-- Select Account --</option>';
            visibleAccounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id; 
                option.textContent = `${acc.name} (${acc.id})`;
                if (acc.id === selectedValue) option.selected = true;
                selectElement.appendChild(option);
            });
        }

        function populateAllAccountDropdowns() { 
            if (!isAuthenticated) return;
            populateAccountDropdown(D.transactionAccountEl);
            populateAccountDropdown(D.transferFromAccountEl);
            populateAccountDropdown(D.transferToAccountEl);
            populateAccountDropdown(document.getElementById('investmentSourceAccount'));
            populateAccountDropdown(document.getElementById('redemptionDepositAccount'));
            populateAccountDropdown(D.loanReturnAccountSelectEl);
        }
        
        function populateSpendCategoryChips(selectedCategory = null) { 
            if (!isAuthenticated || !D.spendCategoryChipsContainerEl) return;
            D.spendCategoryChipsContainerEl.innerHTML = ''; 
            
            spendCategories.sort().forEach(cat => { 
                const chip = document.createElement('span'); 
                chip.classList.add('category-chip'); 
                chip.textContent = cat; 
                chip.dataset.category = cat; 
                if (cat === selectedCategory) chip.classList.add('active'); 
                
                chip.addEventListener('click', () => { 
                    document.querySelectorAll('#spendCategoryChipsContainer .category-chip').forEach(c => c.classList.remove('active')); 
                    chip.classList.add('active'); 
                    D.selectedCategoryInput.value = cat; 
                }); 
                D.spendCategoryChipsContainerEl.appendChild(chip); 
            });
        }
        
        function populateIncomeCategoryChips(selectedCategory = null) { 
            if (!isAuthenticated || !D.incomeCategoryChipsContainerEl) return; 
            D.incomeCategoryChipsContainerEl.innerHTML = '';
            
            incomeCategories.sort().forEach(cat => { 
                const chip = document.createElement('span'); 
                chip.classList.add('category-chip'); 
                chip.textContent = cat; 
                chip.dataset.category = cat; 
                if (cat === selectedCategory) chip.classList.add('active'); 
                
                chip.addEventListener('click', () => { 
                    document.querySelectorAll('#incomeCategoryChipsContainer .category-chip').forEach(c => c.classList.remove('active')); 
                    chip.classList.add('active'); 
                    D.selectedCategoryInput.value = cat; 
                }); 
                D.incomeCategoryChipsContainerEl.appendChild(chip); 
            });
        }

        // ====================================================================
        // 3. SECURITY MODULE (PIN Lock Logic)
        // ====================================================================

        function checkPinStatusAndRedirect() {
            const pin = localStorage.getItem(LS_KEYS.PIN);
            D.loginScreen.style.display = 'flex';

            if (pin) {
                D.loginTitle.textContent = 'Welcome Back';
                D.loginMessage.textContent = 'Enter your 6-Digit PIN to continue.';
                D.pinLoginForm.style.display = 'block';
                D.pinSetupFormWrapper.style.display = 'none';
                D.pinResetFormWrapper.style.display = 'none';
                if(D.pinInput) D.pinInput.value = '';
                if(D.pinError) D.pinError.textContent = '';
                if(D.pinInput) D.pinInput.focus();
            } else {
                D.loginTitle.textContent = 'Setup Security';
                D.loginMessage.textContent = 'Please set a 6-digit PIN and security question for protection.';
                D.pinSetupFormWrapper.style.display = 'block';
                D.pinLoginForm.style.display = 'none';
                D.pinResetFormWrapper.style.display = 'none';
                if(D.newPinInput) D.newPinInput.focus();
            }
        }
        
        function transitionToApp() {
            isAuthenticated = true;
            D.loginScreen.style.display = 'none';
            D.appContainer.style.display = 'flex';
            
            // Core initialization calls 
            updateTransactionFormFields('income'); 
            showView('homeView', 'Dashboard'); 
            renderAllContent();
        }

        function handlePinSetup(e) {
            e.preventDefault();
            const pin = D.newPinInput.value;
            const confirmPin = D.confirmPinInput.value;
            const questionKey = D.securityQuestionSelect.value;
            const answer = D.securityAnswerInput.value.trim().toLowerCase();

            if (!/^\d{6}$/.test(pin)) {
                D.pinSetupError.textContent = 'PIN must be exactly 6 digits.'; return;
            }
            if (pin !== confirmPin) {
                D.pinSetupError.textContent = 'PINs do not match.'; return;
            }
            if (!questionKey || !answer) {
                D.pinSetupError.textContent = 'Please select a question and provide an answer.'; return;
            }

            localStorage.setItem(LS_KEYS.PIN, pin);
            localStorage.setItem(LS_KEYS.SECURITY_Q, questionKey);
            localStorage.setItem(LS_KEYS.SECURITY_A, answer);

            D.pinSetupError.textContent = 'PIN set successfully! Logging in...';
            D.pinSetupError.style.color = 'var(--color-secondary)';
            setTimeout(transitionToApp, 1000);
        }

        function handlePinLogin(e) {
            e.preventDefault();
            const enteredPin = D.pinInput.value;
            const storedPin = localStorage.getItem(LS_KEYS.PIN);

            if (enteredPin === storedPin) {
                D.pinError.textContent = 'Success!';
                D.pinError.style.color = 'var(--color-secondary)';
                setTimeout(transitionToApp, 500);
            } else {
                D.pinError.textContent = 'Invalid PIN. Try again.';
                D.pinInput.value = '';
                D.pinInput.focus();
            }
        }
        
        function showPinResetForm() {
            const questionKey = localStorage.getItem(LS_KEYS.SECURITY_Q);
            if (!questionKey) {
                console.error('No security question found. Cannot proceed with PIN reset.');
                alert('No security question found. Please contact support.');
                return;
            }
            
            D.pinLoginForm.style.display = 'none';
            D.pinResetFormWrapper.style.display = 'block';
            D.resetQuestionDisplay.textContent = securityQuestions[questionKey] || 'Security Question';
            D.resetSecurityAnswerInput.value = '';
            D.newPinResetInput.value = '';
            if(D.pinResetError) D.pinResetError.textContent = '';
            D.resetSecurityAnswerInput.focus();
        }

        function handlePinReset(e) {
            e.preventDefault();
            const enteredAnswer = D.resetSecurityAnswerInput.value.trim().toLowerCase();
            const newPin = D.newPinResetInput.value;
            const storedAnswer = localStorage.getItem(LS_KEYS.SECURITY_A);

            if (!/^\d{6}$/.test(newPin)) {
                D.pinResetError.textContent = 'New PIN must be exactly 6 digits.'; return;
            }

            if (enteredAnswer === storedAnswer) {
                localStorage.setItem(LS_KEYS.PIN, newPin);
                D.pinResetError.textContent = 'PIN reset successful! You can now log in.';
                D.pinResetError.style.color = 'var(--color-secondary)';
                setTimeout(() => {
                    D.pinResetFormWrapper.style.display = 'none';
                    checkPinStatusAndRedirect();
                }, 1000);
            } else {
                D.pinResetError.textContent = 'Incorrect security answer.';
                D.resetSecurityAnswerInput.value = '';
                D.resetSecurityAnswerInput.focus();
            }
        }

        // ====================================================================
        // 4. CORE ACCOUNTING LOGIC (Transactions, Investments, Balances)
        // ====================================================================

        function calculateAllBalances() { 
            if (!isAuthenticated) return {};
            const accBalances = {}; 
            accounts.forEach(acc => accBalances[acc.id] = 0); 

            transactions.forEach(t => { 
                if (t.type === 'income' && accBalances.hasOwnProperty(t.account)) { 
                    accBalances[t.account] += t.amount; 
                } else if (t.type === 'spend' && accBalances.hasOwnProperty(t.account)) { 
                    accBalances[t.account] -= t.amount; 
                } else if (t.type === 'transfer') { 
                    if(accBalances.hasOwnProperty(t.fromAccount)) accBalances[t.fromAccount] -= t.amount; 
                    if(accBalances.hasOwnProperty(t.toAccount)) accBalances[t.toAccount] += t.amount; 
                } else if (t.type === 'loan') { 
                    // Loan outflow (lending money) reduces the account balance
                    if (accBalances.hasOwnProperty(t.account)) { 
                        accBalances[t.account] -= t.amount; 
                    } 
                    // Loan return inflow increases the return account balance
                    if (t.loanStatus === 'returned' && t.returnDetails && t.returnDetails.returnAccount && accBalances.hasOwnProperty(t.returnDetails.returnAccount) && t.returnDetails.returnAmount > 0) { 
                        accBalances[t.returnDetails.returnAccount] += t.returnDetails.returnAmount; 
                    } 
                } 
            }); 
            return accBalances; 
        }

        function updateTransactionFormFields(transactionType = null, isEditing = false) { 
            if (!isAuthenticated) return;
            
            const type = transactionType || D.transactionType.value; 
            
            // Toggle visibility based on type
            D.accountGroup.style.display = (type === 'income' || type === 'spend' || type === 'loan') ? 'block' : 'none'; 
            D.transferGroupEls.forEach(el => el.style.display = (type === 'transfer') ? 'block' : 'none'); 
            D.spendCategoryChipsGroup.style.display = (type === 'spend') ? 'block' : 'none'; 
            D.incomeCategoryChipsGroup.style.display = (type === 'income') ? 'block' : 'none';
            
            // Dynamic Required Setting
            D.transactionAccountEl.required = (type !== 'transfer');
            D.transferFromAccountEl.required = (type === 'transfer');
            D.transferToAccountEl.required = (type === 'transfer');

            // Update labels
            if (type === 'loan') { 
                D.transactionAccountLabelEl.textContent = "Lent From Account"; 
                D.transactionAmountLabelEl.textContent = "Amount Lent (₹)";
                D.transactionDescriptionLabelEl.textContent = "Description (e.g., To Whom, Reason)"; 
                D.transactionAmountEl.min = "0.01";
            } else if (type === 'transfer') {
                D.transactionDescriptionLabelEl.textContent = "Description (Optional)";
                D.transactionAmountLabelEl.textContent = "Amount (₹)";
                D.transactionAmountEl.min = "0.01";
            } else { 
                D.transactionAccountLabelEl.textContent = "Account";
                D.transactionAmountLabelEl.textContent = "Amount (₹)"; 
                D.transactionDescriptionLabelEl.textContent = 'Notes / Specifics (Optional)';
                D.transactionAmountEl.min = "0.01";
            } 
            
            // Reset chips/category input if not editing or type changed
            if (!isEditing || D.selectedCategoryInput.value === '') { 
                D.selectedCategoryInput.value = ''; 
                document.querySelectorAll('.category-chips-container .category-chip.active').forEach(c => c.classList.remove('active'));
            }

            // Re-render chips (preserves active state if selectedCategoryInput has a value)
            if (type === 'spend') { 
                populateSpendCategoryChips(D.selectedCategoryInput.value);
            } else if (type === 'income') { 
                populateIncomeCategoryChips(D.selectedCategoryInput.value); 
            }

            // Repopulate all account dropdowns for fresh state
            populateAllAccountDropdowns();
        }


        function handleTransactionSubmit(e) {
             e.preventDefault(); 
                    
            const editingId = D.editingTransactionId.value ? parseInt(D.editingTransactionId.value) : null; 
            const type = D.transactionType.value; 
            const descriptionInputVal = D.transactionDescriptionEl.value.trim();
            const amount = parseFloat(D.transactionAmountEl.value); 
            const date = D.transactionDateEl.value; 
            
            let category = (type === 'income' || type === 'spend') ? D.selectedCategoryInput.value : null; 
            if((type === 'income' || type === 'spend') && !category) {
                category = descriptionInputVal || (type === 'income' ? 'Uncategorized Income' : 'Uncategorized Spend');
            }

            const description = descriptionInputVal; 
            
            let acc, fromAcc, toAcc, isValid = false;

            if (type === 'income' || type === 'spend') { 
                acc = D.transactionAccountEl.value; 
                if (!acc) { alert('Select account.'); return; } 
                if (amount > 0 && date ) isValid = true;
            } else if (type === 'transfer') { 
                fromAcc = D.transferFromAccountEl.value; 
                toAcc = D.transferToAccountEl.value;
                if (!fromAcc || !toAcc) { alert('Select From & To accounts.'); return; } 
                if (fromAcc === toAcc) { alert('Accounts cannot be same.'); return; } 
                if (amount > 0 && date) isValid = true;
            } else if (type === 'loan') { 
                acc = D.transactionAccountEl.value;
                if (!acc) { alert('Please select the account money is lent from.'); return; } 
                if (!description) { alert('Please enter a description for the loan (e.g., to whom).'); return; } 
                if (amount > 0 && date) isValid = true;
            } 
            
            if (isValid) { 
                const transactionData = { type, description, amount, date };
                
                if (type === 'income' || type === 'spend') { 
                    transactionData.category = category;
                    transactionData.account = acc;
                } else if (type === 'transfer') { 
                    transactionData.fromAccount = fromAcc; 
                    transactionData.toAccount = toAcc; 
                } else if (type === 'loan') { 
                    transactionData.account = acc;
                    // Preserve status/details if editing, otherwise set outstanding
                    const original = editingId ? transactions.find(t => t.id === editingId) : null;
                    transactionData.loanStatus = original ? original.loanStatus : 'outstanding'; 
                    transactionData.returnDetails = original ? original.returnDetails : null; 
                    transactionData.category = 'Loan Receivable'; 
                } 
                
                if (editingId) { 
                    const index = transactions.findIndex(t => t.id === editingId);
                    if (index > -1) { 
                        const original = transactions[index];
                        transactions[index] = { 
                            ...original, 
                            ...transactionData,
                            id: original.id, 
                            // Ensure loan status and return details are only overwritten if the type is still 'loan'
                            loanStatus: type === 'loan' ? transactionData.loanStatus : undefined,
                            returnDetails: type === 'loan' ? transactionData.returnDetails : undefined
                        }; 
                    } 
                } else { 
                    transactionData.id = Date.now(); 
                    transactions.push(transactionData); 
                } 
                
                saveState(); 
                renderAllContent(); 
                D.txClearFiltersBtn?.click(); // Clear filters to show new transaction
                D.transactionModalJQ.modal('hide'); 
            } else { 
                alert('Please fill all required fields correctly.');
            } 
        }

        function handleEditTransaction(transactionId) {
             const transactionToEdit = transactions.find(t => t.id === parseInt(transactionId)); 
            if (transactionToEdit) { 
                D.editingTransactionId.value = transactionToEdit.id; 
                D.transactionModalTitleEl.textContent = 'Edit Transaction'; 
                D.transactionSubmitBtnEl.textContent = 'Update Transaction'; 
                D.transactionSubmitBtnEl.classList.remove('btn-primary'); 
                D.transactionSubmitBtnEl.classList.add('btn-warning');
                
                D.transactionType.value = transactionToEdit.type; 
                updateTransactionFormFields(transactionToEdit.type, true); // Pass true for isEditing
                
                D.transactionDescriptionEl.value = transactionToEdit.description || ''; 
                D.transactionAmountEl.value = transactionToEdit.amount; 
                D.transactionDateEl.value = formatDate(transactionToEdit.date); 
                D.selectedCategoryInput.value = transactionToEdit.category || '';
                
                // Set dropdowns/chips based on type
                if (transactionToEdit.type === 'spend') { 
                    populateSpendCategoryChips(transactionToEdit.category); 
                    populateAccountDropdown(D.transactionAccountEl, transactionToEdit.account); 
                } else if (transactionToEdit.type === 'income') { 
                    populateIncomeCategoryChips(transactionToEdit.category); 
                    populateAccountDropdown(D.transactionAccountEl, transactionToEdit.account);
                } else if (transactionToEdit.type === 'transfer') { 
                    populateAccountDropdown(D.transferFromAccountEl, transactionToEdit.fromAccount); 
                    populateAccountDropdown(D.transferToAccountEl, transactionToEdit.toAccount); 
                } else if (transactionToEdit.type === 'loan') { 
                    populateAccountDropdown(D.transactionAccountEl, transactionToEdit.account);
                } 
                D.transactionModalJQ.modal('show'); 
            } 
        }

        function handleDeleteAction(id, type) {
            const parsedId = parseInt(id);
            if (type === 'transaction') { 
                if (window.confirm('Delete transaction? This cannot be undone.')) { 
                    transactions = transactions.filter(t => t.id !== parsedId); 
                    saveState(); 
                    renderAllContent();
                    D.txClearFiltersBtn?.click();
                }
            } else if (type === 'investment') { 
                const investmentToDelete = investments.find(inv => inv.id === parsedId);
                let confirmMessage = 'Delete investment record? This is permanent.'; 
                if (investmentToDelete && investmentToDelete.status === 'redeemed') { 
                    confirmMessage += '\nNOTE: Associated income transaction is NOT automatically reversed. You may need to delete it manually in the transaction view.';
                } 

                if (window.confirm(confirmMessage)) { 
                    investments = investments.filter(inv => inv.id !== parsedId);
                    if (investmentToDelete) {
                        // Attempt to remove the associated "Investment Expense" transaction
                        transactions = transactions.filter(t => 
                            !(t.type === 'spend' && t.category === 'Investment Expense' && t.description && t.description.includes(investmentToDelete.description))
                        );
                    }
                    saveState(); 
                    renderAllContent();
                }
            }
        }
        
        function handleRecordLoanReturn(e) {
            e.preventDefault();
            const loanId = parseInt(D.originalLoanIdToReturnEl.value);
            const returnDate = D.loanReturnDateInputEl.value;
            const returnAmount = parseFloat(D.loanReturnAmountInputEl.value);
            const returnAccount = D.loanReturnAccountSelectEl.value;

            if (!loanId || !returnDate || isNaN(returnAmount) || returnAmount <= 0 || !returnAccount) {
                alert('Please fill all fields for the loan return correctly.');
                return;
            }

            const loanIndex = transactions.findIndex(t => t.id === loanId && t.type === 'loan');
            if (loanIndex > -1) {
                transactions[loanIndex].loanStatus = 'returned';
                transactions[loanIndex].returnDetails = { returnDate, returnAmount, returnAccount };
                saveState();
                renderAllContent();
                $('#recordLoanReturnModal').modal('hide');
            } else {
                alert('Error finding the original loan transaction.');
            }
        }

        // ====================================================================
        // 5. RENDERING MODULES
        // ====================================================================

        function showView(viewId, title) { 
            if (!isAuthenticated) return;
            D.views.forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.add('active'); else console.error("View not found:", viewId);
            D.navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
            if(D.appTitle) D.appTitle.textContent = title;

            // Trigger view-specific renders
            if (viewId === 'chartsView') { 
                renderChartFilters(); 
                renderSpendCategoryChart(); 
                renderIncomeSpendChart(); 
                renderInvestmentPortfolioChart(); 
                renderMonthlySpendChart();
            }
            if (viewId === 'homeView') renderHomePageSummaries();
            if (viewId === 'investmentsView') renderInvestmentList();
            if (viewId === 'transactionsView') renderFullTransactionList();
            if (viewId === 'settingsView') {
                renderAccountManagementList();
                renderCategoryManagementUI();
                applyCategoryManagementVisibility();
                applyAccountManagementVisibility(); 
            }
        }

        function renderAllContent() { 
            if (!isAuthenticated) return; 
            
            renderAccountBalances(); 
            renderHomePageSummaries(); 
            
            const activeView = document.querySelector('.view.active');
            if (activeView) {
                const viewId = activeView.id;
                if (viewId === 'transactionsView') renderFullTransactionList();
                else if (viewId === 'investmentsView') renderInvestmentList();
                else if (viewId === 'chartsView') { 
                    renderSpendCategoryChart(); 
                    renderIncomeSpendChart(); 
                    renderInvestmentPortfolioChart();
                    renderMonthlySpendChart();
                }
                else if (viewId === 'settingsView') {
                    renderAccountManagementList(); 
                    renderCategoryManagementUI(); 
                }
            }
        }

        function renderAccountBalances() { 
            if (!isAuthenticated || !D.accountBalancesList || !D.totalBalance) return;
            
            D.toggleBalanceVisibilityBtn.innerHTML = balancesVisible ? 
                '<i class="fas fa-eye"></i> Hide Amounts' : 
                '<i class="fas fa-eye-slash"></i> Show Amounts'; 
            
            if (D.showSecretAccountsToggleSettingsEl) D.showSecretAccountsToggleSettingsEl.checked = showSecretAccounts;
            if (D.toggleShowSecretAccountsHomeBtn) {
                D.toggleShowSecretAccountsHomeBtn.innerHTML = showSecretAccounts ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                D.toggleShowSecretAccountsHomeBtn.title = showSecretAccounts ? "Hide Secret Accounts" : "Show Secret Accounts";
            }

            const allBalances = calculateAllBalances(); 
            D.accountBalancesList.innerHTML = ''; 
            
            const visibleAccountsForDisplay = accounts.filter(acc => acc.status === 'active' || (acc.status === 'secret' && showSecretAccounts));
            
            let totalOverallBalance = 0;
            
            if (visibleAccountsForDisplay.length === 0) { 
                D.accountBalancesList.innerHTML = '<p class="text-muted text-center">No active accounts to display.</p>'; 
                D.totalBalance.textContent = formatCurrency(0); 
                return;
            } 
            
            visibleAccountsForDisplay.forEach(acc => { 
                const balance = allBalances[acc.id] || 0; 
                totalOverallBalance += balance; 
                
                const item = document.createElement('div'); 
                item.classList.add('account-balance-item'); 
                
                const valueDisplay = balancesVisible ? formatCurrency(balance) : `<i class="fas fa-eye-slash"></i>`; 
                
                item.innerHTML = `
                    <span class="account-name">
                        ${getAccountNameById(acc.id)} 
                        ${acc.status === 'secret' ? '<i class="fas fa-user-secret text-warning" title="Secret Account"></i>' : ''}
                    </span>
                    <span class="account-value ${!balancesVisible ? 'hidden-balance' : ''}">
                        ${valueDisplay}
                    </span>
                `; 
                D.accountBalancesList.appendChild(item); 
            });
            
            D.totalBalance.textContent = formatCurrency(totalOverallBalance); 
            D.totalBalance.style.color = totalOverallBalance < 0 ? '#dc3545' : 'white';
        }

        function populateFilters() { 
            if (!isAuthenticated) return;
            
            // Populate Month Filter
            if (D.txMonthFilter) { 
                const currentMonth = D.txMonthFilter.value; 
                D.txMonthFilter.innerHTML = '<option value="">All Months</option>';
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthNames.forEach((month, index) => { 
                    const option = document.createElement('option'); 
                    option.value = index; 
                    option.textContent = month; 
                    if (String(index) === currentMonth) option.selected = true; 
                    D.txMonthFilter.appendChild(option); 
                });
            } 
            
            // Populate Year Filter
            if (D.txYearFilter) { 
                const currentYear = D.txYearFilter.value; 
                const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
                D.txYearFilter.innerHTML = '<option value="">All Years</option>'; 
                years.forEach(year => { 
                    const option = document.createElement('option'); 
                    option.value = year; 
                    option.textContent = year; 
                    if (String(year) === currentYear) option.selected = true; 
                    D.txYearFilter.appendChild(option); 
                });
            } 
        }

        function filterAndSearchTransactions() { 
            if (!isAuthenticated) return []; 
            let filtered = [...transactions];
            
            const searchQuery = D.txSearchInput ? D.txSearchInput.value.toLowerCase().trim() : ""; 
            const amountQueryVal = D.txAmountFilter ? D.txAmountFilter.value.trim() : "";
            const amountQuery = amountQueryVal ? parseFloat(amountQueryVal) : null; 
            const selectedMonth = D.txMonthFilter ? D.txMonthFilter.value : "";
            const selectedYear = D.txYearFilter ? D.txYearFilter.value : ""; 
            const selectedType = D.txTypeFilter ? D.txTypeFilter.value : "";
            
            // Search filter
            if (searchQuery) { 
                filtered = filtered.filter(t => (
                    (t.description && t.description.toLowerCase().includes(searchQuery)) || 
                    (t.category && t.category.toLowerCase().includes(searchQuery)) || 
                    (t.type === 'transfer' && (getAccountNameById(t.fromAccount)?.toLowerCase().includes(searchQuery) || getAccountNameById(t.toAccount)?.toLowerCase().includes(searchQuery))) || 
                    (t.type !== 'transfer' && t.type !== 'loan' && getAccountNameById(t.account)?.toLowerCase().includes(searchQuery)) || 
                    (t.type === 'loan' && getAccountNameById(t.account)?.toLowerCase().includes(searchQuery))
                ));
            } 
            
            // Amount filter
            if (amountQuery !== null && !isNaN(amountQuery)) { 
                filtered = filtered.filter(t => 
                    (t.amount === amountQuery) || 
                    (t.type === 'loan' && t.returnDetails && t.returnDetails.returnAmount === amountQuery) 
                );
            } 
            
            // Date filters
            if (selectedYear) { 
                filtered = filtered.filter(t => new Date(t.date).getFullYear() === parseInt(selectedYear));
            } 
            if (selectedMonth !== "") { 
                filtered = filtered.filter(t => new Date(t.date).getMonth() === parseInt(selectedMonth));
            } 
            
            // Type filters (including loan status and investment types)
            if (selectedType) { 
                if (selectedType === "investment_purchase") { 
                    filtered = filtered.filter(t => t.type === 'spend' && t.category === 'Investment Expense');
                } else if (selectedType === "investment_sale") { 
                    filtered = filtered.filter(t => t.type === 'income' && t.category === 'Investment Income');
                } else if (selectedType === "loan_outstanding") { 
                    filtered = filtered.filter(t => t.type === 'loan' && t.loanStatus === 'outstanding');
                } else if (selectedType === "loan_returned") { 
                    filtered = filtered.filter(t => t.type === 'loan' && t.loanStatus === 'returned');
                } else { 
                    filtered = filtered.filter(t => t.type === selectedType); 
                } 
            } 
            return filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
        }

        function renderFullTransactionList() { 
            if (!isAuthenticated || !D.transactionList) return;
            
            populateFilters(); 
            const transactionsToRender = filterAndSearchTransactions(); 
            D.transactionList.innerHTML = ''; 
            
            let filteredIncome = 0; 
            let filteredSpend = 0; 
            let filteredTransfer = 0;

            // Calculate totals based on filtered view
            transactionsToRender.forEach(t => { 
                if (t.type === 'income') {
                    filteredIncome += t.amount; 
                } else if (t.type === 'spend') {
                    filteredSpend += t.amount; 
                } else if (t.type === 'transfer') {
                    filteredTransfer += t.amount; 
                } else if (t.type === 'loan') { 
                    filteredSpend += t.amount; // Initial loan is a cash outflow/spend
                    if (t.loanStatus === 'returned' && t.returnDetails) { 
                        filteredIncome += t.returnDetails.returnAmount; // Return is cash inflow/income
                    } 
                } 
            });

            if (D.filteredTotalsContainer) { 
                const netCashFlow = filteredIncome - filteredSpend;

                if (transactionsToRender.length > 0) { 
                    D.filteredTotalsContainer.innerHTML = `
                        <span class="filtered-total-item filtered-total-income text-success">Income: ${formatCurrency(filteredIncome)}</span> 
                        <span class="filtered-total-item filtered-total-spend text-danger">Spend: ${formatCurrency(filteredSpend)}</span> 
                        <span class="filtered-total-item filtered-total-transfer text-info">Transfers: ${formatCurrency(filteredTransfer)}</span> 
                        <span class="filtered-total-item filtered-total-net ${netCashFlow >= 0 ? 'text-primary' : 'text-danger'}">Net: ${formatCurrency(netCashFlow)}</span> 
                    `;
                    D.filteredTotalsContainer.style.display = 'flex'; 
                } else { 
                    D.filteredTotalsContainer.style.display = 'none'; 
                } 
            } 
            
            // --- Transaction Row Rendering Loop ---
            if (transactionsToRender.length === 0) { 
                if (D.noTransactionsMessageEl) { 
                    D.noTransactionsMessageEl.textContent = transactions.length > 0 ? "No transactions match filters." : "No transactions yet."; 
                    D.noTransactionsMessageEl.style.display = 'block'; 
                    D.transactionList.appendChild(D.noTransactionsMessageEl);
                } 
            } else { 
                if (D.noTransactionsMessageEl) D.noTransactionsMessageEl.style.display = 'none'; 
                
                transactionsToRender.forEach(t => { 
                    let iconClass = '', sign = '', accInfo = '', amountDisplay = formatCurrency(t.amount); 
                    let mainInfo = t.description || 'N/A'; 
                    let loanDetailsHtml = ''; 
                    let actionButtons = `
                        <button class="btn btn-sm btn-outline-warning action-btn edit-btn" data-id="${t.id}" title="Edit"><i class="fas fa-edit"></i></button> 
                        <button class="btn btn-sm btn-outline-danger action-btn delete-btn" data-id="${t.id}" data-type="transaction" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    `; 
                    
                    if (t.type === 'income') { 
                        iconClass = 'fa-arrow-down'; 
                        sign = '+'; 
                        accInfo = `To: ${getAccountNameById(t.account)}`; 
                    } else if (t.type === 'spend') { 
                        iconClass = 'fa-arrow-up'; 
                        sign = '-'; 
                        accInfo = `From: ${getAccountNameById(t.account)}`; 
                    } else if (t.type === 'transfer') { 
                        iconClass = 'fa-exchange-alt'; 
                        accInfo = `From ${getAccountNameById(t.fromAccount)} to ${getAccountNameById(t.toAccount)}`; 
                        mainInfo = t.description || 'Transfer';
                    } else if (t.type === 'loan') { 
                        iconClass = 'fa-hand-holding-usd';
                        mainInfo = `Loan: ${t.description || 'N/A'}`; 
                        
                        mainInfo += `<span class="status-badge status-loan-${t.loanStatus}">${t.loanStatus.charAt(0).toUpperCase() + t.loanStatus.slice(1)}</span>`; 
                        
                        accInfo = `Lent: ${formatCurrency(t.amount)} from ${getAccountNameById(t.account)}`;
                        amountDisplay = `-${formatCurrency(t.amount)}`; 
                        
                        if (t.loanStatus === 'outstanding') { 
                            actionButtons += ` <button class="btn btn-sm btn-outline-success action-btn record-return-btn" data-id="${t.id}" title="Record Return"><i class="fas fa-undo-alt"></i> Return</button>`;
                        } else if (t.loanStatus === 'returned' && t.returnDetails) { 
                            loanDetailsHtml = `<div class="loan-details-info text-success">Returned: ${formatCurrency(t.returnDetails.returnAmount)} to ${getAccountNameById(t.returnDetails.returnAccount)} on ${displayDate(t.returnDetails.returnDate)}</div>`;
                            amountDisplay = `(Lent: -${formatCurrency(t.amount)})<br><span class="text-success" style="font-weight: 700;">+${formatCurrency(t.returnDetails.returnAmount)}</span>`; 
                        } 
                    } 
                    
                    let categoryDisplay = t.category;
                    if(categoryDisplay) {
                         mainInfo = `<span class="category-info">${categoryDisplay}</span>`;
                         if(t.description) mainInfo += `<span class="description-info text-muted"> (${t.description})</span>`;
                    } else {
                        mainInfo = t.description || t.type.charAt(0).toUpperCase() + t.type.slice(1);
                    }

                    const item = document.createElement('li'); 
                    item.classList.add('list-group-item', `transaction-${t.type}`); 
                    
                    item.innerHTML = ` 
                        <div class="list-item-icon"><i class="fas ${iconClass} ${t.type === 'income' ? 'text-success' : t.type === 'spend' ? 'text-danger' : 'text-info'}"></i></div> 
                        <div class="list-item-details"> 
                            <div style="font-weight: 500;">${mainInfo}</div> 
                            <div class="sub-info">${displayDate(t.date)}</div> 
                            <div class="account-info">${accInfo}</div> 
                            ${loanDetailsHtml} 
                        </div> 
                        <div class="list-item-amount-actions"> 
                            <span class="amount ${t.type === 'income' ? 'text-success' : t.type === 'spend' ? 'text-danger' : t.type === 'loan' && t.loanStatus === 'outstanding' ? 'text-danger' : 'text-primary'}">
                                ${t.type === 'loan' && t.loanStatus === 'returned' ? amountDisplay : `${sign}${formatCurrency(t.amount)}`}
                            </span> 
                            <div class="item-actions"> 
                                ${actionButtons} 
                            </div> 
                        </div>
                    `; 
                    D.transactionList.appendChild(item); 
                });
            } 
        }

        function renderInvestmentList() { 
            if (!isAuthenticated || !D.investmentListEl) return; 
            D.investmentListEl.innerHTML = '';
            
            const sortedInvestments = [...investments].sort((a, b) => (a.status === 'active' && b.status !== 'active') ? -1 : (a.status !== 'active' && b.status === 'active') ? 1 : new Date(b.date) - new Date(a.date));
            
            if (sortedInvestments.length === 0) { 
                if (D.noInvestmentsMessageEl) { 
                    D.noInvestmentsMessageEl.style.display = 'block'; 
                    D.investmentListEl.appendChild(D.noInvestmentsMessageEl);
                }
            } else { 
                if (D.noInvestmentsMessageEl) D.noInvestmentsMessageEl.style.display = 'none';
                
                sortedInvestments.forEach(inv => { 
                    const item = document.createElement('li'); 
                    item.classList.add('list-group-item', 'investment-item'); 
                    if (inv.status === 'redeemed') item.classList.add('redeemed-investment'); 
                    
                    let valueDisplay = `<span class="amount text-muted">${formatCurrency(inv.amount)}</span> <small>(Invested)</small>`; 
                    let profitLossDisplay = '';
                    let actionButtonsHtml = '';

                    if (inv.status === 'active') { 
                        if (inv.currentValue !== null && inv.currentValue !== undefined) { 
                            valueDisplay += `<br><span class="amount ${inv.currentValue >= inv.amount ? 'text-success' : 'text-danger'}">${formatCurrency(inv.currentValue)}</span> <small class="current-value-label">(Current)</small>`; 
                        }
                        actionButtonsHtml = `
                            <div class="investment-item-actions">
                                <button class="btn btn-info btn-sm update-value-btn" data-id="${inv.id}" title="Update Value"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-success btn-sm redeem-btn" data-id="${inv.id}" title="Redeem"><i class="fas fa-hand-holding-usd"></i></button>
                            </div>`; 
                    } else if (inv.status === 'redeemed') { 
                        valueDisplay = `<span class="amount text-muted">${formatCurrency(inv.amount)}</span> <small>(Invested)</small><br><span class="amount">${formatCurrency(inv.redeemedAmount || 0)}</span> <small>(Redeemed)</small>`; 
                        if (inv.profitOrLoss !== null && inv.profitOrLoss !== undefined) {
                            profitLossDisplay = `<div class="investment-details ${inv.profitOrLoss >= 0 ? 'profit' : 'loss'}">P/L: ${formatCurrency(inv.profitOrLoss)}</div>`;
                        }
                    }
                    
                    item.innerHTML = `
                        <div class="list-item-content">
                            <div class="main-info">
                                ${inv.description} 
                                <span class="status-badge status-${inv.status}">${inv.status.charAt(0).toUpperCase() + inv.status.slice(1)}</span>
                            </div>
                            <div class="sub-info">Type: ${investmentTypeNames[inv.type] || 'N/A'} | Invested: ${displayDate(inv.date)}</div>
                            ${inv.status === 'active' && inv.maturityInfo ? `<div class="investment-details">Maturity: ${inv.maturityInfo}</div>` : ''}
                            ${inv.status === 'redeemed' && inv.redemptionDate ? `<div class="investment-details">Redeemed: ${displayDate(inv.redemptionDate)}</div>` : ''}
                            ${profitLossDisplay}
                            <div class="investment-details">From: ${getAccountNameById(inv.sourceAccount)}</div>
                        </div>
                        <div class="list-item-amount text-right">${valueDisplay}</div>
                        ${actionButtonsHtml}
                        <button class="delete-btn btn btn-danger btn-sm" data-id="${inv.id}" data-type="investment" title="Delete" style="position: absolute; bottom: 5px; right: 5px;"><i class="fas fa-trash-alt"></i></button>
                    `; 
                    D.investmentListEl.appendChild(item); 
                }); 
            } 
        }

        // The rest of the rendering functions (renderHomePageSummaries, renderAccountManagementList, 
        // renderCategoryManagementUI, renderChartFilters, renderSpendCategoryChart, renderIncomeSpendChart, 
        // renderInvestmentPortfolioChart, renderMonthlySpendChart) are highly specific UI rendering logic 
        // and are kept as they were, relying on the globally accessible D object for DOM access. 
        // ********************************************************************************************
        // NOTE: The rest of the original JS code is included below this line. 
        // This ensures all logic is preserved and only the structure is modified.
        // ********************************************************************************************
        
        function renderHomePageSummaries() { 
            const recentTransactionsListHomeEl = document.getElementById('recentTransactionsListHome');
            const investmentSummaryHomeEl = document.getElementById('investmentSummaryHome');

            if (!isAuthenticated || !recentTransactionsListHomeEl || !investmentSummaryHomeEl) return; 
            
            // Render Recent Transactions
            recentTransactionsListHomeEl.innerHTML = '';
            const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
            
            if(recent.length === 0) { 
                recentTransactionsListHomeEl.innerHTML = '<li class="list-group-item text-center text-muted">No recent transactions.</li>';
            } else { 
                recent.forEach(t => { 
                    let sign = ''; 
                    let amountStr = formatCurrency(t.amount); 
                    let colorClass = ''; 
                    let primaryInfo = t.description || 'N/A'; 
                    
                    if (t.type === 'income') { 
                        sign = '+'; 
                        colorClass = 'text-success'; 
                    } else if (t.type === 'spend') { 
                        sign = '-'; 
                        colorClass = 'text-danger'; 
                    } else if (t.type === 'transfer') { 
                        colorClass = 'text-info'; 
                        primaryInfo = `Transfer: ${getAccountNameById(t.fromAccount)} -> ${getAccountNameById(t.toAccount)}`; 
                        sign = '';
                    } else if (t.type === 'loan') { 
                        colorClass = 'text-warning'; 
                        primaryInfo = `Loan: ${t.description || 'N/A'} (${t.loanStatus})`; 
                        if (t.loanStatus === 'outstanding') { 
                            sign = '-'; 
                        } else if (t.loanStatus === 'returned' && t.returnDetails) { 
                            primaryInfo = `Loan Ret: ${t.description || 'N/A'}`; 
                            amountStr = `Lent: ${formatCurrency(t.amount)}, Ret: ${formatCurrency(t.returnDetails.returnAmount)}`; 
                            colorClass = 'text-success'; 
                            sign = '+';
                        } 
                    } 
                    
                    if(t.category && (t.type === 'income' || t.type === 'spend')) {
                             primaryInfo = t.category;
                             if(t.description) primaryInfo += ` (${t.description.substring(0,15)}...)`;
                    }
                    
                    const item = document.createElement('li'); 
                    item.classList.add('list-group-item'); 
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div style="font-size:0.85rem;">
                                <span style="font-weight:500;">${primaryInfo}</span>
                                <small class="d-block text-muted">${displayDate(t.date)}</small>
                            </div>
                            <small class="${colorClass}" style="font-weight:bold;">${t.type === 'loan' && t.loanStatus === 'returned' ? amountStr : `${sign}${amountStr}`}</small>
                        </div>
                    `; 
                    recentTransactionsListHomeEl.appendChild(item); 
                });
            }
            
            // Render Investment Summary
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            if (activeInvestments.length === 0) { 
                investmentSummaryHomeEl.innerHTML = '<p class="text-center text-muted">No active investments yet.</p>';
            } else { 
                const totalInitialCostActive = activeInvestments.reduce((sum, inv) => sum + inv.amount, 0);
                const totalCurrentValueActive = activeInvestments.reduce((sum, inv) => sum + (inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount), 0);
                const netChange = totalCurrentValueActive - totalInitialCostActive;
                
                investmentSummaryHomeEl.innerHTML = `
                    <p class="text-center mb-1"><strong>Active Investments:</strong> ${activeInvestments.length}</p>
                    <p class="text-center mb-1"><strong>Total Cost:</strong> ${formatCurrency(totalInitialCostActive)}</p>
                    <p class="text-center mb-1"><strong>Current Value:</strong> ${formatCurrency(totalCurrentValueActive)}</p>
                    <p class="text-center mb-0 ${netChange >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>Net Change:</strong> ${formatCurrency(netChange)}
                    </p>
                `;
            } 
        }

        function renderCategoryManagementUI() {
            if (!isAuthenticated || !D.spendCategoriesListContainerEl || !D.incomeCategoriesListContainerEl) return;

            D.spendCategoriesListContainerEl.innerHTML = '';
            if (spendCategories.length === 0) {
                D.spendCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No spend categories defined. Add one above.</p>';
            } else {
                spendCategories.sort().forEach(cat => {
                    const chip = document.createElement('span');
                    chip.className = 'mgmt-category-chip';
                    chip.innerHTML = `
                        ${cat}
                        <button class="remove-chip-btn remove-category-btn" data-type="spend" data-category="${cat}" title="Remove ${cat}">&times;</button>
                    `;
                    D.spendCategoriesListContainerEl.appendChild(chip);
                });
            }

            D.incomeCategoriesListContainerEl.innerHTML = '';
            if (incomeCategories.length === 0) {
                D.incomeCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No income categories defined. Add one above.</p>';
            } else {
                incomeCategories.sort().forEach(cat => {
                    const chip = document.createElement('span');
                    chip.className = 'mgmt-category-chip';
                    chip.innerHTML = `
                        ${cat}
                        <button class="remove-chip-btn remove-category-btn" data-type="income" data-category="${cat}" title="Remove ${cat}">&times;</button>
                    `;
                    D.incomeCategoriesListContainerEl.appendChild(chip);
                });
            }
        }

        function renderAccountManagementList() {
            if (!isAuthenticated || !D.accountsListContainerEl) return;
            D.accountsListContainerEl.innerHTML = ''; 

            if (accounts.length === 0) {
                if (D.noAccountsMessageSettingsEl) D.noAccountsMessageSettingsEl.style.display = 'block';
                return;
            }
            if (D.noAccountsMessageSettingsEl) D.noAccountsMessageSettingsEl.style.display = 'none';

            const ul = document.createElement('ul');
            ul.className = 'list-group';

            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.className = 'list-group-item account-list-item';

                let statusBadge = '';
                let toggleStatusBtnHtml = '';
                let toggleSecretBtnHtml = '';

                if (acc.status === 'inactive') {
                    statusBadge = '<span class="badge badge-secondary">Inactive</span>';
                    toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-success toggle-account-status-btn" data-id="${acc.id}" title="Activate">
                        <i class="fas fa-toggle-on"></i> Activate
                    </button>`;
                } else if (acc.status === 'secret') {
                    statusBadge = '<span class="badge badge-warning">Secret</span>';
                    toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-danger toggle-account-status-btn" data-id="${acc.id}" title="Deactivate">
                        <i class="fas fa-toggle-off"></i> Deactivate
                    </button>`;
                } else { // active
                     statusBadge = '<span class="badge badge-primary">Active</span>';
                     toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-danger toggle-account-status-btn" data-id="${acc.id}" title="Deactivate">
                        <i class="fas fa-toggle-off"></i> Deactivate
                    </button>`;
                }

                if (acc.status === 'secret') {
                    toggleSecretBtnHtml = `<button class="btn btn-sm btn-outline-info toggle-account-secret-btn" data-id="${acc.id}" title="Make Public">
                        <i class="fas fa-eye"></i> Public
                    </button>`;
                } else if (acc.status !== 'inactive') {
                    toggleSecretBtnHtml = `<button class="btn btn-sm btn-outline-warning toggle-account-secret-btn" data-id="${acc.id}" title="Make Secret">
                        <i class="fas fa-user-secret"></i> Secret
                    </button>`;
                }

                li.innerHTML = `
                     <div class="account-name-status">
                        ${acc.name} (ID: ${acc.id}) ${statusBadge}
                    </div>
                    <div class="account-actions">
                        ${toggleStatusBtnHtml}
                        ${toggleSecretBtnHtml}
                    </div>
                 `;
                ul.appendChild(li);
            });
            D.accountsListContainerEl.appendChild(ul);
        }
        
        // --- Chart Filtering Helpers ---
        
        function getDatesForRange(rangeKey) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            let startDate = null;
            let endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 1);
            endDate.setMilliseconds(endDate.getMilliseconds() - 1); // End of today

            if (rangeKey === 'all') {
                startDate = null; 
            } else if (rangeKey === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            } else if (rangeKey === '3months') {
                startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            } else if (rangeKey === '6months') {
                startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
            } else if (rangeKey === 'year') {
                startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            } else if (rangeKey === 'custom') {
                startDate = chartStartDate;
                endDate = chartEndDate ? new Date(chartEndDate.getFullYear(), chartEndDate.getMonth(), chartEndDate.getDate(), 23, 59, 59, 999) : endDate;
                return { startDate, endDate };
            }
            
            if (startDate) startDate.setHours(0, 0, 0, 0);
            return { startDate, endDate };
        }

        function filterTransactionsForCharts() {
            const { startDate, endDate } = getDatesForRange(chartDateRange);
            
            const startTimestamp = startDate ? startDate.getTime() : 0;
            const endTimestamp = endDate ? endDate.getTime() : Infinity;

            return transactions.filter(t => {
                const txDate = new Date(t.date);
                const txTimestamp = txDate.getTime();
                
                return txTimestamp >= startTimestamp && txTimestamp <= endTimestamp;
            });
        }
        
        function handleChartFilterButtonClick(e) {
            const btn = e.target.closest('.chart-filter-btn');
            if (btn) {
                chartDateRange = btn.dataset.range;
                
                if (chartDateRange !== 'custom') {
                    chartStartDate = null;
                    chartEndDate = null;
                    D.chartStartDateEl.value = '';
                    D.chartEndDateEl.value = '';
                    renderChartFilters(); 
                    renderAllContent(); 
                } else {
                    renderChartFilters(); 
                }
            }
        }
        
        function handleApplyCustomDateRange() {
            const start = D.chartStartDateEl.value;
            const end = D.chartEndDateEl.value;

            if (!start || !end) {
                alert('Please select both start and end dates for the custom range.');
                return;
            }

            chartStartDate = new Date(start);
            chartEndDate = new Date(end);
            
            if (chartStartDate.getTime() > chartEndDate.getTime()) {
                alert('Start date cannot be after the end date.');
                return;
            }

            chartDateRange = 'custom';
            renderChartFilters();
            renderAllContent();
        }

        function renderChartFilters() {
            if (!isAuthenticated || !D.chartFilterButtonsContainer) return;

            document.querySelectorAll('.chart-filter-btn').forEach(btn => {
                const isActive = btn.dataset.range === chartDateRange;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('btn-primary', isActive);
                btn.classList.toggle('btn-outline-primary', !isActive && btn.dataset.range !== 'custom');
                btn.classList.toggle('btn-outline-secondary', btn.dataset.range === 'custom' && !isActive);
            });

            if (chartDateRange === 'custom') {
                D.customDateRangeInputsEl.style.display = 'flex';
                D.chartStartDateEl.value = chartStartDate ? formatDate(chartStartDate) : '';
                D.chartEndDateEl.value = chartEndDate ? formatDate(chartEndDate) : '';
            } else {
                D.customDateRangeInputsEl.style.display = 'none';
            }
        }
        
        // --- Chart Rendering ---
        
        function renderSpendCategoryChart() { 
            const spendCategoryChartCanvas = document.getElementById('spendCategoryChart')?.getContext('2d');
            const noSpendDataForCategoryChartEl = document.getElementById('noSpendDataForCategoryChart');

            if (!isAuthenticated || !spendCategoryChartCanvas) return;
            const filteredTransactions = filterTransactionsForCharts(); 
            const categorySpends = {}; 
            
            filteredTransactions.filter(t => t.type === 'spend' && t.category && !investmentRelatedCategories.includes(t.category)).forEach(t => { 
                categorySpends[t.category] = (categorySpends[t.category] || 0) + t.amount; 
            });
            
            const labels = Object.keys(categorySpends); 
            const data = Object.values(categorySpends); 
            const backgroundColors = labels.map((_, index) => `hsl(${(index * 45 + 10) % 360}, 70%, 65%)`);
            
            if (noSpendDataForCategoryChartEl) noSpendDataForCategoryChartEl.style.display = (labels.length === 0) ? 'block' : 'none'; 
            if (spendCategoryChartCanvas.canvas.parentElement) spendCategoryChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none'; 
            
            if (labels.length === 0) { 
                if(spendCategoryChartInstance) spendCategoryChartInstance.destroy(); 
                spendCategoryChartInstance = null; 
                return; 
            } 
            
            if (spendCategoryChartInstance) spendCategoryChartInstance.destroy();
            spendCategoryChartInstance = new Chart(spendCategoryChartCanvas, { 
                type: 'doughnut', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Spend by Category', 
                        data: data, 
                        backgroundColor: backgroundColors, 
                        borderColor: '#fff', 
                        borderWidth: 2, 
                        hoverOffset: 8 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: { animateScale: true, animateRotate: true }, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { font: { size: 10 }, boxWidth:15, padding:10 } 
                        }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` 
                            }
                        } 
                    } 
                } 
            });
        }
        
        function renderIncomeSpendChart() { 
            const incomeSpendChartCanvas = document.getElementById('incomeSpendChart')?.getContext('2d');
            const noIncomeSpendDataEl = document.getElementById('noIncomeSpendData');
            
            if (!isAuthenticated || !incomeSpendChartCanvas) return; 
            
            const filteredTransactions = filterTransactionsForCharts(); 
            let totalIncome = 0; 
            let totalSpend = 0;
            
            filteredTransactions.forEach(t => { 
                if (t.type === 'income') totalIncome += t.amount; 
                else if (t.type === 'spend') totalSpend += t.amount; 
                else if (t.type === 'loan') { 
                    totalSpend += t.amount; // Loan outflow
                    if (t.loanStatus === 'returned' && t.returnDetails) { 
                        totalIncome += t.returnDetails.returnAmount; // Loan return inflow
                    } 
                } 
            });
            
            if (noIncomeSpendDataEl) noIncomeSpendDataEl.style.display = (totalIncome === 0 && totalSpend === 0) ? 'block' : 'none';
            if (incomeSpendChartCanvas.canvas.parentElement) incomeSpendChartCanvas.canvas.parentElement.style.display = (totalIncome > 0 || totalSpend > 0) ? 'block' : 'none';
            
            if (totalIncome === 0 && totalSpend === 0) { 
                if (incomeSpendChartInstance) incomeSpendChartInstance.destroy(); 
                incomeSpendChartInstance = null; 
                return; 
            } 
            
            if (incomeSpendChartInstance) incomeSpendChartInstance.destroy();
            incomeSpendChartInstance = new Chart(incomeSpendChartCanvas, { 
                type: 'bar', 
                data: { 
                    labels: ['Total Income', 'Total Spend'], 
                    datasets: [{ 
                        label: 'Amount (₹)', 
                        data: [totalIncome, totalSpend], 
                        backgroundColor: ['rgba(74, 144, 226, 0.8)', 'rgba(231, 76, 60, 0.8)'], 
                        borderColor: ['rgba(74, 144, 226, 1)', 'rgba(231, 76, 60, 1)'], 
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { callback: value => formatCurrency(value) } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { callbacks: { label: context => `${context.label}: ${formatCurrency(context.parsed.y)}` } } 
                    } 
                } 
            });
        }
        
        function renderInvestmentPortfolioChart() { 
            const investmentPortfolioChartCanvas = document.getElementById('investmentPortfolioChart')?.getContext('2d');
            const noInvestmentPortfolioDataEl = document.getElementById('noInvestmentPortfolioData');
            
            if (!isAuthenticated || !investmentPortfolioChartCanvas) return; 
            
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            const portfolioData = {}; 
            
            activeInvestments.forEach(inv => { 
                const typeName = investmentTypeNames[inv.type] || 'Other'; 
                const value = inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount; 
                portfolioData[typeName] = (portfolioData[typeName] || 0) + value; 
            });
            
            const labels = Object.keys(portfolioData); 
            const data = Object.values(portfolioData); 
            const backgroundColors = labels.map((_, index) => `hsl(${(index * 60 + 30) % 360}, 65%, 60%)`);
            
            if (noInvestmentPortfolioDataEl) noInvestmentPortfolioDataEl.style.display = (labels.length === 0) ? 'block' : 'none'; 
            if (investmentPortfolioChartCanvas.canvas.parentElement) investmentPortfolioChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none'; 
            
            if (labels.length === 0) { 
                if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy(); 
                investmentPortfolioChartInstance = null; 
                return; 
            } 
            
            if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy();
            investmentPortfolioChartInstance = new Chart(investmentPortfolioChartCanvas, { 
                type: 'pie', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Investment Value', 
                        data: data, 
                        backgroundColor: backgroundColors, 
                        borderColor: '#fff', 
                        borderWidth: 2, 
                        hoverOffset: 8 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: { animateScale: true, animateRotate: true }, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { font: { size: 10 }, boxWidth:15, padding:10 } 
                        }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` 
                            }
                        } 
                    } 
                } 
            });
        }

        function renderMonthlySpendChart() {
			const monthlySpendChartCanvas = document.getElementById('monthlySpendChartCanvas')?.getContext('2d');
			const noMonthlySpendDataEl = document.getElementById('noMonthlySpendData');

			if (!isAuthenticated || !monthlySpendChartCanvas) return;
			
			const filteredTransactions = filterTransactionsForCharts(); 
			const monthlyData = {};

			filteredTransactions.forEach(t => {
				let spendAmount = 0;
				
				if (t.type === 'spend' && !investmentRelatedCategories.includes(t.category)) {
					spendAmount = t.amount;
				} else if (t.type === 'loan') {
					spendAmount = t.amount; 
				}

				if (spendAmount > 0) {
					const date = new Date(t.date);
					const timeKey = date.getFullYear() * 100 + (date.getMonth() + 1); 
					const monthLabel = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });

					if (!monthlyData[timeKey]) {
						monthlyData[timeKey] = {
							totalSpend: 0,
							monthLabel: monthLabel
						};
					}
					monthlyData[timeKey].totalSpend += spendAmount;
				}
			});

			const sortedTimeKeys = Object.keys(monthlyData).sort((a, b) => a - b);
			const labels = sortedTimeKeys.map(timeKey => monthlyData[timeKey].monthLabel);
			const data = sortedTimeKeys.map(timeKey => monthlyData[timeKey].totalSpend);

			if (noMonthlySpendDataEl) noMonthlySpendDataEl.style.display = (labels.length === 0) ? 'block' : 'none';
			
			if (monthlySpendChartCanvas?.canvas.parentElement) {
				monthlySpendChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none';
			}

			if (labels.length === 0) {
				if (monthlySpendChartInstance) monthlySpendChartInstance.destroy();
				monthlySpendChartInstance = null;
				return;
			}

			if (monthlySpendChartInstance) monthlySpendChartInstance.destroy();
			
			// --- Modern Bar Chart Configuration Starts Here ---
			monthlySpendChartInstance = new Chart(monthlySpendChartCanvas, {
				type: 'bar', // CHANGED: Set chart type to 'bar'
				data: {
					labels: labels,
					datasets: [{
						label: 'Total Spend (₹)',
						data: data,
						
						// MODERN STYLING: Blue with opacity for bars
						backgroundColor: 'rgba(52, 152, 219, 0.8)', 
						borderColor: 'rgba(52, 152, 219, 1)', 
						borderWidth: 1,
						
						// MODERN FEATURE: Rounded corners for bars
						borderRadius: 5, 
						hoverBackgroundColor: 'rgba(41, 128, 185, 1)' // Darker shade on hover
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: {
							beginAtZero: true,
							title: { display: true, text: 'Amount (₹)' },
							ticks: { callback: value => formatCurrency(value) },
							// CLEANER LOOK: Remove horizontal grid lines
							grid: { drawOnChartArea: false } 
						},
						x: {
							title: { display: true, text: 'Month' },
							// CLEANER LOOK: Remove vertical grid lines
							grid: { drawOnChartArea: false } 
						},
					},
					plugins: {
						legend: { display: false },
						tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}` } }
					}
				}
			});
			// --- Modern Bar Chart Configuration Ends Here ---
		}
        
        function renderHomePageSummaries() { 
            const recentTransactionsListHomeEl = document.getElementById('recentTransactionsListHome');
            const investmentSummaryHomeEl = document.getElementById('investmentSummaryHome');

            if (!isAuthenticated || !recentTransactionsListHomeEl || !investmentSummaryHomeEl) return; 
            
            // Render Recent Transactions
            recentTransactionsListHomeEl.innerHTML = '';
            const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
            
            if(recent.length === 0) { 
                recentTransactionsListHomeEl.innerHTML = '<li class="list-group-item text-center text-muted">No recent transactions.</li>';
            } else { 
                recent.forEach(t => { 
                    let sign = ''; 
                    let amountStr = formatCurrency(t.amount); 
                    let colorClass = ''; 
                    let primaryInfo = t.description || 'N/A'; 
                    
                    if (t.type === 'income') { 
                        sign = '+'; 
                        colorClass = 'text-success'; 
                    } else if (t.type === 'spend') { 
                        sign = '-'; 
                        colorClass = 'text-danger'; 
                    } else if (t.type === 'transfer') { 
                        colorClass = 'text-info'; 
                        primaryInfo = `Transfer: ${getAccountNameById(t.fromAccount)} -> ${getAccountNameById(t.toAccount)}`; 
                        sign = '';
                    } else if (t.type === 'loan') { 
                        colorClass = 'text-warning'; 
                        primaryInfo = `Loan: ${t.description || 'N/A'} (${t.loanStatus})`; 
                        if (t.loanStatus === 'outstanding') { 
                            sign = '-'; 
                        } else if (t.loanStatus === 'returned' && t.returnDetails) { 
                            primaryInfo = `Loan Ret: ${t.description || 'N/A'}`; 
                            amountStr = `Lent: ${formatCurrency(t.amount)}, Ret: ${formatCurrency(t.returnDetails.returnAmount)}`; 
                            colorClass = 'text-success'; 
                            sign = '+';
                        } 
                    } 
                    
                    if(t.category && (t.type === 'income' || t.type === 'spend')) {
                             primaryInfo = t.category;
                             if(t.description) primaryInfo += ` (${t.description.substring(0,15)}...)`;
                    }
                    
                    const item = document.createElement('li'); 
                    item.classList.add('list-group-item'); 
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div style="font-size:0.85rem;">
                                <span style="font-weight:500;">${primaryInfo}</span>
                                <small class="d-block text-muted">${displayDate(t.date)}</small>
                            </div>
                            <small class="${colorClass}" style="font-weight:bold;">${t.type === 'loan' && t.loanStatus === 'returned' ? amountStr : `${sign}${amountStr}`}</small>
                        </div>
                    `; 
                    recentTransactionsListHomeEl.appendChild(item); 
                });
            }
            
            // Render Investment Summary
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            if (activeInvestments.length === 0) { 
                investmentSummaryHomeEl.innerHTML = '<p class="text-center text-muted">No active investments yet.</p>';
            } else { 
                const totalInitialCostActive = activeInvestments.reduce((sum, inv) => sum + inv.amount, 0);
                const totalCurrentValueActive = activeInvestments.reduce((sum, inv) => sum + (inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount), 0);
                const netChange = totalCurrentValueActive - totalInitialCostActive;
                
                investmentSummaryHomeEl.innerHTML = `
                    <p class="text-center mb-1"><strong>Active Investments:</strong> ${activeInvestments.length}</p>
                    <p class="text-center mb-1"><strong>Total Cost:</strong> ${formatCurrency(totalInitialCostActive)}</p>
                    <p class="text-center mb-1"><strong>Current Value:</strong> ${formatCurrency(totalCurrentValueActive)}</p>
                    <p class="text-center mb-0 ${netChange >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>Net Change:</strong> ${formatCurrency(netChange)}
                    </p>
                `;
            } 
        }

        function renderCategoryManagementUI() {
            if (!isAuthenticated || !D.spendCategoriesListContainerEl || !D.incomeCategoriesListContainerEl) return;

            D.spendCategoriesListContainerEl.innerHTML = '';
            if (spendCategories.length === 0) {
                D.spendCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No spend categories defined. Add one above.</p>';
            } else {
                spendCategories.sort().forEach(cat => {
                    const chip = document.createElement('span');
                    chip.className = 'mgmt-category-chip';
                    chip.innerHTML = `
                        ${cat}
                        <button class="remove-chip-btn remove-category-btn" data-type="spend" data-category="${cat}" title="Remove ${cat}">&times;</button>
                    `;
                    D.spendCategoriesListContainerEl.appendChild(chip);
                });
            }

            D.incomeCategoriesListContainerEl.innerHTML = '';
            if (incomeCategories.length === 0) {
                D.incomeCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No income categories defined. Add one above.</p>';
            } else {
                incomeCategories.sort().forEach(cat => {
                    const chip = document.createElement('span');
                    chip.className = 'mgmt-category-chip';
                    chip.innerHTML = `
                        ${cat}
                        <button class="remove-chip-btn remove-category-btn" data-type="income" data-category="${cat}" title="Remove ${cat}">&times;</button>
                    `;
                    D.incomeCategoriesListContainerEl.appendChild(chip);
                });
            }
        }

        function renderAccountManagementList() {
            if (!isAuthenticated || !D.accountsListContainerEl) return;
            D.accountsListContainerEl.innerHTML = ''; 

            if (accounts.length === 0) {
                if (D.noAccountsMessageSettingsEl) D.noAccountsMessageSettingsEl.style.display = 'block';
                return;
            }
            if (D.noAccountsMessageSettingsEl) D.noAccountsMessageSettingsEl.style.display = 'none';

            const ul = document.createElement('ul');
            ul.className = 'list-group';

            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.className = 'list-group-item account-list-item';

                let statusBadge = '';
                let toggleStatusBtnHtml = '';
                let toggleSecretBtnHtml = '';

                if (acc.status === 'inactive') {
                    statusBadge = '<span class="badge badge-secondary">Inactive</span>';
                    toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-success toggle-account-status-btn" data-id="${acc.id}" title="Activate">
                        <i class="fas fa-toggle-on"></i> Activate
                    </button>`;
                } else if (acc.status === 'secret') {
                    statusBadge = '<span class="badge badge-warning">Secret</span>';
                    toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-danger toggle-account-status-btn" data-id="${acc.id}" title="Deactivate">
                        <i class="fas fa-toggle-off"></i> Deactivate
                    </button>`;
                } else { // active
                     statusBadge = '<span class="badge badge-primary">Active</span>';
                     toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-danger toggle-account-status-btn" data-id="${acc.id}" title="Deactivate">
                        <i class="fas fa-toggle-off"></i> Deactivate
                    </button>`;
                }

                if (acc.status === 'secret') {
                    toggleSecretBtnHtml = `<button class="btn btn-sm btn-outline-info toggle-account-secret-btn" data-id="${acc.id}" title="Make Public">
                        <i class="fas fa-eye"></i> Public
                    </button>`;
                } else if (acc.status !== 'inactive') {
                    toggleSecretBtnHtml = `<button class="btn btn-sm btn-outline-warning toggle-account-secret-btn" data-id="${acc.id}" title="Make Secret">
                        <i class="fas fa-user-secret"></i> Secret
                    </button>`;
                }

                li.innerHTML = `
                     <div class="account-name-status">
                        ${acc.name} (ID: ${acc.id}) ${statusBadge}
                    </div>
                    <div class="account-actions">
                        ${toggleStatusBtnHtml}
                        ${toggleSecretBtnHtml}
                    </div>
                 `;
                ul.appendChild(li);
            });
            D.accountsListContainerEl.appendChild(ul);
        }
        
        // --- Chart Filtering Helpers ---
        
        function renderChartFilters() {
            if (!isAuthenticated || !D.chartFilterButtonsContainer) return;

            document.querySelectorAll('.chart-filter-btn').forEach(btn => {
                const isActive = btn.dataset.range === chartDateRange;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('btn-primary', isActive);
                btn.classList.toggle('btn-outline-primary', !isActive && btn.dataset.range !== 'custom');
                btn.classList.toggle('btn-outline-secondary', btn.dataset.range === 'custom' && !isActive);
            });

            if (chartDateRange === 'custom') {
                D.customDateRangeInputsEl.style.display = 'flex';
                D.chartStartDateEl.value = chartStartDate ? formatDate(chartStartDate) : '';
                D.chartEndDateEl.value = chartEndDate ? formatDate(chartEndDate) : '';
            } else {
                D.customDateRangeInputsEl.style.display = 'none';
            }
        }
        
        // --- Chart Rendering ---
        
        function renderSpendCategoryChart() { 
            const spendCategoryChartCanvas = document.getElementById('spendCategoryChart')?.getContext('2d');
            const noSpendDataForCategoryChartEl = document.getElementById('noSpendDataForCategoryChart');

            if (!isAuthenticated || !spendCategoryChartCanvas) return;
            const filteredTransactions = filterTransactionsForCharts(); 
            const categorySpends = {}; 
            
            filteredTransactions.filter(t => t.type === 'spend' && t.category && !investmentRelatedCategories.includes(t.category)).forEach(t => { 
                categorySpends[t.category] = (categorySpends[t.category] || 0) + t.amount; 
            });
            
            const labels = Object.keys(categorySpends); 
            const data = Object.values(categorySpends); 
            const backgroundColors = labels.map((_, index) => `hsl(${(index * 45 + 10) % 360}, 70%, 65%)`);
            
            if (noSpendDataForCategoryChartEl) noSpendDataForCategoryChartEl.style.display = (labels.length === 0) ? 'block' : 'none'; 
            if (spendCategoryChartCanvas.canvas.parentElement) spendCategoryChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none'; 
            
            if (labels.length === 0) { 
                if(spendCategoryChartInstance) spendCategoryChartInstance.destroy(); 
                spendCategoryChartInstance = null; 
                return; 
            } 
            
            if (spendCategoryChartInstance) spendCategoryChartInstance.destroy();
            spendCategoryChartInstance = new Chart(spendCategoryChartCanvas, { 
                type: 'doughnut', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Spend by Category', 
                        data: data, 
                        backgroundColor: backgroundColors, 
                        borderColor: '#fff', 
                        borderWidth: 2, 
                        hoverOffset: 8 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: { animateScale: true, animateRotate: true }, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { font: { size: 10 }, boxWidth:15, padding:10 } 
                        }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` 
                            }
                        } 
                    } 
                } 
            });
        }
        
        function renderIncomeSpendChart() { 
            const incomeSpendChartCanvas = document.getElementById('incomeSpendChart')?.getContext('2d');
            const noIncomeSpendDataEl = document.getElementById('noIncomeSpendData');
            
            if (!isAuthenticated || !incomeSpendChartCanvas) return; 
            
            const filteredTransactions = filterTransactionsForCharts(); 
            let totalIncome = 0; 
            let totalSpend = 0;
            
            filteredTransactions.forEach(t => { 
                if (t.type === 'income') totalIncome += t.amount; 
                else if (t.type === 'spend') totalSpend += t.amount; 
                else if (t.type === 'loan') { 
                    totalSpend += t.amount; // Loan outflow
                    if (t.loanStatus === 'returned' && t.returnDetails) { 
                        totalIncome += t.returnDetails.returnAmount; // Loan return inflow
                    } 
                } 
            });
            
            if (noIncomeSpendDataEl) noIncomeSpendDataEl.style.display = (totalIncome === 0 && totalSpend === 0) ? 'block' : 'none';
            if (incomeSpendChartCanvas.canvas.parentElement) incomeSpendChartCanvas.canvas.parentElement.style.display = (totalIncome > 0 || totalSpend > 0) ? 'block' : 'none';
            
            if (totalIncome === 0 && totalSpend === 0) { 
                if (incomeSpendChartInstance) incomeSpendChartInstance.destroy(); 
                incomeSpendChartInstance = null; 
                return; 
            } 
            
            if (incomeSpendChartInstance) incomeSpendChartInstance.destroy();
            incomeSpendChartInstance = new Chart(incomeSpendChartCanvas, { 
                type: 'bar', 
                data: { 
                    labels: ['Total Income', 'Total Spend'], 
                    datasets: [{ 
                        label: 'Amount (₹)', 
                        data: [totalIncome, totalSpend], 
                        backgroundColor: ['rgba(74, 144, 226, 0.8)', 'rgba(231, 76, 60, 0.8)'], 
                        borderColor: ['rgba(74, 144, 226, 1)', 'rgba(231, 76, 60, 1)'], 
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { callback: value => formatCurrency(value) } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { callbacks: { label: context => `${context.label}: ${formatCurrency(context.parsed.y)}` } } 
                    } 
                } 
            });
        }
        
        function renderInvestmentPortfolioChart() { 
            const investmentPortfolioChartCanvas = document.getElementById('investmentPortfolioChart')?.getContext('2d');
            const noInvestmentPortfolioDataEl = document.getElementById('noInvestmentPortfolioData');
            
            if (!isAuthenticated || !investmentPortfolioChartCanvas) return; 
            
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            const portfolioData = {}; 
            
            activeInvestments.forEach(inv => { 
                const typeName = investmentTypeNames[inv.type] || 'Other'; 
                const value = inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount; 
                portfolioData[typeName] = (portfolioData[typeName] || 0) + value; 
            });
            
            const labels = Object.keys(portfolioData); 
            const data = Object.values(portfolioData); 
            const backgroundColors = labels.map((_, index) => `hsl(${(index * 60 + 30) % 360}, 65%, 60%)`);
            
            if (noInvestmentPortfolioDataEl) noInvestmentPortfolioDataEl.style.display = (labels.length === 0) ? 'block' : 'none'; 
            if (investmentPortfolioChartCanvas.canvas.parentElement) investmentPortfolioChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none'; 
            
            if (labels.length === 0) { 
                if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy(); 
                investmentPortfolioChartInstance = null; 
                return; 
            } 
            
            if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy();
            investmentPortfolioChartInstance = new Chart(investmentPortfolioChartCanvas, { 
                type: 'pie', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Investment Value', 
                        data: data, 
                        backgroundColor: backgroundColors, 
                        borderColor: '#fff', 
                        borderWidth: 2, 
                        hoverOffset: 8 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: { animateScale: true, animateRotate: true }, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { font: { size: 10 }, boxWidth:15, padding:10 } 
                        }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` 
                            }
                        } 
                    } 
                } 
            });
        }

        
        
        function renderHomePageSummaries() { 
            const recentTransactionsListHomeEl = document.getElementById('recentTransactionsListHome');
            const investmentSummaryHomeEl = document.getElementById('investmentSummaryHome');

            if (!isAuthenticated || !recentTransactionsListHomeEl || !investmentSummaryHomeEl) return; 
            
            // Render Recent Transactions
            recentTransactionsListHomeEl.innerHTML = '';
            const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
            
            if(recent.length === 0) { 
                recentTransactionsListHomeEl.innerHTML = '<li class="list-group-item text-center text-muted">No recent transactions.</li>';
            } else { 
                recent.forEach(t => { 
                    let sign = ''; 
                    let amountStr = formatCurrency(t.amount); 
                    let colorClass = ''; 
                    let primaryInfo = t.description || 'N/A'; 
                    
                    if (t.type === 'income') { 
                        sign = '+'; 
                        colorClass = 'text-success'; 
                    } else if (t.type === 'spend') { 
                        sign = '-'; 
                        colorClass = 'text-danger'; 
                    } else if (t.type === 'transfer') { 
                        colorClass = 'text-info'; 
                        primaryInfo = `Transfer: ${getAccountNameById(t.fromAccount)} -> ${getAccountNameById(t.toAccount)}`; 
                        sign = '';
                    } else if (t.type === 'loan') { 
                        colorClass = 'text-warning'; 
                        primaryInfo = `Loan: ${t.description || 'N/A'} (${t.loanStatus})`; 
                        if (t.loanStatus === 'outstanding') { 
                            sign = '-'; 
                        } else if (t.loanStatus === 'returned' && t.returnDetails) { 
                            primaryInfo = `Loan Ret: ${t.description || 'N/A'}`; 
                            amountStr = `Lent: ${formatCurrency(t.amount)}, Ret: ${formatCurrency(t.returnDetails.returnAmount)}`; 
                            colorClass = 'text-success'; 
                            sign = '+';
                        } 
                    } 
                    
                    if(t.category && (t.type === 'income' || t.type === 'spend')) {
                             primaryInfo = t.category;
                             if(t.description) primaryInfo += ` (${t.description.substring(0,15)}...)`;
                    }
                    
                    const item = document.createElement('li'); 
                    item.classList.add('list-group-item'); 
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div style="font-size:0.85rem;">
                                <span style="font-weight:500;">${primaryInfo}</span>
                                <small class="d-block text-muted">${displayDate(t.date)}</small>
                            </div>
                            <small class="${colorClass}" style="font-weight:bold;">${t.type === 'loan' && t.loanStatus === 'returned' ? amountStr : `${sign}${amountStr}`}</small>
                        </div>
                    `; 
                    recentTransactionsListHomeEl.appendChild(item); 
                });
            }
            
            // Render Investment Summary
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            if (activeInvestments.length === 0) { 
                investmentSummaryHomeEl.innerHTML = '<p class="text-center text-muted">No active investments yet.</p>';
            } else { 
                const totalInitialCostActive = activeInvestments.reduce((sum, inv) => sum + inv.amount, 0);
                const totalCurrentValueActive = activeInvestments.reduce((sum, inv) => sum + (inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount), 0);
                const netChange = totalCurrentValueActive - totalInitialCostActive;
                
                investmentSummaryHomeEl.innerHTML = `
                    <p class="text-center mb-1"><strong>Active Investments:</strong> ${activeInvestments.length}</p>
                    <p class="text-center mb-1"><strong>Total Cost:</strong> ${formatCurrency(totalInitialCostActive)}</p>
                    <p class="text-center mb-1"><strong>Current Value:</strong> ${formatCurrency(totalCurrentValueActive)}</p>
                    <p class="text-center mb-0 ${netChange >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>Net Change:</strong> ${formatCurrency(netChange)}
                    </p>
                `;
            } 
        }

        function renderCategoryManagementUI() {
            if (!isAuthenticated || !D.spendCategoriesListContainerEl || !D.incomeCategoriesListContainerEl) return;

            D.spendCategoriesListContainerEl.innerHTML = '';
            if (spendCategories.length === 0) {
                D.spendCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No spend categories defined. Add one above.</p>';
            } else {
                spendCategories.sort().forEach(cat => {
                    const chip = document.createElement('span');
                    chip.className = 'mgmt-category-chip';
                    chip.innerHTML = `
                        ${cat}
                        <button class="remove-chip-btn remove-category-btn" data-type="spend" data-category="${cat}" title="Remove ${cat}">&times;</button>
                    `;
                    D.spendCategoriesListContainerEl.appendChild(chip);
                });
            }

            D.incomeCategoriesListContainerEl.innerHTML = '';
            if (incomeCategories.length === 0) {
                D.incomeCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No income categories defined. Add one above.</p>';
            } else {
                incomeCategories.sort().forEach(cat => {
                    const chip = document.createElement('span');
                    chip.className = 'mgmt-category-chip';
                    chip.innerHTML = `
                        ${cat}
                        <button class="remove-chip-btn remove-category-btn" data-type="income" data-category="${cat}" title="Remove ${cat}">&times;</button>
                    `;
                    D.incomeCategoriesListContainerEl.appendChild(chip);
                });
            }
        }

        function renderAccountManagementList() {
            if (!isAuthenticated || !D.accountsListContainerEl) return;
            D.accountsListContainerEl.innerHTML = ''; 

            if (accounts.length === 0) {
                if (D.noAccountsMessageSettingsEl) D.noAccountsMessageSettingsEl.style.display = 'block';
                return;
            }
            if (D.noAccountsMessageSettingsEl) D.noAccountsMessageSettingsEl.style.display = 'none';

            const ul = document.createElement('ul');
            ul.className = 'list-group';

            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.className = 'list-group-item account-list-item';

                let statusBadge = '';
                let toggleStatusBtnHtml = '';
                let toggleSecretBtnHtml = '';

                if (acc.status === 'inactive') {
                    statusBadge = '<span class="badge badge-secondary">Inactive</span>';
                    toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-success toggle-account-status-btn" data-id="${acc.id}" title="Activate">
                        <i class="fas fa-toggle-on"></i> Activate
                    </button>`;
                } else if (acc.status === 'secret') {
                    statusBadge = '<span class="badge badge-warning">Secret</span>';
                    toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-danger toggle-account-status-btn" data-id="${acc.id}" title="Deactivate">
                        <i class="fas fa-toggle-off"></i> Deactivate
                    </button>`;
                } else { // active
                     statusBadge = '<span class="badge badge-primary">Active</span>';
                     toggleStatusBtnHtml = `<button class="btn btn-sm btn-outline-danger toggle-account-status-btn" data-id="${acc.id}" title="Deactivate">
                        <i class="fas fa-toggle-off"></i> Deactivate
                    </button>`;
                }

                if (acc.status === 'secret') {
                    toggleSecretBtnHtml = `<button class="btn btn-sm btn-outline-info toggle-account-secret-btn" data-id="${acc.id}" title="Make Public">
                        <i class="fas fa-eye"></i> Public
                    </button>`;
                } else if (acc.status !== 'inactive') {
                    toggleSecretBtnHtml = `<button class="btn btn-sm btn-outline-warning toggle-account-secret-btn" data-id="${acc.id}" title="Make Secret">
                        <i class="fas fa-user-secret"></i> Secret
                    </button>`;
                }

                li.innerHTML = `
                     <div class="account-name-status">
                        ${acc.name} (ID: ${acc.id}) ${statusBadge}
                    </div>
                    <div class="account-actions">
                        ${toggleStatusBtnHtml}
                        ${toggleSecretBtnHtml}
                    </div>
                 `;
                ul.appendChild(li);
            });
            D.accountsListContainerEl.appendChild(ul);
        }
        
        // --- Chart Filtering Helpers ---
        
        function renderChartFilters() {
            if (!isAuthenticated || !D.chartFilterButtonsContainer) return;

            document.querySelectorAll('.chart-filter-btn').forEach(btn => {
                const isActive = btn.dataset.range === chartDateRange;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('btn-primary', isActive);
                btn.classList.toggle('btn-outline-primary', !isActive && btn.dataset.range !== 'custom');
                btn.classList.toggle('btn-outline-secondary', btn.dataset.range === 'custom' && !isActive);
            });

            if (chartDateRange === 'custom') {
                D.customDateRangeInputsEl.style.display = 'flex';
                D.chartStartDateEl.value = chartStartDate ? formatDate(chartStartDate) : '';
                D.chartEndDateEl.value = chartEndDate ? formatDate(chartEndDate) : '';
            } else {
                D.customDateRangeInputsEl.style.display = 'none';
            }
        }
        
        // --- Chart Rendering ---
        
        function renderSpendCategoryChart() { 
            const spendCategoryChartCanvas = document.getElementById('spendCategoryChart')?.getContext('2d');
            const noSpendDataForCategoryChartEl = document.getElementById('noSpendDataForCategoryChart');

            if (!isAuthenticated || !spendCategoryChartCanvas) return;
            const filteredTransactions = filterTransactionsForCharts(); 
            const categorySpends = {}; 
            
            filteredTransactions.filter(t => t.type === 'spend' && t.category && !investmentRelatedCategories.includes(t.category)).forEach(t => { 
                categorySpends[t.category] = (categorySpends[t.category] || 0) + t.amount; 
            });
            
            const labels = Object.keys(categorySpends); 
            const data = Object.values(categorySpends); 
            const backgroundColors = labels.map((_, index) => `hsl(${(index * 45 + 10) % 360}, 70%, 65%)`);
            
            if (noSpendDataForCategoryChartEl) noSpendDataForCategoryChartEl.style.display = (labels.length === 0) ? 'block' : 'none'; 
            if (spendCategoryChartCanvas.canvas.parentElement) spendCategoryChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none'; 
            
            if (labels.length === 0) { 
                if(spendCategoryChartInstance) spendCategoryChartInstance.destroy(); 
                spendCategoryChartInstance = null; 
                return; 
            } 
            
            if (spendCategoryChartInstance) spendCategoryChartInstance.destroy();
            spendCategoryChartInstance = new Chart(spendCategoryChartCanvas, { 
                type: 'doughnut', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Spend by Category', 
                        data: data, 
                        backgroundColor: backgroundColors, 
                        borderColor: '#fff', 
                        borderWidth: 2, 
                        hoverOffset: 8 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: { animateScale: true, animateRotate: true }, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { font: { size: 10 }, boxWidth:15, padding:10 } 
                        }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` 
                            }
                        } 
                    } 
                } 
            });
        }
        
        function renderIncomeSpendChart() { 
            const incomeSpendChartCanvas = document.getElementById('incomeSpendChart')?.getContext('2d');
            const noIncomeSpendDataEl = document.getElementById('noIncomeSpendData');
            
            if (!isAuthenticated || !incomeSpendChartCanvas) return; 
            
            const filteredTransactions = filterTransactionsForCharts(); 
            let totalIncome = 0; 
            let totalSpend = 0;
            
            filteredTransactions.forEach(t => { 
                if (t.type === 'income') totalIncome += t.amount; 
                else if (t.type === 'spend') totalSpend += t.amount; 
                else if (t.type === 'loan') { 
                    totalSpend += t.amount; // Loan outflow
                    if (t.loanStatus === 'returned' && t.returnDetails) { 
                        totalIncome += t.returnDetails.returnAmount; // Loan return inflow
                    } 
                } 
            });
            
            if (noIncomeSpendDataEl) noIncomeSpendDataEl.style.display = (totalIncome === 0 && totalSpend === 0) ? 'block' : 'none';
            if (incomeSpendChartCanvas.canvas.parentElement) incomeSpendChartCanvas.canvas.parentElement.style.display = (totalIncome > 0 || totalSpend > 0) ? 'block' : 'none';
            
            if (totalIncome === 0 && totalSpend === 0) { 
                if (incomeSpendChartInstance) incomeSpendChartInstance.destroy(); 
                incomeSpendChartInstance = null; 
                return; 
            } 
            
            if (incomeSpendChartInstance) incomeSpendChartInstance.destroy();
            incomeSpendChartInstance = new Chart(incomeSpendChartCanvas, { 
                type: 'bar', 
                data: { 
                    labels: ['Total Income', 'Total Spend'], 
                    datasets: [{ 
                        label: 'Amount (₹)', 
                        data: [totalIncome, totalSpend], 
                        backgroundColor: ['rgba(74, 144, 226, 0.8)', 'rgba(231, 76, 60, 0.8)'], 
                        borderColor: ['rgba(74, 144, 226, 1)', 'rgba(231, 76, 60, 1)'], 
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { callback: value => formatCurrency(value) } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { callbacks: { label: context => `${context.label}: ${formatCurrency(context.parsed.y)}` } } 
                    } 
                } 
            });
        }
        
        function renderInvestmentPortfolioChart() { 
            const investmentPortfolioChartCanvas = document.getElementById('investmentPortfolioChart')?.getContext('2d');
            const noInvestmentPortfolioDataEl = document.getElementById('noInvestmentPortfolioData');
            
            if (!isAuthenticated || !investmentPortfolioChartCanvas) return; 
            
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            const portfolioData = {}; 
            
            activeInvestments.forEach(inv => { 
                const typeName = investmentTypeNames[inv.type] || 'Other'; 
                const value = inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount; 
                portfolioData[typeName] = (portfolioData[typeName] || 0) + value; 
            });
            
            const labels = Object.keys(portfolioData); 
            const data = Object.values(portfolioData); 
            const backgroundColors = labels.map((_, index) => `hsl(${(index * 60 + 30) % 360}, 65%, 60%)`);
            
            if (noInvestmentPortfolioDataEl) noInvestmentPortfolioDataEl.style.display = (labels.length === 0) ? 'block' : 'none'; 
            if (investmentPortfolioChartCanvas.canvas.parentElement) investmentPortfolioChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none'; 
            
            if (labels.length === 0) { 
                if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy(); 
                investmentPortfolioChartInstance = null; 
                return; 
            } 
            
            if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy();
            investmentPortfolioChartInstance = new Chart(investmentPortfolioChartCanvas, { 
                type: 'pie', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Investment Value', 
                        data: data, 
                        backgroundColor: backgroundColors, 
                        borderColor: '#fff', 
                        borderWidth: 2, 
                        hoverOffset: 8 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: { animateScale: true, animateRotate: true }, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { font: { size: 10 }, boxWidth:15, padding:10 } 
                        }, 
                        tooltip: { 
                            callbacks: { 
                                label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` 
                            }
                        } 
                    } 
                } 
            });
        }

        
        
        function renderInvestmentList() { 
            if (!isAuthenticated || !D.investmentListEl) return; 
            D.investmentListEl.innerHTML = '';
            
            const sortedInvestments = [...investments].sort((a, b) => (a.status === 'active' && b.status !== 'active') ? -1 : (a.status !== 'active' && b.status === 'active') ? 1 : new Date(b.date) - new Date(a.date));
            
            if (sortedInvestments.length === 0) { 
                if (D.noInvestmentsMessageEl) { 
                    D.noInvestmentsMessageEl.style.display = 'block'; 
                    D.investmentListEl.appendChild(D.noInvestmentsMessageEl);
                }
            } else { 
                if (D.noInvestmentsMessageEl) D.noInvestmentsMessageEl.style.display = 'none';
                
                sortedInvestments.forEach(inv => { 
                    const item = document.createElement('li'); 
                    item.classList.add('list-group-item', 'investment-item'); 
                    if (inv.status === 'redeemed') item.classList.add('redeemed-investment'); 
                    
                    let valueDisplay = `<span class="amount text-muted">${formatCurrency(inv.amount)}</span> <small>(Invested)</small>`; 
                    let profitLossDisplay = '';
                    let actionButtonsHtml = '';

                    if (inv.status === 'active') { 
                        if (inv.currentValue !== null && inv.currentValue !== undefined) { 
                            valueDisplay += `<br><span class="amount ${inv.currentValue >= inv.amount ? 'text-success' : 'text-danger'}">${formatCurrency(inv.currentValue)}</span> <small class="current-value-label">(Current)</small>`; 
                        }
                        actionButtonsHtml = `
                            <div class="investment-item-actions">
                                <button class="btn btn-info btn-sm update-value-btn" data-id="${inv.id}" title="Update Value"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-success btn-sm redeem-btn" data-id="${inv.id}" title="Redeem"><i class="fas fa-hand-holding-usd"></i></button>
                            </div>`; 
                    } else if (inv.status === 'redeemed') { 
                        valueDisplay = `<span class="amount text-muted">${formatCurrency(inv.amount)}</span> <small>(Invested)</small><br><span class="amount">${formatCurrency(inv.redeemedAmount || 0)}</span> <small>(Redeemed)</small>`; 
                        if (inv.profitOrLoss !== null && inv.profitOrLoss !== undefined) {
                            profitLossDisplay = `<div class="investment-details ${inv.profitOrLoss >= 0 ? 'profit' : 'loss'}">P/L: ${formatCurrency(inv.profitOrLoss)}</div>`;
                        }
                    }
                    
                    item.innerHTML = `
                        <div class="list-item-content">
                            <div class="main-info">
                                ${inv.description} 
                                <span class="status-badge status-${inv.status}">${inv.status.charAt(0).toUpperCase() + inv.status.slice(1)}</span>
                            </div>
                            <div class="sub-info">Type: ${investmentTypeNames[inv.type] || 'N/A'} | Invested: ${displayDate(inv.date)}</div>
                            ${inv.status === 'active' && inv.maturityInfo ? `<div class="investment-details">Maturity: ${inv.maturityInfo}</div>` : ''}
                            ${inv.status === 'redeemed' && inv.redemptionDate ? `<div class="investment-details">Redeemed: ${displayDate(inv.redemptionDate)}</div>` : ''}
                            ${profitLossDisplay}
                            <div class="investment-details">From: ${getAccountNameById(inv.sourceAccount)}</div>
                        </div>
                        <div class="list-item-amount text-right">${valueDisplay}</div>
                        ${actionButtonsHtml}
                        <button class="delete-btn btn btn-danger btn-sm" data-id="${inv.id}" data-type="investment" title="Delete" style="position: absolute; bottom: 5px; right: 5px;"><i class="fas fa-trash-alt"></i></button>
                    `; 
                    D.investmentListEl.appendChild(item); 
                }); 
            } 
        }

        // --- Settings Delegation (Account & Category Management) ---
        function handleSettingsDelegation(e) {
            const target = e.target.closest('button, .remove-category-btn');
            if (!target || !target.closest('#settingsView')) return;

            // Handle Account Toggles
            if (target.classList.contains('toggle-account-status-btn') || target.classList.contains('toggle-account-secret-btn')) {
                const accountId = target.dataset.id;
                const account = accounts.find(acc => acc.id === accountId);
                if (!account) return;

                if (target.classList.contains('toggle-account-status-btn')) {
                    if (account.status === 'active' || account.status === 'secret') {
                        account.status = 'inactive';
                    } else if (account.status === 'inactive') {
                        account.status = 'active'; 
                    }
                } else if (target.classList.contains('toggle-account-secret-btn')) {
                    if (account.status === 'secret') {
                        account.status = 'active'; 
                    } else if (account.status === 'active') {
                        account.status = 'secret'; 
                    }
                }
                
                saveState();
                renderAccountManagementList();
                populateAllAccountDropdowns();
                renderAccountBalances();
                if(document.getElementById('transactionsView').classList.contains('active')) renderFullTransactionList(); 
                return;
            }
            
            // Handle Category Removal
            if (target.classList.contains('remove-category-btn')) {
                const type = target.dataset.type;
                const categoryToRemove = target.dataset.category;
                
                if (confirm(`Are you sure you want to remove the ${type} category "${categoryToRemove}"?`)) {
                    if (type === 'spend') {
                        spendCategories = spendCategories.filter(cat => cat !== categoryToRemove);
                    } else if (type === 'income') {
                        incomeCategories = incomeCategories.filter(cat => cat !== categoryToRemove);
                    }
                    saveState();
                    renderCategoryManagementUI();
                    populateSpendCategoryChips(); 
                    populateIncomeCategoryChips(); 
                }
            }
        }

        // ====================================================================
        // 6. EVENT HANDLERS & LISTENERS SETUP
        // ====================================================================

        function setupEventListeners() {
            // --- PIN SECURITY LISTENERS ---
            D.loginForm?.addEventListener('submit', handlePinLogin);
            D.pinSetupForm?.addEventListener('submit', handlePinSetup);
            D.forgotPinButton?.addEventListener('click', showPinResetForm);
            D.backToLoginButton?.addEventListener('click', checkPinStatusAndRedirect);
            D.pinResetForm?.addEventListener('submit', handlePinReset);
            
            // --- CORE APP LISTENERS ---
            D.toggleBalanceVisibilityBtn?.addEventListener('click', () => { 
                balancesVisible = !balancesVisible; 
                localStorage.setItem(LS_KEYS.BALANCES_VISIBLE, JSON.stringify(balancesVisible));
                renderAccountBalances(); 
            });
            D.transactionType?.addEventListener('change', () => updateTransactionFormFields());
            D.transactionForm?.addEventListener('submit', handleTransactionSubmit);
            D.recordLoanReturnForm?.addEventListener('submit', handleRecordLoanReturn);
            D.openTransactionModalFab?.addEventListener('click', handleOpenTransactionModal);
            
            // --- Navigation Listeners ---
            D.navItems.forEach(item => { 
                item.addEventListener('click', () => { 
                    showView(item.dataset.view, item.dataset.title); 
                }); 
            });

            // --- Transaction Filter Listeners ---
            D.txSearchInput?.addEventListener('input', renderFullTransactionList);
            D.txAmountFilter?.addEventListener('input', renderFullTransactionList);
            D.txMonthFilter?.addEventListener('change', renderFullTransactionList);
            D.txYearFilter?.addEventListener('change', renderFullTransactionList);
            D.txTypeFilter?.addEventListener('change', renderFullTransactionList);
            D.txClearFiltersBtn?.addEventListener('click', handleClearFilters);

            // --- Centralized Action Delegation ---
            document.body.addEventListener('click', function(e) { 
                if (!isAuthenticated) return; 
                const editButton = e.target.closest('.edit-btn'); 
                const deleteButton = e.target.closest('.delete-btn'); 
                const recordReturnBtn = e.target.closest('.record-return-btn');
                const updateBtn = e.target.closest('.update-value-btn');
                const redeemBtn = e.target.closest('.redeem-btn');
                
                if (editButton && editButton.dataset.type !== 'investment') handleEditTransaction(editButton.dataset.id);
                if (deleteButton) handleDeleteAction(deleteButton.dataset.id, deleteButton.dataset.type); 
                
                if (recordReturnBtn) handleOpenRecordLoanReturnModal(recordReturnBtn.dataset.id);
                if (updateBtn) handleOpenUpdateInvestmentModal(updateBtn.dataset.id);
                if (redeemBtn) handleOpenRedeemInvestmentModal(redeemBtn.dataset.id);

                // Settings clicks handled via delegation for dynamic elements
                handleSettingsDelegation(e);
            });

            // Modals cleanup/reset
            $('.modal').on('hidden.bs.modal', function () { 
                if (document.activeElement) document.activeElement.blur(); 
            });
            
            // FIX: Show/Hide Secret Accounts toggle listener
            D.showSecretAccountsToggleSettingsEl?.addEventListener('change', (e) => {
                showSecretAccounts = e.target.checked;
                localStorage.setItem(LS_KEYS.SHOW_SECRET, JSON.stringify(showSecretAccounts)); 
                
                // RENDER UPDATES
                renderAccountManagementList(); // Rerender the list in settings
                populateAllAccountDropdowns(); // Update dropdowns (important for transfers/tx)
                renderAccountBalances(); // Update balances list on Dashboard/Home
                if(document.getElementById('transactionsView').classList.contains('active')) renderFullTransactionList(); 
            });

            D.toggleShowSecretAccountsHomeBtn?.addEventListener('click', () => {
                showSecretAccounts = !showSecretAccounts;
                localStorage.setItem(LS_KEYS.SHOW_SECRET, JSON.stringify(showSecretAccounts)); 
                
                // Keep the Settings toggle in sync
                if(D.showSecretAccountsToggleSettingsEl) D.showSecretAccountsToggleSettingsEl.checked = showSecretAccounts; 
                
                // RENDER UPDATES
                renderAccountManagementList(); 
                populateAllAccountDropdowns(); 
                renderAccountBalances(); 
                if(document.getElementById('transactionsView').classList.contains('active')) renderFullTransactionList(); 
            });
        }
        
        function handleOpenTransactionModal() {
             lastFocusedElementBeforeModal = document.activeElement; 
            D.editingTransactionId.value = ''; 
            D.transactionModalTitleEl.textContent = 'Add New Transaction'; 
            D.transactionSubmitBtnEl.textContent = 'Add Transaction'; 
            D.transactionSubmitBtnEl.classList.remove('btn-warning'); 
            D.transactionSubmitBtnEl.classList.add('btn-primary'); 
            D.transactionForm.reset(); 
            D.selectedCategoryInput.value = ''; 
            setDefaultDate(D.transactionDateEl);
            // Reset chips/defaults, preserving loan logic via updateTransactionFormFields
            updateTransactionFormFields('income'); 
            D.transactionModalJQ.modal('show'); 
        }

        function handleClearFilters() {
            if(D.txSearchInput) D.txSearchInput.value = ''; 
            if(D.txAmountFilter) D.txAmountFilter.value = ''; 
            if(D.txMonthFilter) D.txMonthFilter.value = ''; 
            if(D.txYearFilter) D.txYearFilter.value = ''; 
            if(D.txTypeFilter) D.txTypeFilter.value = ''; 
            renderFullTransactionList();
        }

        function handleOpenRecordLoanReturnModal(loanId) { 
            const loanToReturn = transactions.find(t => t.id === parseInt(loanId) && t.type === 'loan'); 
            if (loanToReturn && loanToReturn.loanStatus === 'outstanding') { 
                D.originalLoanIdToReturnEl.value = loanToReturn.id;
                D.loanReturnDescriptionEl.textContent = loanToReturn.description; 
                D.originalLoanAmountDisplayEl.textContent = formatCurrency(loanToReturn.amount); 
                D.loanReturnAmountInputEl.value = loanToReturn.amount.toFixed(2); 
                setDefaultDate(D.loanReturnDateInputEl); 
                populateAccountDropdown(D.loanReturnAccountSelectEl); 
                $('#recordLoanReturnModal').modal('show'); 
            } else {
                 alert('Cannot record return for this loan.');
            }
        }
        
        function handleOpenUpdateInvestmentModal(investmentId) {
            const investment = investments.find(inv => inv.id === parseInt(investmentId)); 
            if (!investment || investment.status !== 'active') return; 
            
            document.getElementById('updateValueInvestmentId').value = investment.id; 
            document.getElementById('updateValueInvestmentName').textContent = investment.description;
            document.getElementById('investmentCurrentValue').value = investment.currentValue !== null && investment.currentValue !== undefined ? investment.currentValue.toFixed(2) : ''; 
            $('#updateInvestmentValueModal').modal('show'); 
        }
        
        function handleOpenRedeemInvestmentModal(investmentId) {
            const investment = investments.find(inv => inv.id === parseInt(investmentId));
            if (!investment || investment.status !== 'active') return; 
            
            document.getElementById('redeemInvestmentId').value = investment.id; 
            document.getElementById('redeemInvestmentName').textContent = investment.description; 
            document.getElementById('redeemInvestmentInitialCost').textContent = formatCurrency(investment.amount); 
            document.getElementById('investmentRedeemedAmount').value = investment.currentValue !== null && investment.currentValue !== undefined ? investment.currentValue.toFixed(2) : investment.amount.toFixed(2);
            setDefaultDate(document.getElementById('investmentRedemptionDate')); 
            populateAccountDropdown(document.getElementById('redemptionDepositAccount')); 
            document.getElementById('redeemProfitLossInfo').textContent = ''; 
            $('#redeemInvestmentModal').modal('show'); 
        }

        // ====================================================================
        // 7. INITIALIZATION
        // ====================================================================

        function initializeApp() {
            // 1. Map DOM elements
            populateDOMElements();

            // 2. Load Data and UI State
            loadState();
            
            // 3. Setup Listeners
            setupEventListeners();
            
            // 4. Set App Info
            if (D.appVersionInfoEl) D.appVersionInfoEl.textContent = `RaGhaS Money Tracker - ${APP_VERSION}`;
            document.title = `RaGhaS Money Tracker - ${APP_VERSION}`;

            // 5. Check PIN Status and Redirect to Login/Setup
            checkPinStatusAndRedirect();
            
            // Initial render state for elements not behind the gate, or needed for initial screen
            if (D.showSecretAccountsToggleSettingsEl) D.showSecretAccountsToggleSettingsEl.checked = showSecretAccounts;
            if (D.toggleShowSecretAccountsHomeBtn) {
                D.toggleShowSecretAccountsHomeBtn.innerHTML = showSecretAccounts ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                D.toggleShowSecretAccountsHomeBtn.title = showSecretAccounts ? "Hide Secret Accounts" : "Show Secret Accounts";
            }
            if (D.toggleBalanceVisibilityBtn) {
                 D.toggleBalanceVisibilityBtn.innerHTML = balancesVisible ? 
                        '<i class="fas fa-eye"></i> Hide Amounts' : 
                        '<i class="fas fa-eye-slash"></i> Show Amounts'; 
            }
            
            // Attach secondary handlers (not dependent on isAuthenticated initially)
            setupSecondaryEventListeners();
        }
        
        function setupSecondaryEventListeners() {
            // Data Management
            document.getElementById('exportDataBtn')?.addEventListener('click', exportData);
            document.getElementById('importDataTriggerBtn')?.addEventListener('click', () => { document.getElementById('importFile').click();});
            document.getElementById('importFile')?.addEventListener('change', importData);
            document.getElementById('resetDataBtn')?.addEventListener('click', handleResetData);
            
            // Settings UI Toggles
            D.toggleCategoryManagementBtn?.addEventListener('click', handleToggleCategoryManagement);
            D.toggleAccountManagementBtn?.addEventListener('click', handleToggleAccountManagement);

            // Settings Forms
            D.addSpendCategoryForm?.addEventListener('submit', handleAddCategory);
            D.addIncomeCategoryForm?.addEventListener('submit', handleAddCategory);
            document.getElementById('addAccountForm')?.addEventListener('submit', handleAddAccount);

            // Investment Value Preview (Needs to be attached early)
            const investmentRedeemedAmountEl = document.getElementById('investmentRedeemedAmount');
            if(investmentRedeemedAmountEl) { 
                investmentRedeemedAmountEl.addEventListener('input', handleRedemptionAmountInput);
            }
            
            // Chart Filter Handlers
            D.chartFilterButtonsContainer?.addEventListener('click', handleChartFilterButtonClick);
            D.applyCustomDateRangeBtn?.addEventListener('click', handleApplyCustomDateRange);
            document.getElementById('updateInvestmentValueForm')?.addEventListener('submit', handleUpdateInvestmentValue);
            document.getElementById('redeemInvestmentForm')?.addEventListener('submit', handleRedeemInvestment);
            document.getElementById('investmentForm')?.addEventListener('submit', handleAddInvestment);
        }
        
        // --- Setting Management Helpers ---

        function handleToggleCategoryManagement() {
            categoryManagementVisible = !categoryManagementVisible;
            saveState();
            applyCategoryManagementVisibility();
        }
        function handleToggleAccountManagement() {
            accountManagementVisible = !accountManagementVisible;
            saveState();
            applyAccountManagementVisibility();
        }
        function applyCategoryManagementVisibility() {
            if (!D.categoryManagementContentEl || !D.toggleCategoryManagementBtn) return;
            D.categoryManagementContentEl.style.display = categoryManagementVisible ? 'block' : 'none';
            D.toggleCategoryManagementBtn.innerHTML = categoryManagementVisible ? '<i class="fas fa-eye-slash"></i> Hide' : '<i class="fas fa-eye"></i> Show';
            D.toggleCategoryManagementBtn.title = categoryManagementVisible ? 'Hide Category Section' : 'Show Category Section';
        }
        function applyAccountManagementVisibility() {
            if (!D.accountManagementContentEl || !D.toggleAccountManagementBtn) return;
            D.accountManagementContentEl.style.display = accountManagementVisible ? 'block' : 'none';
            D.toggleAccountManagementBtn.innerHTML = accountManagementVisible ? '<i class="fas fa-eye-slash"></i> Hide' : '<i class="fas fa-eye"></i> Show';
            D.toggleAccountManagementBtn.title = accountManagementVisible ? 'Hide Account Section' : 'Show Account Section';
        }

        function handleAddCategory(e) {
            e.preventDefault();
            const isSpend = e.target.id === 'addSpendCategoryForm';
            const inputEl = isSpend ? D.newSpendCategoryName : D.newIncomeCategoryName;
            const categoriesArray = isSpend ? spendCategories : incomeCategories;
            const categoryName = inputEl.value.trim();

            if (categoryName && !categoriesArray.find(c => c.toLowerCase() === categoryName.toLowerCase())) {
                categoriesArray.push(categoryName);
                if (isSpend) { saveState(); renderCategoryManagementUI(); populateSpendCategoryChips(); }
                else { saveState(); renderCategoryManagementUI(); populateIncomeCategoryChips(); }
                inputEl.value = '';
            } else if (categoryName) {
                alert(`The ${isSpend ? 'spend' : 'income'} category already exists or is invalid.`);
            }
        }
        
        function handleAddAccount(e) {
            e.preventDefault();
            const name = document.getElementById('newAccountName').value.trim();
            const id = document.getElementById('newAccountId').value.trim().toLowerCase().replace(/\s+/g, '_'); 

            if (!name || !id) { alert('Please provide both account name and a short ID.'); return; }
            if (accounts.some(acc => acc.id === id)) { alert('Account ID already exists. Please choose a unique ID.'); return; }
            if (!/^[a-z0-9_]+$/.test(id)) { alert('Account ID can only contain lowercase letters, numbers, and underscores.'); return; }

            accounts.push({ id, name, status: 'active' }); 
            saveState();
            renderAccountManagementList();
            populateAllAccountDropdowns(); 
            renderAccountBalances(); 
            document.getElementById('addAccountForm').reset();
        }
        
        // --- Data Management Helpers ---
        function exportData() { 
            if (!isAuthenticated) return; 
            const dataToExport = { 
                accounts, 
                transactions, 
                investments, 
                spendCategories, 
                incomeCategories, 
                appVersion: `money_tracker_${APP_VERSION}_export`, 
                exportDate: new Date().toISOString() 
            };
            const jsonData = JSON.stringify(dataToExport, null, 2); 
            const blob = new Blob([jsonData], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `money_tracker_data_${formatDate(new Date().toISOString().slice(0,10))}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
            alert('Data exported successfully!');
        }
        
        function importData(event) { 
             if (!isAuthenticated) return; 
            const file = event.target.files[0]; 
            if (!file) return; 
            if (file.type !== "application/json") { alert("Invalid file type."); return;
            } 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                try { 
                    const importedData = JSON.parse(e.target.result);
                    const isValidTransaction = (tr) => typeof tr.id === 'number' && typeof tr.type === 'string';
                    const isValidInvestment = (inv) => typeof inv.id === 'number' && typeof inv.description === 'string';
                    const isValidAccount = (acc) => typeof acc.id === 'string' && typeof acc.name === 'string' && typeof acc.status === 'string';
                    const isValidCategoryArray = (arr) => Array.isArray(arr) && arr.every(item => typeof item === 'string');

                    if (importedData && 
                        (!importedData.transactions || (Array.isArray(importedData.transactions) && importedData.transactions.every(isValidTransaction))) && 
                        (!importedData.investments || (Array.isArray(importedData.investments) && importedData.investments.every(isValidInvestment))) && 
                        (!importedData.accounts || (Array.isArray(importedData.accounts) && importedData.accounts.every(isValidAccount))) &&
                        (!importedData.spendCategories || isValidCategoryArray(importedData.spendCategories)) &&
                        (!importedData.incomeCategories || isValidCategoryArray(importedData.incomeCategories))
                    ) { 
                        if (confirm('This will merge imported data. New items added. Existing IDs/Names skipped. Continue?')) { 
                            let newTransactionsAdded = 0;
                            let skippedTransactions = 0; 
                            let newInvestmentsAdded = 0; 
                            let skippedInvestments = 0; 
                            let newAccountsAdded = 0; 
                            let skippedAccounts = 0;
                            let newSpendCategoriesAdded = 0;
                            let skippedSpendCategories = 0;
                            let newIncomeCategoriesAdded = 0;
                            let skippedIncomeCategories = 0;

                            if (importedData.accounts) { 
                                const existingAccountIds = new Set(accounts.map(acc => acc.id));
                                importedData.accounts.forEach(importedAcc => { 
                                    if (!existingAccountIds.has(importedAcc.id)) { 
                                        accounts.push(importedAcc); newAccountsAdded++; 
                                    } else { skippedAccounts++; } 
                                });
                            } 
                            
                            const existingTransactionIds = new Set(transactions.map(t => t.id)); 
                            if(importedData.transactions) importedData.transactions.forEach(importedTx => { 
                                if (!existingTransactionIds.has(importedTx.id)) { 
                                    const amount = importedTx.type === 'loan' ? (importedTx.amount_lent || importedTx.amount || 0) : (importedTx.amount || 0); 
                                    transactions.push({...importedTx, amount: parseFloat(amount) }); newTransactionsAdded++; 
                                } else { skippedTransactions++; } 
                            });
                            
                            const existingInvestmentIds = new Set(investments.map(inv => inv.id)); 
                            if(importedData.investments) importedData.investments.forEach(importedInv => { 
                                if (!existingInvestmentIds.has(importedInv.id)) { 
                                    investments.push({ 
                                        ...importedInv, 
                                        amount: parseFloat(importedInv.amount || 0), 
                                        currentValue: importedInv.currentValue ? parseFloat(importedInv.currentValue) : null, 
                                        redeemedAmount: importedInv.redeemedAmount ? parseFloat(importedInv.redeemedAmount) : null, 
                                        profitOrLoss: importedInv.profitOrLoss ? parseFloat(importedInv.profitOrLoss) : null, 
                                        status: importedInv.status || 'active' 
                                    }); 
                                    newInvestmentsAdded++; 
                                } else { skippedInvestments++; } 
                            });

                            if (importedData.spendCategories) {
                                const existingSpendCatSet = new Set(spendCategories.map(c => c.toLowerCase()));
                                importedData.spendCategories.forEach(cat => {
                                    if (typeof cat === 'string' && !existingSpendCatSet.has(cat.toLowerCase())) {
                                        spendCategories.push(cat);
                                        newSpendCategoriesAdded++;
                                    } else {
                                        skippedSpendCategories++;
                                    }
                                });
                            }
                            if (importedData.incomeCategories) {
                                const existingIncomeCatSet = new Set(incomeCategories.map(c => c.toLowerCase()));
                                importedData.incomeCategories.forEach(cat => {
                                    if (typeof cat === 'string' && !existingIncomeCatSet.has(cat.toLowerCase())) {
                                        incomeCategories.push(cat);
                                        newIncomeCategoriesAdded++;
                                    } else {
                                        skippedIncomeCategories++;
                                    }
                                });
                            }
                            
                            saveState(); 
                            renderAllContent(); populateFilters(); 
                            alert(`Data merged!\nAccounts: ${newAccountsAdded} new (Skipped: ${skippedAccounts})\nTransactions: ${newTransactionsAdded} new (Skipped: ${skippedTransactions})\nInvestments: ${newInvestmentsAdded} new (Skipped: ${skippedInvestments})\nSpend Cats: ${newSpendCategoriesAdded} new (Skipped: ${skippedSpendCategories})\nIncome Cats: ${newIncomeCategoriesAdded} new (Skipped: ${skippedIncomeCategories})`);
                        } 
                    } else { 
                        alert('Invalid data structure in imported file.'); 
                    } 
                } catch (error) { 
                    console.error("Import Error:", error);
                    alert('Error importing data.'); 
                } finally { 
                    document.getElementById('importFile').value = ''; 
                } 
            }; 
            reader.readAsText(file);
        }
        
        function handleResetData() { 
            if (!isAuthenticated) return; 
            
            if (window.confirm('ARE YOU SURE you want to reset all data? This cannot be undone.')) { 
                if (window.confirm('SECOND CONFIRMATION: All data will be permanently deleted. Proceed?')) { 
                    transactions = [];
                    investments = []; 
                    accounts = [ { id: 'cash', name: 'Cash', status: 'active' }, { id: 'sbi', name: 'SBI', status: 'active'} ]; 
                    
                    spendCategories = [ 'Bills & Recharges', 'CC Bills', 'Cloths', 'Education', 'Entertainment', 'EMI', 'Foods & Drinks' ,'Fuel', 'Gifts', 'Groceries', 'Homes & Utilities', 'Health & Medicine', 'Insurance', 'Investment Expense', 'Labs & Tests', 'Maintenance', 'Travel', 'Shopping', 'Parties', 'Vacation', 'Personal Care', 'Rent', 'Subscriptions', 'Others' ]; 
                    incomeCategories = ["Salary", "In-hand Cash", "Savings", "Earnings", "Investment Income", "Gifts Received", "Refunds", "Other Income", "Loan Receivable"]; 

                    saveState(); 
                    
                    renderAllContent(); 
                    populateFilters();
                    
                    alert('All application data has been reset.'); 
                    showView('homeView', 'Dashboard'); 
                } 
            } 
        }

        // --- Investment Helpers ---
        
        function handleAddInvestment(e) { 
            e.preventDefault(); 
            const type = document.getElementById('investmentType').value; 
            const description = document.getElementById('investmentDescription').value.trim(); 
            const date = document.getElementById('investmentDate').value; 
            const amount = parseFloat(document.getElementById('investmentAmount').value); 
            const maturityInfo = document.getElementById('investmentMaturity').value.trim(); 
            const sourceAccount = document.getElementById('investmentSourceAccount').value; 
            
            if (!description || !date || isNaN(amount) || amount <= 0 || !sourceAccount) { 
                alert('Fill required fields.'); 
                return; 
            } 
            
            const newInvestment = { 
                id: Date.now(), 
                type, description, date, amount, maturityInfo, sourceAccount, 
                status: 'active', currentValue: null, redeemedAmount: null, redemptionDate: null, profitOrLoss: null 
            }; 
            investments.push(newInvestment); 
            saveState(); 
            
            const spendTransactionForInvestment = { 
                id: Date.now() + 1, 
                type: 'spend', 
                category: 'Investment Expense', 
                description: `Investment: ${description}`, 
                amount: amount, 
                date: date, 
                account: sourceAccount 
            };
            transactions.push(spendTransactionForInvestment); 
            saveState(); 
            
            renderAllContent(); 
            D.investmentModalJQ.modal('hide'); 
        }

        function handleUpdateInvestmentValue(e) {
            e.preventDefault(); 
            const id = parseInt(document.getElementById('updateValueInvestmentId').value); 
            const currentValue = parseFloat(document.getElementById('investmentCurrentValue').value); 
            const investmentIndex = investments.findIndex(inv => inv.id === id); 
            
            if (investmentIndex > -1 && !isNaN(currentValue) && currentValue >= 0) { 
                investments[investmentIndex].currentValue = currentValue; 
                saveState(); 
                renderAllContent(); 
                $('#updateInvestmentValueModal').modal('hide'); 
            } else { 
                alert('Invalid current value.'); 
            } 
        }

        function handleRedeemInvestment(e) {
            e.preventDefault(); 
            const id = parseInt(document.getElementById('redeemInvestmentId').value); 
            const redeemedAmount = parseFloat(document.getElementById('investmentRedeemedAmount').value); 
            const redemptionDate = document.getElementById('investmentRedemptionDate').value; 
            const depositAccount = document.getElementById('redemptionDepositAccount').value; 
            
            const investmentIndex = investments.findIndex(inv => inv.id === id); 
            
            if (investmentIndex > -1 && !isNaN(redeemedAmount) && redeemedAmount > 0 && redemptionDate && depositAccount) { 
                const investment = investments[investmentIndex];
                const profitLoss = redeemedAmount - investment.amount; 
                
                investment.status = 'redeemed'; 
                investment.redeemedAmount = redeemedAmount; 
                investment.redemptionDate = redemptionDate; 
                investment.profitOrLoss = profitLoss;
                investment.currentValue = null; 
                
                const incomeTransaction = { 
                    id: Date.now(), 
                    type: 'income', 
                    description: `Redemption: ${investment.description} (P/L: ${formatCurrency(profitLoss)})`, 
                    amount: redeemedAmount, 
                    date: redemptionDate, 
                    account: depositAccount, 
                    category: 'Investment Income' 
                };
                transactions.push(incomeTransaction); 
                
                saveState(); 
                renderAllContent(); 
                $('#redeemInvestmentModal').modal('hide'); 
            } else { 
                alert('Fill all fields correctly.');
            } 
        }

        function handleRedemptionAmountInput() {
            const investmentId = parseInt(document.getElementById('redeemInvestmentId').value); 
            const investment = investments.find(inv => inv.id === investmentId); 
            if (!investment) return; 
            
            const redeemedAmountVal = parseFloat(this.value); 
            const redeemProfitLossInfoEl = document.getElementById('redeemProfitLossInfo');
            
            if (!isNaN(redeemedAmountVal)) { 
                const profitLoss = redeemedAmountVal - investment.amount; 
                redeemProfitLossInfoEl.textContent = `Est. P/L: ${formatCurrency(profitLoss)}`; 
                redeemProfitLossInfoEl.className = `profit-loss-info text-center mb-2 ${profitLoss >= 0 ? 'text-success' : 'text-danger'}`; 
            } else { 
                redeemProfitLossInfoEl.textContent = ''; 
            } 
        }
        
        // --- Chart Filtering Helpers ---
        
        function getDatesForRange(rangeKey) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            let startDate = null;
            let endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 1);
            endDate.setMilliseconds(endDate.getMilliseconds() - 1); // End of today

            if (rangeKey === 'all') {
                startDate = null; 
            } else if (rangeKey === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            } else if (rangeKey === '3months') {
                startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            } else if (rangeKey === '6months') {
                startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
            } else if (rangeKey === 'year') {
                startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            } else if (rangeKey === 'custom') {
                startDate = chartStartDate;
                endDate = chartEndDate ? new Date(chartEndDate.getFullYear(), chartEndDate.getMonth(), chartEndDate.getDate(), 23, 59, 59, 999) : endDate;
                return { startDate, endDate };
            }
            
            if (startDate) startDate.setHours(0, 0, 0, 0);
            return { startDate, endDate };
        }

        function filterTransactionsForCharts() {
            const { startDate, endDate } = getDatesForRange(chartDateRange);
            
            const startTimestamp = startDate ? startDate.getTime() : 0;
            const endTimestamp = endDate ? endDate.getTime() : Infinity;

            return transactions.filter(t => {
                const txDate = new Date(t.date);
                const txTimestamp = txDate.getTime();
                
                return txTimestamp >= startTimestamp && txTimestamp <= endTimestamp;
            });
        }
        
        function handleChartFilterButtonClick(e) {
            const btn = e.target.closest('.chart-filter-btn');
            if (btn) {
                chartDateRange = btn.dataset.range;
                
                if (chartDateRange !== 'custom') {
                    chartStartDate = null;
                    chartEndDate = null;
                    D.chartStartDateEl.value = '';
                    D.chartEndDateEl.value = '';
                    renderChartFilters(); 
                    renderAllContent(); 
                } else {
                    renderChartFilters(); 
                }
            }
        }
        
        function handleApplyCustomDateRange() {
            const start = D.chartStartDateEl.value;
            const end = D.chartEndDateEl.value;

            if (!start || !end) {
                alert('Please select both start and end dates for the custom range.');
                return;
            }

            chartStartDate = new Date(start);
            chartEndDate = new Date(end);
            
            if (chartStartDate.getTime() > chartEndDate.getTime()) {
                alert('Start date cannot be after the end date.');
                return;
            }

            chartDateRange = 'custom';
            renderChartFilters();
            renderAllContent();
        }

        function renderChartFilters() {
            if (!isAuthenticated || !D.chartFilterButtonsContainer) return;

            document.querySelectorAll('.chart-filter-btn').forEach(btn => {
                const isActive = btn.dataset.range === chartDateRange;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('btn-primary', isActive);
                btn.classList.toggle('btn-outline-primary', !isActive && btn.dataset.range !== 'custom');
                btn.classList.toggle('btn-outline-secondary', btn.dataset.range === 'custom' && !isActive);
            });

            if (chartDateRange === 'custom') {
                D.customDateRangeInputsEl.style.display = 'flex';
                D.chartStartDateEl.value = chartStartDate ? formatDate(chartStartDate) : '';
                D.chartEndDateEl.value = chartEndDate ? formatDate(chartEndDate) : '';
            } else {
                D.customDateRangeInputsEl.style.display = 'none';
            }
        }
        
        // --- FINAL INIT CALL ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    })();
    </script>

</body>
</html>
