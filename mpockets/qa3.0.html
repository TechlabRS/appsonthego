<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmaRGht Gen Analytics (Voice)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
        
        .modal-enter { animation: slideUp 0.3s ease-out forwards; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .mic-active { animation: pulse-ring 1.5s infinite; color: #2563eb !important; background: #eff6ff !important; }

        .filter-chip.active { background-color: #111827; color: white; border-color: #111827; }

        .category-chip { transition: all 0.2s; border: 1px solid #e5e7eb; }
        .category-chip:active { transform: scale(0.95); }
        .category-chip.selected { background-color: #2563eb; color: white; border-color: #2563eb; font-weight: 600; }
        
        .nav-item.active { color: #2563eb; }
        .nav-item.active i { font-weight: bold; }

        .inv-card-bg { background-image: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); }

        .pin-input { width: 100%; aspect-ratio: 1 / 1; text-align: center; font-size: 1.5rem; font-weight: 700; border-width: 1px; border-color: rgb(209 213 219); border-radius: 0.5rem; transition: all 0.15s; }
        .pin-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); }
        
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.selected { border-color: black; transform: scale(1.1); }
        
        /* Command Bar Styles */
        #command-bar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #command-progress-bar { transition: width 3s linear; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] w-11/12 max-w-md space-y-2 pointer-events-none"></div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="import-file" accept=".json" class="hidden" onchange="handleFileSelect(event)">

    <!-- AUTHENTICATION CONTAINER -->
    <div id="auth-container" class="fixed inset-0 bg-gray-50 z-[100] flex flex-col items-center justify-center p-6 transition-opacity duration-300">
        <div class="max-w-md w-full text-center">
            <div class="flex items-center justify-center gap-2 mb-8 text-blue-600">
                <div class="bg-blue-600/10 p-2 rounded-lg"><i class="ph ph-brain text-2xl"></i></div>
                <span class="text-2xl font-bold tracking-wide">SmaRGht Gen Analytics</span>
            </div>
            <div id="auth-forms-wrapper"></div>
        </div>
    </div>
    
    <!-- MAIN APP -->
    <div id="app-container" class="h-full flex flex-col hidden relative">
        <main id="main-content" class="flex-1 overflow-y-auto pb-40 hide-scroll bg-gray-50">
            
            <!-- Dashboard -->
            <div id="view-dashboard" class="fade-in pb-6 flex flex-col">
                 <!-- Header -->
                <header class="bg-purple-600 text-white pt-6 pb-8 px-6 rounded-b-[2.5rem] shadow-lg relative overflow-hidden z-10 shrink-0">
                    <div class="absolute top-0 right-0 opacity-10 pointer-events-none"><i class="ph ph-currency-inr text-8xl"></i></div>
                    <div class="flex items-center gap-2 mb-6 opacity-90">
                        <div class="bg-white/20 p-1.5 rounded-lg backdrop-blur-sm"><i class="ph ph-brain text-xl"></i></div>
                        <span class="text-lg font-bold tracking-wide">SmaRGht Gen Analytics</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <p class="text-blue-100 text-xs font-medium uppercase tracking-wider">Total Net Worth</p>
                            <h1 class="text-3xl font-bold mt-1" id="total-balance">₹ 0.00</h1>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="triggerImport()" class="text-blue-200 hover:text-white hover:bg-white/10 w-8 h-8 rounded-full flex items-center justify-center transition-all"><i class="ph ph-upload-simple text-xl"></i></button>
                            <button onclick="exportData()" class="text-blue-200 hover:text-white hover:bg-white/10 w-8 h-8 rounded-full flex items-center justify-center transition-all"><i class="ph ph-download-simple text-xl"></i></button>
                            <button onclick="logout()" class="text-blue-200 hover:text-white hover:bg-white/10 w-8 h-8 rounded-full flex items-center justify-center transition-all"><i class="ph ph-lock-key-open text-xl"></i></button>
                            <button onclick="resetData()" class="text-blue-200 hover:text-white hover:bg-white/10 w-8 h-8 rounded-full flex items-center justify-center transition-all"><i class="ph ph-trash text-xl"></i></button>
                        </div>
                    </div>
                    <!-- Snapshots -->
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-md border border-white/10 mt-4 mb-4">
                        <div class="flex justify-between items-center text-xs text-blue-100 mb-2 uppercase tracking-wider"><span>Snapshot (All Time)</span><i class="ph ph-chart-bar"></i></div>
                        <div class="grid grid-cols-4 gap-2 text-center">
                            <div><div class="text-[10px] text-emerald-200">Income</div><div class="font-bold text-sm truncate" id="snap-income">₹0</div></div>
                            <div><div class="text-[10px] text-red-200">Spend</div><div class="font-bold text-sm truncate" id="snap-expense">₹0</div></div>
                            <div><div class="text-[10px] text-indigo-200">Invest</div><div class="font-bold text-sm truncate" id="snap-invest">₹0</div></div>
                            <div><div class="text-[10px] text-orange-200">Lent</div><div class="font-bold text-sm truncate" id="snap-lent">₹0</div></div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="bg-white/10 rounded-xl p-3 flex-1 backdrop-blur-md border border-white/10"><div class="text-blue-100 text-[10px] uppercase flex items-center gap-1"><i class="ph ph-trend-up"></i> Month In</div><div class="font-semibold text-lg truncate" id="monthly-income">₹ 0</div></div>
                        <div class="bg-white/10 rounded-xl p-3 flex-1 backdrop-blur-md border border-white/10"><div class="text-blue-100 text-[10px] uppercase flex items-center gap-1"><i class="ph ph-trend-down"></i> Month Out</div><div class="font-semibold text-lg truncate" id="monthly-expense">₹ 0</div></div>
                    </div>
                </header>

                <!-- Accounts Header -->
                <div class="-mt-6 z-20 relative px-4 mb-1 flex justify-between items-end shrink-0">
                    <span class="text-xs font-bold uppercase text-gray-500 tracking-wider bg-gray-50 px-2 rounded-t-lg">Accounts</span>
                    <button onclick="openModal('accounts-list')" class="text-[10px] font-bold text-blue-600 bg-white px-2 py-1 rounded-full shadow-sm flex items-center gap-1"><i class="ph ph-gear"></i> Manage</button>
                </div>
                <!-- Accounts Cards -->
                <div class="px-4 overflow-x-auto hide-scroll flex gap-3 pb-4 z-20 relative shrink-0"><div id="account-cards-container" class="flex gap-3"></div></div>

                <div class="px-4 mt-2 space-y-6">
                    <div id="alerts-section" class="hidden">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-1"><i class="ph ph-bell-ringing text-orange-500"></i> Action Required</h3>
                        <div id="alerts-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-end mb-3"><h3 class="text-lg font-bold text-gray-800">Recent Activity</h3><button onclick="switchTab('history')" class="text-sm text-blue-600 font-medium">View All</button></div>
                        <div id="recent-transactions" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Portfolio -->
            <div id="view-portfolio" class="px-4 mt-4 space-y-4 hidden fade-in pb-20">
                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Portfolio</h2><div class="text-xs text-right"><div class="text-gray-400 uppercase font-bold">Current Value</div><div class="text-lg font-bold text-indigo-600" id="portfolio-total">₹ 0</div></div></div>
                <div class="bg-gray-200 p-1 rounded-xl flex text-sm font-bold mb-4">
                    <button onclick="renderPortfolio('active')" id="tab-active" class="flex-1 py-2 rounded-lg bg-white shadow-sm text-gray-800 transition-all">Active</button>
                    <button onclick="renderPortfolio('redeemed')" id="tab-redeemed" class="flex-1 py-2 rounded-lg text-gray-500 transition-all">Redeemed</button>
                </div>
                <div id="portfolio-list" class="space-y-3"></div>
            </div>

            <!-- Analytics -->
            <div id="view-analytics" class="px-4 mt-4 space-y-6 hidden fade-in pb-20">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-bold">Insights</h2>
                    <select id="analytics-period" onchange="updateCharts()" class="bg-white border border-gray-200 text-sm rounded-lg px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="thisMonth">This Month</option><option value="lastMonth">Last Month</option><option value="last3Months">Last 3 Months</option><option value="yearToDate">Year to Date</option><option value="all">All Time</option></select>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Spending Trend</h3><div class="w-full h-[40vh] relative"><canvas id="trendChart"></canvas></div></div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Expenses</h3><div class="w-full h-[35vh] relative"><canvas id="spendingChart"></canvas></div></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Asset Allocation</h3><div class="w-full h-[35vh] relative"><canvas id="investmentChart"></canvas></div></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 md:col-span-2"><h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Portfolio Breakdown</h3><div class="w-full h-[35vh] relative"><canvas id="investBreakdownChart"></canvas></div></div>
                </div>
            </div>

            <!-- Planning -->
            <div id="view-planning" class="px-4 mt-4 space-y-4 hidden fade-in pb-20">
                <div class="flex justify-between items-center"><div><h2 class="text-2xl font-bold">Planner</h2><p class="text-xs text-gray-500">Bills, Loans & Receivables</p></div><button onclick="openModal('reminder')" class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-1 transition-transform active:scale-95"><i class="ph ph-plus-bold"></i> New Alert</button></div>
                <div id="all-reminders" class="space-y-3"></div>
            </div>

            <!-- History -->
            <div id="view-history" class="hidden fade-in flex flex-col h-full">
                <div class="bg-gray-50 pt-4 px-4 pb-2 sticky top-0 z-30 shadow-sm">
                    <h2 class="text-2xl font-bold mb-3">Transactions</h2>
                    <div class="flex gap-2 mb-3">
                        <div class="relative flex-1"><i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i><input type="text" id="history-search" oninput="applyHistoryFilters()" placeholder="Search..." class="w-full bg-white border border-gray-200 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></div>
                        <button onclick="openModal('filter')" class="bg-white border border-gray-200 w-11 rounded-xl flex items-center justify-center text-gray-600 shadow-sm active:bg-gray-100"><i class="ph ph-faders text-lg"></i></button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                        <button onclick="setQuickFilter('all')" class="filter-chip active px-4 py-1.5 rounded-full text-xs font-bold border border-gray-200 bg-white text-gray-600 whitespace-nowrap" id="chip-all">All</button>
                        <button onclick="setQuickFilter('expense')" class="filter-chip px-4 py-1.5 rounded-full text-xs font-bold border border-gray-200 bg-white text-gray-600 whitespace-nowrap" id="chip-expense">Spends</button>
                        <button onclick="setQuickFilter('income')" class="filter-chip px-4 py-1.5 rounded-full text-xs font-bold border border-gray-200 bg-white text-gray-600 whitespace-nowrap" id="chip-income">Income</button>
                        <button onclick="setQuickFilter('investment')" class="filter-chip px-4 py-1.5 rounded-full text-xs font-bold border border-gray-200 bg-white text-gray-600 whitespace-nowrap" id="chip-investment">Invest</button>
                    </div>
                    <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100 overflow-x-auto hide-scroll pb-1">
                         <div class="min-w-[80px] flex-1 bg-emerald-50 rounded-lg px-2 py-1.5 text-center shrink-0"><div class="text-[9px] text-emerald-600 font-bold uppercase">Income</div><div class="text-xs font-bold text-emerald-700 truncate" id="h-inc">₹0</div></div>
                         <div class="min-w-[80px] flex-1 bg-rose-50 rounded-lg px-2 py-1.5 text-center shrink-0"><div class="text-[9px] text-rose-600 font-bold uppercase">Spent</div><div class="text-xs font-bold text-rose-700 truncate" id="h-exp">₹0</div></div>
                         <div class="min-w-[80px] flex-1 bg-indigo-50 rounded-lg px-2 py-1.5 text-center shrink-0"><div class="text-[9px] text-indigo-600 font-bold uppercase">Invest</div><div class="text-xs font-bold text-indigo-700 truncate" id="h-inv">₹0</div></div>
                         <div class="min-w-[80px] flex-1 bg-blue-50 rounded-lg px-2 py-1.5 text-center shrink-0"><div class="text-[9px] text-blue-600 font-bold uppercase">Transfer</div><div class="text-xs font-bold text-blue-700 truncate" id="h-tra">₹0</div></div>
                         <div class="min-w-[80px] flex-1 bg-orange-50 rounded-lg px-2 py-1.5 text-center shrink-0"><div class="text-[9px] text-orange-600 font-bold uppercase">Lent</div><div class="text-xs font-bold text-orange-700 truncate" id="h-len">₹0</div></div>
                    </div>
                </div>
                <div id="full-history-list" class="px-4 pb-24 pt-3 space-y-4 overflow-y-auto"></div>
            </div>

            <div class="text-center py-8 text-gray-400 pb-24"><p class="text-[10px] uppercase tracking-widest opacity-60">SmaRGht Gen Analytics</p></div>
        </main>

        <!-- FLOATING COMMAND BAR (Fixed above nav) -->
        <div class="fixed bottom-20 left-0 right-0 px-4 z-40 pb-2">
            <!-- Progress Bar for Auto-Save -->
            <div id="command-feedback" class="hidden mb-2 bg-white rounded-lg shadow-lg border border-indigo-100 p-2 flex items-center justify-between animate-slideUp">
                <div class="flex items-center gap-3 w-full">
                    <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center shrink-0"><i class="ph ph-magic-wand text-lg"></i></div>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-gray-800 mb-1" id="cmd-feedback-text">Processing...</div>
                        <div class="h-1 w-full bg-gray-100 rounded-full overflow-hidden">
                            <div id="command-progress-bar" class="h-full bg-indigo-600 w-0"></div>
                        </div>
                    </div>
                    <button onclick="cancelAutoSave()" class="w-8 h-8 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors"><i class="ph ph-x"></i></button>
                </div>
            </div>

            <!-- Input Bar -->
            <div id="command-bar" class="bg-white rounded-full shadow-xl border border-gray-200 flex items-center p-1.5 gap-2 ring-1 ring-gray-100">
                <button onclick="toggleVoice()" id="mic-btn" class="w-10 h-10 rounded-full bg-gray-50 text-gray-500 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all shrink-0">
                    <i class="ph ph-microphone text-xl"></i>
                </button>
                <input type="text" id="command-input" class="flex-1 bg-transparent border-none text-sm font-medium focus:ring-0 outline-none placeholder-gray-400" placeholder="Type or say 'Spent 100 on food'...">
                <button onclick="processCommand()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform shrink-0">
                    <i class="ph ph-paper-plane-right text-lg"></i>
                </button>
            </div>
        </div>

        <!-- FAB (Moved slightly up to avoid overlap) -->
        <button onclick="openModal('transaction')" class="fixed bottom-36 right-4 bg-white text-black border border-gray-200 w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl hover:scale-105 transition-transform z-30"><i class="ph ph-plus"></i></button>

        <!-- Navbar -->
        <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 pb-safe pt-2 px-6 flex justify-between items-center z-40 h-20">
            <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center space-y-1 text-gray-400 w-14 transition-colors"><i class="ph ph-house text-2xl"></i><span class="text-[10px] font-medium">Home</span></button>
            <button onclick="switchTab('portfolio')" class="nav-item flex flex-col items-center space-y-1 text-gray-400 w-14 transition-colors"><i class="ph ph-plant text-2xl"></i><span class="text-[10px] font-medium">Invest</span></button>
            <button onclick="switchTab('analytics')" class="nav-item flex flex-col items-center space-y-1 text-gray-400 w-14 transition-colors"><i class="ph ph-chart-pie-slice text-2xl"></i><span class="text-[10px] font-medium">Insights</span></button>
            <button onclick="switchTab('planning')" class="nav-item flex flex-col items-center space-y-1 text-gray-400 w-14 transition-colors"><i class="ph ph-calendar-check text-2xl"></i><span class="text-[10px] font-medium">Plan</span></button>
            <button onclick="switchTab('history')" class="nav-item flex flex-col items-center space-y-1 text-gray-400 w-14 transition-colors"><i class="ph ph-list-dashes text-2xl"></i><span class="text-[10px] font-medium">History</span></button>
        </nav>
    </div>

    <!-- MODALS -->
    <!-- Investment Detail Table Modal -->
    <div id="investment-detail-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <div><h3 class="text-xl font-bold text-gray-800">Investment Ledger</h3><p class="text-xs text-gray-400 mt-1">Detailed breakdown of your portfolio</p></div>
                <button onclick="closeModal('investment-detail')" class="bg-gray-50 rounded-full p-2 text-gray-500 hover:bg-gray-100"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div class="overflow-auto flex-1 p-0"><table class="w-full text-left border-collapse"><thead class="bg-gray-50 sticky top-0 z-10"><tr><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Type / Name</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Buy Date</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Sell Date</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">Buy Qty/Amt</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">Sell Qty/Amt</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">P/L</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-center">Status</th></tr></thead><tbody id="invest-detail-body" class="divide-y divide-gray-100 text-sm"></tbody></table></div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl text-center"><button onclick="closeModal('investment-detail')" class="text-blue-600 text-sm font-bold">Close</button></div>
        </div>
    </div>

    <!-- Accounts List Modal -->
    <div id="accounts-list-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-enter max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">My Accounts</h3><button onclick="closeModal('accounts-list')" class="bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200"><i class="ph ph-x"></i></button></div>
            <div id="manage-accounts-container" class="space-y-3 overflow-y-auto flex-1 pb-4"></div>
            <button onclick="openAccountEditModal()" class="w-full bg-black text-white font-bold py-3 rounded-xl shadow-lg mt-2 flex items-center justify-center gap-2"><i class="ph ph-plus"></i> Add Account</button>
        </div>
    </div>

    <!-- Edit/Add Account Modal -->
    <div id="account-edit-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-enter">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold" id="acc-modal-title">Add Account</h3><button onclick="closeModal('account-edit')" class="bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200"><i class="ph ph-x"></i></button></div>
            <form onsubmit="handleAccountSave(event)" class="space-y-4">
                <input type="hidden" id="acc-id">
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Account Name</label><input type="text" id="acc-name" required class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm font-bold focus:ring-2 focus:ring-black outline-none"></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Type</label><select id="acc-type" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-3 text-sm focus:ring-2 focus:ring-black outline-none"><option value="cash">Cash / Wallet</option><option value="bank">Bank Account</option><option value="credit">Credit Card</option><option value="investment">Investment Pot</option></select></div><div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Initial Balance</label><input type="number" id="acc-initial" step="any" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm focus:ring-2 focus:ring-black outline-none"></div></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-2">Color Theme</label><div class="flex flex-wrap gap-3" id="acc-color-picker"></div><input type="hidden" id="acc-color" required></div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg mt-2">Save Account</button>
            </form>
        </div>
    </div>

    <!-- Transaction -->
    <div id="transaction-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-enter max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold" id="tx-modal-title">New Transaction</h3><button onclick="closeModal('transaction')" class="bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200"><i class="ph ph-x"></i></button></div>
            <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
                <button onclick="setTxType('expense')" id="btn-expense" class="flex-1 py-2.5 rounded-lg text-xs font-bold uppercase transition-all">Spend</button>
                <button onclick="setTxType('income')" id="btn-income" class="flex-1 py-2.5 rounded-lg text-xs font-bold uppercase transition-all">Income</button>
                <button onclick="setTxType('transfer')" id="btn-transfer" class="flex-1 py-2.5 rounded-lg text-xs font-bold uppercase transition-all">Transfer</button>
                <button onclick="setTxType('investment')" id="btn-investment" class="flex-1 py-2.5 rounded-lg text-xs font-bold uppercase transition-all">Invest</button>
            </div>
            <form id="tx-form" onsubmit="handleTransactionSubmit(event)" class="space-y-4">
                <input type="hidden" id="tx-type" value="expense"><input type="hidden" id="editing-tx-id">
                <div>
                    <div class="flex justify-between items-center mb-1"><label class="block text-xs text-gray-500 uppercase font-bold">Amount</label><button type="button" onclick="toggleBreakdown()" class="text-xs font-bold text-blue-600 flex items-center gap-1 hover:bg-blue-50 px-2 py-0.5 rounded-lg transition-colors"><i class="ph ph-list-plus"></i> Split / Details</button></div>
                    <div class="relative"><span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold text-lg">₹</span><input type="text" id="tx-amount" onblur="evaluateMath(this)" inputmode="text" required class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3.5 pl-10 pr-4 text-xl font-bold focus:ring-2 focus:ring-black outline-none" placeholder="e.g. 20+40+50"></div>
                    <div id="tx-breakdown" class="hidden mt-3 bg-gray-50 rounded-xl p-3 border border-gray-200"><div id="breakdown-list" class="space-y-2 mb-3"></div><button type="button" onclick="addBreakdownItem()" class="w-full py-2 text-xs font-bold text-gray-500 border border-dashed border-gray-300 rounded-lg hover:bg-white hover:text-blue-600 transition-colors">+ Add Item</button></div>
                </div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-gray-500 uppercase font-bold mb-1" id="label-from">From</label><select id="tx-from-account" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-3 text-sm font-medium focus:ring-2 focus:ring-black outline-none"></select></div><div id="field-to-account" class="hidden"><label class="block text-xs text-gray-500 uppercase font-bold mb-1">To</label><select id="tx-to-account" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-3 text-sm font-medium focus:ring-2 focus:ring-black outline-none"></select></div></div>
                <div id="field-category"><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Category</label><div id="category-selection-container" class="flex flex-wrap gap-2 mt-2"></div><input type="hidden" id="tx-category" required></div>
                <div id="field-maturity" class="hidden bg-indigo-50 p-3 rounded-xl border border-indigo-100"><label class="block text-xs text-indigo-800 uppercase font-bold mb-1">Maturity Date</label><input type="date" id="tx-maturity" class="w-full bg-white border border-indigo-200 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Tags</label><div class="relative"><i class="ph ph-hash absolute left-4 top-3.5 text-gray-400 text-lg"></i><input type="text" id="tx-tags" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 pl-10 text-sm focus:ring-2 focus:ring-black outline-none" placeholder="Comma separated"></div></div>
                <div class="grid grid-cols-3 gap-4"><div class="col-span-2"><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Note</label><input type="text" id="tx-note" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm focus:ring-2 focus:ring-black outline-none" placeholder="Description"></div><div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Date</label><input type="date" id="tx-date" required class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-2 text-sm focus:ring-2 focus:ring-black outline-none"></div></div>
                <button type="submit" class="w-full bg-black text-white font-bold py-4 rounded-xl shadow-lg hover:bg-gray-800 transition-colors mt-2">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Redeem -->
    <div id="redeem-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-enter">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-indigo-700">Redeem</h3><button onclick="closeModal('redeem')" class="bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200"><i class="ph ph-x"></i></button></div>
            <form id="redeem-form" onsubmit="handleRedeemSubmit(event)" class="space-y-4">
                <input type="hidden" id="redeem-id">
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Principal</label><input type="text" id="redeem-principal" disabled class="w-full bg-gray-100 border border-gray-200 rounded-xl py-3 px-4 text-gray-500 font-bold"></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Current Value</label><input type="text" id="redeem-curr-val" disabled class="w-full bg-gray-100 border border-gray-200 rounded-xl py-3 px-4 text-gray-500 font-bold"></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Redeem Amount</label><div class="relative"><span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold">₹</span><input type="number" id="redeem-amount" step="0.01" required class="w-full bg-white border border-gray-200 rounded-xl py-3 pl-8 pr-4 text-lg font-bold focus:ring-2 focus:ring-indigo-500 outline-none" inputmode="decimal"></div><p class="text-[10px] text-gray-500 mt-1">* Enter full amount to close, or less for partial redeem.</p></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Deposit To</label><select id="redeem-to-account" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none"></select></div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg mt-2 hover:bg-indigo-700 transition-colors">Confirm</button>
            </form>
        </div>
    </div>

    <!-- Reminder -->
    <div id="reminder-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-enter">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">Add Alert</h3><button onclick="closeModal('reminder')" class="bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200"><i class="ph ph-x"></i></button></div>
            <form id="reminder-form" onsubmit="handleReminderSubmit(event)" class="space-y-4">
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-2">Type</label><div class="grid grid-cols-3 gap-2"><button type="button" onclick="setRemType('bill')" id="rt-bill" class="py-2 rounded-lg text-xs font-bold border">Bill</button><button type="button" onclick="setRemType('loan_taken')" id="rt-loan_taken" class="py-2 rounded-lg text-xs font-bold border">Debt</button><button type="button" onclick="setRemType('loan_given')" id="rt-loan_given" class="py-2 rounded-lg text-xs font-bold border">Receive</button></div><input type="hidden" id="rem-type" value="bill"></div>
                <input type="text" id="rem-title" required placeholder="Name / Description" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm focus:ring-2 focus:ring-black outline-none">
                <div class="grid grid-cols-2 gap-4"><input type="number" id="rem-amount" step="0.01" required placeholder="Amount" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm focus:ring-2 focus:ring-black outline-none" inputmode="decimal"><input type="date" id="rem-date" required class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm focus:ring-2 focus:ring-black outline-none"></div>
                <div id="record-tx-option" class="hidden flex items-center gap-2 p-3 bg-gray-50 rounded-xl border border-gray-100"><input type="checkbox" id="record-now" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300"><label for="record-now" class="text-sm text-gray-700 select-none">Record as transaction?</label></div>
                <div id="record-tx-account" class="hidden"><label class="block text-xs text-gray-500 uppercase font-bold mb-1">Account</label><select id="rem-account" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm focus:ring-2 focus:ring-black outline-none"></select></div>
                <button type="submit" class="w-full bg-black text-white font-bold py-4 rounded-xl shadow-lg mt-2 hover:bg-gray-800 transition-colors">Save Alert</button>
            </form>
        </div>
    </div>

    <!-- Filter -->
    <div id="filter-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-enter">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">Filters</h3><button onclick="closeModal('filter')" class="bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200"><i class="ph ph-x"></i></button></div>
            <div class="space-y-4">
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-2">Date Range</label><select id="filter-date" onchange="applyHistoryFilters()" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm"><option value="all">All Time</option><option value="thisMonth">This Month</option><option value="lastMonth">Last Month</option><option value="thisYear">This Year</option></select></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-2">Account</label><select id="filter-account" onchange="applyHistoryFilters()" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm"><option value="all">All Accounts</option></select></div>
                <div><label class="block text-xs text-gray-500 uppercase font-bold mb-2">Sort By</label><select id="filter-sort" onchange="applyHistoryFilters()" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 px-4 text-sm"><option value="date-desc">Newest First</option><option value="amount-desc">Highest Amount</option></select></div>
                <button onclick="resetFilters()" class="w-full py-3 text-sm font-bold text-white bg-blue-600 rounded-xl shadow-lg hover:bg-blue-700 transition-colors mt-2">Reset</button>
            </div>
        </div>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        const CONSTANTS = { PIN: 'sga_pin_hash_v16', SEC_Q: 'sga_sec_q_v16', SEC_A: 'sga_sec_a_hash_v16', AUTH: 'sga_is_authenticated_v16', DATA: 'wealthflow_v17_data' };
        
        const DEFAULT_ACCOUNTS = [
            { id: 'Cash', name: 'Cash / Wallet', type: 'cash', color: 'from-green-400 to-emerald-600', icon: 'ph-money', initialBalance: 0 },
            { id: 'UPI', name: 'UPI', type: 'cash', color: 'from-green-400 to-emerald-600', icon: 'ph-money', initialBalance: 0 },
            { id: 'SB', name: 'SBI (Salary)', type: 'bank', color: 'from-blue-400 to-blue-600', icon: 'ph-bank', initialBalance: 0 },
            { id: 'IC', name: 'ICICI (Savings)', type: 'bank', color: 'from-indigo-400 to-purple-600', icon: 'ph-bank', initialBalance: 0 },
            { id: 'HD', name: 'HDFC (UPI)', type: 'bank', color: 'from-gray-400 to-gray-600', icon: 'ph-qr-code', initialBalance: 0 },
			{ id: 'XS', name: 'Axis (Savings)', type: 'bank', color: 'from-gray-400 to-gray-600', icon: 'ph-qr-code', initialBalance: 0 },
            { id: 'acc_inv', name: 'Investments', type: 'investment', color: 'from-orange-400 to-red-500', icon: 'ph-trend-up', initialBalance: 0 }
        ];

        const ACCOUNT_COLORS = [
            { id: 'green', val: 'from-green-400 to-emerald-600', hex: '#34d399' },
            { id: 'blue', val: 'from-blue-400 to-blue-600', hex: '#60a5fa' },
            { id: 'indigo', val: 'from-indigo-400 to-purple-600', hex: '#818cf8' },
            { id: 'gray', val: 'from-gray-400 to-gray-600', hex: '#9ca3af' },
            { id: 'orange', val: 'from-orange-400 to-red-500', hex: '#fb923c' },
            { id: 'pink', val: 'from-pink-400 to-rose-600', hex: '#fb7185' },
            { id: 'cyan', val: 'from-cyan-400 to-blue-500', hex: '#22d3ee' },
            { id: 'yellow', val: 'from-yellow-400 to-orange-500', hex: '#fbbf24' }
        ];

        const DEFAULT_CATEGORIES = {
            expense: ['Food', 'Transport', 'Shop', 'Bills', 'Rent', 'Health', 'Fun', 'Lent', 'Other'],
            income: ['Salary', 'Freelance', 'Refund', 'Dividend', 'Inv Return', 'Loan Back', 'Capital Gains'],
            investment: ['FD', 'SIP/MF', 'Savings', 'Stocks', 'Gold']
        };
        
        const TX_CONFIG = {
            income: { icon: 'ph-arrow-down-left', bg: 'bg-green-50', text: 'text-green-600', btnStyle: 'text-green-600 shadow-sm' },
            expense: { icon: 'ph-shopping-bag', bg: 'bg-red-50', text: 'text-red-600', btnStyle: 'text-red-600 shadow-sm' },
            transfer: { icon: 'ph-arrows-left-right', bg: 'bg-blue-50', text: 'text-blue-600', btnStyle: 'text-blue-600 shadow-sm' },
            investment: { icon: 'ph-trend-up', bg: 'bg-indigo-50', text: 'text-indigo-600', btnStyle: 'text-indigo-600 shadow-sm' }
        };

        let appData = { transactions: [], balances: {}, categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)), reminders: [], portfolio: [], accounts: [] };
        let filterState = { search: '', type: 'all', date: 'all', account: 'all', sort: 'date-desc' };
        let charts = { spending: null, investment: null, trend: null, invBreakdown: null };
        let currentRemType = 'bill', currentPortfolioView = 'active', activeReminderIndex = null;
        let autoSaveTimer = null;
        let pendingCommandTx = null;

        /* --- UTILITIES --- */
        const formatCurrency = n => "₹ " + n.toLocaleString('en-IN');
        const showToast = (msg, err=false) => {
            const t = document.createElement('div');
            t.className = `${err?'bg-red-600':'bg-black'} text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 text-sm fade-in`;
            t.innerHTML = `<i class="ph ${err?'ph-warning':'ph-check-circle'}"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };
        const arrayBufferToHex = b => Array.prototype.map.call(new Uint8Array(b), x => ('00' + x.toString(16)).slice(-2)).join('');
        async function hashString(s) { const e=new TextEncoder(),d=e.encode(s),h=await crypto.subtle.digest('SHA-256',d); return arrayBufferToHex(h); }
        const safeAdd = (a, b) => parseFloat((a + b).toFixed(2));
        const safeSub = (a, b) => parseFloat((a - b).toFixed(2));
        
        /* --- AI COMMAND PARSER --- */
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            recognition.onstart = () => { document.getElementById('mic-btn').classList.add('mic-active'); document.getElementById('command-input').placeholder = "Listening..."; };
            recognition.onend = () => { document.getElementById('mic-btn').classList.remove('mic-active'); document.getElementById('command-input').placeholder = "Type or say 'Spent 100 on food'..."; };
            recognition.onresult = (e) => { 
                const transcript = e.results[0][0].transcript; 
                document.getElementById('command-input').value = transcript;
                processCommand();
            };
        }

        function toggleVoice() {
            if(!recognition) return showToast("Voice not supported in this browser", true);
            recognition.start();
        }

        function processCommand() {
            const text = document.getElementById('command-input').value.toLowerCase().trim();
            if(!text) return;
            
            // AI Logic to parse text
            const parsed = parseNaturalLanguage(text);
            if(parsed) {
                pendingCommandTx = parsed;
                startAutoSaveTimer(parsed);
            } else {
                showToast("Could not understand command", true);
            }
        }

        function parseNaturalLanguage(text) {
            // 1. Extract Amount (First number found)
            const amtMatch = text.match(/(\d+)(\.\d{1,2})?/); // Matches integers or floats
            if(!amtMatch) return null;
            const amount = parseFloat(amtMatch[0]);

            // 2. Identify Type
            let type = 'expense';
            if(text.includes('income') || text.includes('received') || text.includes('salary') || text.includes('got')) type = 'income';
            else if(text.includes('transfer') || text.includes('sent') || text.includes('move')) type = 'transfer';
            else if(text.includes('invest') || text.includes('sip') || text.includes('fd') || text.includes('deposit')) type = 'investment';
            
            // 3. Identify Accounts (From / To)
            let fromAcc = appData.accounts.find(a => text.includes(a.name.toLowerCase()) || text.includes(a.id.toLowerCase()));
            // Default "from" logic
            if(!fromAcc) fromAcc = appData.accounts[0]; // Default to first (usually Cash or UPI)
            
            // Try to find a second account for transfer
            let toAcc = null;
            if(type === 'transfer') {
                const accs = appData.accounts.filter(a => text.includes(a.name.toLowerCase()) || text.includes(a.id.toLowerCase()));
                if(accs.length >= 2) {
                    // Primitive logic: "from X to Y"
                    const fromIndex = text.indexOf('from');
                    const toIndex = text.indexOf('to');
                    if(fromIndex > -1 && toIndex > -1) {
                         // Assign based on position relative to 'to'
                         toAcc = accs.find(a => text.indexOf(a.name.toLowerCase()) > toIndex || text.indexOf(a.id.toLowerCase()) > toIndex);
                         fromAcc = accs.find(a => a.id !== toAcc?.id);
                    } else {
                        fromAcc = accs[0]; toAcc = accs[1];
                    }
                }
            } else if (type === 'income') {
                 // For income, "to HDFC" means 'from' in our tx model is the destination account
                 const dest = appData.accounts.find(a => text.includes(a.name.toLowerCase()) || text.includes(a.id.toLowerCase()));
                 if(dest) fromAcc = dest;
            }

            // 4. Extract Category & Note
            // Remove keywords and numbers to get clean text
            let cleanText = text.replace(/(\d+)(\.\d{1,2})?/, '').replace(/(spent|on|rs|rupees|income|transfer|invest|from|to|mature|date)/g, '').trim();
            // Try to match existing category
            let category = (appData.categories[type] || []).find(c => cleanText.includes(c.toLowerCase()));
            if(!category) category = type === 'expense' ? 'Other' : type === 'income' ? 'Salary' : 'Transfer'; // Default
            
            // 5. Extract Date (Simple parser)
            let date = new Date().toISOString().split('T')[0];
            const months = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
            months.forEach((m, i) => {
                if(text.includes(m)) {
                     // Find day number after month
                     const dayMatch = text.slice(text.indexOf(m)).match(/\d+/);
                     if(dayMatch) {
                         const y = new Date().getFullYear();
                         date = `${y}-${String(i+1).padStart(2,'0')}-${String(dayMatch[0]).padStart(2,'0')}`;
                     }
                }
            });
            if(text.includes('yesterday')) { const d = new Date(); d.setDate(d.getDate()-1); date = d.toISOString().split('T')[0]; }

            // 6. Special: Investment Maturity
            let maturityDate = '';
            if(type === 'investment') {
                category = 'Savings'; // Default inv category
                if(text.includes('fd')) category = 'FD';
                if(text.includes('sip')) category = 'SIP/MF';
                if(text.includes('gold')) category = 'Gold';
                
                // Parse future date for maturity
                const yearMatch = text.match(/20\d\d/);
                if(yearMatch) {
                    maturityDate = `${yearMatch[0]}-12-30`; // Default to end of year if only year found
                    months.forEach((m, i) => {
                         if(text.includes(m)) {
                             const dayMatch = text.slice(text.indexOf(m)).match(/\d+/);
                             if(dayMatch) maturityDate = `${yearMatch[0]}-${String(i+1).padStart(2,'0')}-${String(dayMatch[0]).padStart(2,'0')}`;
                         }
                    });
                }
            }

            return {
                id: Date.now(), type, amount, date,
                from: fromAcc.id,
                to: toAcc ? toAcc.id : (type==='investment'?'acc_inv':fromAcc.id),
                category,
                note: cleanText.charAt(0).toUpperCase() + cleanText.slice(1) || 'Voice Command',
                tags: ['voice'],
                maturityDate // Only for investment
            };
        }

        function startAutoSaveTimer(tx) {
            const fb = document.getElementById('command-feedback');
            const txt = document.getElementById('cmd-feedback-text');
            const bar = document.getElementById('command-progress-bar');
            
            fb.classList.remove('hidden');
            
            // Friendly text
            let desc = `${tx.type.toUpperCase()}: ₹${tx.amount}`;
            if(tx.type === 'transfer') desc += ` (${tx.from} -> ${tx.to})`;
            else desc += ` on ${tx.category}`;
            
            txt.textContent = `Saving: ${desc}`;
            bar.style.width = '0%';
            
            // Reset animation
            setTimeout(() => { bar.style.width = '100%'; }, 50);

            if(autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveParsedTransaction(tx);
            }, 3000);
        }

        function cancelAutoSave() {
            clearTimeout(autoSaveTimer);
            document.getElementById('command-feedback').classList.add('hidden');
            document.getElementById('command-progress-bar').style.width = '0%';
            document.getElementById('command-input').value = '';
            showToast("Cancelled", true);
        }

        function saveParsedTransaction(tx) {
            document.getElementById('command-feedback').classList.add('hidden');
            document.getElementById('command-progress-bar').style.width = '0%';
            document.getElementById('command-input').value = '';

            appData.transactions.push(tx);
            
            // If Investment, add to portfolio
            if(tx.type === 'investment') {
                const pItem = {
                    id: tx.id, name: tx.note || tx.category, type: tx.category,
                    amount: tx.amount, currentValue: tx.amount, date: tx.date, status: 'active',
                    maturityDate: tx.maturityDate
                };
                appData.portfolio.push(pItem);
            }
            
            saveData();
            showToast("Transaction Saved!");
        }


        /* --- AUTHENTICATION --- */
        document.addEventListener('DOMContentLoaded', () => {
            renderAuthForms(); // Inject auth HTML dynamically to be DRY
            if(localStorage.getItem(CONSTANTS.PIN) !== null) {
                sessionStorage.getItem(CONSTANTS.AUTH) === 'true' ? setAuthenticated(true) : showAuthScreen('auth-login');
            } else showAuthScreen('auth-setup');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tx-date').value = today;
            document.getElementById('rem-date').value = today;
            
            // Render Color Picker in Modal
            const cp = document.getElementById('acc-color-picker');
            ACCOUNT_COLORS.forEach(c => {
                 cp.innerHTML += `<div class="color-dot bg-gradient-to-br ${c.val}" onclick="selectAccountColor('${c.val}', this)"></div>`;
            });
        });

        function renderAuthForms() {
            const pinInputs = (id) => `<div class="flex justify-center gap-2 mb-4">${[1,2,3,4,5,6].map(i => `<input type="password" id="${id}-pin${i}" class="pin-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" oninput="moveToNext(this, '${id}-pin${i+1}')" onkeyup="handlePinInput(event, '${id}-pin${i}')">`).join('')}</div>`;
            
            const forms = `
            <div id="auth-setup" class="hidden fade-in bg-white p-6 rounded-2xl shadow-xl border border-gray-100 space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Set 6-Digit PIN</h2>
                <form onsubmit="handleSetup(event)">
                    ${pinInputs('setup')}
                    <p class="text-sm font-semibold mb-2 text-gray-600">Security Question</p>
                    <select id="setup-security-q" class="w-full bg-gray-100 border border-gray-200 rounded-xl py-3 px-4 text-sm mb-3"><option value="pet">First Pet Name?</option><option value="city">Birth City?</option><option value="mother">Mother's Maiden Name?</option></select>
                    <input type="text" id="setup-security-a" required placeholder="Answer" class="w-full bg-gray-100 border border-gray-200 rounded-xl py-3 px-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg mt-4">Set PIN</button>
                </form>
            </div>
            <div id="auth-login" class="hidden fade-in bg-white p-6 rounded-2xl shadow-xl border border-gray-100 space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Enter PIN</h2>
                <form onsubmit="handleLogin(event)">${pinInputs('login')}<button type="submit" class="w-full bg-black text-white font-bold py-3 rounded-xl shadow-lg mt-4">Login</button></form>
                <button onclick="showResetScreen()" class="text-sm text-gray-500 hover:text-blue-600 mt-4 block w-full">Forgot PIN?</button>
            </div>
            <div id="auth-reset" class="hidden fade-in bg-white p-6 rounded-2xl shadow-xl border border-gray-100 space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Reset PIN</h2>
                <form onsubmit="handleReset(event)">
                    <p class="text-sm font-semibold text-gray-600">Security Answer: <span id="reset-security-q" class="text-blue-600"></span></p>
                    <input type="text" id="reset-security-a" required placeholder="Answer" class="w-full bg-gray-100 border border-gray-200 rounded-xl py-3 px-4 text-sm mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-sm font-semibold mb-2 text-gray-600">New PIN</p>
                    ${pinInputs('reset')}
                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg mt-4">Reset</button>
                </form>
                <button onclick="showLoginScreen()" class="text-sm text-gray-500 hover:text-blue-600 mt-4 block w-full">Back</button>
            </div>`;
            document.getElementById('auth-forms-wrapper').innerHTML = forms;
        }

        function moveToNext(c, n) { if(c.value.length===c.maxLength) document.getElementById(n)?.focus(); }
        function handlePinInput(e, c) { if(e.key==='Backspace' && !e.target.value) { const p = c.slice(0,-1) + (parseInt(c.slice(-1))-1); document.getElementById(p)?.focus(); } }
        function getPin(p) { let s=''; for(let i=1;i<=6;i++){ const v=document.getElementById(`${p}-pin${i}`).value; if(!v) return null; s+=v; } return s; }
        
        function showAuthScreen(id) { ['auth-setup','auth-login','auth-reset'].forEach(x=>document.getElementById(x).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.getElementById(`${id}-pin1`)?.focus(); }
        function showLoginScreen() { showAuthScreen('auth-login'); }
        function showResetScreen() { const q=localStorage.getItem(CONSTANTS.SEC_Q); if(!q) return showToast('Error loading security question', true); document.getElementById('reset-security-q').textContent=q; showAuthScreen('auth-reset'); }
        function setAuthenticated(s) { 
            sessionStorage.setItem(CONSTANTS.AUTH, s?'true':'false'); 
            if(s) { document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); loadData(); renderAll(); }
            else { document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); document.querySelectorAll('.pin-input').forEach(i=>i.value=''); showLoginScreen(); }
        }
        function logout() { if(confirm("Log out?")) setAuthenticated(false); }

        async function handleSetup(e) { e.preventDefault(); const p=getPin('setup'), a=document.getElementById('setup-security-a').value.trim(); if(!p||!a) return showToast("Fill all fields", true); localStorage.setItem(CONSTANTS.PIN, await hashString(p)); localStorage.setItem(CONSTANTS.SEC_Q, document.getElementById('setup-security-q').options[document.getElementById('setup-security-q').selectedIndex].text); localStorage.setItem(CONSTANTS.SEC_A, await hashString(a.toLowerCase())); setAuthenticated(true); }
        async function handleLogin(e) { e.preventDefault(); const p=getPin('login'); if(!p) return; (await hashString(p)) === localStorage.getItem(CONSTANTS.PIN) ? setAuthenticated(true) : showToast("Invalid PIN", true); }
        async function handleReset(e) { e.preventDefault(); const p=getPin('reset'), a=document.getElementById('reset-security-a').value.trim(); if(!p||!a) return; if((await hashString(a.toLowerCase())) === localStorage.getItem(CONSTANTS.SEC_A)) { localStorage.setItem(CONSTANTS.PIN, await hashString(p)); showToast("PIN Reset"); showLoginScreen(); } else showToast("Wrong Answer", true); }

        /* --- DATA MANAGEMENT --- */
        function loadData() {
            const s = localStorage.getItem(CONSTANTS.DATA);
            if (s) {
                appData = JSON.parse(s);
                if(!appData.portfolio) appData.portfolio = [];
                if(!appData.categories) appData.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
                // Migration: If no accounts in saved data, init with default
                if(!appData.accounts || appData.accounts.length === 0) appData.accounts = JSON.parse(JSON.stringify(DEFAULT_ACCOUNTS));
                appData.transactions.forEach(t => { if(!t.tags) t.tags=[]; });
            } else {
                appData.accounts = JSON.parse(JSON.stringify(DEFAULT_ACCOUNTS));
                saveData();
            }
            // CRITICAL FIX: Always recalculate balances from history on load to prevent drift
            recalculateBalances();
            populateAccountFilter();
            populateAccountSelect('rem-account');
        }

        function saveData() { 
            recalculateBalances(); // Always sync math before save
            localStorage.setItem(CONSTANTS.DATA, JSON.stringify(appData)); 
            renderAll(); 
        }
        function resetData() { if(confirm('Delete ALL data permanently?')) { localStorage.removeItem(CONSTANTS.DATA); localStorage.removeItem(CONSTANTS.PIN); location.reload(); } }
        
        // The core fix for the "-10" issue. Balances are derived, not accumulated blindly.
        // UPDATED: Now handles Contra logic correctly via types
        function recalculateBalances() {
            appData.balances = {};
            // Init with base
            appData.accounts.forEach(a => appData.balances[a.id] = (parseFloat(a.initialBalance) || 0));
            
            // Sort Transactions by Date for Correct History (Though balances are commutative)
            appData.transactions.sort((a,b) => new Date(a.date) - new Date(b.date));

            // Replay all transactions
            appData.transactions.forEach(t => {
                const amt = t.amount;
                if (t.type === 'expense') {
                     if (t.items && t.items.length > 0) t.items.forEach(i => appData.balances[i.account] = safeSub(appData.balances[i.account] || 0, i.amount));
                     else appData.balances[t.from] = safeSub(appData.balances[t.from] || 0, amt);
                }
                else if (t.type === 'income') {
                    appData.balances[t.from] = safeAdd(appData.balances[t.from] || 0, amt);
                }
                else if (t.type === 'transfer') {
                    appData.balances[t.from] = safeSub(appData.balances[t.from] || 0, amt);
                    appData.balances[t.to] = safeAdd(appData.balances[t.to] || 0, amt);
                }
                else if (t.type === 'investment') {
                    appData.balances[t.from] = safeSub(appData.balances[t.from] || 0, amt);
                    appData.balances['acc_inv'] = safeAdd(appData.balances['acc_inv'] || 0, amt);
                }
            });
        }
        
        // Removed `updateAccountBalance` local manipulation. We now rely on `recalculateBalances()` + `saveData()` for single source of truth.

        /* --- RENDERING & LOGIC --- */
        function renderAll() {
            updateHeaderStats(); renderAccounts(); renderRecentList(appData.transactions.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0, 10)); // Recent 10 sorted desc
            renderReminders(); renderPortfolio(currentPortfolioView); applyHistoryFilters(); updateCharts();
        }

        function updateHeaderStats() {
            let net = 0, stats = { income: 0, expense: 0, invest: 0, lent: 0 };
            
            // Net Worth: Sum accounts not type 'investment', plus active portfolio value
            // FIX: Use current value of portfolio for Net Worth, but Ledger Balance for specific account
            appData.accounts.forEach(a => { if(a.type!=='investment') net += (appData.balances[a.id] || 0); });
            appData.portfolio.filter(p => p.status === 'active').forEach(p => net += (p.currentValue || p.amount));
            document.getElementById('total-balance').textContent = formatCurrency(net);

            // All Time Stats
            appData.transactions.forEach(t => {
                if(t.type==='income') stats.income += t.amount;
                else if(t.type==='investment') stats.invest += t.amount;
                else if(t.type==='expense') { if((t.category||'').includes('Lent')) stats.lent += t.amount; else stats.expense += t.amount; }
            });
            ['income', 'expense', 'invest', 'lent'].forEach(k => document.getElementById(`snap-${k}`).textContent = formatCurrency(stats[k]));

            // Monthly
            const now = new Date();
            const mTx = appData.transactions.filter(t => { const d=new Date(t.date); return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear(); });
            document.getElementById('monthly-income').textContent = formatCurrency(mTx.filter(t=>t.type==='income' && t.category !== 'Inv Return').reduce((a,b)=>a+b.amount,0)); // Exclude Principal Return
            document.getElementById('monthly-expense').textContent = formatCurrency(mTx.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0));
        }

        function renderAccounts() {
            const c = document.getElementById('account-cards-container'); c.innerHTML = '';
            appData.accounts.forEach(a => {
                // NEW: Added onclick to trigger investment details for Investment pot
                const clickAction = a.id === 'acc_inv' ? `onclick="openInvestmentDetails()"` : '';
                const cursorClass = a.id === 'acc_inv' ? 'cursor-pointer active:scale-95 transition-transform' : '';
                
                c.innerHTML += `<div ${clickAction} class="min-w-[140px] h-24 rounded-2xl bg-gradient-to-br ${a.color} text-white p-4 flex flex-col justify-between shadow-md shrink-0 relative overflow-hidden ${cursorClass}"><div class="absolute right-[-10px] top-[-10px] opacity-20"><i class="ph ${a.icon} text-6xl"></i></div><div class="text-[10px] font-bold opacity-90 uppercase tracking-wide relative z-10">${a.name}</div><div class="font-bold text-lg truncate relative z-10">${formatCurrency(appData.balances[a.id]||0)}</div></div>`;
            });
        }
        
        // NEW: Open Investment Details Table
        function openInvestmentDetails() {
            const tbody = document.getElementById('invest-detail-body');
            tbody.innerHTML = '';
            
            // Sort by Date Desc
            const sorted = [...appData.portfolio].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(sorted.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-400">No investments found</td></tr>';
            } else {
                sorted.forEach(p => {
                    const isRedeemed = p.status === 'redeemed';
                    const growth = isRedeemed ? (p.finalAmount - p.amount) : ((p.currentValue || p.amount) - p.amount);
                    const colorClass = growth >= 0 ? 'text-green-600' : 'text-red-600';
                    const sign = growth >= 0 ? '+' : '';
                    
                    // Format Dates
                    const buyDt = new Date(p.date).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'2-digit'});
                    const sellDt = isRedeemed && p.redeemDate ? new Date(p.redeemDate).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'2-digit'}) : '-';

                    const row = `
                        <tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0">
                            <td class="p-4">
                                <div class="font-bold text-gray-800">${p.name}</div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-wide">${p.type}</div>
                            </td>
                            <td class="p-4 text-xs text-gray-600 font-medium">${buyDt}</td>
                            <td class="p-4 text-xs text-gray-600 font-medium">${sellDt}</td>
                            <td class="p-4 text-right font-bold text-gray-700">${formatCurrency(p.amount)}</td>
                            <td class="p-4 text-right font-bold text-gray-600">${isRedeemed ? formatCurrency(p.finalAmount) : '-'}</td>
                            <td class="p-4 text-right font-bold ${colorClass}">
                                <div>${sign}${formatCurrency(growth)}</div>
                            </td>
                            <td class="p-4 text-center">
                                <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${isRedeemed ? 'bg-gray-100 text-gray-500' : 'bg-indigo-50 text-indigo-600'}">
                                    ${p.status}
                                </span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            openModal('investment-detail');
        }

        function renderRecentList(list, targetId='recent-transactions') {
            const c = document.getElementById(targetId); c.innerHTML = '';
            if(list.length === 0) { c.innerHTML = '<div class="text-center text-gray-400 py-8 text-sm">No transactions yet</div>'; return; }
            list.forEach(t => c.innerHTML += renderTransactionCard(t));
        }

        function renderTransactionCard(t) {
            const conf = TX_CONFIG[t.type];
            let accName = appData.accounts.find(a => a.id === t.from)?.name || 'Unknown';
            // Show "Mixed" if items exist and have different accounts
            if (t.from === 'mixed') accName = 'Multiple Accounts';
            else if(t.type === 'transfer') accName += ` → ${appData.accounts.find(a => a.id === t.to)?.name || 'Unknown'}`;
            else if(t.type === 'income') accName = `To: ${accName}`;
            else if(t.type === 'investment') accName += ` → Investment Pot`;
            
            const isNeg = t.type === 'expense' || t.type === 'investment' || (t.type === 'transfer');
            const tagsHtml = (t.tags||[]).map(tag => `<span class="bg-gray-100 text-gray-500 px-1.5 rounded text-[9px]">#${tag}</span>`).join('');

            // Generate Mini-Table for Items with Source Account Name
            let itemsHtml = '';
            if(t.items && t.items.length > 0) {
                itemsHtml = `<div class="mt-2 pt-2 border-t border-dashed border-gray-100 space-y-0.5">`;
                t.items.forEach(i => {
                    const iAccName = appData.accounts.find(a=>a.id === i.account)?.name || 'Unknown';
                    itemsHtml += `<div class="flex justify-between text-[10px] text-gray-500">
                        <span class="truncate pr-2">${i.name} <span class="text-gray-300">|</span> <span class="text-xs text-blue-500">${iAccName}</span></span>
                        <span class="font-medium shrink-0">₹${i.amount}</span>
                    </div>`;
                });
                itemsHtml += `</div>`;
            }

            return `<div class="bg-white rounded-xl p-3 shadow-sm border border-gray-50 flex flex-col">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${conf.bg} ${conf.text} shrink-0"><i class="ph ${conf.icon} text-xl"></i></div>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${t.category}</div>
                            <div class="text-xs text-gray-500">${t.note || ''}</div>
                            <div class="text-[10px] text-gray-400 font-medium mt-0.5">${accName}</div>
                            <div class="flex gap-1 mt-1">${tagsHtml}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="font-bold text-sm ${isNeg ? 'text-gray-800' : 'text-green-600'}">${t.type==='transfer'||t.type==='investment'?'':(isNeg?'-':'+')} ${formatCurrency(t.amount).replace('₹ ', '₹')}</div>
                            <div class="text-[10px] text-gray-400">${new Date(t.date).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'2-digit'})}</div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editTransaction(${t.id})" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100"><i class="ph ph-pencil-simple"></i></button>
                            <button onclick="deleteTransaction(${t.id})" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:bg-red-50 hover:text-red-500"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                </div>
                ${itemsHtml}
            </div>`;
        }

        /* --- FILTERS --- */
        function applyHistoryFilters() {
            let r = [...appData.transactions];
            const s = document.getElementById('history-search').value.toLowerCase().trim();
            const d = document.getElementById('filter-date').value;
            const a = document.getElementById('filter-account').value;
            const o = document.getElementById('filter-sort').value;

            if (s) {
                r = r.filter(t => 
                    (t.category || '').toLowerCase().includes(s) || 
                    (t.note || '').toLowerCase().includes(s) || 
                    t.amount.toString().includes(s) || 
                    (t.tags || []).some(tag => tag.toLowerCase().includes(s))
                );
            }

            if (filterState.type !== 'all') {
                r = r.filter(t => t.type === filterState.type);
            }

            if (d !== 'all') {
                const now = new Date();
                r = r.filter(t => {
                    const txDate = new Date(t.date);
                    if (d === 'thisMonth') return txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear();
                    if (d === 'lastMonth') {
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        return txDate.getMonth() === lastMonth.getMonth() && txDate.getFullYear() === lastMonth.getFullYear();
                    }
                    if (d === 'thisYear') return txDate.getFullYear() === now.getFullYear();
                    return true;
                });
            }

            if (a !== 'all') {
                r = r.filter(t => 
                    t.from === a || 
                    t.to === a || 
                    (t.items && t.items.some(i => i.account === a))
                );
            }

            r.sort((x, y) => {
                if (o === 'amount-desc') return y.amount - x.amount;
                return new Date(y.date) - new Date(x.date);
            });

            let stats = { income: 0, expense: 0, invest: 0, transfer: 0, lent: 0 };
            r.forEach(t => {
                if (t.type === 'income') stats.income += t.amount;
                else if (t.type === 'investment') stats.invest += t.amount;
                else if (t.type === 'transfer') stats.transfer += t.amount;
                else { 
                    if ((t.category||'').includes('Lent')) stats.lent += t.amount;
                    else stats.expense += t.amount;
                }
            });

            document.getElementById('h-inc').textContent = formatCurrency(stats.income);
            document.getElementById('h-exp').textContent = formatCurrency(stats.expense);
            document.getElementById('h-inv').textContent = formatCurrency(stats.invest);
            document.getElementById('h-tra').textContent = formatCurrency(stats.transfer);
            document.getElementById('h-len').textContent = formatCurrency(stats.lent);

            renderRecentList(r, 'full-history-list');
        }

        function setQuickFilter(type) {
            filterState.type = type;
            document.querySelectorAll('.filter-chip').forEach(b => {
                b.classList.toggle('active', b.id === `chip-${type}`);
            });
            applyHistoryFilters();
        }

        function resetFilters() {
            document.getElementById('history-search').value = '';
            document.getElementById('filter-date').value = 'all';
            document.getElementById('filter-account').value = 'all';
            document.getElementById('filter-sort').value = 'date-desc';
            setQuickFilter('all');
            closeModal('filter');
        }

        /* --- TRANSACTIONS & CATEGORIES --- */
        function setTxType(t) {
            document.getElementById('tx-type').value = t;
            ['expense','income','transfer','investment'].forEach(x => {
                const btn = document.getElementById(`btn-${x}`);
                const conf = TX_CONFIG[x];
                btn.className = `flex-1 py-2.5 rounded-lg text-xs font-bold uppercase border transition-all ${x===t ? `bg-white ${conf.btnStyle}` : 'text-gray-400 hover:bg-gray-100'}`;
            });
            
            populateAccountSelect('tx-from-account');
            const isTransfer = t === 'transfer';
            document.getElementById('field-to-account').classList.toggle('hidden', !isTransfer);
            document.getElementById('field-category').classList.toggle('hidden', isTransfer);
            document.getElementById('field-maturity').classList.toggle('hidden', t !== 'investment');
            
            if(isTransfer) populateAccountSelect('tx-to-account');
            else renderCategoryChips(t);
        }

        function renderCategoryChips(type) {
            const container = document.getElementById('category-selection-container');
            container.innerHTML = '';
            (appData.categories[type] || []).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-chip px-4 py-2 rounded-full text-xs font-medium bg-white text-gray-600';
                btn.textContent = cat;
                btn.type = 'button';
                btn.onclick = () => selectCategory(cat, btn);
                container.appendChild(btn);
            });
            const addBtn = document.createElement('button');
            addBtn.className = 'category-chip px-3 py-2 rounded-full text-xs font-bold border-dashed border-2 border-gray-300 text-blue-600 bg-blue-50';
            addBtn.innerHTML = '<i class="ph ph-plus"></i> Add';
            addBtn.type = 'button';
            addBtn.onclick = () => addNewCategory(type);
            container.appendChild(addBtn);
        }

        function selectCategory(cat, el) {
            document.getElementById('tx-category').value = cat;
            document.querySelectorAll('.category-chip').forEach(b => b.classList.remove('selected'));
            if(el) el.classList.add('selected');
            else Array.from(document.querySelectorAll('.category-chip')).find(b => b.textContent === cat)?.classList.add('selected');
        }

        function addNewCategory(type) {
            const name = prompt(`New ${type} category:`);
            if(name?.trim()) {
                const clean = name.trim();
                if(!appData.categories[type].includes(clean)) {
                    appData.categories[type].push(clean);
                    saveData();
                    renderCategoryChips(type);
                    selectCategory(clean);
                    showToast(`Added ${clean}`);
                } else showToast('Category exists', true);
            }
        }

        /* --- MATH & BREAKDOWN --- */
        function evaluateMath(el) {
            let val = el.value.trim();
            if (/^[0-9+\-*/.\s()]+$/.test(val)) {
                try {
                    const result = Function('"use strict";return (' + val + ')')();
                    if(isFinite(result)) {
                        el.value = parseFloat(result).toFixed(2).replace(/\.00$/, '');
                    }
                } catch (e) { /* ignore */ }
            }
        }
        
        function toggleBreakdown() {
            const box = document.getElementById('tx-breakdown');
            box.classList.toggle('hidden');
            if(!box.classList.contains('hidden') && document.getElementById('breakdown-list').children.length === 0) {
                const mainAcc = document.getElementById('tx-from-account').value;
                addBreakdownItem('', '', mainAcc);
            }
        }

        function getAccountOptionsHtml(selectedId) {
            let html = '';
            appData.accounts.forEach(a => {
                if(a.type !== 'investment') {
                    html += `<option value="${a.id}" ${a.id === selectedId ? 'selected' : ''}>${a.name}</option>`;
                }
            });
            return html;
        }

        function addBreakdownItem(name='', cost='', accId='') {
            const div = document.createElement('div');
            div.className = 'flex flex-wrap sm:flex-nowrap gap-2 items-center bg-white sm:bg-transparent p-2 sm:p-0 rounded-lg border sm:border-0 border-gray-100 shadow-sm sm:shadow-none mb-2 sm:mb-0';
            if(!accId) accId = appData.accounts[0].id;
            div.innerHTML = `
                <input type="text" placeholder="Item Name" value="${name}" class="bd-name w-full sm:w-auto sm:flex-[2] bg-gray-50 sm:bg-white border border-gray-200 rounded-lg py-2 px-3 text-xs outline-none focus:border-blue-500 transition-colors">
                <div class="relative w-[40%] sm:w-auto sm:flex-1">
                     <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xs">₹</span>
                     <input type="number" placeholder="0" value="${cost}" oninput="updateTotalFromBreakdown()" class="bd-cost w-full bg-gray-50 sm:bg-white border border-gray-200 rounded-lg py-2 pl-5 pr-2 text-xs outline-none focus:border-blue-500 font-bold text-right transition-colors" inputmode="decimal">
                </div>
                <select class="bd-account flex-1 sm:w-auto sm:flex-1 bg-gray-50 sm:bg-white border border-gray-200 rounded-lg py-2 px-1 text-xs outline-none focus:border-blue-500 truncate transition-colors">
                    ${getAccountOptionsHtml(accId)}
                </select>
                <button type="button" onclick="this.parentElement.remove(); updateTotalFromBreakdown()" class="text-red-400 hover:text-red-600 p-1 sm:p-0 rounded-full hover:bg-red-50 sm:hover:bg-transparent transition-colors"><i class="ph ph-trash text-lg sm:text-base"></i></button>
            `;
            document.getElementById('breakdown-list').appendChild(div);
        }

        function updateTotalFromBreakdown() {
            let total = 0;
            document.querySelectorAll('.bd-cost').forEach(inp => total += parseFloat(inp.value) || 0);
            if(total > 0) document.getElementById('tx-amount').value = total;
        }

        function handleTransactionSubmit(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('tx-amount').value),
                  type = document.getElementById('tx-type').value,
                  from = document.getElementById('tx-from-account').value,
                  editId = document.getElementById('editing-tx-id').value;

            if(!amt || amt <= 0) return showToast("Invalid Amount", true);

            // Removing existing tx if edit
            if(editId) {
                const idx = appData.transactions.findIndex(t => t.id == editId);
                if(idx > -1) { 
                    // Special Handling for Investment Edit: If we remove investment, we must remove it from portfolio
                    if(appData.transactions[idx].type === 'investment') {
                        const pIdx = appData.portfolio.findIndex(p => p.id == editId);
                        if(pIdx > -1) appData.portfolio.splice(pIdx, 1);
                    }
                    appData.transactions.splice(idx, 1); 
                }
            }

            const breakdownItems = [];
            document.querySelectorAll('#breakdown-list > div').forEach(row => {
                const name = row.querySelector('.bd-name').value.trim();
                const cost = parseFloat(row.querySelector('.bd-cost').value);
                const acc = row.querySelector('.bd-account').value;
                if(name && cost && acc) breakdownItems.push({ name, amount: cost, account: acc });
            });

            let finalFrom = from;
            if (breakdownItems.length > 0) {
                const accountsUsed = [...new Set(breakdownItems.map(i => i.account))];
                if (accountsUsed.length > 1) finalFrom = 'mixed';
                else if(accountsUsed.length === 1) finalFrom = accountsUsed[0];
            }

            const tx = {
                id: editId ? parseInt(editId) : Date.now(),
                type, amount: amt, from: finalFrom,
                date: document.getElementById('tx-date').value,
                note: document.getElementById('tx-note').value,
                tags: document.getElementById('tx-tags').value.split(',').map(t=>t.trim()).filter(t=>t),
                items: breakdownItems
            };

            if (type === 'transfer') {
                tx.to = document.getElementById('tx-to-account').value;
                if(from === tx.to) return showToast("Accounts must be different", true);
                tx.category = 'Transfer';
            } else {
                tx.category = document.getElementById('tx-category').value;
                if(!tx.category) return showToast("Select Category", true);
                
                if(type === 'income') { tx.to = from; }
                else if(type === 'investment') {
                    tx.to = 'acc_inv';
                    // Add or Update Portfolio Item
                    const pItem = {
                        id: tx.id, name: tx.note || tx.category, type: tx.category,
                        amount: amt, currentValue: amt, date: tx.date, status: 'active',
                        maturityDate: document.getElementById('tx-maturity').value
                    };
                    
                    const existingPIdx = appData.portfolio.findIndex(p => p.id === tx.id);
                    if(existingPIdx > -1) appData.portfolio[existingPIdx] = pItem;
                    else appData.portfolio.push(pItem);
                }
            }

            appData.transactions.push(tx);
            
            if(activeReminderIndex !== null) {
                const r = appData.reminders[activeReminderIndex];
                if(amt < r.amount) {
                    r.amount -= amt;
                    showToast(`Remaining: ${formatCurrency(r.amount)}`);
                } else {
                    appData.reminders.splice(activeReminderIndex, 1);
                }
                activeReminderIndex = null;
            }
            
            saveData();
            closeModal('transaction');
            showToast("Transaction Saved");
        }

        // REMOVED `revertBalance` function as it's unsafe. We use `recalculateBalances` now.

        function editTransaction(id) {
            const tx = appData.transactions.find(t => t.id === id);
            if(!tx) return;
            openModal('transaction');
            document.getElementById('tx-modal-title').textContent = "Edit Transaction";
            document.getElementById('editing-tx-id').value = tx.id;
            setTxType(tx.type);
            document.getElementById('tx-amount').value = tx.amount;
            document.getElementById('tx-date').value = tx.date;
            document.getElementById('tx-note').value = tx.note || '';
            
            if (tx.from !== 'mixed') document.getElementById('tx-from-account').value = tx.from;
            document.getElementById('tx-tags').value = (tx.tags || []).join(', ');
            
            document.getElementById('breakdown-list').innerHTML = '';
            if(tx.items && tx.items.length > 0) {
                document.getElementById('tx-breakdown').classList.remove('hidden');
                tx.items.forEach(i => addBreakdownItem(i.name, i.amount, i.account));
            } else {
                document.getElementById('tx-breakdown').classList.add('hidden');
            }
            
            if(tx.type === 'transfer') document.getElementById('tx-to-account').value = tx.to;
            else if(tx.type === 'investment') {
                const p = appData.portfolio.find(p => p.id === tx.id);
                if(p?.maturityDate) document.getElementById('tx-maturity').value = p.maturityDate;
                setTimeout(() => selectCategory(tx.category), 50);
            } else {
                setTimeout(() => selectCategory(tx.category), 50);
            }
        }

        function deleteTransaction(id) {
            if(confirm("Delete this transaction?")) {
                const idx = appData.transactions.findIndex(t => t.id === id);
                if(idx > -1) { 
                     // Also remove from portfolio if investment
                     if(appData.transactions[idx].type === 'investment') {
                        const pIdx = appData.portfolio.findIndex(p => p.id === id);
                        if(pIdx > -1) appData.portfolio.splice(pIdx, 1);
                     }
                     appData.transactions.splice(idx, 1); 
                     saveData(); 
                     showToast("Deleted"); 
                }
            }
        }

        /* --- REMINDERS --- */
        function setRemType(t) {
            currentRemType = t; document.getElementById('rem-type').value = t;
            const map = { bill: { id:'rt-bill', style:'bg-blue-50 text-blue-700 border-blue-500' }, loan_taken: { id:'rt-loan_taken', style:'bg-red-50 text-red-700 border-red-500' }, loan_given: { id:'rt-loan_given', style:'bg-emerald-50 text-emerald-700 border-emerald-500' } };
            document.querySelectorAll('#reminder-modal button[type="button"]').forEach(b => b.className = 'py-2 rounded-lg text-xs font-bold border text-gray-500 hover:bg-gray-50 transition-all');
            document.getElementById(map[t].id).className = `py-2 rounded-lg text-xs font-bold border transition-all ${map[t].style}`;
            
            const isLoan = t !== 'bill';
            document.getElementById('record-tx-option').classList.toggle('hidden', !isLoan);
            document.getElementById('record-tx-account').classList.toggle('hidden', !isLoan);
        }

        function handleReminderSubmit(e) {
            e.preventDefault();
            const r = {
                title: document.getElementById('rem-title').value,
                amount: parseFloat(document.getElementById('rem-amount').value),
                date: document.getElementById('rem-date').value,
                type: currentRemType
            };
            appData.reminders.push(r);
            
            if(document.getElementById('record-now').checked && currentRemType !== 'bill') {
                const acc = document.getElementById('rem-account').value;
                const isGiven = currentRemType === 'loan_given';
                const tx = {
                    id: Date.now(),
                    type: isGiven ? 'expense' : 'income',
                    amount: r.amount, date: r.date, from: acc,
                    category: isGiven ? 'Lent' : 'Loan Back',
                    note: `${isGiven?'Lent to':'Borrowed from'}: ${r.title}`,
                    tags: ['alert']
                };
                if(!isGiven) tx.to = acc;
                // updateAccountBalance removed, handled by Save
                appData.transactions.push(tx);
            }
            saveData(); closeModal('reminder'); showToast("Alert Saved");
        }

        function resolveAlert(i) {
            activeReminderIndex = i; const r = appData.reminders[i];
            openModal('transaction');
            document.getElementById('tx-amount').value = r.amount;
            document.getElementById('tx-note').value = r.title;
            if(r.type === 'loan_given') { setTxType('income'); setTimeout(()=>selectCategory('Loan Back'), 100); }
            else if(r.type === 'loan_taken') { setTxType('expense'); setTimeout(()=>selectCategory('Lent'), 100); }
            else { setTxType('expense'); setTimeout(()=>selectCategory('Bills'), 100); }
            showToast('Verify details', false);
        }

        function renderReminders() {
            const c = document.getElementById('all-reminders'), al = document.getElementById('alerts-list');
            c.innerHTML = ''; al.innerHTML = '';
            if(appData.reminders.length === 0) { c.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">No alerts</div>'; document.getElementById('alerts-section').style.display = 'none'; return; }
            
            let hasAlerts = false;
            appData.reminders.forEach((r, i) => {
                const days = Math.ceil((new Date(r.date) - new Date()) / 86400000);
                if(days <= 3) hasAlerts = true;
                const color = r.type === 'loan_given' ? 'border-green-500' : r.type === 'loan_taken' ? 'border-red-500' : 'border-blue-500';
                const html = `<div class="bg-white border-l-4 ${color} p-3 rounded-r-xl shadow-sm flex justify-between items-center mb-2">
                    <div><div class="font-bold text-sm">${r.title}</div><div class="text-xs text-gray-500">${days < 0 ? 'Overdue' : days + ' days'}</div></div>
                    <div class="flex gap-2"><span class="font-bold text-sm">${formatCurrency(r.amount)}</span>
                        <button onclick="resolveAlert(${i})" class="bg-green-50 text-green-600 w-8 h-8 rounded-full flex items-center justify-center"><i class="ph ph-check-bold"></i></button>
                        <button onclick="appData.reminders.splice(${i},1);saveData()" class="text-red-400 w-8 h-8 flex items-center justify-center"><i class="ph ph-trash"></i></button>
                    </div></div>`;
                c.innerHTML += html;
                if(days <= 3) al.innerHTML += html;
            });
            document.getElementById('alerts-section').style.display = hasAlerts ? 'block' : 'none';
        }

        /* --- PORTFOLIO --- */
        function renderPortfolio(status) {
            currentPortfolioView = status;
            const c = document.getElementById('portfolio-list'); c.innerHTML = '';
            const isActive = status === 'active';
            document.getElementById('tab-active').className = isActive ? 'flex-1 py-2 rounded-lg bg-white shadow-sm text-gray-800 transition-all' : 'flex-1 py-2 rounded-lg text-gray-500 transition-all';
            document.getElementById('tab-redeemed').className = !isActive ? 'flex-1 py-2 rounded-lg bg-white shadow-sm text-gray-800 transition-all' : 'flex-1 py-2 rounded-lg text-gray-500 transition-all';
            
            let total = 0;
            appData.portfolio.filter(p => p.status === 'active').forEach(p => total += (p.currentValue || p.amount));
            document.getElementById('portfolio-total').textContent = formatCurrency(total);

            const list = appData.portfolio.filter(p => p.status === status);
            if(list.length === 0) { c.innerHTML = `<div class="text-center text-gray-400 py-8 text-sm">No ${status} investments</div>`; return; }

            list.forEach(p => {
                let footer = '';
                if(isActive) {
                    const growth = (p.currentValue || p.amount) - p.amount;
                    const perc = p.amount > 0 ? ((growth/p.amount)*100).toFixed(1) : 0;
                    footer = `<div class="flex justify-between w-full text-xs mt-2 pt-2 border-t border-gray-100"><span class="text-gray-400">Princ: ${formatCurrency(p.amount)}</span><span class="font-bold ${growth>=0?'text-green-600':'text-red-600'}">${growth>=0?'+':''}${formatCurrency(growth)} (${perc}%)</span></div>`;
                } else {
                    const profit = p.finalAmount - p.amount;
                    footer = `<div class="mt-2 pt-2 border-t border-gray-100 text-xs font-bold ${profit>=0?'text-green-600':'text-red-600'}">${profit>=0?'Profit':'Loss'}: ${formatCurrency(Math.abs(profit))}</div>`;
                }

                c.innerHTML += `<div class="inv-card-bg p-4 rounded-xl border border-gray-100 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div><div class="text-xs text-indigo-500 font-bold uppercase">${p.type}</div><div class="font-bold text-gray-800 text-lg">${p.name}</div><div class="text-[10px] text-gray-400">Val: ${formatCurrency(isActive ? (p.currentValue||p.amount) : p.finalAmount)}</div></div>
                        ${isActive ? `<div class="flex gap-1"><button onclick="updateInvestValue(${p.id})" class="w-7 h-7 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="ph ph-trend-up"></i></button><button onclick="openRedeemModal(${p.id})" class="bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full">Redeem</button></div>` : ''}
                    </div>
                    ${footer}
                </div>`;
            });
        }

        function updateInvestValue(id) {
            const p = appData.portfolio.find(x => x.id === id);
            const val = prompt(`Update Market Value for ${p.name}:`, p.currentValue || p.amount);
            if(val && !isNaN(parseFloat(val))) { p.currentValue = parseFloat(val); saveData(); showToast("Updated"); }
        }

        function openRedeemModal(id) {
            const p = appData.portfolio.find(x => x.id === id);
            document.getElementById('redeem-id').value = id;
            document.getElementById('redeem-principal').value = formatCurrency(p.amount);
            document.getElementById('redeem-curr-val').value = formatCurrency(p.currentValue || p.amount);
            document.getElementById('redeem-amount').value = '';
            populateAccountSelect('redeem-to-account');
            openModal('redeem');
        }

        // CORRECTED REDEEM LOGIC: Split into Principal (Transfer) and Profit (Income)
        function handleRedeemSubmit(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('redeem-id').value),
                  amt = parseFloat(document.getElementById('redeem-amount').value),
                  to = document.getElementById('redeem-to-account').value;
            
            if(!amt || amt <= 0) return;
            const p = appData.portfolio.find(x => x.id === id);
            const currentVal = p.currentValue || p.amount;

            if (amt < currentVal) {
                // PARTIAL REDEEM
                if(confirm(`Confirm Partial Redeem of ${formatCurrency(amt)}?\nInvestment will remain active.`)) {
                     const ratio = amt / currentVal;
                     // Logic: We must reduce principal pro-rata to keep the books honest
                     const principalPortion = safeSub(p.amount, p.amount * (1 - ratio));
                     const profitPortion = safeSub(amt, principalPortion);

                     p.amount = safeSub(p.amount, principalPortion);
                     p.currentValue = safeSub(currentVal, amt);
                     
                     // 1. Principal Return (Transfer: Inv -> Bank)
                     if(principalPortion > 0) {
                        appData.transactions.push({
                            id: Date.now(), type: 'transfer', category: 'Inv Principal', amount: principalPortion,
                            date: new Date().toISOString().split('T')[0], note: `Partial Principal: ${p.name}`, from: 'acc_inv', to: to
                        });
                     }
                     // 2. Profit (Income)
                     if(profitPortion > 0) {
                         appData.transactions.push({
                            id: Date.now() + 1, type: 'income', category: 'Capital Gains', amount: profitPortion,
                            date: new Date().toISOString().split('T')[0], note: `Partial Profit: ${p.name}`, from: to, to: to
                         });
                     }
                     
                     saveData(); closeModal('redeem'); showToast("Partial Redeem Success");
                }
            } else {
                // FULL REDEEM
                p.status = 'redeemed'; p.finalAmount = amt; p.redeemDate = new Date().toISOString();
                
                const principal = p.amount;
                const profit = safeSub(amt, principal);

                // 1. Return Principal (Transfer: Inv -> Bank)
                appData.transactions.push({
                    id: Date.now(), type: 'transfer', category: 'Inv Principal', amount: principal,
                    date: new Date().toISOString().split('T')[0], note: `Principal Return: ${p.name}`, from: 'acc_inv', to: to
                });

                // 2. Record Profit (Income) OR Loss (Expense)
                if (profit > 0) {
                    appData.transactions.push({
                        id: Date.now()+1, type: 'income', category: 'Capital Gains', amount: profit,
                        date: new Date().toISOString().split('T')[0], note: `Profit: ${p.name}`, from: to, to: to
                    });
                } else if (profit < 0) {
                    // Loss logic: We already moved full principal back? No.
                    // If we lost money, we move LESS principal back. The rest stays in Inv Pot? 
                    // No, the loss is realized. 
                    // Actually, if profit < 0, it means we got back LESS than principal.
                    // The Transfer above moved FULL principal. That was wrong.
                    
                    // CORRECTION FOR LOSS:
                    // Remove the transfer above.
                    appData.transactions.pop();
                    
                    // Transfer only what we got back (amt)
                    appData.transactions.push({
                        id: Date.now(), type: 'transfer', category: 'Inv Return (Loss)', amount: amt,
                        date: new Date().toISOString().split('T')[0], note: `Return: ${p.name}`, from: 'acc_inv', to: to
                    });
                    
                    // We must also write-off the remaining balance in acc_inv (The Loss)
                    // We do this by creating an Expense from 'acc_inv'
                    const lossAmount = Math.abs(profit);
                    appData.transactions.push({
                        id: Date.now()+1, type: 'expense', category: 'Inv Loss', amount: lossAmount,
                        date: new Date().toISOString().split('T')[0], note: `Realized Loss: ${p.name}`, from: 'acc_inv'
                    });
                }

                saveData(); closeModal('redeem'); showToast("Redeemed Successfully");
            }
        }

        /* --- ACCOUNT MANAGEMENT --- */
        function openAccountEditModal(id=null) {
            closeModal('accounts-list');
            openModal('account-edit');
            const form = document.querySelector('#account-edit-modal form');
            form.reset();
            
            if (id) {
                const acc = appData.accounts.find(a => a.id === id);
                document.getElementById('acc-modal-title').textContent = 'Edit Account';
                document.getElementById('acc-id').value = acc.id;
                document.getElementById('acc-name').value = acc.name;
                document.getElementById('acc-type').value = acc.type;
                document.getElementById('acc-initial').value = acc.initialBalance || 0;
                selectAccountColor(acc.color);
            } else {
                document.getElementById('acc-modal-title').textContent = 'Add Account';
                document.getElementById('acc-id').value = '';
                selectAccountColor(ACCOUNT_COLORS[0].val); // Default first color
            }
        }

        function selectAccountColor(val, el=null) {
            document.getElementById('acc-color').value = val;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            if(el) el.classList.add('selected');
            else {
                // Find by value
                const found = Array.from(document.querySelectorAll('.color-dot')).find(d => d.classList.contains(val.split(' ')[0])); // Simple check
                if(found) found.classList.add('selected');
            }
        }

        function handleAccountSave(e) {
            e.preventDefault();
            const id = document.getElementById('acc-id').value;
            const name = document.getElementById('acc-name').value;
            const type = document.getElementById('acc-type').value;
            const color = document.getElementById('acc-color').value;
            const initial = parseFloat(document.getElementById('acc-initial').value) || 0;

            if (id) {
                // Edit
                const acc = appData.accounts.find(a => a.id === id);
                if(acc) {
                    acc.name = name; acc.type = type; acc.color = color; acc.initialBalance = initial;
                }
            } else {
                // Add
                const newId = 'acc_' + Date.now();
                let icon = 'ph-wallet';
                if(type==='bank') icon='ph-bank'; else if(type==='credit') icon='ph-credit-card'; else if(type==='investment') icon='ph-trend-up';
                
                appData.accounts.push({ id: newId, name, type, color, icon, initialBalance: initial });
            }
            saveData();
            closeModal('account-edit');
            showToast('Account Saved');
        }

        function deleteAccount(id) {
            // Check usage
            const used = appData.transactions.some(t => t.from === id || t.to === id || (t.items && t.items.some(i => i.account === id)));
            if (used) return showToast("Account has transactions. Cannot delete.", true);
            if (appData.accounts.length <= 1) return showToast("Keep at least one account", true);
            
            if (confirm('Delete this account?')) {
                appData.accounts = appData.accounts.filter(a => a.id !== id);
                saveData();
                renderManageAccountsList(); // Refresh list
                renderAll(); // Refresh main view
                showToast('Deleted');
            }
        }

        function renderManageAccountsList() {
            const c = document.getElementById('manage-accounts-container');
            c.innerHTML = '';
            appData.accounts.forEach(a => {
                c.innerHTML += `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br ${a.color} text-white flex items-center justify-center"><i class="ph ${a.icon} text-lg"></i></div>
                            <div>
                                <div class="font-bold text-sm text-gray-800">${a.name}</div>
                                <div class="text-xs text-gray-500 capitalize">${a.type} • Init: ₹${a.initialBalance||0}</div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="openAccountEditModal('${a.id}')" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-blue-600 flex items-center justify-center"><i class="ph ph-pencil-simple"></i></button>
                            ${a.id !== 'acc_inv' ? `<button onclick="deleteAccount('${a.id}')" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-red-500 flex items-center justify-center"><i class="ph ph-trash"></i></button>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        /* --- SUPPORT --- */
        function populateAccountSelect(id) { const s=document.getElementById(id); s.innerHTML=''; appData.accounts.forEach(a=>{ if(a.type!=='investment') s.innerHTML+=`<option value="${a.id}">${a.name}</option>` }); }
        function populateAccountFilter() { const s=document.getElementById('filter-account'); s.innerHTML='<option value="all">All Accounts</option>'; appData.accounts.forEach(a=>s.innerHTML+=`<option value="${a.id}">${a.name}</option>`); }
        function handleFileSelect(e) { const r=new FileReader(); r.onload=ev=>{ try{appData=JSON.parse(ev.target.result);saveData();location.reload();}catch(x){showToast("Error importing file", true);} }; r.readAsText(e.target.files[0]); }
        function triggerImport(){document.getElementById('import-file').click()} 
        function exportData(){ const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
			const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData)); const a=document.createElement('a'); a.href=s; a.download=`smart_gen_backup_${dateStr}_${timeStr}.json`; document.body.appendChild(a); a.click(); a.remove(); }
        
        /* --- UI MANAGERS --- */
        function switchTab(t) { ['dashboard','portfolio','analytics','planning','history'].forEach(x=>document.getElementById(`view-${x}`).classList.add('hidden')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.innerText.toLowerCase().includes(t==='dashboard'?'home':t))); if(t==='portfolio') renderPortfolio('active'); if(t==='analytics') updateCharts(); if(t==='history') applyHistoryFilters(); }
        
        function openModal(n) { 
            document.getElementById(`${n}-modal`).classList.remove('hidden'); 
            if(n==='transaction') { 
                document.getElementById('tx-modal-title').innerText="New Transaction"; 
                document.getElementById('editing-tx-id').value=""; 
                document.getElementById('tx-form').reset(); 
                document.getElementById('tx-date').value = new Date().toISOString().split('T')[0]; 
                document.getElementById('breakdown-list').innerHTML = '';
                document.getElementById('tx-breakdown').classList.add('hidden');
                setTxType('expense');
                document.getElementById('tx-amount').focus();
            } 
            if(n==='reminder') { 
                document.getElementById('reminder-form').reset(); 
                setRemType('bill'); 
                document.getElementById('rem-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('rem-title').focus();
            }
            if(n==='accounts-list') renderManageAccountsList();
        }
        function closeModal(n) { document.getElementById(`${n}-modal`).classList.add('hidden'); if(n==='transaction') activeReminderIndex=null; }

        function updateCharts() {
            const p=document.getElementById('analytics-period').value, now=new Date(); 
            let f=appData.transactions.filter(t=>{ const d=new Date(t.date); if(p==='all')return true; if(p==='thisMonth') return d.getMonth()===now.getMonth(); if(p==='lastMonth') return d.getMonth()===now.getMonth()-1; if(p==='yearToDate') return d.getFullYear()===now.getFullYear(); return d>new Date(now.setMonth(now.getMonth()-3)); }); 
            const sd={}; f.filter(t=>t.type==='expense').forEach(t=>sd[t.category]=(sd[t.category]||0)+t.amount); 
            if(charts.spending)charts.spending.destroy(); 
            // UPDATED: Charts now responsive
            charts.spending=new Chart(document.getElementById('spendingChart'), {type:'doughnut',data:{labels:Object.keys(sd),datasets:[{data:Object.values(sd),backgroundColor:['#f87171','#fb923c','#fbbf24','#a3e635','#34d399','#22d3ee','#818cf8']}]}, options: { responsive: true, maintainAspectRatio: false }}); 
            
            let c=0,b=0,i=0; appData.accounts.forEach(a=>{if(a.type==='cash')c+=appData.balances[a.id]||0;else if(a.type==='bank')b+=appData.balances[a.id]||0;else i+=appData.balances[a.id]||0;});
            if(charts.investment)charts.investment.destroy(); 
            charts.investment=new Chart(document.getElementById('investmentChart'), {type:'pie',data:{labels:['Cash','Bank','Inv'],datasets:[{data:[c,b,i],backgroundColor:['#34d399','#3b82f6','#8b5cf6']}]}, options: { responsive: true, maintainAspectRatio: false }});

            const md={}; f.filter(t=>t.type==='expense').forEach(t=>{const k=new Date(t.date).toLocaleString('default',{month:'short'});md[k]=(md[k]||0)+t.amount;});
            if(charts.trend)charts.trend.destroy(); 
            charts.trend=new Chart(document.getElementById('trendChart'), {type:'bar',data:{labels:Object.keys(md),datasets:[{data:Object.values(md),backgroundColor:'#6366f1',borderRadius:4}]},options:{scales:{x:{grid:{display:false}},y:{grid:{display:false}}},plugins:{legend:{display:false}}, responsive: true, maintainAspectRatio: false}});

            const id={}; appData.portfolio.filter(p=>p.status==='active').forEach(p=>id[p.type]=(id[p.type]||0)+(p.currentValue||p.amount));
            if(charts.invBreakdown)charts.invBreakdown.destroy(); 
            charts.invBreakdown=new Chart(document.getElementById('investBreakdownChart'), {type:'doughnut',data:{labels:Object.keys(id),datasets:[{data:Object.values(id),backgroundColor:['#818cf8','#c084fc','#f472b6','#2dd4bf','#fbbf24','#60a5fa','#34d399']}]}, options: { responsive: true, maintainAspectRatio: false }});
        }

        window.onclick = e => { if(e.target.classList.contains('fixed')) e.target.classList.add('hidden'); }
    </script>
</body>
</html>
