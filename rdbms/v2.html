<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBMS Visualizer: Enhanced I/O</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- ANIMATIONS --- */
        @keyframes pulse-dirty {
            0% { box-shadow: 0 0 0 rgba(245, 158, 11, 0); border-color: #f59e0b; }
            50% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.8); border-color: #fcd34d; }
            100% { box-shadow: 0 0 0 rgba(245, 158, 11, 0); border-color: #f59e0b; }
        }

        .component-box {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .component-box.active {
            border-color: #3b82f6;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.3);
            background-color: rgba(30, 41, 59, 0.9);
        }
        .component-box.error {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        /* Buffer Frames */
        .buffer-frame {
            transition: all 0.3s;
        }
        .buffer-frame.occupied {
            background-color: rgba(15, 23, 42, 0.8);
            border-color: #3b82f6;
        }
        .buffer-frame.dirty {
            animation: pulse-dirty 2s infinite;
        }

        /* Flying Page Animation Object */
        .flying-page {
            position: fixed;
            z-index: 100;
            background: #1e293b;
            border: 2px solid #64748b;
            border-radius: 0.5rem;
            pointer-events: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #cbd5e1;
            transition: top 1.2s cubic-bezier(0.22, 1, 0.36, 1), left 1.2s cubic-bezier(0.22, 1, 0.36, 1);
        }
        
        /* Step Pills (from dbv1) */
        .step-pill { opacity: 0.2; transition: all 0.3s; transform: scale(0.95); }
        .step-pill.step-active { opacity: 1; transform: scale(1.05); background-color: #3b82f6; color: white; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); }
        .step-pill.step-error { opacity: 1; transform: scale(1.05); background-color: #ef4444; color: white; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }

        /* Scenario Tabs */
        .scenario-tab { transition: all 0.2s; opacity: 0.6; border-bottom: 2px solid transparent; }
        .scenario-tab.active { opacity: 1; border-color: #3b82f6; color: #60a5fa; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-4 flex justify-between items-center shadow-lg z-10 shrink-0">
        <h1 class="text-2xl font-bold text-blue-400"><i class="fas fa-database mr-2"></i>DBMS <span class="text-white font-light">Visualizer</span></h1>
        <div class="flex space-x-2 md:space-x-4">
            <button onclick="switchView('learn')" class="text-xs md:text-base px-3 md:px-4 py-2 hover:bg-slate-700 rounded transition" id="btn-learn">Concept: File vs DBMS</button>
            <button onclick="switchView('playground')" class="text-xs md:text-base px-3 md:px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded transition shadow-lg shadow-blue-500/50" id="btn-play">Interactive SQL Lab</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow relative overflow-y-auto w-full">
        
        <!-- VIEW 1: Concepts (File vs DBMS) -->
        <div id="view-learn" class="hidden h-full flex-col p-4 md:p-8 overflow-y-auto w-full max-w-6xl mx-auto">
            
            <div class="flex flex-col items-center mb-6">
                <h2 class="text-2xl font-bold mb-4">Why do we need a DBMS?</h2>
                <div class="flex space-x-6 border-b border-slate-800 w-full justify-center">
                    <button onclick="switchScenario(1)" id="tab-scen-1" class="scenario-tab active pb-2">Scenario 1: Data Redundancy (Bank)</button>
                    <button onclick="switchScenario(2)" id="tab-scen-2" class="scenario-tab pb-2">Scenario 2: Concurrency (Booking)</button>
                </div>
            </div>

            <!-- SCENARIO 1: BANK (Redundancy) -->
            <div id="scenario-1" class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full transition-all duration-500">
                <!-- File System Side -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 flex flex-col relative group hover:border-red-900/50 transition">
                    <div class="absolute top-0 right-0 bg-red-900/50 text-red-300 text-[10px] px-3 py-1 rounded-bl-lg font-bold border-l border-b border-red-900">FILE SYSTEM</div>
                    <h3 class="text-red-400 font-bold mb-2"><i class="fas fa-copy mr-2"></i>The Problem</h3>
                    <p class="text-xs text-slate-500 mb-4">Files store duplicate data. Updating one file doesn't update others.</p>
                    
                    <div class="space-y-3 flex-grow">
                        <div class="bg-slate-950 border border-slate-700 p-3 rounded font-mono text-xs">
                            <div class="text-slate-500 border-b border-slate-800 pb-1 mb-1">ðŸ“„ user.txt</div>
                            <div id="fs-f1">Name: Alice | City: <span id="fs-city-1" class="bg-slate-800 px-1 rounded text-blue-200">NY</span></div>
                        </div>
                        <div class="bg-slate-950 border border-slate-700 p-3 rounded font-mono text-xs">
                            <div class="text-slate-500 border-b border-slate-800 pb-1 mb-1">ðŸ“„ loan.txt</div>
                            <div id="fs-f2">Loan: $5k | City: <span id="fs-city-2" class="bg-slate-800 px-1 rounded text-blue-200">NY</span></div>
                        </div>
                    </div>
                    <button onclick="runScen1_FS()" class="mt-4 w-full py-2 bg-slate-800 hover:bg-red-900/30 text-red-200 border border-red-900/50 rounded text-sm transition">Simulate Update: Move to London</button>
                    <div id="status-s1-fs" class="mt-2 text-xs text-center h-4 text-red-400 font-bold"></div>
                </div>

                <!-- DBMS Side -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 flex flex-col relative group hover:border-green-900/50 transition">
                    <div class="absolute top-0 right-0 bg-green-900/50 text-green-300 text-[10px] px-3 py-1 rounded-bl-lg font-bold border-l border-b border-green-900">DBMS</div>
                    <h3 class="text-green-400 font-bold mb-2"><i class="fas fa-database mr-2"></i>The Solution</h3>
                    <p class="text-xs text-slate-500 mb-4">Data Normalization. City is stored once. Others reference User ID.</p>

                    <div class="space-y-3 flex-grow">
                        <div class="bg-slate-950 border border-slate-700 p-3 rounded font-mono text-xs">
                            <div class="text-slate-500 border-b border-slate-800 pb-1 mb-1 flex justify-between"><span>Table: Users</span> <i class="fas fa-key text-yellow-500"></i></div>
                            <div>ID: 1 | Name: Alice | City: <span id="db-city-1" class="bg-slate-800 px-1 rounded text-blue-200">NY</span></div>
                        </div>
                        <div class="bg-slate-950 border border-slate-700 p-3 rounded font-mono text-xs opacity-75">
                            <div class="text-slate-500 border-b border-slate-800 pb-1 mb-1 flex justify-between"><span>Table: Loans</span> <i class="fas fa-link text-blue-400"></i></div>
                            <div>Loan: $5k | User_ID: <span class="text-blue-400">1</span></div>
                        </div>
                    </div>
                    <button onclick="runScen1_DB()" class="mt-4 w-full py-2 bg-slate-800 hover:bg-green-900/30 text-green-200 border border-green-900/50 rounded text-sm transition">Execute SQL UPDATE</button>
                    <div id="status-s1-db" class="mt-2 text-xs text-center h-4 text-green-400 font-bold"></div>
                </div>
            </div>

            <!-- SCENARIO 2: CONCURRENCY (Tickets) -->
            <div id="scenario-2" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8 h-full transition-all duration-500">
                
                <!-- File System (Race Condition) -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 flex flex-col relative">
                    <div class="absolute top-0 right-0 bg-red-900/50 text-red-300 text-[10px] px-3 py-1 rounded-bl-lg font-bold border-l border-b border-red-900">FILE SYSTEM</div>
                    <h3 class="text-red-400 font-bold mb-2">Race Condition</h3>
                    <p class="text-xs text-slate-500 mb-4">No Locking. Two users book the last seat simultaneously.</p>
                    
                    <div class="bg-black p-4 rounded text-center mb-4 border border-slate-700">
                        <div class="text-slate-500 text-[10px] uppercase">seats.txt</div>
                        <div id="fs-seats" class="text-2xl font-mono text-white">1</div>
                        <div class="text-xs text-slate-500">Seats Left</div>
                    </div>

                    <div class="flex justify-between gap-4">
                        <div class="flex-1 bg-slate-900 p-2 rounded text-xs text-center opacity-50 transition" id="fs-u1">User A<br>Reading...</div>
                        <div class="flex-1 bg-slate-900 p-2 rounded text-xs text-center opacity-50 transition" id="fs-u2">User B<br>Reading...</div>
                    </div>

                    <button onclick="runScen2_FS()" class="mt-4 w-full py-2 bg-slate-800 hover:bg-red-900/30 text-red-200 border border-red-900/50 rounded text-sm">Simulate Concurrent Booking</button>
                    <div id="status-s2-fs" class="mt-2 text-xs text-center h-4 text-red-400 font-bold"></div>
                </div>

                <!-- DBMS (Locking) -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 flex flex-col relative">
                    <div class="absolute top-0 right-0 bg-green-900/50 text-green-300 text-[10px] px-3 py-1 rounded-bl-lg font-bold border-l border-b border-green-900">DBMS</div>
                    <h3 class="text-green-400 font-bold mb-2">Lock Manager</h3>
                    <p class="text-xs text-slate-500 mb-4">Locks the row during transaction. User B must wait.</p>

                    <div class="bg-black p-4 rounded text-center mb-4 border border-slate-700 relative overflow-hidden">
                        <div id="db-lock" class="absolute top-2 right-2 text-slate-700"><i class="fas fa-unlock"></i></div>
                        <div class="text-slate-500 text-[10px] uppercase">Table: Seats</div>
                        <div id="db-seats" class="text-2xl font-mono text-white">1</div>
                        <div class="text-xs text-slate-500">Seats Left</div>
                    </div>

                    <div class="flex justify-between gap-4">
                        <div class="flex-1 bg-slate-900 p-2 rounded text-xs text-center opacity-50 transition" id="db-u1">User A<br>Txn Start</div>
                        <div class="flex-1 bg-slate-900 p-2 rounded text-xs text-center opacity-50 transition" id="db-u2">User B<br>Waiting...</div>
                    </div>

                    <button onclick="runScen2_DB()" class="mt-4 w-full py-2 bg-slate-800 hover:bg-green-900/30 text-green-200 border border-green-900/50 rounded text-sm">Execute Concurrent Txn</button>
                    <div id="status-s2-db" class="mt-2 text-xs text-center h-4 text-green-400 font-bold"></div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: Interactive Playground -->
        <div id="view-playground" class="h-full flex flex-col md:flex-row overflow-hidden">
            
            <!-- Left Panel: SQL Interface -->
            <div class="w-full md:w-1/3 bg-slate-800 border-r border-slate-700 flex flex-col p-4 shadow-xl z-20 shrink-0 md:h-full h-1/2">
                <div class="mb-4 flex-grow flex flex-col">
                    <h3 class="text-lg font-semibold text-blue-300 mb-2"><i class="fas fa-terminal mr-2"></i>Query Console</h3>
                    <p class="text-xs text-slate-400 mb-2">Type SQL or use buttons below.</p>
                    
                    <!-- Quick Actions -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <button onclick="fillQuery('CREATE')" class="px-2 py-1 bg-slate-700 hover:bg-purple-600 text-xs rounded border border-slate-600 transition">CREATE TABLE</button>
                        <button onclick="fillQuery('INSERT')" class="px-2 py-1 bg-slate-700 hover:bg-green-600 text-xs rounded border border-slate-600 transition">INSERT DATA</button>
                        <button onclick="fillQuery('SELECT')" class="px-2 py-1 bg-slate-700 hover:bg-blue-600 text-xs rounded border border-slate-600 transition">SELECT ALL</button>
                        <button onclick="fillQuery('DELETE')" class="px-2 py-1 bg-slate-700 hover:bg-red-600 text-xs rounded border border-slate-600 transition">DELETE</button>
                    </div>

                    <!-- AI Helper -->
                    <div id="ai-suggestion" class="hidden bg-yellow-900/30 border border-yellow-600 text-yellow-200 text-xs p-2 rounded mb-2 flex justify-between items-center animate-pulse">
                        <span id="ai-text">Did you mean...?</span>
                        <button onclick="applyFix()" class="text-yellow-400 underline hover:text-white font-bold ml-2">Fix It</button>
                    </div>

                    <div class="relative flex-grow">
                        <textarea id="sqlInput" class="w-full h-full bg-black text-green-400 font-mono p-3 rounded border border-slate-600 focus:border-blue-500 focus:outline-none resize-none" placeholder="SELECT * FROM students..."></textarea>
                    </div>
                    <button id="runBtn" onclick="runQuery()" class="w-full mt-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded shadow-lg transform active:scale-95 transition flex items-center justify-center">
                        <span id="btnText"><i class="fas fa-play mr-2"></i>Execute Query</span>
                    </button>
                </div>

                <!-- Logs / Output -->
                <div class="h-48 bg-black rounded p-2 overflow-y-auto font-mono text-xs border border-slate-700 shrink-0">
                    <div class="text-slate-500 border-b border-slate-800 pb-1 mb-2 sticky top-0 bg-black flex justify-between">
                        <span>System Logs</span>
                        <span class="text-[10px] text-slate-600">Verbose Mode</span>
                    </div>
                    <div id="console-logs" class="space-y-1">
                        <div class="text-slate-400">> System Ready...</div>
                        <div class="text-slate-400">> Waiting for input...</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Visualizer -->
            <div class="w-full md:w-2/3 bg-slate-900 relative p-6 flex flex-col overflow-y-auto">
                
                <!-- Architecture Diagram -->
                <div class="flex-grow flex flex-col justify-center items-center relative py-8">
                    
                    <!-- Step 1: Query Parser -->
                    <div id="node-parser" class="component-box w-72 bg-slate-800 p-4 rounded-lg border-2 border-slate-600 mb-8 relative z-10">
                        <div class="absolute -left-4 top-1/2 -translate-y-1/2 w-4 h-1 bg-slate-600 md:block hidden"></div>
                        <div class="text-center">
                            <i class="fas fa-code-branch text-purple-400 text-2xl mb-2"></i>
                            <h4 class="font-bold">Query Processor</h4>
                            
                            <!-- Internal Steps Visualization (Pills from dbv1) -->
                            <div class="mt-3 flex justify-between items-center text-[10px] bg-slate-900/50 p-2 rounded-lg gap-1">
                                <span id="step-syntax" class="step-pill px-2 py-1 bg-slate-700 rounded text-slate-300">Syntax</span>
                                <i class="fas fa-arrow-right text-slate-600 text-[8px]"></i>
                                <span id="step-opt" class="step-pill px-2 py-1 bg-slate-700 rounded text-slate-300">Optimizer</span>
                                <i class="fas fa-arrow-right text-slate-600 text-[8px]"></i>
                                <span id="step-plan" class="step-pill px-2 py-1 bg-slate-700 rounded text-slate-300">Exe Plan</span>
                            </div>
                            
                            <div id="status-parser" class="text-xs mt-2 text-slate-500 font-mono h-4">Idle</div>
                        </div>
                    </div>

                    <!-- Connection Line -->
                    <div class="h-12 w-1 bg-slate-600"></div>

                    <!-- Step 2: Storage Engine (Enhanced with Buffer Grid) -->
                    <div id="node-engine" class="component-box w-96 bg-slate-800 p-4 rounded-lg border-2 border-slate-600 mb-8 relative z-10">
                        <div class="flex justify-between items-center mb-2">
                             <div class="text-center">
                                <i class="fas fa-cogs text-orange-400 text-xl"></i>
                                <span class="font-bold ml-2">Buffer Pool</span>
                            </div>
                            <span id="step-buffer" class="step-pill px-2 py-0.5 bg-slate-700 rounded text-[10px]">Buffer Check</span>
                        </div>
                       
                        <!-- Buffer Grid for Animation -->
                        <div class="grid grid-cols-4 gap-2 mb-2" id="buffer-grid">
                            <!-- Generated via JS -->
                        </div>

                        <div id="status-engine" class="text-xs mt-1 text-slate-500 font-mono h-4 text-center">Idle</div>
                    </div>

                    <!-- Connection Line -->
                    <div class="h-12 w-1 bg-slate-600"></div>

                    <!-- Step 3: Physical Disk (Enhanced with Page Grid) -->
                    <div id="node-disk" class="component-box w-full max-w-2xl bg-slate-800 p-4 rounded-lg border-2 border-slate-600 relative min-h-[150px] z-10">
                        <div class="text-center mb-2 flex justify-between items-center border-b border-slate-700 pb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-hdd text-blue-400 text-2xl"></i>
                                <div class="text-left">
                                    <h4 class="font-bold">Physical Storage</h4>
                                    <p class="text-xs text-slate-400">Disk Pages (students.db)</p>
                                </div>
                            </div>
                            <span id="step-file" class="step-pill px-2 py-1 bg-slate-700 rounded text-[10px]">Disk I/O</span>
                        </div>
                        
                        <!-- Disk Pages Grid for Animation -->
                        <div id="disk-grid" class="grid grid-cols-3 gap-4">
                            <!-- Generated via JS -->
                        </div>
                    </div>
                </div>

                <!-- Result Overlay -->
                <div id="result-area" class="mt-4 p-4 bg-black border border-green-500/50 rounded shadow-lg hidden">
                    <h5 id="result-title" class="text-green-400 text-sm mb-2 font-mono flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> Query Result:
                    </h5>
                    <pre id="query-output" class="text-slate-200 font-mono text-xs overflow-x-auto whitespace-pre-wrap"></pre>
                </div>

            </div>
        </div>
    </main>

    <script>
        // --- DATA STATE (Page-based to support animation) ---
        let diskPages = [
            { id: 101, rows: [{id:1, name:'Alice', age:24}, {id:2, name:'Bob', age:29}] },
            { id: 102, rows: [{id:3, name:'Charlie', age:22}] },
            { id: 103, rows: [] } // Empty page for inserts
        ];
        // Buffer pool slots
        let bufferFrames = [null, null, null, null];

        let suggestionFix = "";
        let isRunning = false;
        
        // Helper for delays
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- Initialization ---
        window.onload = () => {
            switchView('playground'); // Default view
            renderDisk();
            renderBuffer();
        };

        // --- UI Logic ---
        function switchView(viewName) {
            document.getElementById('view-learn').classList.add('hidden');
            document.getElementById('view-playground').classList.add('hidden');
            document.getElementById('view-learn').classList.remove('flex');
            
            // Toggle active button styles
            const btnLearn = document.getElementById('btn-learn');
            const btnPlay = document.getElementById('btn-play');

            btnLearn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
            btnPlay.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');

            if(viewName === 'learn') {
                const learnView = document.getElementById('view-learn');
                learnView.classList.remove('hidden');
                learnView.classList.add('flex');
                btnLearn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
            } else {
                document.getElementById('view-playground').classList.remove('hidden');
                btnPlay.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
            }
        }

        // --- SCENARIO TABS LOGIC ---
        function switchScenario(n) {
            document.getElementById('scenario-1').classList.add('hidden');
            document.getElementById('scenario-2').classList.add('hidden');
            document.getElementById('tab-scen-1').classList.remove('active', 'border-blue-600', 'text-blue-500');
            document.getElementById('tab-scen-2').classList.remove('active', 'border-blue-600', 'text-blue-500');

            document.getElementById(`scenario-${n}`).classList.remove('hidden');
            document.getElementById(`tab-scen-${n}`).classList.add('active', 'border-blue-600', 'text-blue-500');
        }

        async function runScen1_FS() {
            document.getElementById('fs-city-1').innerText = "LDN";
            document.getElementById('fs-city-1').className = "text-yellow-400";
            await wait(500);
            document.getElementById('fs-city-2').className = "text-red-500 font-bold";
            document.getElementById('status-s1-fs').innerText = "Crash! Loan file mismatch.";
        }
        async function runScen1_DB() {
            document.getElementById('db-city-1').innerText = "LDN";
            document.getElementById('db-city-1').className = "text-green-400";
            document.getElementById('status-s1-db').innerText = "Success. All refs updated.";
        }
        async function runScen2_FS() {
            document.getElementById('fs-seats').innerText = "-1";
            document.getElementById('fs-seats').className = "text-2xl font-mono text-red-500";
            document.getElementById('status-s2-fs').innerText = "Race Condition! Double Booking.";
        }
        async function runScen2_DB() {
            document.getElementById('db-lock').className = "fas fa-lock absolute top-2 right-2 text-red-500";
            await wait(500);
            document.getElementById('db-seats').innerText = "0";
            document.getElementById('db-lock').className = "fas fa-unlock absolute top-2 right-2 text-slate-600";
            document.getElementById('status-s2-db').innerText = "Safe. User B blocked.";
        }

        function fillQuery(type) {
            const input = document.getElementById('sqlInput');
            let txt = "";
            switch(type) {
                case 'CREATE': txt = "CREATE TABLE students (id INT, name VARCHAR, age INT, role VARCHAR);"; break;
                case 'INSERT': txt = "INSERT INTO students VALUES (4, 'David', 30, 'Analyst');"; break;
                case 'SELECT': txt = "SELECT * FROM students;"; break;
                case 'DELETE': txt = "DELETE FROM students WHERE id = 1;"; break;
            }
            input.value = txt;
            checkAI(txt); 
        }

        // --- "AI" Helper Logic ---
        document.getElementById('sqlInput').addEventListener('input', (e) => {
            checkAI(e.target.value);
        });

        function checkAI(val) {
            const aiBox = document.getElementById('ai-suggestion');
            const lowerVal = val.toLowerCase();
            let suggestion = null;
            
            if (lowerVal.includes('selct') || lowerVal.includes('slect')) suggestion = "SELECT * FROM students";
            else if (lowerVal.includes('insrt')) suggestion = "INSERT INTO students";
            else if (lowerVal.includes('cret')) suggestion = "CREATE TABLE";
            else if (lowerVal.includes('delt')) suggestion = "DELETE FROM";

            if (suggestion) {
                aiBox.classList.remove('hidden');
                aiBox.classList.add('flex');
                document.getElementById('ai-text').innerText = `Typo detected. Did you mean: "${suggestion}"?`;
                suggestionFix = val.replace(/^\w+/, suggestion.split(' ')[0]); 
            } else {
                aiBox.classList.add('hidden');
                aiBox.classList.remove('flex');
            }
        }

        function applyFix() {
            if(suggestionFix) {
                document.getElementById('sqlInput').value = suggestionFix;
                document.getElementById('ai-suggestion').classList.add('hidden');
                document.getElementById('ai-suggestion').classList.remove('flex');
            }
        }

        // --- RENDER FUNCTIONS (Grid-based for animation) ---
        function renderDisk() {
            const grid = document.getElementById('disk-grid');
            grid.innerHTML = '';
            diskPages.forEach(p => {
                let rowHtml = p.rows.map(r => `<div class="flex justify-between border-b border-slate-700 pb-1 mb-1"><span class="text-blue-300">${r.id}</span><span class="text-slate-400">${r.name}</span></div>`).join('');
                if(p.rows.length === 0) rowHtml = "<div class='text-slate-600 italic'>Empty Page</div>";

                const div = document.createElement('div');
                div.id = `disk-page-${p.id}`;
                div.className = "bg-slate-950 border border-slate-700 p-2 rounded h-24 relative hover:border-slate-500 transition text-[10px] font-mono";
                div.innerHTML = `
                    <div class="absolute top-0 right-0 bg-slate-800 text-[9px] px-2 rounded-bl text-slate-400">Pg ${p.id}</div>
                    <div class="mt-4">${rowHtml}</div>
                `;
                grid.appendChild(div);
            });
        }

        function renderBuffer() {
            const grid = document.getElementById('buffer-grid');
            grid.innerHTML = '';
            for(let i=0; i<4; i++) {
                const page = bufferFrames[i];
                let content = `<div class="text-[9px] text-slate-600">Empty</div>`;
                if(page) {
                     const rows = page.rows.map(r => `[${r.id}]`).join(' ');
                     content = `
                        <div class="text-xs font-bold text-blue-300">Pg ${page.id}</div>
                        <div class="text-[9px] text-slate-400 mt-1">${page.rows.length} Rows</div>
                    `;
                }
                
                const div = document.createElement('div');
                div.className = `buffer-frame h-16 border border-dashed border-slate-600 rounded bg-slate-900/50 flex flex-col items-center justify-center relative ${page ? 'occupied' : ''}`;
                div.id = `frame-${i}`;
                div.innerHTML = `<div class="absolute top-0 left-1 text-[8px] text-slate-600">F${i}</div>${content}`;
                grid.appendChild(div);
            }
        }

        // --- ANIMATION UTILS ---
        async function animateIO(pageId, frameIdx, type) {
            const diskEl = document.getElementById(`disk-page-${pageId}`);
            const frameEl = document.getElementById(`frame-${frameIdx}`);
            
            if(!diskEl || !frameEl) return;

            const rectDisk = diskEl.getBoundingClientRect();
            const rectFrame = frameEl.getBoundingClientRect();

            const flyer = document.createElement('div');
            flyer.className = "flying-page";
            flyer.innerHTML = `<i class="fas fa-file-code mr-2"></i> Pg ${pageId}`;
            flyer.style.width = "80px";
            flyer.style.height = "40px";

            // Start Position
            if(type === 'read') {
                flyer.style.top = rectDisk.top + "px";
                flyer.style.left = rectDisk.left + "px";
            } else {
                flyer.style.top = rectFrame.top + "px";
                flyer.style.left = rectFrame.left + "px";
                flyer.style.borderColor = "#f59e0b"; // Dirty color
            }

            document.body.appendChild(flyer);
            
            // Trigger animation
            await wait(50); 
            if(type === 'read') {
                flyer.style.top = (rectFrame.top + 10) + "px";
                flyer.style.left = (rectFrame.left + 5) + "px";
            } else {
                flyer.style.top = (rectDisk.top + 10) + "px";
                flyer.style.left = (rectDisk.left + 5) + "px";
            }

            await wait(1000); // Animation duration
            flyer.remove();
        }

        function log(msg, type='info') {
            const logs = document.getElementById('console-logs');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            
            let color = 'text-slate-400';
            if(type === 'success') color = 'text-green-400';
            if(type === 'error') color = 'text-red-400';
            if(type === 'process') color = 'text-yellow-400';
            if(type === 'detail') color = 'text-blue-300 italic pl-4';

            div.className = `${color}`;
            div.innerHTML = `<span class="opacity-50 text-[10px]">[${time}]</span> ${msg}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function highlightPill(id, active, isError=false) {
            const el = document.getElementById(id);
            if (!el) return; // Added safety check
            if(active) {
                if(isError) el.classList.add('step-error');
                else el.classList.add('step-active');
            } else {
                el.classList.remove('step-active', 'step-error');
            }
        }

        function resetVisuals() {
            // removed step-trans which doesn't exist in DOM
            ['step-syntax', 'step-opt', 'step-plan', 'step-buffer', 'step-file'].forEach(id => highlightPill(id, false));
            document.getElementById('node-parser').classList.remove('active', 'error');
            document.getElementById('node-engine').classList.remove('active');
            document.getElementById('node-disk').classList.remove('active');
            document.getElementById('status-parser').innerText = "Idle";
            document.getElementById('status-engine').innerText = "Idle";
            document.getElementById('status-parser').classList.remove('text-green-400', 'text-red-400');
            document.getElementById('status-engine').classList.remove('text-orange-400');
            document.getElementById('result-area').classList.add('hidden');
        }

        // --- MAIN EXECUTION LOGIC (Strict Validation + IO Animation) ---
        async function runQuery() {
            if(isRunning) return; 
            
            const rawSql = document.getElementById('sqlInput').value.trim();
            if (!rawSql) {
                log("Error: Query is empty.", "error");
                return;
            }

            isRunning = true;
            document.getElementById('runBtn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('btnText').innerText = "Processing...";
            resetVisuals();

            // --- PHASE 1: Query Processor ---
            log(`Starting execution for: "${rawSql.substring(0,25)}..."`, "info");
            
            const parserNode = document.getElementById('node-parser');
            parserNode.classList.add('active');
            document.getElementById('status-parser').innerText = "Parsing SQL...";
            document.getElementById('status-parser').classList.add('text-green-400');
            
            // Sub-step 1: Syntax
            await wait(600);
            highlightPill('step-syntax', true);
            log("1.1 Syntax Check: Validating grammar...", "detail");
            await wait(800); 

            // --- STRICT SYNTAX VALIDATION (Preserved from dbv1) ---
            const normalizedSql = rawSql.trim().replace(/;$/, '').replace(/\s+/g, ' ');
            const upperSql = normalizedSql.toUpperCase();
            
            let syntaxError = null;
            let action = "";

            if (upperSql.startsWith("SELECT")) {
                action = "SELECT";
                if (!upperSql.includes(" FROM ")) syntaxError = "Missing 'FROM' clause.";
                else {
                    const parts = normalizedSql.split(/ from /i);
                    const cols = parts[0].substring(6).trim();
                    if (cols.length === 0) syntaxError = "Missing columns! (Did you mean 'SELECT *'?)";
                    else if (parts.length < 2 || parts[1].trim().length === 0) syntaxError = "Missing table name after FROM.";
                }
            } 
            else if (upperSql.startsWith("INSERT")) {
                action = "INSERT";
                 if (!upperSql.includes(" INTO ")) syntaxError = "Missing 'INTO' clause.";
                 else if (!upperSql.includes(" VALUES")) syntaxError = "Missing 'VALUES' clause.";
                 else if (!/\s+VALUES\s*\(.+\)/i.test(normalizedSql)) syntaxError = "Malformed VALUES format. Usage: VALUES (x, y...)";
            }
            else if (upperSql.startsWith("DELETE")) {
                action = "DELETE";
                if (!upperSql.includes(" FROM ")) syntaxError = "Missing 'FROM' clause.";
                else {
                     const tablePart = normalizedSql.substring(upperSql.indexOf(" FROM ") + 6).trim();
                     if (tablePart.length === 0) syntaxError = "Missing table name.";
                }
            } 
            else if (upperSql.startsWith("CREATE")) {
                action = "CREATE";
                if (!upperSql.includes(" TABLE ")) syntaxError = "Missing 'TABLE' keyword.";
                else if (!/\(.+\)/.test(normalizedSql)) syntaxError = "Missing column definitions (...)";
            }
            else {
                syntaxError = "Unknown SQL Command.";
            }

            if (syntaxError) {
                highlightPill('step-syntax', true, true);
                parserNode.classList.remove('active');
                parserNode.classList.add('error');
                document.getElementById('status-parser').innerText = "Syntax Error!";
                document.getElementById('status-parser').classList.remove('text-green-400');
                document.getElementById('status-parser').classList.add('text-red-400');
                
                log(`SYNTAX ERROR: ${syntaxError}`, "error");
                const resArea = document.getElementById('result-area');
                resArea.classList.remove('hidden');
                document.getElementById('result-title').innerHTML = '<i class="fas fa-times-circle mr-2"></i> Syntax Error:';
                document.getElementById('result-title').className = "text-red-400 text-sm mb-2 font-mono flex items-center";
                document.getElementById('query-output').innerText = syntaxError;
                document.getElementById('result-area').classList.add('border-red-500/50');

                finishRun();
                return; 
            }
            // ------------------------------

            // Sub-step 2: Optimizer
            highlightPill('step-syntax', false);
            highlightPill('step-opt', true);
            log("1.2 Optimizer: Calculating cost (CPU/IO)...", "detail");
            await wait(800);

            // Sub-step 3: Plan
            highlightPill('step-opt', false);
            highlightPill('step-plan', true);
            log("1.3 Plan: Generated Tree. Sent to Engine.", "detail");
            await wait(800);

            highlightPill('step-plan', false);
            parserNode.classList.remove('active');
            document.getElementById('status-parser').innerText = "Idle";
            document.getElementById('status-parser').classList.remove('text-green-400');


            // --- PHASE 2: Storage Engine ---
            log("Phase 2: Execution Engine taking over...", "process");
            const engineNode = document.getElementById('node-engine');
            engineNode.classList.add('active');
            document.getElementById('status-engine').innerText = "Executing Plan...";
            document.getElementById('status-engine').classList.add('text-orange-400');

            await wait(400);
            highlightPill('step-buffer', true);
            log("2.2 Buffer Pool: Checking memory cache...", "detail");
            await wait(600);

            // --- PHASE 3: Physical I/O (Flying Page Animation) ---
            highlightPill('step-buffer', false);
            highlightPill('step-file', true);
            const diskNode = document.getElementById('node-disk');
            diskNode.classList.add('active');

            let resultMsg = "";
            let success = true;

            // Execute based on Action
            try {
                if (action === "SELECT") {
                    log("Full Table Scan: Reading all pages...", "process");
                    // Read all non-empty pages
                    let count = 0;
                    for(let i=0; i<diskPages.length; i++) {
                        const p = diskPages[i];
                        if(p.rows.length === 0) continue; 
                        
                        log(`Reading Page ${p.id} into Buffer Frame ${i%4}...`, "detail");
                        await animateIO(p.id, i%4, 'read'); // FLYING READ ANIMATION
                        bufferFrames[i%4] = JSON.parse(JSON.stringify(p)); 
                        renderBuffer();
                        await wait(300);
                        count++;
                    }
                    const allRows = diskPages.flatMap(p=>p.rows);
                    resultMsg = JSON.stringify(allRows, null, 2);
                    log(`Fetched ${allRows.length} rows.`, "success");
                } 
                else if (action === "INSERT") {
                    // Extract Values using regex
                    const valRegex = /VALUES\s*\(\s*(\d+)\s*,\s*'([^']+)'\s*,\s*(\d+)\s*,\s*'([^']+)'\s*\)/i;
                    // Try simple 4 arg match first, fallback to simpler if user uses old syntax
                    // Supporting standard dbv1 syntax: INSERT INTO students VALUES (4, 'David', 30, 'Analyst');
                    // Regex needs to be robust. 
                    const valuesMatch = rawSql.match(/VALUES\s*\((.+)\)/i);
                    
                    if(valuesMatch && valuesMatch[1]) {
                         const parts = valuesMatch[1].split(',').map(s => s.trim().replace(/^['"]|['"]$/g, ""));
                         const newRow = { id: parts[0], name: parts[1], age: parts[2], role: parts[3] };
                         
                         // Find space
                        let targetIdx = diskPages.findIndex(p => p.rows.length < 2);
                        if(targetIdx === -1) {
                            diskPages.push({id: 100+diskPages.length+1, rows: []});
                            targetIdx = diskPages.length-1;
                            renderDisk();
                        }
                        const pageId = diskPages[targetIdx].id;
                        const frameIdx = 0; 

                        // 1. Read
                        log(`Page ${pageId} miss. Reading from disk...`, "detail");
                        await animateIO(pageId, frameIdx, 'read');
                        bufferFrames[frameIdx] = JSON.parse(JSON.stringify(diskPages[targetIdx]));
                        renderBuffer();

                        // 2. Modify (Dirty)
                        await wait(500);
                        bufferFrames[frameIdx].rows.push(newRow);
                        renderBuffer();
                        document.getElementById(`frame-${frameIdx}`).classList.add('dirty'); // Visual Dirty
                        log("Tuple inserted in Buffer. Page is DIRTY.", "process");
                        await wait(800);

                        // 3. Flush (Write)
                        log("WAL Commit. Flushing dirty page to disk...", "detail");
                        await animateIO(pageId, frameIdx, 'write'); // FLYING WRITE ANIMATION
                        diskPages[targetIdx] = JSON.parse(JSON.stringify(bufferFrames[frameIdx]));
                        renderDisk();
                        resultMsg = "1 Row Inserted.";
                    } else {
                        throw new Error("Syntax Error in VALUES");
                    }
                }
                else if (action === "DELETE") {
                     // Basic WHERE id=X support
                     const whereMatch = rawSql.match(/id\s*=\s*(\d+)/i);
                     let targetId = whereMatch ? whereMatch[1] : null;

                     let found = false;
                     // Scan pages
                     for(let i=0; i<diskPages.length; i++) {
                         if(diskPages[i].rows.length === 0) continue;
                         
                         // If we are deleting specific ID, skip pages that don't have it (Index optimization sim)
                         // But for now we act like full scan
                         const frameIdx = 0;
                         await animateIO(diskPages[i].id, frameIdx, 'read');
                         bufferFrames[frameIdx] = JSON.parse(JSON.stringify(diskPages[i]));
                         renderBuffer();

                         const beforeCount = bufferFrames[frameIdx].rows.length;
                         if(targetId) {
                             bufferFrames[frameIdx].rows = bufferFrames[frameIdx].rows.filter(r => r.id != targetId);
                         } else {
                             bufferFrames[frameIdx].rows = []; // Delete All
                         }

                         if(bufferFrames[frameIdx].rows.length < beforeCount) {
                             found = true;
                             document.getElementById(`frame-${frameIdx}`).classList.add('dirty');
                             log("Rows deleted in Buffer.", "process");
                             await wait(600);
                             await animateIO(diskPages[i].id, frameIdx, 'write');
                             diskPages[i] = JSON.parse(JSON.stringify(bufferFrames[frameIdx]));
                             renderDisk();
                         }
                     }
                     resultMsg = found ? "Row(s) Deleted." : "No rows found to delete.";
                }
                else if (action === "CREATE") {
                    resultMsg = "Table 'students' exists (Mock Mode).";
                }
            } catch (e) {
                log("Runtime Error: " + e.message, "error");
                success = false;
            }

            diskNode.classList.remove('active');
            engineNode.classList.remove('active');
            document.getElementById('status-engine').innerText = "Idle";
            document.getElementById('status-engine').classList.remove('text-orange-400');
            highlightPill('step-file', false);

            // Show Result
            if(success) {
                const resArea = document.getElementById('result-area');
                resArea.classList.remove('hidden');
                document.getElementById('result-title').innerHTML = '<i class="fas fa-check-circle mr-2"></i> Query Result:';
                document.getElementById('result-title').className = "text-green-400 text-sm mb-2 font-mono flex items-center";
                document.getElementById('result-area').classList.remove('border-red-500/50');
                document.getElementById('result-area').classList.add('border-green-500/50');
                document.getElementById('query-output').innerText = resultMsg;
            }
            
            finishRun();
        }

        function finishRun() {
            isRunning = false;
            document.getElementById('runBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('btnText').innerHTML = '<i class="fas fa-play mr-2"></i>Execute Query';
        }
    </script>
</body>
</html>