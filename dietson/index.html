<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Food Tracker</title>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* CSS variables for a modern theme */
        :root {
            --primary-green: #2d6a4f;
            --medium-green: #40916c;
            --light-green: #b7e4c7;
            --bg-light: #f7fdf9;
            --white: #ffffff;
            --grey-light: #f0f0f0;
            --grey-medium: #d8d8d8;
            --text-dark: #212529;
            --text-light: #495057;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --warning-light: #fff3cd;
            --warning-dark: #856404;
        }

        /* General Reset & Body */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }

        /* Main App Container */
        .container {
            max-width: 500px; /* Compact, mobile-first */
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        /* Header */
        header {
            padding: 24px;
            background: var(--primary-green);
            color: var(--white);
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Main Navigation Tabs */
        .main-nav {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--grey-light);
        }

        .nav-tab {
            flex: 1;
            padding: 16px 4px; /* Adjusted padding for 5 tabs */
            text-align: center;
            cursor: pointer;
            font-size: 0.8rem; /* Adjusted font size for 5 tabs */
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .nav-tab i {
            font-size: 1.5rem; /* Icon size */
        }
        .nav-tab.active {
            color: var(--primary-green);
            border-bottom-color: var(--primary-green);
        }
        .nav-tab:hover:not(.active) {
            background-color: var(--bg-light);
        }

        /* Page Container */
        main {
            padding: 24px;
        }

        .page {
            display: none; /* Hidden by default */
        }
        .page.active {
            display: block; /* Shown when active */
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-green);
        }

        /* Card element */
        .card {
            background: var(--white);
            border: 1px solid var(--grey-light);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* --- Dashboard Page --- */
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            text-align: center;
        }
        .stat p {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .weight-log-form {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .form-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--grey-medium);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
        }
        .form-button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: var(--medium-green);
            color: var(--white);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .form-button:hover {
            background: var(--primary-green);
        }
        .motivation-quote {
            font-style: italic;
            color: var(--text-light);
            text-align: center;
        }

        /* --- Add Food / Log Meal Page --- */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .food-search-container {
            position: relative;
        }
        .food-search-results {
            position: absolute;
            width: 100%;
            background: var(--white);
            border: 1px solid var(--grey-medium);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            /* Hide border-top when empty */
            border-top: none;
        }
        .food-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--grey-light);
        }
        .food-result-item:last-child {
            border-bottom: none;
        }
        .food-result-item:hover {
            background-color: var(--bg-light);
        }
        .food-result-item p {
            font-weight: 500;
        }
        .food-result-item span {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Logged List */
        .todays-log-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
        }
        .log-item-details p {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .log-item-details span {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        .remove-log-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
        }
        .remove-log-btn:hover {
            color: #d00000;
        }

        /* Nutrition Summary */
        .nutrition-summary {
            margin-top: 16px;
            border-top: 1px solid var(--grey-light);
            padding-top: 16px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            padding: 8px 0;
        }
        .summary-item p {
            color: var(--text-light);
        }
        .summary-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* --- Meal Ideas Page --- */
        .day-selector {
            display: flex;
            overflow-x: auto;
            background: var(--bg-light);
            border-radius: 8px;
            padding: 6px;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            /* Hide scrollbar */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .day-selector::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Opera */
        }
        .day-tab {
            flex: 0 0 auto; /* Don't grow, don't shrink, base on content */
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
        }
        .day-tab.active {
            background: var(--medium-green);
            color: var(--white);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .meal-list {
            display: grid;
            gap: 16px;
        }
        .meal-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border: 1px solid var(--grey-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .meal-icon {
            font-size: 1.75rem;
            color: var(--primary-green);
            margin-top: 4px;
        }
        .meal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .meal-description {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* --- Toast Message --- */
        #toast-message {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-dark);
            color: var(--white);
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            transition: bottom 0.5s ease;
            box-shadow: var(--shadow-lg);
        }
        #toast-message.show {
            bottom: 30px;
        }

        /* --- Exercises Page --- */
        .exercise-list {
            display: grid;
            gap: 16px;
        }
        .exercise-card {
            background: var(--white);
            border: 1px solid var(--grey-light);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .exercise-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 8px;
        }
        .exercise-card p {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* --- Warning Box --- */
        .warning-box {
            background: var(--warning-light);
            border: 1px solid var(--warning-dark);
            color: var(--warning-dark);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .warning-box strong {
            font-weight: 700;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 400px) {
            body {
                padding: 10px;
            }
            main {
                padding: 16px;
            }
            header {
                padding: 20px;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .nav-tab {
                padding: 12px 4px;
                font-size: 0.7rem;
            }
            .nav-tab i {
                font-size: 1.25rem;
            }
        }
        
        /* --- General Form Elements (re-using from dashboard) --- */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .food-search-container {
            position: relative;
        }
        .food-search-results {
            position: absolute;
            width: 100%;
            background: var(--white);
            border: 1px solid var(--grey-medium);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            border-top: none; /* Hide top border */
        }
        .food-search-results:empty {
            border: none;
        }
        .food-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--grey-light);
        }
        .food-result-item:last-child {
            border-bottom: none;
        }
        .food-result-item:hover {
            background-color: var(--bg-light);
        }
        .food-result-item p {
            font-weight: 500;
        }
        .food-result-item span {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .todays-log-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
        }
        .log-item-details p {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .log-item-details span {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        .remove-log-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
        }
        .remove-log-btn:hover {
            color: #d00000;
        }

        .nutrition-summary {
            margin-top: 16px;
            border-top: 1px solid var(--grey-light);
            padding-top: 16px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            padding: 8px 0;
        }
        .summary-item p {
            color: var(--text-light);
        }
        .summary-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* --- Exercises Page --- */
        .exercise-list {
            display: grid;
            gap: 16px;
        }
        .exercise-card {
            background: var(--white);
            border: 1px solid var(--grey-light);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        /* --- Food List Page --- */
        .food-database-list {
            display: grid;
            gap: 12px;
        }

        .food-list-item {
            background: var(--white);
            border: 1px solid var(--grey-light);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .food-list-item h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 8px;
        }

        .food-list-item .serving-info {
            font-size: 0.85rem;
            color: var(--text-light);
            font-style: italic;
            margin-bottom: 12px;
        }

        .food-list-nutrients {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9rem;
        }

        .food-list-nutrients span {
            color: var(--text-dark);
        }

        .food-list-nutrients span strong {
            font-weight: 600;
            color: var(--text-light);
        }
        
        /* --- New Routine Log Page --- */
        .routine-meal-group {
            margin-bottom: 24px;
        }
        .routine-meal-group h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .routine-card {
            background: var(--white);
            border: 1px solid var(--grey-light);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }
        .routine-card p {
            font-size: 0.95rem;
            color: var(--text-dark);
            margin-bottom: 16px;
            line-height: 1.5;
        }
        .routine-card p strong {
            font-weight: 600;
        }
        .routine-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn-log-base, .btn-log-booster {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-log-base {
            background-color: var(--medium-green);
            color: var(--white);
            flex-grow: 1; /* Takes more space */
        }
        .btn-log-base:hover {
            background-color: var(--primary-green);
        }
        .btn-log-booster {
            background-color: var(--grey-light);
            color: var(--text-dark);
            border: 1px solid var(--grey-medium);
        }
        .btn-log-booster:hover {
            background-color: var(--grey-medium);
        }
        /* --- End Routine Log Page --- */

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RS' Diet and Goal Tracker</h1>
            <p>Your journey to healthy weight gain</p>
        </header>
        
        <!-- Main Navigation -->
        <nav class="main-nav">
            <div class="nav-tab active" data-page="dashboard">
                <i class="ph-light ph-chart-line"></i>
                Dashboard
            </div>
            <div class="nav-tab" data-page="log-routine">
                <i class="ph-light ph-plus-circle"></i>
                Log Routine
            </div>
            <div class="nav-tab" data-page="add-custom">
                <i class="ph-light ph-magnifying-glass"></i>
                Add Custom
            </div>
            <div class="nav-tab" data-page="plan">
                <i class="ph-light ph-calendar"></i>
                Meal Ideas
            </div>
            <div class="nav-tab" data-page="food-list">
                <i class="ph-light ph-books"></i>
                Food List
            </div>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="page active">
                <h2 class="page-title"><i class="ph-light ph-chart-line"></i>Dashboard</h2>
                
                <div class="card">
                    <h3>Your Progress</h3>
                    <div class="progress-stats">
                        <div class="stat">
                            <p>Start</p>
                            <span class="stat-value" id="stat-start-weight">-- kg</span>
                        </div>
                        <div class="stat">
                            <p>Current</p>
                            <span class="stat-value" id="stat-current-weight">-- kg</span>
                        </div>
                        <div class="stat">
                            <p>Goal</p>
                            <span class="stat-value" id="stat-goal-weight">-- kg</span>
                        </div>
                        <div class="stat">
                            <p>Gained</p>
                            <span class="stat-value" id="stat-total-gained">-- kg</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Log Today's Weight</h3>
                    <form id="weight-log-form" class="weight-log-form">
                        <input type="number" id="weight-input" class="form-input" placeholder="Enter weight in kg" step="0.1" required>
                        <button type="submit" class="form-button">Save</button>
                    </form>
                    <h3>Today's Summary</h3>
                    <div class="progress-stats">
                        <div class="stat">
                            <p>Meals Logged</p>
                            <span class="stat-value" id="stat-meals-logged">0</span>
                        </div>
                        <div class="stat">
                            <p>Calories Logged</p>
                            <span class="stat-value" id="stat-calories-logged">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Motivation</h3>
                    <p class="motivation-quote" id="motivation-quote">"Consistency is the key to progress."</p>
                </div>
            </section>

            <!-- Log Meal Page -->
            <section id="page-add-custom" class="page">
                <h2 class="page-title"><i class="ph-light ph-magnifying-glass"></i>Add Custom Food</h2>
                
                <div class="form-group food-search-container">
                    <label for="food-search-input">Search Food Database</label>
                    <input type="text" id="food-search-input" class="form-input" placeholder="e.g., Rice, Paneer...">
                    <div id="food-search-results" class="food-search-results"></div>
                </div>

                <div class="card" style="padding-top: 10px;">
                    <h3>Today's Log</h3>
                    <div id="todays-log-list" class="todays-log-list">
                        <!-- Logged items will appear here -->
                    </div>
                    
                    <h3 style="margin-top: 20px;">Today's Totals</h3>
                    <div id="nutrition-summary" class="nutrition-summary">
                        <!-- Summary will appear here -->
                    </div>
                </div>
            </section>
            
            <!-- NEW: Log Routine Page -->
            <section id="page-log-routine" class="page">
                <h2 class="page-title"><i class="ph-light ph-plus-circle"></i>Log Routine Meal</h2>
                <p style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-light);">
                    Log your daily template meals with one click. Add boosters as needed.
                </p>

                <!-- Morning -->
                <div class="routine-meal-group">
                    <h3><i class="ph-light ph-coffee"></i>Morning</h3>
                    <div class="routine-card">
                        <p><strong>Base:</strong> 1 cup Milk or Coffee</p>
                        <div class="routine-actions">
                            <button class="btn-log-base" data-meal="morning_drink"><i class="ph ph-plus"></i>Log Milk</button>
                            <button class="btn-log-base" data-meal="morning_coffee"><i class="ph ph-plus"></i>Log Coffee</button>
                        </div>
                    </div>
                </div>

                <!-- Breakfast -->
                <div class="routine-meal-group">
                    <h3><i class="ph-light ph-plant"></i>Breakfast</h3>
                    <div class="routine-card">
                        <p><strong>Base:</strong> 3 Idlis + 1 serving Peanut Chutney</p>
                        <div class="routine-actions">
                            <button class="btn-log-base" data-meal="breakfast"><i class="ph ph-plus"></i>Log Base Breakfast</button>
                            <button class="btn-log-booster" data-food-id="9"><i class="ph ph-plus-circle"></i>+ Ghee (Upma)</button>
                        </div>
                    </div>
                </div>

                <!-- Lunch -->
                <div class="routine-meal-group">
                    <h3><i class="ph-light ph-bowl-food"></i>Lunch</h3>
                    <div class="routine-card">
                        <p><strong>Base:</strong> 1 cup Rice + 1 cup Dal + 1 cup Curd</p>
                        <div class="routine-actions">
                            <button class="btn-log-base" data-meal="lunch"><i class="ph ph-plus"></i>Log Base Lunch</button>
                            <button class="btn-log-booster" data-food-id="9"><i class="ph ph-plus-circle"></i>+ Ghee</button>
                            <button class="btn-log-booster" data-food-id="26"><i class="ph ph-plus-circle"></i>+ Badam</button>
                        </div>
                    </div>
                </div>

                <!-- Snack -->
                <div class="routine-meal-group">
                    <h3><i class="ph-light ph-cookie"></i>Snack</h3>
                    <div class="routine-card">
                        <p><strong>Base:</strong> 1 cup Coffee + 2 Biscuits</p>
                        <div class="routine-actions">
                            <button class="btn-log-base" data-meal="snack"><i class="ph ph-plus"></i>Log Base Snack</button>
                            <button class="btn-log-booster" data-food-id="22"><i class="ph ph-plus-circle"></i>+ Peanut Chikki</button>
                            <button class="btn-log-booster" data-food-id="23"><i class="ph ph-plus-circle"></i>+ Khoa</button>
                        </div>
                    </div>
                </div>

                <!-- Dinner -->
                <div class="routine-meal-group">
                    <h3><i class="ph-light ph-pot"></i>Dinner</h3>
                    <div class="routine-card">
                        <p><strong>Base:</strong> 2 Rotis + 1 cup Sambar</p>
                        <div class="routine-actions">
                            <button class="btn-log-base" data-meal="dinner"><i class="ph ph-plus"></i>Log Base Dinner</button>
                            <button class="btn-log-booster" data-food-id="9"><i class="ph ph-plus-circle"></i>+ Ghee (on Roti)</button>
                            <button class="btn-log-booster" data-food-id="4"><i class="ph ph-plus-circle"></i>+ Paneer</button>
                        </div>
                    </div>
                </div>

                <!-- Logged Foods Quick View -->
                <div class="card" style="padding-top: 10px;">
                    <h3>Today's Log</h3>
                    <div id="todays-log-list-routine" class="todays-log-list">
                        <!-- Logged items will appear here -->
                    </div>
                </div>
            </section>

            <!-- Meal Ideas Page -->
            <section id="page-plan" class="page">
                <h2 class="page-title"><i class="ph-light ph-calendar"></i>Meal Ideas</h2>
                <p style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-light);">
                    Use this 7-day plan as a reference for ideas. Log what you eat using the "Log Meal" tab.
                </p>
                <!-- Day selection tabs will be injected here -->
                <nav id="day-selector" class="day-selector"></nav>
                <!-- Meal cards for the selected day will be injected here -->
                <main id="meal-list" class="meal-list"></main>
            </section>

            <!-- Food List Page -->
            <section id="page-food-list" class="page">
                <h2 class="page-title"><i class="ph-light ph-books"></i>Food Database</h2>
                <p style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-light);">
                    Here is a list of all foods available in the app's database for logging.
                </p>
                <div id="food-database-list" class="food-database-list">
                    <!-- Food items will be injected here -->
                </div>
            </section>

        </main>
    </div>
    
    <!-- Toast Message -->
    <div id="toast-message"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DATA (MEAL IDEAS) ---
            const MEAL_PLAN_DATA = [
                {
                    "day": "Monday",
                    "meals": {
                        "breakfast": "2-3 Idlis with chutney. 1 glass milk.",
                        "mid_morning_snack": "1 Ripe Banana.",
                        "lunch": "1 cup Rice + 1 cup Moong Dal (with ghee) + 1 cup Potato curry. Side of curd.",
                        "evening_snack": "1 glass Sweet Lassi or Milkshake.",
                        "dinner": "2 Rotis + 1 cup Paneer Bhurji + 1 cup vegetable soup."
                    }
                },
                {
                    "day": "Tuesday",
                    "meals": {
                        "breakfast": "1 bowl Oats Porridge (cooked with milk, topped with banana & 1 tsp honey).",
                        "mid_morning_snack": "Handful of raisins & 2-3 dates.",
                        "lunch": "1.5 cups Veg Khichdi (with extra ghee) + 1 bowl Curd.",
                        "evening_snack": "1 slice Toast with 1 tbsp Peanut Butter.",
                        "dinner": "2 Rotis + 1 cup Tofu Curry + 1 cup cooked carrot/pumpkin."
                    }
                },
                {
                    "day": "Wednesday",
                    "meals": {
                        "breakfast": "1 bowl Poha (with potatoes & peas).",
                        "mid_morning_snack": "1 glass Mango/Chikoo Shake.",
                        "lunch": "1 cup Rice + 1 cup Masoor Dal + 1 cup Bhindi (Okra).",
                        "evening_snack": "1/2 Avocado (mashed) with salt/lime.",
                        "dinner": "2-3 soft Dosas + 1 cup Sambar (with vegetables)."
                    }
                },
                {
                    "day": "Thursday",
                    "meals": {
                        "breakfast": "1 bowl Upma (with vegetables). 1 glass milk.",
                        "mid_morning_snack": "1 Ripe Banana.",
                        "lunch": "2 Rotis + 1 cup Lauki (Bottle Gourd) Kofta Curry + 1 bowl Curd.",
                        "evening_snack": "1 glass Sattu drink (sweet or savory).",
                        "dinner": "1 cup Rice + 1 cup well-cooked Rajma (mashed slightly) + side salad (cucumber)."
                    }
                },
                {
                    "day": "Friday",
                    "meals": {
                        "breakfast": "2 slices Toast with Peanut Butter & Banana.",
                        "mid_morning_snack": "1 glass Sweet Lassi.",
                        "lunch": "1.5 cups Curd Rice + side of pickle/papad.",
                        "evening_snack": "1 bowl Fruit Chaat (banana, papaya, mango).",
                        "dinner": "2 Rotis + 1 cup Potato-Spinach curry + 1 bowl Dal soup."
                    }
                },
                {
                    "day": "Saturday",
                    "meals": {
                        "breakfast": "2-3 Paneer/Aloo Parathas (with ghee) + Curd.",
                        "mid_morning_snack": "1 glass Milkshake with dates.",
                        "lunch": "1 cup Rice + 1 cup Sambar + 1 cup Mixed Veg (cooked soft).",
                        "evening_snack": "1 bowl Sweet Potato (boiled, with jaggery).",
                        "dinner": "1.5 cups Veg Pulao (with tofu/paneer) + 1 bowl Raita."
                    }
                },
                {
                    "day": "Sunday",
                    "meals": {
                        "breakfast": "1 bowl Vermicelli Upma (Semiya).",
                        "mid_morning_snack": "1 Ripe Banana.",
                        "lunch": "Repeat any lunch you enjoyed.",
                        "evening_snack": "1 slice Toast with Avocado.",
                        "dinner": "2 Rotis + 1 cup Mixed Veg Korma (creamy) + 1 cup Dal."
                    }
                }
            ];
            
            // --- NEW: SAMPLE FOOD DATABASE ---
            // You can easily add more items here.
            // I've included key items from your plan.
            const FOOD_DATABASE = [
                { id: 1, name: 'Rice, White (cooked)', serving: '1 cup (158g)', calories: 204, protein: 4.2, fat: 0.4, carbs: 44.2, calcium_mg: 15.8, iron_mg: 0.2 },
                { id: 2, name: 'Moong Dal (cooked)', serving: '1 cup (202g)', calories: 212, protein: 14.2, fat: 0.8, carbs: 38.7, calcium_mg: 55, iron_mg: 2.7 },
                { id: 3, name: 'Roti / Chapati', serving: '1 medium (60g)', calories: 170, protein: 5.8, fat: 4.9, carbs: 25.8, calcium_mg: 22, iron_mg: 1.5 },
                { id: 4, name: 'Paneer', serving: '100g', calories: 296, protein: 18.3, fat: 22.8, carbs: 4.5, calcium_mg: 480, iron_mg: 1.1 },
                { id: 5, name: 'Tofu, Soft', serving: '100g', calories: 61, protein: 6.9, fat: 3.5, carbs: 2.8, calcium_mg: 111, iron_mg: 1.1 },
                { id: 6, name: 'Potato (cooked)', serving: '1 cup (156g)', calories: 134, protein: 3, fat: 0.1, carbs: 31.1, calcium_mg: 11, iron_mg: 0.5 },
                { id: 7, name: 'Banana, Ripe', serving: '1 medium (118g)', calories: 105, protein: 1.3, fat: 0.4, carbs: 27, calcium_mg: 5.9, iron_mg: 0.3 },
                { id: 8, name: 'Milk, Full Fat (3.5%)', serving: '1 cup (244g)', calories: 149, protein: 7.7, fat: 8, carbs: 11.7, calcium_mg: 276, iron_mg: 0.1 },
                { id: 9, name: 'Ghee', serving: '1 tbsp (14g)', calories: 123, protein: 0, fat: 14, carbs: 0, calcium_mg: 0, iron_mg: 0 },
                { id: 10, name: 'Peanut Butter', serving: '2 tbsp (32g)', calories: 188, protein: 8, fat: 16, carbs: 6.9, calcium_mg: 13, iron_mg: 0.6 },
                { id: 11, name: 'Yogurt / Curd (Full Fat)', serving: '1 cup (245g)', calories: 149, protein: 8.5, fat: 8, carbs: 11.4, calcium_mg: 296, iron_mg: 0.1 },
                { id: 12, name: 'Oats (cooked in water)', serving: '1 cup (234g)', calories: 143, protein: 6, fat: 2.5, carbs: 25.3, calcium_mg: 19, iron_mg: 1.7 },
                { id: 13, name: 'Avocado', serving: '1/2 fruit (100g)', calories: 160, protein: 2, fat: 14.7, carbs: 8.5, calcium_mg: 12, iron_mg: 0.6 },
                // --- NEW FOODS ADDED ---
                { id: 14, name: 'Apple', serving: '1 medium (182g)', calories: 95, protein: 0.5, fat: 0.3, carbs: 25.1, calcium_mg: 10.9, iron_mg: 0.2 },
                { id: 15, name: 'Grapes, Black', serving: '1 cup (151g)', calories: 104, protein: 1.1, fat: 0.2, carbs: 27.3, calcium_mg: 15.1, iron_mg: 0.5 },
                { id: 16, name: 'Pineapple', serving: '1 cup chunks (165g)', calories: 83, protein: 0.9, fat: 0.2, carbs: 21.6, calcium_mg: 21.5, iron_mg: 0.5 },
                { id: 17, name: 'Toor Dal (cooked)', serving: '1 cup (172g)', calories: 205, protein: 12.9, fat: 0.9, carbs: 36.5, calcium_mg: 39.6, iron_mg: 2.2 },
                { id: 18, name: 'Idli', serving: '1 medium (39g)', calories: 58, protein: 1.9, fat: 0.2, carbs: 12.1, calcium_mg: 6.2, iron_mg: 0.3 },
                { id: 19, name: 'Dosa, Plain', serving: '1 medium (85g)', calories: 168, protein: 3.9, fat: 6.8, carbs: 29, calcium_mg: 9.4, iron_mg: 0.9 },
                { id: 20, name: 'Peanut Chutney', serving: '2 tbsp (30g)', calories: 90, protein: 3.5, fat: 7.5, carbs: 4, calcium_mg: 10, iron_mg: 0.4 },
                { id: 21, name: 'Bread, White', serving: '1 slice (30g)', calories: 80, protein: 2.7, fat: 1, carbs: 14.8, calcium_mg: 30, iron_mg: 0.9 },
                { id: 22, name: 'Peanut Chikki', serving: '1 piece (15g)', calories: 73, protein: 2, fat: 4.5, carbs: 6.8, calcium_mg: 10, iron_mg: 0.3 },
                { id: 23, name: 'Khoa / Mawa', serving: '30g (approx 1 oz)', calories: 108, protein: 5.2, fat: 7.8, carbs: 4.3, calcium_mg: 130, iron_mg: 0.1 },
                { id: 24, name: 'Upma, Rava', serving: '1 cup (160g)', calories: 250, protein: 5.5, fat: 8.5, carbs: 38.1, calcium_mg: 18, iron_mg: 1.1 },
                { id: 25, name: 'Puffed Rice (Murmura)', serving: '1 cup (14g)', calories: 56, protein: 1, fat: 0.1, carbs: 12.6, calcium_mg: 0.8, iron_mg: 4.4 },
                { id: 26, name: 'Almonds (Badam)', serving: '10 nuts (12g)', calories: 70, protein: 2.6, fat: 6, carbs: 2.6, calcium_mg: 32.8, iron_mg: 0.4 },
                { id: 27, name: 'Cashews (Kaju)', serving: '10 nuts (11g)', calories: 61, protein: 2, fat: 5.1, carbs: 3.6, calcium_mg: 4.1, iron_mg: 0.7 },
                { id: 28, name: 'Raisins (Kishmish)', serving: '2 tbsp (20g)', calories: 60, protein: 0.6, fat: 0.1, carbs: 15.9, calcium_mg: 10, iron_mg: 0.4 },
                { id: 29, name: 'Marie Biscuit', serving: '2 biscuits (10g)', calories: 45, protein: 0.7, fat: 1.2, carbs: 7.8, calcium_mg: 6, iron_mg: 0.2 },
                { id: 30, name: 'Ven Pongal', serving: '1 cup (204g)', calories: 339, protein: 9.8, fat: 12.8, carbs: 46.5, calcium_mg: 37, iron_mg: 1.9 },
                { id: 31, name: 'Cucumber (Keera)', serving: '1 cup sliced (104g)', calories: 16, protein: 0.7, fat: 0.1, carbs: 3.8, calcium_mg: 16.6, iron_mg: 0.3 },
                { id: 32, name: 'Beetroot (cooked)', serving: '1 cup (170g)', calories: 75, protein: 2.9, fat: 0.3, carbs: 17.6, calcium_mg: 27.2, iron_mg: 1.4 },
                { id: 33, name: 'Carrot (raw)', serving: '1 medium (61g)', calories: 25, protein: 0.6, fat: 0.1, carbs: 5.8, calcium_mg: 20.1, iron_mg: 0.2 },
                { id: 34, name: 'Sambar', serving: '1 cup (250ml)', calories: 115, protein: 5, fat: 3.5, carbs: 18.2, calcium_mg: 40, iron_mg: 1.1 },
                // --- ADDED FOR ROUTINE ---
                { id: 35, name: 'Coffee (with milk, sugar)', serving: '1 cup (250ml)', calories: 60, protein: 3, fat: 3, carbs: 6, calcium_mg: 110, iron_mg: 0.1 },
                { id: 36, name: 'Good Day Biscuit', serving: '1 biscuit (12g)', calories: 50, protein: 0.6, fat: 2.3, carbs: 6.8, calcium_mg: 5, iron_mg: 0.2 }
            ];

            // --- NEW: ROUTINE TEMPLATE ---
            // Maps the data-meal attribute to an array of food IDs from the database
            const ROUTINE_TEMPLATE = {
                'morning_drink': [8], // 1 cup Milk
                'morning_coffee': [35], // 1 cup Coffee
                'breakfast': [18, 18, 18, 20], // 3 Idlis, 1 Peanut Chutney
                'lunch': [1, 2, 11], // 1 Rice, 1 Moong Dal, 1 Curd
                'snack': [35, 36, 36], // 1 Coffee, 2 Good Day Biscuits
                'dinner': [3, 3, 34] // 2 Rotis, 1 Sambar
            };

            const MEAL_TYPE_MAP = { 'breakfast': 'Breakfast', 'mid_morning_snack': 'Morning Snack', 'lunch': 'Lunch', 'evening_snack': 'Evening Snack', 'dinner': 'Dinner' };
            const MEAL_ICON_MAP = { 'breakfast': 'coffee', 'mid_morning_snack': 'apple-logo', 'lunch': 'bowl-food', 'evening_snack': 'cookie', 'dinner': 'pot' };
            const DAY_NAMES = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const MOTIVATIONAL_QUOTES = [
                "Consistency is the key to progress.",
                "One good meal at a time.",
                "Trust the process. Good things take time.",
                "Nourish to flourish.",
                "You are capable of amazing things.",
                "A little progress each day adds up to big results.",
                "Be patient with your body."
            ];

            // --- 2. DOM ELEMENTS ---
            const mainNav = document.querySelector('.main-nav');
            const pages = document.querySelectorAll('.page');
            const toastMessage = document.getElementById('toast-message');

            // Dashboard
            const statStartWeight = document.getElementById('stat-start-weight');
            const statCurrentWeight = document.getElementById('stat-current-weight');
            const statGoalWeight = document.getElementById('stat-goal-weight');
            const statTotalGained = document.getElementById('stat-total-gained');
            const weightLogForm = document.getElementById('weight-log-form');
            const weightInput = document.getElementById('weight-input');
            const statMealsLogged = document.getElementById('stat-meals-logged');
            const statCaloriesLogged = document.getElementById('stat-calories-logged');
            const motivationQuote = document.getElementById('motivation-quote');

            // Meal Ideas
            const daySelectorContainer = document.getElementById('day-selector');
            const mealListContainer = document.getElementById('meal-list');

            // Add Food
            const foodSearchInput = document.getElementById('food-search-input');
            const foodSearchResults = document.getElementById('food-search-results');
            const todaysLogList = document.getElementById('todays-log-list');
            const nutritionSummary = document.getElementById('nutrition-summary');
            const foodDatabaseListContainer = document.getElementById('food-database-list');

            // Routine Log Page
            const routineLogPage = document.getElementById('page-log-routine');
            const todaysLogListRoutine = document.getElementById('todays-log-list-routine');

            // --- 3. STATE ---
            let selectedPlanDay = getCurrentDayName();
            let userProfile = {};
            let weightLog = [];
            let mealLog = {};

            // --- 4. HELPER FUNCTIONS ---
            function getTodayDateString() {
                return new Date().toISOString().split('T')[0];
            }

            function getCurrentDayName() {
                return DAY_NAMES[new Date().getDay()];
            }

            function showToast(message) {
                toastMessage.textContent = message;
                toastMessage.classList.add('show');
                setTimeout(() => {
                    toastMessage.classList.remove('show');
                }, 3000);
            }
            
            // --- 5. LOCALSTORAGE FUNCTIONS ---
            function loadData() {
                // Profile: Start weight 39kg, Goal +1kg/month
                userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
                    startWeight: 39,
                    goalPerMonth: 1,
                    startDate: getTodayDateString()
                };
                
                weightLog = JSON.parse(localStorage.getItem('weightLog')) || [];
                mealLog = JSON.parse(localStorage.getItem('mealLog')) || {};
                
                // Ensure profile has start weight if log is empty
                if (weightLog.length === 0) {
                     userProfile.startWeight = 39;
                     localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
            }

            function saveWeightLog() {
                localStorage.setItem('weightLog', JSON.stringify(weightLog));
            }
            
            function saveMealLog() {
                localStorage.setItem('mealLog', JSON.stringify(mealLog));
            }

            // --- 6. PAGE NAVIGATION ---
            function showPage(pageId) {
                // Hide all pages
                pages.forEach(page => page.classList.remove('active'));
                
                // Deactivate all nav tabs
                mainNav.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                
                // Show the target page
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                // Activate the target nav tab
                const targetTab = mainNav.querySelector(`.nav-tab[data-page="${pageId}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // Load content for the page
                if (pageId === 'dashboard') {
                    renderDashboard();
                } else if (pageId === 'add-custom') { // Renamed from 'add-food'
                    renderTodaysLog('add-custom'); // Pass page context
                    foodSearchInput.focus();
                } else if (pageId === 'log-routine') {
                    renderTodaysLog('log-routine'); // Pass page context
                } else if (pageId === 'plan') {
                    renderDayTabs();
                    renderMealIdeas(selectedPlanDay);
                } else if (pageId === 'food-list') {
                    renderFoodDatabase();
                }
            }
            
            mainNav.addEventListener('click', (e) => {
                const navTab = e.target.closest('.nav-tab');
                if (navTab && navTab.dataset.page) {
                    showPage(navTab.dataset.page);
                }
            });

            // --- 7. DASHBOARD LOGIC ---
            function renderDashboard() {
                loadData(); // Ensure data is fresh
                
                const startWeight = userProfile.startWeight;
                let currentWeight = startWeight;
                
                if (weightLog.length > 0) {
                    // Get the most recent weight log
                    currentWeight = weightLog[weightLog.length - 1].weight;
                }
                
                const totalGained = (currentWeight - startWeight).toFixed(1);
                
                // Calculate goal weight
                const startDate = new Date(userProfile.startDate);
                const today = new Date();
                const monthsPassed = (today.getFullYear() - startDate.getFullYear()) * 12 + (today.getMonth() - startDate.getMonth());
                const goalWeight = startWeight + (userProfile.goalPerMonth * (monthsPassed + 1)); // Goal for *end* of current month

                statStartWeight.textContent = `${startWeight} kg`;
                statCurrentWeight.textContent = `${currentWeight} kg`;
                statTotalGained.textContent = `${totalGained} kg`;
                statGoalWeight.textContent = `${goalWeight.toFixed(1)} kg`;
                
                // Today's meal/calorie summary
                const todayDateStr = getTodayDateString();
                const todayMeals = mealLog[todayDateStr] || [];
                
                const totalMeals = todayMeals.length;
                
                // Calculate calories from the log
                const totalCalories = todayMeals.reduce((sum, logEntry) => {
                    const food = FOOD_DATABASE.find(f => f.id === logEntry.dbId);
                    // Assuming quantity is always 1 for this simple log
                    return sum + (food ? food.calories : 0); 
                }, 0);
                
                statMealsLogged.textContent = totalMeals;
                statCaloriesLogged.textContent = totalCalories;
                
                // Motivation
                motivationQuote.textContent = MOTIVATIONAL_QUOTES[new Date().getDate() % MOTIVATIONAL_QUOTES.length];
            }
            
            weightLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const weight = parseFloat(weightInput.value);
                if (weight > 30 && weight < 100) { // Basic validation
                    const newLogEntry = {
                        date: getTodayDateString(),
                        weight: weight
                    };
                    
                    // Add or update today's log
                    const todayIndex = weightLog.findIndex(entry => entry.date === newLogEntry.date);
                    if (todayIndex > -1) {
                        weightLog[todayIndex] = newLogEntry; // Update
                    } else {
                        weightLog.push(newLogEntry); // Add new
                    }
                    
                    saveWeightLog();
                    showToast('Weight logged successfully!');
                    weightInput.value = '';
                    renderDashboard(); // Refresh stats
                } else {
                    showToast('Please enter a valid weight.');
                }
            });

            // --- 8. LOG MEAL LOGIC ---
            
            // Render search results based on input
            function renderSearchResults(query) {
                if (!query) {
                    foodSearchResults.innerHTML = '';
                    return;
                }
                const lowerQuery = query.toLowerCase();
                const results = FOOD_DATABASE.filter(food => 
                    food.name.toLowerCase().includes(lowerQuery)
                );
                
                foodSearchResults.innerHTML = results.map(food => `
                    <div class="food-result-item" data-id="${food.id}">
                        <p>${food.name}</p>
                        <span>${food.serving} &bull; ${food.calories} kcal</span>
                    </div>
                `).join('');
            }
            
            // Add a food to today's log
            function addFoodToLog(foodId) {
                const food = FOOD_DATABASE.find(f => f.id === foodId);
                if (!food) return;

                const newLogEntry = {
                    dbId: food.id,
                    name: food.name,
                    serving: food.serving
                    // In a real app, you'd add a quantity prompt here
                };
                
                const todayDateStr = getTodayDateString();
                if (!mealLog[todayDateStr]) {
                    mealLog[todayDateStr] = [];
                }
                
                mealLog[todayDateStr].push(newLogEntry);
                saveMealLog();
                
                showToast(`${food.name} added to log!`);
                foodSearchInput.value = '';
                foodSearchResults.innerHTML = '';
                renderTodaysLog('add-custom'); // Re-render the custom add page
            }
            
            // Remove a food from today's log
            function removeFoodFromLog(index) {
                const todayDateStr = getTodayDateString();
                if (mealLog[todayDateStr] && mealLog[todayDateStr][index]) {
                    const removed = mealLog[todayDateStr].splice(index, 1);
                    saveMealLog();
                    showToast(`${removed[0].name} removed.`);
                    renderTodaysLog('add-custom'); // Re-render both
                    renderTodaysLog('log-routine'); // Re-render both
                }
            }
            
            // Calculate and render totals
            function calculateAndRenderTotals() {
                const todayDateStr = getTodayDateString();
                const todayMeals = mealLog[todayDateStr] || [];
                
                const totals = {
                    calories: 0,
                    protein: 0,
                    fat: 0,
                    carbs: 0,
                    calcium_mg: 0,
                    iron_mg: 0
                };
                
                todayMeals.forEach(logEntry => {
                    const food = FOOD_DATABASE.find(f => f.id === logEntry.dbId);
                    if (food) {
                        totals.calories += food.calories;
                        totals.protein += food.protein;
                        totals.fat += food.fat;
                        totals.carbs += food.carbs;
                        totals.calcium_mg += food.calcium_mg;
                        totals.iron_mg += food.iron_mg;
                    }
                });
                
                // Render the summary
                nutritionSummary.innerHTML = `
                    <div class="summary-item">
                        <p>Total Calories</p>
                        <span class="summary-value">${totals.calories.toFixed(0)} kcal</span>
                    </div>
                    <div class="summary-item">
                        <p>Total Protein</p>
                        <span class="summary-value">${totals.protein.toFixed(1)} g</span>
                    </div>
                    <div class="summary-item">
                        <p>Total Fat</p>
                        <span class="summary-value">${totals.fat.toFixed(1)} g</span>
                    </div>
                    <div class="summary-item">
                        <p>Total Carbs</p>
                        <span class="summary-value">${totals.carbs.toFixed(1)} g</span>
                    </div>
                    <div class="summary-item">
                        <p>Total Calcium</p>
                        <span class="summary-value">${totals.calcium_mg.toFixed(0)} mg</span>
                    </div>
                    <div class="summary-item">
                        <p>Total Iron</p>
                        <span class="summary-value">${totals.iron_mg.toFixed(1)} mg</span>
                    </div>
                `;
            }
            
            // Render the list of food logged today
            // context: 'add-custom' or 'log-routine'
            function renderTodaysLog(context) {
                const todayDateStr = getTodayDateString();
                const todayMeals = mealLog[todayDateStr] || [];
                
                let targetList;
                if (context === 'add-custom') {
                    targetList = todaysLogList;
                    // Also calculate totals when on this page
                    calculateAndRenderTotals(); 
                } else if (context === 'log-routine') {
                    targetList = todaysLogListRoutine;
                } else {
                    return; // Don't render if context is wrong
                }

                if (todayMeals.length === 0) {
                    targetList.innerHTML = `<p style="text-align: center; color: var(--text-light); padding: 16px 0;">No foods logged yet today.</p>`;
                } else {
                    targetList.innerHTML = todayMeals.map((logEntry, index) => `
                        <div class="log-item">
                            <div class="log-item-details">
                                <p>${logEntry.name}</p>
                                <span>${logEntry.serving}</span>
                            </div>
                            <button class="remove-log-btn" data-index="${index}" title="Remove item">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
                
                // Only the 'add-custom' page has the summary box
                if(context === 'add-custom') {
                    calculateAndRenderTotals();
                }
            }

            // --- Event Listeners for Add Food ---
            foodSearchInput.addEventListener('input', () => {
                renderSearchResults(foodSearchInput.value);
            });
            
            foodSearchResults.addEventListener('click', (e) => {
                const item = e.target.closest('.food-result-item');
                if (item && item.dataset.id) {
                    addFoodToLog(parseInt(item.dataset.id));
                }
            });
            
            // Updated to work on both log lists
            todaysLogList.addEventListener('click', (e) => {
                const button = e.target.closest('.remove-log-btn');
                if (button && button.dataset.index) {
                    removeFoodFromLog(parseInt(button.dataset.index));
                }
            });
            todaysLogListRoutine.addEventListener('click', (e) => {
                const button = e.target.closest('.remove-log-btn');
                if (button && button.dataset.index) {
                    removeFoodFromLog(parseInt(button.dataset.index));
                }
            });
            
            // --- 9. NEW: ROUTINE LOGIC ---
            routineLogPage.addEventListener('click', (e) => {
                const baseBtn = e.target.closest('.btn-log-base');
                const boosterBtn = e.target.closest('.btn-log-booster');

                if (baseBtn && baseBtn.dataset.meal) {
                    const mealKey = baseBtn.dataset.meal;
                    const foodIds = ROUTINE_TEMPLATE[mealKey];
                    
                    if (foodIds) {
                        foodIds.forEach(id => {
                            const food = FOOD_DATABASE.find(f => f.id === id);
                            if (food) {
                                // A "silent" add to log, without toast spam
                                const newLogEntry = { dbId: food.id, name: food.name, serving: food.serving };
                                const todayDateStr = getTodayDateString();
                                if (!mealLog[todayDateStr]) {
                                    mealLog[todayDateStr] = [];
                                }
                                mealLog[todayDateStr].push(newLogEntry);
                            }
                        });
                        saveMealLog();
                        showToast('Routine meal added!');
                        renderTodaysLog('log-routine'); // Update the list on this page
                    }
                }

                if (boosterBtn && boosterBtn.dataset.foodId) {
                    const foodId = parseInt(boosterBtn.dataset.foodId);
                    const food = FOOD_DATABASE.find(f => f.id === foodId);
                    if (!food) return;
    
                    const newLogEntry = { dbId: food.id, name: food.name, serving: food.serving };
                    const todayDateStr = getTodayDateString();
                    if (!mealLog[todayDateStr]) {
                        mealLog[todayDateStr] = [];
                    }
                    mealLog[todayDateStr].push(newLogEntry);
                    saveMealLog();
                    showToast(`${food.name} (booster) added!`);
                    renderTodaysLog('log-routine'); // Update the list on this page
                }
            });

            // --- 10. FOOD LIST PAGE LOGIC ---
            function renderFoodDatabase() {
                foodDatabaseListContainer.innerHTML = '';
                
                // Sort database alphabetically by name
                const sortedDB = [...FOOD_DATABASE].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedDB.forEach(food => {
                    const cardHTML = `
                        <div class="food-list-item">
                            <h3>${food.name}</h3>
                            <p class="serving-info">${food.serving}</p>
                            <div class="food-list-nutrients">
                                <span><strong>Calories:</strong> ${food.calories.toFixed(0)} kcal</span>
                                <span><strong>Protein:</strong> ${food.protein.toFixed(1)} g</span>
                                <span><strong>Fat:</strong> ${food.fat.toFixed(1)} g</span>
                                <span><strong>Carbs:</strong> ${food.carbs.toFixed(1)} g</span>
                                <span><strong>Calcium:</strong> ${food.calcium_mg.toFixed(0)} mg</span>
                                <span><strong>Iron:</strong> ${food.iron_mg.toFixed(1)} mg</span>
                            </div>
                        </div>
                    `;
                    foodDatabaseListContainer.insertAdjacentHTML('beforeend', cardHTML);
                });
            }

            // --- 11. MEAL IDEAS LOGIC (from previous app) ---
            function renderDayTabs() {
                daySelectorContainer.innerHTML = '';
                MEAL_PLAN_DATA.forEach(dayData => {
                    const tab = document.createElement('div');
                    tab.className = 'day-tab';
                    tab.textContent = dayData.day;
                    tab.dataset.dayName = dayData.day;
                    
                    if (dayData.day === selectedPlanDay) {
                        tab.classList.add('active');
                    }
                    daySelectorContainer.appendChild(tab);
                });
            }

            function renderMealIdeas(dayName) {
                mealListContainer.innerHTML = '';
                const dayData = MEAL_PLAN_DATA.find(d => d.day === dayName);
                if (!dayData) return;

                Object.entries(dayData.meals).forEach(([key, description]) => {
                    const mealName = MEAL_TYPE_MAP[key] || 'Meal';
                    const mealIcon = MEAL_ICON_MAP[key] || 'dot';
                    
                    // NOTE: Removed the "Track" button. This is just for viewing.
                    const cardHTML = `
                        <div class="meal-card">
                            <i class="ph-light ph-${mealIcon} meal-icon"></i>
                            <h3 class="meal-title">${mealName}</h3>
                            <p class="meal-description">${description}</p>
                        </div>
                    `;
                    mealListContainer.insertAdjacentHTML('beforeend', cardHTML);
                });
            }

            daySelectorContainer.addEventListener('click', (e) => {
                const tab = e.target.closest('.day-tab');
                if (tab && tab.dataset.dayName) {
                    selectedPlanDay = tab.dataset.dayName;
                    renderDayTabs(); // Re-render tabs to show active state
                    renderMealIdeas(selectedPlanDay); // Re-render meals
                }
            });

            // --- 11. INITIALIZATION ---
            function init() {
                // Rename 'page-add-food' to 'page-add-custom' to match nav
                const oldPage = document.getElementById('page-add-food');
                if (oldPage) {
                    oldPage.id = 'page-add-custom';
                }

                loadData();
                showPage('dashboard'); // Start on the dashboard
            }

            init();
        });
    </script>

</body>
</html>
