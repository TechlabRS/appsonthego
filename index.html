<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RaGhaS Vault v3.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5; /* Modern Indigo */
            --primary-hover: #4338ca;
            --bg-light: #f3f4f6;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition-speed: 0.3s;
        }

        body {
            background-color: var(--bg-light);
            font-family: 'Inter', sans-serif;
            transition: background-color var(--transition-speed);
            -webkit-tap-highlight-color: transparent;
        }

        /* Dark Mode Variables */
        [data-bs-theme="dark"] body {
            background-color: #111827;
        }
        [data-bs-theme="dark"] .card {
            background-color: #1f2937;
            border-color: #374151;
        }
        [data-bs-theme="dark"] .password-chip {
            background-color: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        [data-bs-theme="dark"] .password-chip:hover {
            border-color: #6366f1;
            background-color: #4b5563;
        }

        /* Navbar & Branding */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .navbar-brand {
            font-weight: 700;
            letter-spacing: -0.5px;
            font-size: 1.35rem;
        }

        /* Layout & Views */
        .view {
            display: none;
            padding-top: 20px;
            padding-bottom: 40px;
            animation: fadeIn 0.4s ease-in-out;
        }
        .active-view {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            font-weight: 600;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        [data-bs-theme="dark"] .card-header {
             border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Strength Meter */
        .strength-meter {
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 10px;
            margin: 8px 0;
            overflow: hidden;
        }
        [data-bs-theme="dark"] .strength-meter { background-color: #4b5563; }
        .strength-meter div {
            height: 100%;
            border-radius: 10px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.4s;
        }
        .strength-weak { width: 30%; background-color: #ef4444; }
        .strength-medium { width: 60%; background-color: #f59e0b; }
        .strength-strong { width: 100%; background-color: #10b981; }

        /* Rich Password Chips (Cards) */
        .password-chip-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 5px;
        }
        .password-chip {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .password-chip:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        .password-chip .chip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .password-chip .chip-website {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }
        [data-bs-theme="dark"] .password-chip .chip-website { color: #818cf8; }
        .password-chip .chip-username {
            font-size: 0.85rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        [data-bs-theme="dark"] .password-chip .chip-username { color: #9ca3af; }

        .chip-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Quick Copy Button on Chip */
        .btn-chip-action {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: transparent;
            color: #9ca3af;
            transition: all 0.2s;
        }
        .btn-chip-action:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--primary-color);
        }
        [data-bs-theme="dark"] .btn-chip-action:hover {
             background-color: rgba(255,255,255,0.1);
        }

        /* Floating Action Button (Mobile) */
        .fab-add {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.4);
            display: none; /* Shown via JS media query logic mostly */
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 1000;
            border: none;
            transition: transform 0.2s;
        }
        .fab-add:hover { transform: scale(1.05); background-color: var(--primary-hover); }
        .fab-add:active { transform: scale(0.95); }

        /* Typography Utilities */
        .text-mono { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .password-chip-container {
                max-height: none; /* Scroll the whole page on mobile */
                grid-template-columns: 1fr; /* Full width cards */
            }
            #addCredentialCard {
                display: none; /* Hidden by default on mobile, toggled */
            }
            .fab-add { display: flex; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="app.ui.refreshPage()">
                <i class="bi bi-shield-lock-fill me-2"></i>RaGhaS Vault
            </a>
            
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-light border-0" onclick="app.ui.toggleTheme()" title="Toggle Dark Mode">
                    <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
                </button>
                
                <span id="masterKeyStatus" class="badge bg-secondary d-none d-md-inline-block">Init...</span>
                <div id="sessionTimerDisplay" class="badge bg-success font-monospace" style="display: none; font-size: 0.9rem;">--:--</div>
                
                <button id="logoutButton" class="btn btn-sm btn-warning ms-2 fw-bold" style="display: none;" onclick="app.session.logout()">
                    <i class="bi bi-power"></i> <span class="d-none d-sm-inline">Logout</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="globalAlertPlaceholder"></div>

        <div id="setupView" class="view">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card shadow-lg">
                        <div class="card-body p-4 p-md-5 text-center">
                            <div class="mb-4 text-primary">
                                <i class="bi bi-shield-check" style="font-size: 4rem;"></i>
                            </div>
                            <h2 class="card-title fw-bold mb-3">Setup Your Vault</h2>
                            <p class="text-muted mb-4">Create a strong master password. This is the only key to access your data. We cannot recover it for you.</p>
                            
                            <div class="text-start">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Master Password</label>
                                    <input type="password" class="form-control form-control-lg" id="setupMasterPassword" 
                                           oninput="app.passwords.checkPasswordStrength(this.value, 'setupPasswordStrengthMeter', 'setupPasswordStrengthText')" placeholder="Make it strong...">
                                    <div class="strength-meter" id="setupPasswordStrengthMeter"><div></div></div>
                                    <small id="setupPasswordStrengthText" class="text-muted"></small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Confirm Password</label>
                                    <input type="password" class="form-control form-control-lg" id="confirmMasterPassword" placeholder="Repeat password">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label">Hint (Optional)</label>
                                    <input type="text" class="form-control" id="masterPasswordHint" placeholder="e.g. My first pet's name">
                                </div>
                            </div>

                            <button class="btn btn-primary btn-lg w-100 py-3 fw-bold" onclick="app.masterKey.handleSetMasterKey()">
                                Create Secure Vault
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loginView" class="view">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow-lg mt-5">
                        <div class="card-body p-4 p-md-5">
                            <div class="text-center mb-4">
                                <i class="bi bi-lock-fill text-primary" style="font-size: 3rem;"></i>
                                <h3 class="fw-bold mt-2">Vault Locked</h3>
                                <p class="text-muted">Enter your Master Password to unlock.</p>
                            </div>
                            
                            <div class="mb-4">
                                <input type="password" class="form-control form-control-lg text-center" id="loginMasterPassword" placeholder="••••••••">
                            </div>

                            <button class="btn btn-primary btn-lg w-100 mb-3" onclick="app.masterKey.handleLogin()">Unlock Vault</button>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-link btn-sm text-decoration-none" onclick="app.ui.showHintModal()">Show Hint</button>
                                <button class="btn btn-link btn-sm text-decoration-none text-danger" onclick="app.ui.showRecoveryKeyModalPrompt()">Use Recovery Key</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="mainAppView" class="view">
            <div class="d-md-none mb-3">
                <button class="btn btn-primary w-100" type="button" onclick="app.ui.toggleAddFormMobile()">
                    <i class="bi bi-plus-lg me-2"></i> Add New Credential
                </button>
            </div>

            <div class="row">
                <div class="col-md-5 mb-4" id="addCredentialCard">
                    <div class="card h-100 border-primary border-opacity-25">
                        <div class="card-header bg-primary bg-opacity-10 text-primary">
                            <span id="saveUpdateFormTitle"><i class="bi bi-plus-circle-fill me-2"></i>Add Credential</span>
                            <button class="btn-close d-md-none" onclick="app.ui.toggleAddFormMobile()"></button>
                        </div>
                        <div class="card-body">
                            <input type="hidden" id="editingPasswordId">
                            
                            <div class="mb-3">
                                <label class="form-label small text-uppercase text-muted fw-bold">Website / App</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-globe"></i></span>
                                    <input type="text" class="form-control" id="website" placeholder="example.com">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small text-uppercase text-muted fw-bold">Username</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control" id="username" placeholder="user@email.com">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label small text-uppercase text-muted fw-bold">Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" oninput="app.passwords.checkPasswordStrength(this.value, 'passwordStrengthMeter', 'passwordStrengthText')">
                                    <button class="btn btn-outline-secondary" type="button" onclick="app.ui.togglePasswordVisibility('password')"><i class="bi bi-eye"></i></button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="app.passwords.generateStrongPassword('password')" title="Generate Strong"><i class="bi bi-magic"></i></button>
                                </div>
                                <div class="strength-meter" id="passwordStrengthMeter"><div></div></div>
                                <small id="passwordStrengthText" class="text-muted fst-italic"></small>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" id="savePasswordButton" onclick="app.passwords.handleSavePassword()">
                                    <i class="bi bi-save2-fill me-2"></i>Save
                                </button>
                                <button class="btn btn-light text-muted" id="cancelEditButton" style="display:none;" onclick="app.ui.resetSaveForm()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-7 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <div><i class="bi bi-collection-fill me-2"></i>Vault Items</div>
                            <div class="input-group input-group-sm w-50">
                                <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="Search..." onkeyup="app.ui.renderPasswordList()">
                            </div>
                        </div>
                        <div class="card-body bg-light bg-opacity-10">
                            <div id="passwordChipContainer" class="password-chip-container">
                                </div>
                            
                            <div id="noPasswordsMessage" class="text-center py-5" style="display:none;">
                                <i class="bi bi-shield-plus text-muted opacity-25" style="font-size: 4rem;"></i>
                                <p class="mt-3 text-muted">Your vault is empty.<br>Add your first credential!</p>
                            </div>
                             <div id="noSearchResultsMessage" class="text-center py-5" style="display:none;">
                                <i class="bi bi-search text-muted opacity-25" style="font-size: 3rem;"></i>
                                <p class="mt-3 text-muted">No matches found.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-2">
                <div class="card-header bg-secondary bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#settingsCollapse" style="cursor: pointer;">
                    <span><i class="bi bi-sliders me-2"></i>Settings & Tools</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
                <div id="settingsCollapse" class="collapse show">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-info w-100 h-100 py-2" onclick="app.ui.showHintModal(true)">
                                    <i class="bi bi-lightbulb d-block fs-4 mb-1"></i> Hint
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-primary w-100 h-100 py-2" onclick="app.passwords.exportPasswords()">
                                    <i class="bi bi-cloud-download d-block fs-4 mb-1"></i> Export
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-secondary w-100 h-100 py-2" onclick="document.getElementById('importFile').click()">
                                    <i class="bi bi-cloud-upload d-block fs-4 mb-1"></i> Import
                                    <input type="file" id="importFile" hidden accept=".json" onchange="app.passwords.handleImportFile(event)">
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-danger w-100 h-100 py-2" onclick="app.ui.confirmClearAllData()">
                                    <i class="bi bi-trash3 d-block fs-4 mb-1"></i> Reset App
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-end">
                             <button class="btn btn-sm btn-link text-warning" onclick="app.ui.showRecoveryKeyModalPrompt(true)">Recover Master Password</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="fab-add d-md-none" onclick="app.ui.toggleAddFormMobile()">
            <i class="bi bi-plus-lg"></i>
        </button>

    </div>

    <div class="modal fade" id="recoveryKeyModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-key-fill me-2"></i>Emergency Recovery Key</h5>
                </div>
                <div class="modal-body text-center">
                    <div id="recoveryKeyModalAlertPlaceholder"></div>
                    <p class="text-danger fw-bold small text-uppercase">Do not lose this.</p>
                    <p class="small text-muted">This key is the ONLY way to access your accounts if you forget your master password.</p>
                    
                    <div class="p-3 bg-light rounded border mb-3">
                        <code id="recoveryKeyDisplayArea" class="text-break fs-5 text-dark fw-bold"></code>
                    </div>

                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                        <button class="btn btn-success btn-sm" onclick="app.masterKey.copyRecoveryKeyToClipboard()"><i class="bi bi-clipboard"></i> Copy</button>
                        <button class="btn btn-dark btn-sm" onclick="app.masterKey.downloadRecoveryKey()"><i class="bi bi-download"></i> Save File</button>
                        <button class="btn btn-primary btn-sm" onclick="app.masterKey.shareRecoveryKey()"><i class="bi bi-share-fill"></i> Share</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger w-100" onclick="app.ui.hideModal('recoveryKeyModal'); app.ui.navigateToView('loginView')">I Have Saved It Securely</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="passwordActionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold text-primary" id="actionModalWebsite"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3" id="actionModalUsername"></p>
                    
                    <label class="form-label small fw-bold">Password</label>
                    <div class="input-group mb-3">
                        <input type="password" class="form-control text-mono" id="actionModalPasswordDisplay" readonly value="************">
                        <button class="btn btn-outline-secondary" type="button" id="actionModalRevealBtn" onclick="app.passwords.revealPasswordInModal()"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-outline-primary" type="button" onclick="app.passwords.copyPasswordFromModal()"><i class="bi bi-clipboard"></i></button>
                    </div>
                    
                    <div id="passwordActionModalAlertPlaceholder"></div>
                    
                    <div class="row g-2 mt-4">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" onclick="app.passwords.editPasswordFromModal()">
                                <i class="bi bi-pencil me-1"></i> Edit
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-danger w-100" onclick="app.passwords.deletePasswordFromModal()">
                                <i class="bi bi-trash me-1"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <i class="bi bi-exclamation-circle text-warning display-4 mb-3"></i>
                    <p class="fw-bold mb-3" id="confirmationModalMessage">Are you sure?</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger px-4" id="confirmationModalConfirm">Yes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="hintModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center pb-4">
                    <i class="bi bi-lightbulb-fill text-warning fs-1 mb-2"></i>
                    <h5 class="fw-bold">Password Hint</h5>
                    <p class="bg-light p-3 rounded mt-2" id="hintDisplay"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="enterRecoveryKeyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Recover Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="enterRecoveryKeyModalAlertPlaceholder"></div>
                    <label class="form-label">Paste your Recovery Key:</label>
                    <textarea class="form-control text-mono mb-3" id="userProvidedRecoveryKey" rows="3"></textarea>
                    <button type="button" class="btn btn-primary w-100" onclick="app.masterKey.handleShowRecoveredMasterPassword()">Recover</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="recoveredMasterPasswordDisplayModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-success">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Success</h5>
                </div>
                <div class="modal-body text-center">
                    <div id="recoveredMasterPasswordDisplayModalAlertPlaceholder"></div>
                    <p>Your Master Password is:</p>
                    <div id="actualRecoveredPasswordDisplay" class="h3 fw-bold text-mono text-primary my-3"></div>
                    <button class="btn btn-outline-success btn-sm" onclick="app.ui.copyRecoveredMasterPasswordToClipboard()">Copy to Clipboard</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success w-100" onclick="app.ui.closeRecoveredPasswordModalAndFocusLogin()">Go to Login</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const app = {};
        
        // --- CONFIGURATION ---
        app.config = {
            storageKeys: { appData: 'raghasVault_app', passwords: 'raghasVault_creds', theme: 'raghasVault_theme' },
            pbkdf2: { iterations: 100000, keySize: 256 / 32, saltSize: 128 / 8 },
            aes: { ivSize: 128 / 8 },
            recoveryKeyLength: 32, 
            sessionTimeoutDuration: 5 * 60 * 1000, 
            strongPasswordLength: 16,
            masterPasswordCheckValue: "VALIDATION_CHECK_STRING"
        };

        // --- STATE MANAGEMENT ---
        app.state = {
            masterKeySalt: null, derivedEncryptionKey: null, isAuthenticated: false, sessionTimeoutId: null,
            currentRecoveryKey: null, passwords: [], editingPasswordId: null, tempRecoveredMasterPassword: null,
            currentActionEntryId: null
        };

        // --- UI CONTROLLER ---
        app.ui = {
            elements: {
                // Modals
                modals: ['recoveryKeyModal', 'hintModal', 'enterRecoveryKeyModal', 'confirmationModal', 'recoveredMasterPasswordDisplayModal', 'passwordActionModal'],
                bsModals: {}, // Store Bootstrap instances
            },
            
            init: () => {
                // Initialize Bootstrap Modals
                app.ui.elements.modals.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) app.ui.elements.bsModals[id] = new bootstrap.Modal(el);
                });
                
                // Load Theme
                const savedTheme = localStorage.getItem(app.config.storageKeys.theme) || 'light';
                document.documentElement.setAttribute('data-bs-theme', savedTheme);
                app.ui.updateThemeIcon(savedTheme);

                // Setup View Logic
                const appData = app.storage.getAppData();
                if (appData && appData.masterKeySalt) {
                    app.state.masterKeySalt = appData.masterKeySalt;
                    app.ui.updateMasterKeyStatus("Locked", "bg-danger");
                    app.ui.navigateToView('loginView');
                } else {
                    app.ui.navigateToView('setupView');
                }
            },

            navigateToView: (viewId) => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
                document.getElementById(viewId).classList.add('active-view');
                
                // Navbar State
                const logoutBtn = document.getElementById('logoutButton');
                const timerDisplay = document.getElementById('sessionTimerDisplay');
                
                if (viewId === 'mainAppView' && app.state.isAuthenticated) {
                    logoutBtn.style.display = 'inline-block';
                    timerDisplay.style.display = 'inline-block';
                    app.ui.renderPasswordList();
                } else {
                    logoutBtn.style.display = 'none';
                    if (viewId !== 'loginView') timerDisplay.style.display = 'none';
                }
            },

            toggleTheme: () => {
                const currentTheme = document.documentElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem(app.config.storageKeys.theme, newTheme);
                app.ui.updateThemeIcon(newTheme);
            },

            updateThemeIcon: (theme) => {
                const icon = document.getElementById('themeIcon');
                if(theme === 'dark') { icon.classList.remove('bi-moon-stars-fill'); icon.classList.add('bi-sun-fill'); }
                else { icon.classList.remove('bi-sun-fill'); icon.classList.add('bi-moon-stars-fill'); }
            },

            toggleAddFormMobile: () => {
                // Toggle visibility of the Add Form card on mobile
                const card = document.getElementById('addCredentialCard');
                if(window.getComputedStyle(card).display === 'none') {
                    card.style.display = 'block';
                    // Scroll to it
                    card.scrollIntoView({behavior: "smooth"});
                } else {
                    card.style.display = 'none';
                }
            },

            renderPasswordList: () => {
                if (!app.state.isAuthenticated) return;
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const container = document.getElementById('passwordChipContainer');
                container.innerHTML = '';
                
                const filtered = app.state.passwords.filter(p => 
                    p.website.toLowerCase().includes(searchTerm) || p.username.toLowerCase().includes(searchTerm)
                );

                document.getElementById('noPasswordsMessage').style.display = (app.state.passwords.length === 0) ? 'block' : 'none';
                document.getElementById('noSearchResultsMessage').style.display = (app.state.passwords.length > 0 && filtered.length === 0) ? 'block' : 'none';

                filtered.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'password-chip';
                    div.onclick = (e) => {
                        // Prevent click if clicking the action button
                        if(e.target.closest('.btn-chip-action')) return;
                        app.ui.showPasswordActions(p.id);
                    };
                    
                    div.innerHTML = `
                        <div class="chip-header">
                            <div class="chip-website" title="${p.website}">${p.website}</div>
                        </div>
                        <div class="chip-username" title="${p.username}">${p.username}</div>
                        <div class="chip-actions">
                            <button class="btn-chip-action" title="Copy Username" onclick="app.ui.copyToClipboard('${p.username}', 'Username')">
                                <i class="bi bi-person-fill-check"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            showPasswordActions: (id) => {
                const entry = app.state.passwords.find(p => p.id === id);
                if(!entry) return;
                app.state.currentActionEntryId = id;
                document.getElementById('actionModalWebsite').textContent = entry.website;
                document.getElementById('actionModalUsername').textContent = entry.username;
                
                const passField = document.getElementById('actionModalPasswordDisplay');
                passField.value = '************';
                passField.type = 'password';
                document.getElementById('actionModalRevealBtn').innerHTML = '<i class="bi bi-eye"></i>';
                
                app.ui.showModal('passwordActionModal');
            },

            // --- HELPER FUNCTIONS ---
            updateMasterKeyStatus: (text, badgeClass) => {
                const el = document.getElementById('masterKeyStatus');
                el.textContent = text;
                el.className = `badge ${badgeClass} d-none d-md-inline-block`;
            },
            
            showAlert: (msg, type = 'info', placeholderId = 'globalAlertPlaceholder', duration = 4000) => {
                const ph = document.getElementById(placeholderId);
                if(!ph) return;
                const alertId = 'alert-' + Date.now();
                ph.innerHTML = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
                    ${msg} <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                if(duration) setTimeout(() => { const el = document.getElementById(alertId); if(el) bootstrap.Alert.getOrCreateInstance(el).close(); }, duration);
            },

            showModal: (id) => app.ui.elements.bsModals[id]?.show(),
            hideModal: (id) => app.ui.elements.bsModals[id]?.hide(),
            
            refreshPage: () => window.location.reload(),

            togglePasswordVisibility: (id) => {
                const el = document.getElementById(id);
                const btn = el.nextElementSibling; // Assuming button is next
                if(el.type === 'password') {
                    el.type = 'text';
                    btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
                } else {
                    el.type = 'password';
                    btn.innerHTML = '<i class="bi bi-eye"></i>';
                }
            },

            copyToClipboard: (text, type = "Item") => {
                navigator.clipboard.writeText(text).then(() => app.ui.showAlert(`${type} copied!`, "success", 'globalAlertPlaceholder', 2000))
                .catch(() => app.ui.showAlert("Failed to copy", "danger"));
            },

            resetSaveForm: () => {
                document.getElementById('saveUpdateFormTitle').innerHTML = '<i class="bi bi-plus-circle-fill me-2"></i>Add Credential';
                document.getElementById('editingPasswordId').value = '';
                document.getElementById('website').value = '';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('password').type = 'password';
                document.getElementById('savePasswordButton').textContent = 'Save';
                document.getElementById('savePasswordButton').className = 'btn btn-primary';
                document.getElementById('cancelEditButton').style.display = 'none';
                app.passwords.checkPasswordStrength('', 'passwordStrengthMeter', 'passwordStrengthText');
                app.state.editingPasswordId = null;
                // On mobile, maybe hide the form
                if(window.innerWidth < 768) document.getElementById('addCredentialCard').style.display = 'none';
            },

            confirm: (msg, action) => {
                document.getElementById('confirmationModalMessage').textContent = msg;
                const btn = document.getElementById('confirmationModalConfirm');
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.onclick = () => { action(); app.ui.hideModal('confirmationModal'); };
                app.ui.showModal('confirmationModal');
            },

            confirmClearAllData: () => {
                app.ui.confirm("CRITICAL: This will wipe ALL passwords and keys. This cannot be undone.", () => app.masterKey.clearAllData());
            },

            // Hint & Recovery Modals
            showHintModal: (checkAuth = false) => {
                if(checkAuth && !app.state.isAuthenticated) return app.ui.showAlert("Login required", "warning");
                const hint = app.storage.getAppData()?.hint || "No hint set.";
                document.getElementById('hintDisplay').textContent = hint;
                app.ui.showModal('hintModal');
            },
            
            showRecoveryKeyModalPrompt: (checkAuth = false) => {
                if(checkAuth && !app.state.isAuthenticated) return app.ui.showAlert("Login required", "warning");
                document.getElementById('userProvidedRecoveryKey').value = '';
                app.ui.showModal('enterRecoveryKeyModal');
            },
            
            displayRecoveredMasterPassword: (pass) => {
                app.state.tempRecoveredMasterPassword = pass;
                document.getElementById('actualRecoveredPasswordDisplay').textContent = pass;
                app.ui.showModal('recoveredMasterPasswordDisplayModal');
            },
            
            copyRecoveredMasterPasswordToClipboard: () => {
                if(app.state.tempRecoveredMasterPassword) 
                    app.ui.copyToClipboard(app.state.tempRecoveredMasterPassword, "Master Password");
            },
            
            closeRecoveredPasswordModalAndFocusLogin: () => {
                app.ui.hideModal('recoveredMasterPasswordDisplayModal');
                app.state.tempRecoveredMasterPassword = null;
                document.getElementById('actualRecoveredPasswordDisplay').textContent = "";
                app.ui.navigateToView('loginView');
            }
        };

        // --- CRYPTO MODULE ---
        app.crypto = {
            generateSalt: () => CryptoJS.lib.WordArray.random(app.config.pbkdf2.saltSize).toString(CryptoJS.enc.Hex),
            deriveKey: (password, saltHex) => { 
                return CryptoJS.PBKDF2(password, CryptoJS.enc.Hex.parse(saltHex), { 
                    keySize: app.config.pbkdf2.keySize, 
                    iterations: app.config.pbkdf2.iterations, 
                    hasher: CryptoJS.algo.SHA256 
                });
            },
            encrypt: (plaintext, key) => { 
                const iv = CryptoJS.lib.WordArray.random(app.config.aes.ivSize);
                const encrypted = CryptoJS.AES.encrypt(plaintext, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }); 
                return { iv: iv.toString(CryptoJS.enc.Hex), ciphertext: encrypted.ciphertext.toString(CryptoJS.enc.Base64) };
            },
            decrypt: (encryptedData, key) => { 
                try {
                    const iv = CryptoJS.enc.Hex.parse(encryptedData.iv);
                    const cipherParams = CryptoJS.lib.CipherParams.create({ ciphertext: CryptoJS.enc.Base64.parse(encryptedData.ciphertext) });
                    const decrypted = CryptoJS.AES.decrypt(cipherParams, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
                    return decrypted.toString(CryptoJS.enc.Utf8);
                } catch (e) { return null; }
            },
            generateRandomKey: (len) => CryptoJS.lib.WordArray.random(len).toString(CryptoJS.enc.Hex)
        };

        // --- STORAGE MODULE ---
        app.storage = {
            getAppData: () => JSON.parse(localStorage.getItem(app.config.storageKeys.appData)),
            saveAppData: (data) => localStorage.setItem(app.config.storageKeys.appData, JSON.stringify(data)),
            getPasswords: () => JSON.parse(localStorage.getItem(app.config.storageKeys.passwords)) || [],
            savePasswords: (data) => localStorage.setItem(app.config.storageKeys.passwords, JSON.stringify(data))
        };

        // --- MASTER KEY LOGIC ---
        app.masterKey = {
            handleSetMasterKey: () => {
                const pwd = document.getElementById('setupMasterPassword').value;
                const confirm = document.getElementById('confirmMasterPassword').value;
                if(pwd.length < 8) return app.ui.showAlert("Password too short (min 8 chars).", "warning", "globalAlertPlaceholder");
                if(pwd !== confirm) return app.ui.showAlert("Passwords do not match.", "danger", "globalAlertPlaceholder");

                // Crypto Setup
                app.state.masterKeySalt = app.crypto.generateSalt();
                app.state.currentRecoveryKey = app.crypto.generateRandomKey(app.config.recoveryKeyLength);
                
                // 1. Encrypt Master Pass with Recovery Key (for emergency)
                const recEncKey = CryptoJS.enc.Hex.parse(app.state.currentRecoveryKey);
                const recoveryData = app.crypto.encrypt(pwd, recEncKey);

                // 2. Validate Key Check (to verify login without storing pass)
                const derivedKey = app.crypto.deriveKey(pwd, app.state.masterKeySalt);
                const validationData = app.crypto.encrypt(app.config.masterPasswordCheckValue, derivedKey);

                const data = {
                    masterKeySalt: app.state.masterKeySalt,
                    hint: document.getElementById('masterPasswordHint').value,
                    recoveryData: recoveryData,
                    validationData: validationData
                };

                app.storage.saveAppData(data);
                app.storage.savePasswords([]);
                
                document.getElementById('recoveryKeyDisplayArea').textContent = app.state.currentRecoveryKey;
                app.ui.showModal('recoveryKeyModal');
            },

            handleLogin: () => {
                const pwd = document.getElementById('loginMasterPassword').value;
                const appData = app.storage.getAppData();
                
                if(!appData || !appData.masterKeySalt) return app.ui.refreshPage(); // Should not happen

                const derivedKey = app.crypto.deriveKey(pwd, appData.masterKeySalt);
                
                // Validate
                const check = app.crypto.decrypt(appData.validationData, derivedKey);
                if(check !== app.config.masterPasswordCheckValue) {
                    document.getElementById('loginMasterPassword').value = '';
                    return app.ui.showAlert("Incorrect Master Password", "danger", "globalAlertPlaceholder");
                }

                // Success
                app.state.derivedEncryptionKey = derivedKey;
                app.state.isAuthenticated = true;
                app.state.passwords = app.storage.getPasswords();
                
                app.ui.updateMasterKeyStatus("Unlocked", "bg-success");
                app.ui.navigateToView('mainAppView');
                app.session.start();
                document.getElementById('loginMasterPassword').value = '';
            },

            copyRecoveryKeyToClipboard: () => {
                app.ui.copyToClipboard(app.state.currentRecoveryKey, "Recovery Key");
            },

            downloadRecoveryKey: () => {
                const blob = new Blob([`RaGhaS Vault Recovery Key:\n${app.state.currentRecoveryKey}\n\nKEEP SAFE`], {type: "text/plain"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'Vault_Recovery_Key.txt';
                a.click();
            },

            shareRecoveryKey: () => {
                if (navigator.share) {
                    navigator.share({
                        title: 'My Vault Recovery Key',
                        text: `Emergency Key: ${app.state.currentRecoveryKey}`
                    }).catch(console.error);
                } else {
                    // Fallback to WhatsApp
                    window.open(`https://wa.me/?text=${encodeURIComponent("My Vault Recovery Key: " + app.state.currentRecoveryKey)}`, "_blank");
                }
            },

            handleShowRecoveredMasterPassword: () => {
                const key = document.getElementById('userProvidedRecoveryKey').value.trim();
                const appData = app.storage.getAppData();
                try {
                     const decKey = CryptoJS.enc.Hex.parse(key);
                     const recovered = app.crypto.decrypt(appData.recoveryData, decKey);
                     if(recovered) {
                         app.ui.hideModal('enterRecoveryKeyModal');
                         app.ui.displayRecoveredMasterPassword(recovered);
                     } else {
                         throw new Error();
                     }
                } catch(e) {
                    app.ui.showAlert("Invalid Recovery Key", "danger", "enterRecoveryKeyModalAlertPlaceholder");
                }
            },

            clearAllData: () => {
                localStorage.clear();
                app.ui.refreshPage();
            }
        };

        // --- PASSWORD LOGIC ---
        app.passwords = {
            checkPasswordStrength: (val, meterId, textId) => {
                const meter = document.getElementById(meterId).firstElementChild;
                const text = document.getElementById(textId);
                let score = 0;
                if(val.length > 8) score++;
                if(val.length > 12) score++;
                if(/[A-Z]/.test(val)) score++;
                if(/[0-9]/.test(val)) score++;
                if(/[^A-Za-z0-9]/.test(val)) score++;

                let cls = 'bg-danger', txt = 'Weak';
                let w = '30%';
                if(score > 2) { cls = 'bg-warning'; txt = 'Medium'; w = '60%'; }
                if(score > 4) { cls = 'bg-success'; txt = 'Strong'; w = '100%'; }
                
                meter.style.width = val ? w : '0%';
                meter.style.backgroundColor = val ? '' : ''; // Reset via class
                meter.className = val ? '' : ''; // handled by CSS width mostly, simplified logic here:
                
                // Specific coloring override
                if(score > 4) meter.style.backgroundColor = '#10b981';
                else if(score > 2) meter.style.backgroundColor = '#f59e0b';
                else meter.style.backgroundColor = '#ef4444';

                text.textContent = val ? txt : '';
                text.style.color = meter.style.backgroundColor;
            },

            generateStrongPassword: (id) => {
                const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+";
                let pass = "";
                const array = new Uint32Array(16);
                crypto.getRandomValues(array);
                for(let i=0; i<16; i++) pass += chars[array[i] % chars.length];
                const el = document.getElementById(id);
                el.value = pass;
                el.dispatchEvent(new Event('input'));
            },

            handleSavePassword: () => {
                const site = document.getElementById('website').value;
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                const id = document.getElementById('editingPasswordId').value || 'id_' + Date.now();

                if(!site || !user || !pass) return app.ui.showAlert("All fields required", "warning");

                const encPass = app.crypto.encrypt(pass, app.state.derivedEncryptionKey);
                const entry = { id, website: site, username: user, encryptedPasswordData: encPass };

                if(app.state.editingPasswordId) {
                    const idx = app.state.passwords.findIndex(p => p.id === id);
                    app.state.passwords[idx] = entry;
                } else {
                    app.state.passwords.push(entry);
                }

                app.storage.savePasswords(app.state.passwords);
                app.ui.resetSaveForm();
                app.ui.renderPasswordList();
                app.ui.showAlert("Saved successfully", "success");
                app.session.start(); // Refresh timer
            },

            revealPasswordInModal: () => {
                const id = app.state.currentActionEntryId;
                const entry = app.state.passwords.find(p => p.id === id);
                const el = document.getElementById('actionModalPasswordDisplay');
                const btn = document.getElementById('actionModalRevealBtn');

                if(el.type === 'password') {
                    const decrypted = app.crypto.decrypt(entry.encryptedPasswordData, app.state.derivedEncryptionKey);
                    el.value = decrypted;
                    el.type = 'text';
                    btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
                } else {
                    el.value = '************';
                    el.type = 'password';
                    btn.innerHTML = '<i class="bi bi-eye"></i>';
                }
                app.session.start();
            },

            copyPasswordFromModal: () => {
                const id = app.state.currentActionEntryId;
                const entry = app.state.passwords.find(p => p.id === id);
                const decrypted = app.crypto.decrypt(entry.encryptedPasswordData, app.state.derivedEncryptionKey);
                app.ui.copyToClipboard(decrypted, "Password");
                app.session.start();
            },

            editPasswordFromModal: () => {
                const id = app.state.currentActionEntryId;
                const entry = app.state.passwords.find(p => p.id === id);
                app.ui.hideModal('passwordActionModal');
                
                // Populate Form
                app.state.editingPasswordId = id;
                document.getElementById('editingPasswordId').value = id;
                document.getElementById('website').value = entry.website;
                document.getElementById('username').value = entry.username;
                
                const decrypted = app.crypto.decrypt(entry.encryptedPasswordData, app.state.derivedEncryptionKey);
                document.getElementById('password').value = decrypted;
                
                // UI Changes
                document.getElementById('saveUpdateFormTitle').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Update Credential';
                document.getElementById('savePasswordButton').textContent = 'Update';
                document.getElementById('savePasswordButton').className = 'btn btn-warning';
                document.getElementById('cancelEditButton').style.display = 'block';
                
                // Show form if on mobile
                const card = document.getElementById('addCredentialCard');
                card.style.display = 'block';
                card.scrollIntoView({behavior: "smooth"});
            },

            deletePasswordFromModal: () => {
                const id = app.state.currentActionEntryId;
                app.ui.hideModal('passwordActionModal');
                app.ui.confirm("Delete this credential?", () => {
                    app.state.passwords = app.state.passwords.filter(p => p.id !== id);
                    app.storage.savePasswords(app.state.passwords);
                    app.ui.renderPasswordList();
                    app.ui.showAlert("Deleted", "info");
                });
            },

            exportPasswords: () => {
                const data = {
                    date: new Date().toISOString(),
                    app: app.storage.getAppData(),
                    creds: app.storage.getPasswords()
                };
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `RaGhaS_Backup_${Date.now()}.json`;
                a.click();
            },

            handleImportFile: (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if(data.app && data.creds) {
                            app.ui.confirm("Importing will overwrite current vault. Continue?", () => {
                                app.storage.saveAppData(data.app);
                                app.storage.savePasswords(data.creds);
                                app.ui.showAlert("Import success. Please login again.", "success");
                                setTimeout(() => window.location.reload(), 1500);
                            });
                        } else throw new Error();
                    } catch(err) {
                        app.ui.showAlert("Invalid Backup File", "danger");
                    }
                    e.target.value = null; // reset input
                };
                reader.readAsText(file);
            }
        };

        // --- SESSION ---
        app.session = {
            timer: null,
            start: () => {
                if(app.session.timer) clearInterval(app.session.timer);
                if(app.state.sessionTimeoutId) clearTimeout(app.state.sessionTimeoutId);
                
                let timeLeft = app.config.sessionTimeoutDuration;
                
                app.state.sessionTimeoutId = setTimeout(app.session.logout, timeLeft);
                
                app.session.timer = setInterval(() => {
                    timeLeft -= 1000;
                    if(timeLeft <= 0) { clearInterval(app.session.timer); return; }
                    const m = Math.floor(timeLeft / 60000);
                    const s = ((timeLeft % 60000) / 1000).toFixed(0).padStart(2, '0');
                    document.getElementById('sessionTimerDisplay').textContent = `${m}:${s}`;
                }, 1000);
            },
            logout: () => {
                app.state.derivedEncryptionKey = null;
                app.state.isAuthenticated = false;
                if(app.session.timer) clearInterval(app.session.timer);
                app.ui.showAlert("Session Expired / Logged Out", "warning");
                app.ui.navigateToView('loginView');
            }
        };

        // Init App
        document.addEventListener('DOMContentLoaded', app.ui.init);

    </script>
</body>
</html>