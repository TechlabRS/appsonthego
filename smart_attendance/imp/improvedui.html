<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Medha Presence | Premium</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Palette - The "Rich" Spectrum */
            --primary: #4f46e5;
            --primary-grad: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --secondary: #06b6d4;
            --surface: rgba(255, 255, 255, 0.85);
            --surface-glass: rgba(255, 255, 255, 0.6);
            --bg-base: #f1f5f9;
            --text-main: #1e293b;
            --text-mute: #64748b;
            
            /* Effects */
            --shadow-soft: 0 10px 40px -10px rgba(79, 70, 229, 0.15);
            --shadow-sharp: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --blur: blur(16px);
        }

        /* --- GLOBAL RESET & TYPOGRAPHY --- */
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-base);
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(6, 182, 212, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            overflow: hidden; /* App-like feel */
        }

        h1, h2, h3, .font-mono { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em; }
        
        /* --- HIJACKING TAILWIND CLASSES FOR PREMIUM UI --- */
        /* This section overrides the classes YOUR JS generates */

        /* 1. Cards (The "bg-white" your JS injects) */
        .bg-white {
            background-color: var(--surface) !important;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: var(--glass-border);
            box-shadow: var(--shadow-sharp);
        }

        /* 2. Primary Buttons (The "bg-blue-600" your JS injects) */
        .bg-blue-600, .bg-indigo-600 {
            background: var(--primary-grad) !important;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            border: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .bg-blue-600:active, .bg-indigo-600:active { transform: scale(0.96); }

        /* 3. Inputs */
        input, select, textarea {
            background: rgba(255, 255, 255, 0.5) !important;
            border: 1px solid rgba(203, 213, 225, 0.6) !important;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            backdrop-filter: blur(5px);
            font-family: 'Space Grotesk', monospace !important;
        }
        input:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
            background: #fff !important;
        }

        /* 4. Avatars & Images */
        img.rounded-full {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid white !important;
        }

        /* --- UI COMPONENT OVERRIDES --- */

        /* Navigation Dock */
        nav.fixed.bottom-0 {
            background: rgba(255, 255, 255, 0.9) !important;
            border-top: none !important;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            backdrop-filter: blur(20px);
        }
        .nav-btn.text-blue-600 i {
            filter: drop-shadow(0 4px 6px rgba(99, 102, 241, 0.5));
            transform: translateY(-2px);
        }

        /* Modals (Glassmorphism) */
        .fixed.inset-0.bg-black\/90, .fixed.inset-0.bg-black\/80 {
            background-color: rgba(15, 23, 42, 0.6) !important; /* Lighter overlay */
            backdrop-filter: blur(15px);
        }
        /* Modal Content Containers */
        [id$="-modal"] > div {
            background: #ffffff !important;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 24px;
        }

        /* Toast Notifications */
        #toast-container > div {
            background: rgba(15, 23, 42, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            color: white !important;
        }

        /* --- ANIMATIONS & UTILS --- */
        .loader {
            border-width: 3px;
            border-color: rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
        }
        
        .tab-content { animation: floatUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes floatUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Camera Feed Styling */
        #camera-modal { background: #000 !important; }
        .scan-line {
            box-shadow: 0 0 20px #6366f1, 0 0 10px #fff;
            background: #fff;
            height: 2px;
        }
        .scan-overlay {
            background: radial-gradient(circle, transparent 35%, rgba(0,0,0,0.8) 80%);
        }

        /* Live Monitor Stats Cards */
        #live-monitor .bg-green-50, #live-monitor .bg-orange-50 {
            background: white !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9;
        }
        
        /* The Bubble Effect for Attendees */
        #attendee-list > div {
            background: rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        /* Hide Scrollbar but allow scroll */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.2); border-radius: 10px; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col text-slate-800">

    <div id="toast-container" class="fixed top-16 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none p-4"></div>

    <div class="fixed top-4 right-4 z-50 pointer-events-none">
        <div class="bg-white/90 backdrop-blur-xl border border-white/60 shadow-lg px-5 py-2.5 rounded-2xl flex flex-col items-end transform transition-transform hover:scale-105">
            <span class="text-[12px] font-black tracking-widest font-mono bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
                MEDHA<span class="font-light text-slate-400">PRESENCE</span>
            </span>
            <div class="flex items-center gap-1 mt-0.5">
                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-[8px] text-slate-400 font-bold tracking-tight uppercase">System Active</span>
            </div>
        </div>
    </div>

    <div id="success-modal" class="fixed inset-0 bg-black/90 z-[110] flex items-center justify-center hidden p-6 backdrop-blur-md">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center shadow-2xl relative overflow-hidden">
            <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%2322c55e\' fill-opacity=\'1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');"></div>
            
            <div class="relative z-10 flex flex-col items-center">
                <div class="w-28 h-28 rounded-full p-1.5 border-4 border-emerald-400 bg-white shadow-xl mb-6 relative animate-pop">
                    <img id="success-img" src="" class="w-full h-full rounded-full object-cover">
                    <div class="absolute -bottom-1 -right-1 bg-gradient-to-br from-green-400 to-emerald-600 text-white w-10 h-10 rounded-full flex items-center justify-center border-4 border-white shadow-lg">
                        <i class="fa-solid fa-check text-lg"></i>
                    </div>
                </div>

                <h3 id="success-name" class="text-2xl font-bold text-slate-800 mb-2 leading-tight">Thank you!</h3>
                <p class="text-sm text-slate-500 font-medium mb-6">Attendance captured securely.</p>
                
                <div class="bg-emerald-50/50 rounded-2xl p-5 w-full border border-emerald-100/50 mb-6 backdrop-blur-sm">
                     <p id="success-class" class="text-xs font-bold text-emerald-700 uppercase tracking-wide mb-1 break-words"></p>
                     <p id="success-time" class="text-[11px] font-mono text-emerald-600/70"></p>
                </div>

                <button onclick="closeSuccessModal()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-black transition-all shadow-xl active:scale-95 text-sm uppercase tracking-wide">Return to Dashboard</button>
            </div>
        </div>
    </div>

    <div id="config-modal" class="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center hidden p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl">
            <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center mb-4 mx-auto text-red-500"><i class="fa-solid fa-gear"></i></div>
            <h2 class="text-xl font-bold mb-2 text-center">System Configuration</h2>
            <p class="text-xs text-gray-500 mb-6 text-center">Paste your Firebase JSON object to initialize the database connection.</p>
            <textarea id="firebase-config-input" class="w-full p-4 border border-slate-200 rounded-2xl mb-4 text-[10px] font-mono bg-slate-50 focus:outline-none focus:border-blue-500 transition-colors shadow-inner" rows="6" placeholder='Paste JSON Config here...'></textarea>
            <button onclick="saveConfigManually()" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition-colors">Initialize App</button>
        </div>
    </div>

    <div id="otp-modal" class="fixed inset-0 bg-black/80 z-[80] flex items-center justify-center hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 w-full max-w-xs text-center shadow-2xl transform transition-all scale-100 border border-white/20">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                <i class="fa-solid fa-shield-halved text-2xl"></i>
            </div>
            <h3 class="font-bold text-xl text-slate-800">Security PIN</h3>
            <p class="text-xs text-slate-500 mb-8 mt-1">Enter the 4-digit code displayed by faculty</p>
            <input type="tel" id="otp-input" maxlength="4" class="otp-input w-full text-5xl font-mono font-bold text-slate-800 border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2 mb-8 bg-transparent transition-colors" placeholder="••••" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeOtpModal()" class="py-3 rounded-xl font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 transition-colors text-xs uppercase tracking-wider">Cancel</button>
                <button onclick="submitOtp()" class="py-3 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors text-xs uppercase tracking-wider">Verify</button>
            </div>
        </div>
    </div>

    <div id="review-modal" class="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white/50 backdrop-blur-sm sticky top-0 z-10">
                <h3 class="font-bold text-lg text-slate-800">Attendance Audit</h3>
                <button onclick="closeReviewModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="flex gap-4 justify-center items-center mb-8">
                    <div class="text-center w-1/2 relative">
                        <p class="text-[9px] font-bold text-slate-400 mb-2 uppercase tracking-widest">Registered</p>
                        <div class="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-200 p-1 mx-auto">
                             <img id="review-enrolled-img" src="" class="w-full h-full object-cover rounded-xl">
                        </div>
                        <div id="review-enrolled-loader" class="absolute inset-0 flex items-center justify-center bg-white/80 backdrop-blur-sm"><div class="loader w-6 h-6 border-2"></div></div>
                    </div>
                    <div class="text-slate-300"><i class="fa-solid fa-right-long text-xl"></i></div>
                    <div class="text-center w-1/2">
                        <p class="text-[9px] font-bold text-slate-400 mb-2 uppercase tracking-widest">Captured</p>
                        <div class="w-24 h-24 rounded-2xl border-2 border-blue-500 p-1 mx-auto shadow-lg shadow-blue-200">
                             <img id="review-live-img" src="" class="w-full h-full rounded-xl object-cover">
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 p-5 rounded-2xl space-y-3 text-sm border border-slate-100">
                    <div class="flex justify-between border-b border-slate-200/60 pb-2"><span class="text-slate-500 text-xs font-bold uppercase">Student</span><span id="review-name" class="font-bold text-slate-800"></span></div>
                    <div class="flex justify-between border-b border-slate-200/60 pb-2"><span class="text-slate-500 text-xs font-bold uppercase">Roll No</span><span id="review-roll" class="font-mono font-bold text-slate-800"></span></div>
                    <div class="flex justify-between"><span class="text-slate-500 text-xs font-bold uppercase">Time</span><span id="review-time" class="font-mono text-xs text-slate-600"></span></div>
                </div>
                
                <div class="mt-6 flex flex-col gap-3">
                    <div id="review-badge" class="bg-green-50 text-green-700 px-3 py-3 rounded-xl text-xs font-bold w-full text-center border border-green-200 shadow-sm">
                        <i class="fa-solid fa-check-circle mr-1"></i> Biometric Verified
                    </div>
                    <button id="approve-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3.5 rounded-xl font-bold text-xs hover:shadow-lg transition-all hidden items-center justify-center gap-2">
                        <i class="fa-solid fa-thumbs-up"></i> Approve Attendance
                    </button>
                    <button id="reject-btn" class="w-full bg-white text-red-600 border border-red-100 py-3.5 rounded-xl font-bold text-xs hover:bg-red-50 transition-colors flex items-center justify-center gap-2 shadow-sm">
                        <i class="fa-solid fa-user-xmark"></i> Reject Attendance
                    </button>
                </div>
                
                <p class="text-[10px] text-center text-slate-400 mt-6 font-medium">Privacy Note: Live photos auto-delete in 7 days</p>
            </div>
        </div>
    </div>

    <div id="pending-review-modal" class="fixed inset-0 bg-black/90 z-[95] flex items-center justify-center hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-orange-100 flex justify-between items-center bg-orange-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600"><i class="fa-solid fa-clipboard-question"></i></div>
                    <div>
                        <h3 class="font-bold text-lg text-orange-900">Review Pending</h3>
                        <p class="text-[10px] text-orange-700 font-bold uppercase tracking-wide">Action Required</p>
                    </div>
                </div>
                <button onclick="document.getElementById('pending-review-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-white/50 text-orange-800 hover:bg-white transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="pending-list-container" class="p-4 overflow-y-auto space-y-2 bg-slate-50 min-h-[200px]">
                </div>
            <div class="p-4 bg-white border-t border-slate-100">
                <button onclick="forceCloseSession()" class="w-full text-xs font-bold text-slate-400 hover:text-red-500 transition-colors py-2">Ignore Requests & Close Session</button>
            </div>
        </div>
    </div>

    <div id="image-viewer-modal" class="fixed inset-0 bg-black/95 z-[90] flex items-center justify-center hidden p-4 backdrop-blur-md" onclick="this.classList.add('hidden')">
        <div class="max-w-sm w-full bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl p-3 shadow-2xl transform transition-all scale-100" onclick="event.stopPropagation()">
            <div class="relative rounded-2xl overflow-hidden aspect-square bg-black shadow-inner">
                <img id="viewer-img" src="" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/50 to-transparent p-6 pt-12">
                    <p id="viewer-caption" class="text-white font-bold text-xl mb-1"></p>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        <p class="text-white/70 text-xs font-mono uppercase tracking-widest">Verified Profile</p>
                    </div>
                </div>
            </div>
            <button onclick="document.getElementById('image-viewer-modal').classList.add('hidden')" class="absolute top-5 right-5 w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur-md hover:bg-black/60 transition-colors border border-white/10"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>
    
    <div id="session-details-modal" class="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="font-bold text-xl text-slate-800 leading-tight" id="sd-subject">Subject</h3>
                    <p class="text-[11px] font-mono text-slate-400 mt-1 uppercase tracking-wide" id="sd-meta">Date | Time</p>
                </div>
                <button onclick="closeSessionModal()" class="w-9 h-9 rounded-full bg-slate-50 text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6 bg-slate-50/50">
               <div class="grid grid-cols-4 gap-3 text-center">
                    <div class="bg-green-50/80 p-3 rounded-2xl border border-green-100 shadow-sm">
                        <p class="text-[9px] text-green-600 font-bold uppercase tracking-wider mb-1">Present</p>
                        <p class="text-xl font-black text-green-700" id="sd-present-count">-</p>
                    </div>
                    <div class="bg-orange-50/80 p-3 rounded-2xl border border-orange-100 shadow-sm">
                        <p class="text-[9px] text-orange-600 font-bold uppercase tracking-wider mb-1">Pending</p>
                        <p class="text-xl font-black text-orange-700" id="sd-pending-count">-</p>
                    </div>
                    <div class="bg-red-50/80 p-3 rounded-2xl border border-red-100 shadow-sm">
                        <p class="text-[9px] text-red-500 font-bold uppercase tracking-wider mb-1">Absent</p>
                        <p class="text-xl font-black text-red-600" id="sd-absent-count">-</p>
                    </div>
                     <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total</p>
                        <p class="text-xl font-black text-slate-700" id="sd-total-count">-</p>
                    </div>
               </div>
               
               <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_4px_20px_-5px_rgba(0,0,0,0.05)]">
                   <h4 class="text-xs font-bold text-slate-800 mb-4 pb-2 border-b border-slate-50 flex items-center justify-between">
                       <span>Attendee List</span>
                       <span class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">Live</span>
                   </h4>
                   <div id="sd-attendee-list" class="space-y-1 max-h-56 overflow-y-auto pr-1"></div>
               </div>
               
               <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_4px_20px_-5px_rgba(0,0,0,0.05)]">
                   <h4 class="text-xs font-bold text-slate-800 mb-4 pb-2 border-b border-slate-50">Absentees</h4>
                   <div id="sd-absentee-list" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto"></div>
               </div>
            </div>
        </div>
    </div>

    <div id="backup-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">Data Center</h3>
                    <p class="text-xs text-slate-400">Manage local records</p>
                </div>
                <button onclick="closeBackupModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-500 hover:bg-slate-100"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <button onclick="exportAttendanceToJSON()" class="w-full flex items-center justify-between p-5 bg-gradient-to-r from-blue-50 to-white rounded-2xl border border-blue-100 hover:shadow-md transition-all group text-left">
                    <div>
                        <p class="font-bold text-blue-800 text-sm mb-0.5">Backup Database</p>
                        <p class="text-[10px] text-blue-500 font-medium">Export all records to JSON</p>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform"><i class="fa-solid fa-download"></i></div>
                </button>
                <div class="p-5 bg-gradient-to-r from-green-50 to-white rounded-2xl border border-green-100">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <p class="font-bold text-green-800 text-sm mb-0.5">Restore / Sync</p>
                            <p class="text-[10px] text-green-600 font-medium">Import JSON to Cloud</p>
                        </div>
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="backup-upload" accept=".json" class="text-[10px] w-full bg-white border border-green-200 rounded-xl p-2 text-slate-600 file:mr-2 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-[10px] file:bg-green-100 file:text-green-700">
                        <button onclick="importAttendanceFromJSON()" class="bg-green-600 text-white px-4 rounded-xl font-bold text-xs hover:bg-green-700 shadow-md shadow-green-200">Sync</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main id="main-view" class="flex-1 overflow-y-auto pb-32 scroll-smooth bg-slate-50/50">
        <div id="loading-screen" class="flex flex-col items-center justify-center h-full space-y-6">
            <div class="relative">
                <div class="w-16 h-16 rounded-full border-4 border-indigo-100 border-t-indigo-600 animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
                </div>
            </div>
            <p class="text-slate-400 text-[10px] font-bold tracking-[0.2em] animate-pulse">SYSTEM INITIALIZING</p>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 grid grid-cols-2 py-2 px-6 pb-safe z-40 bg-white/80 backdrop-blur-xl border-t border-white/50">
        <button onclick="switchTab('student')" id="nav-student" class="nav-btn flex flex-col items-center justify-center gap-1.5 p-3 rounded-2xl hover:bg-slate-50 transition-all group">
            <i class="fa-solid fa-user-graduate text-xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
            <span class="text-[10px] font-bold text-slate-400 group-hover:text-slate-600 hidden">Student</span>
        </button>
        <button onclick="switchTab('faculty')" id="nav-faculty" class="nav-btn flex flex-col items-center justify-center gap-1.5 p-3 rounded-2xl hover:bg-slate-50 transition-all group">
            <i class="fa-solid fa-chalkboard-user text-xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
            <span class="text-[10px] font-bold text-slate-400 group-hover:text-slate-600 hidden">Faculty</span>
        </button>
    </nav>

    <div id="camera-modal" class="fixed inset-0 bg-black z-[90] hidden flex flex-col">
        <div class="relative flex-1 flex flex-col items-center justify-center overflow-hidden bg-black">
            <video id="video-feed" class="absolute inset-0 w-full h-full object-cover camera-feed opacity-80" autoplay muted playsinline></video>
            <canvas id="overlay-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
            
            <div class="scan-overlay"></div>
            
            <div id="liveness-challenge" class="absolute top-28 left-1/2 transform -translate-x-1/2 bg-black/40 backdrop-blur-md text-white px-8 py-4 rounded-full border border-white/10 font-bold text-sm hidden transition-all flex items-center justify-center min-w-[180px] shadow-2xl">
                <span id="challenge-icon" class="mr-3 text-lg"><i class="fa-regular fa-eye"></i></span>
                <span id="challenge-text" class="tracking-wide">Blink Eyes</span>
            </div>

            <div class="relative z-10 w-72 h-72 rounded-full border border-white/20 overflow-hidden shadow-[0_0_50px_rgba(99,102,241,0.3)]">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-1 h-4 bg-white/50"></div>
                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-4 bg-white/50"></div>
                <div class="absolute left-0 top-1/2 -translate-y-1/2 w-4 h-1 bg-white/50"></div>
                <div class="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-1 bg-white/50"></div>
                
                <div class="scan-line"></div>
            </div>
            
            <div id="camera-status" class="absolute bottom-32 bg-white/10 text-white px-6 py-2 rounded-full text-xs font-bold backdrop-blur-md border border-white/10 tracking-wide uppercase">Initializing System...</div>
        </div>
        <div class="bg-black p-8 pb-safe flex justify-between items-center border-t border-white/10">
            <button onclick="closeCamera()" class="w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            <button id="capture-btn" class="bg-white text-black px-8 py-4 rounded-full font-bold shadow-[0_0_30px_rgba(255,255,255,0.3)] opacity-50 cursor-not-allowed text-sm transition-all uppercase tracking-widest" disabled>Scanning...</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc, deleteField, writeBatch, deleteDoc, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const EMBEDDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBXECIZa45dq-o8Ka4G9Y1N7nll7cyli2U",
            authDomain: "stuattnd.firebaseapp.com",
            projectId: "stuattnd",
            storageBucket: "stuattnd.firebasestorage.app",
            messagingSenderId: "511533506488",
            appId: "1:511533506488:web:aca4de3d513915d012f94d",
            measurementId: "G-9PZZM5LFKX"
        }; 
        
        // HASHED ADMIN KEY (SHA-256 for "ADMIN123")
        const MASTER_KEY_HASH = "b257d4499962eb197c6f57ca98113d9dd244aa007a5cb27ae067567135ba8fb9"; 
        
        const ATTENDANCE_RADIUS_METERS = 10; 
        const FACE_MATCH_THRESHOLD = 0.38; // STRICTER THRESHOLD (Lower is stricter)
        const OTP_REFRESH_RATE = 30; 
        const PHOTO_RETENTION_DAYS = 3;

        // --- STATE ---
        window.appState = {
            user: null, userId: null, role: 'student', // Default fallback
            faceDescriptor: null, enrolledPhoto: null, modelsLoaded: false,
            studentProfile: null, facultyProfile: null, isFacultyLoggedIn: false,
            verifiedSessionId: null, verifiedOTP: null, // NEW: OTP Cache
            pendingRequests: [], // NEW: Local cache for pending review
            // ADDED: Memory Cleanup Trackers
            activeListeners: [], 
            activeIntervals: [] 
        };

        // ADDED: Global Cleanup Function
        window.clearActiveSubscriptions = () => {
            // Stop all Firestore listeners
            if (window.appState.activeListeners.length > 0) {
                window.appState.activeListeners.forEach(unsub => unsub && unsub());
                window.appState.activeListeners = [];
                console.log("Cleaned up listeners");
            }
            // Stop all Timers (OTP, etc)
            if (window.appState.activeIntervals.length > 0) {
                window.appState.activeIntervals.forEach(id => clearInterval(id));
                window.appState.activeIntervals = [];
                console.log("Cleaned up intervals");
            }
        };
        
        window.currentSessionAttendees = [];

        let db, auth, appId;

        // --- UTILS ---
        function getDist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
        function deg2rad(deg) { return deg * (Math.PI/180); }
        
        // Secure Hash Function
        async function sha256(source) {
            const sourceBytes = new TextEncoder().encode(source);
            const digest = await crypto.subtle.digest("SHA-256", sourceBytes);
            const resultBytes = [...new Uint8Array(digest)];
            return resultBytes.map(x => x.toString(16).padStart(2, '0')).join("");
        }
        
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R=6371; var dLat=deg2rad(lat2-lat1); var dLon=deg2rad(lon2-lon1); 
            var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2); 
            var c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c*1000; 
        }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container'); const el = document.createElement('div');
            const bg = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-600' : (type === 'orange' ? 'bg-orange-500' : 'bg-slate-800'));
            el.className = `${bg} text-white px-6 py-3 rounded-full shadow-xl text-xs font-bold transform transition-all translate-y-full opacity-0 backdrop-blur-md`; el.innerText = msg;
            container.appendChild(el); requestAnimationFrame(() => { el.classList.remove('translate-y-full', 'opacity-0'); });
            setTimeout(() => { el.classList.add('opacity-0', '-translate-y-2'); setTimeout(() => el.remove(), 300); }, 3000);
        }

        // --- GEOLOCATION & HELPERS ---
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject("Geo unavailable");
                navigator.geolocation.getCurrentPosition(
                    (p) => resolve({ lat: p.coords.latitude, lng: p.coords.longitude }), 
                    (err) => reject(err), 
                    // INCREASED TIMEOUT HERE TO FIX ERROR
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 10000 }
                );
            });
        }

        async function performCleanup() {
            const cutoffDate = new Date(); cutoffDate.setDate(cutoffDate.getDate() - PHOTO_RETENTION_DAYS);
            const q = query(getAttPath(), where("timestamp", "<", cutoffDate));
            const snap = await getDocs(q);
            if(snap.empty) return;
            const batch = writeBatch(db); let count = 0;
            snap.forEach(doc => { if (doc.data().capturedPhoto) { batch.update(doc.ref, { capturedPhoto: deleteField() }); count++; } });
            if(count > 0) await batch.commit();
        }

        // --- INIT ---
        async function initFirebase() {
            try {
                let configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                if (!configStr && EMBEDDED_FIREBASE_CONFIG.apiKey) configStr = JSON.stringify(EMBEDDED_FIREBASE_CONFIG);
                
                // Try LocalStorage safely
                if (!configStr) {
                    try {
                        configStr = localStorage.getItem('sa_firebase_config');
                    } catch (e) { console.warn("LocalStorage access denied", e); }
                }
                
                if (!configStr) { document.getElementById('config-modal').classList.remove('hidden'); return; }

                appId = typeof __app_id !== 'undefined' ? __app_id : 'demo1001';
                const firebaseConfig = JSON.parse(configStr);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        window.appState.user = u; window.appState.userId = u.uid;
                        await Promise.all([loadStudentProfile(), loadFaceData(), checkFacultyRegistration()]);
                        
                        // --- SMART ROLE SWITCHING ---
                        if (window.appState.studentProfile) window.appState.role = 'student';
                        else if (window.appState.facultyProfile) window.appState.role = 'faculty';
                        else window.appState.role = localStorage.getItem('sa_last_role') || 'student';
                        
                        // Force tab UI update
                        switchTab(window.appState.role, false); // false = don't double render

                        renderView();
                        setTimeout(loadAIModels, 500); 
                    }
                });
            } catch (e) { 
                console.error("Init Failed", e.message, e.stack); 
                showToast("Init Failed: " + e.message, "error"); 
            }
        }

        // --- EXPOSE HELPERS TO WINDOW FOR HTML ONCLICK ---
        window.saveConfigManually = () => {
            const input = document.getElementById('firebase-config-input').value;
            if(input) { 
                try {
                    localStorage.setItem('sa_firebase_config', input); 
                    location.reload(); 
                } catch(e) {
                    alert("Could not save to LocalStorage. Please check permissions.");
                }
            }
        };

        async function loadAIModels() {
            if(window.appState.modelsLoaded) return;
            if (typeof faceapi === 'undefined') { console.error("faceapi not loaded"); return; }
            
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                window.appState.modelsLoaded = true;
                console.log("AI Models Ready");
            } catch (e) { console.error("AI Load Error", e.message); }
        }

        // --- DATA LOADERS ---
        const getSessionPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'sessions');
        const getAttPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'attendance');
        const getStudentsPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'students');
        const getTemplatesPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'templates');
        const getMasterPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'master_students');
        const getUserProfileDoc = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
        const getFacultyProfileDoc = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'faculty_data', 'creds');

        async function loadFaceData() {
            if(!window.appState.userId) return;
            const docSnap = await getDoc(getUserProfileDoc(window.appState.userId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                window.appState.faceDescriptor = new Float32Array(Object.values(data.descriptor));
                if(data.enrolledPhoto) window.appState.enrolledPhoto = data.enrolledPhoto;
            }
        }
        
        async function loadStudentProfile() {
            if(!window.appState.userId) return;
            const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', window.appState.userId));
            if (docSnap.exists()) {
                const profile = docSnap.data();
                
                // NEW: Fetch Section from Master List for filtering
                try {
                    // Assuming Master List ID is the Roll No (as per handleCSVUpload logic)
                    const masterRef = doc(db, 'artifacts', appId, 'public', 'data', 'master_students', profile.rollNo);
                    const masterSnap = await getDoc(masterRef);
                    if(masterSnap.exists()) {
                        profile.section = masterSnap.data().section; // e.g., "A"
                    }
                } catch(e) { console.error("Section fetch error", e); }

                window.appState.studentProfile = profile;
            }
        }

        async function checkFacultyRegistration() {
            if(!window.appState.userId) return;
            const docSnap = await getDoc(getFacultyProfileDoc(window.appState.userId));
            if(docSnap.exists()) window.appState.facultyProfile = docSnap.data();
        }

        window.switchTab = (tab, shouldRender = true) => {
            // ADDED: Clean up memory before switching tabs
            window.clearActiveSubscriptions();

            window.appState.role = tab;
            localStorage.setItem('sa_last_role', tab); // SAVE ROLE PREFERENCE
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                const icon = b.querySelector('i');
                const text = b.querySelector('span');
                if(b.id === `nav-${tab}`) {
                    b.classList.remove('text-slate-400'); b.classList.add('text-blue-600');
                    icon.classList.add('mb-1'); text.classList.remove('hidden');
                } else {
                    b.classList.add('text-slate-400'); b.classList.remove('text-blue-600');
                    icon.classList.remove('mb-1');
                }
            });
            if(shouldRender) renderView();
        };

        function renderView() {
            const main = document.getElementById('main-view');
            if (window.appState.role === 'student') window.renderStudentFlow(main);
            else if (window.appState.role === 'faculty') renderFacultyDashboard(main);
        }

        // --- FACULTY DASHBOARD ---
        function renderFacultyDashboard(container) {
            if (!window.appState.facultyProfile) { renderFacultyRegistration(container); return; }
            if (!window.appState.isFacultyLoggedIn) { renderFacultyLogin(container); return; }
            renderFacultyMain(container);
            performCleanup(); 
        }

        function renderFacultyMain(container) {
            const facPhoto = window.appState.facultyProfile.photoUrl || null;
            const avatarHtml = facPhoto 
                ? `<img src="${facPhoto}" class="w-10 h-10 rounded-full object-cover border-2 border-slate-100 shadow-sm">` 
                : `<div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm">${window.appState.facultyProfile.name.charAt(0)}</div>`;

            container.innerHTML = `
                <header class="bg-white sticky top-0 z-30 px-6 py-4 shadow-sm flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="relative cursor-pointer group" onclick="updateFacultyPhoto()">
                            ${avatarHtml}
                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-blue-500 rounded-full border border-white flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-camera text-[6px] text-white"></i>
                            </div>
                        </div>
                        <div>
                            <h1 class="text-xl font-extrabold text-slate-800 tracking-tight">Dashboard</h1>
                            <p class="text-xs text-slate-500 font-medium">Welcome, ${window.appState.facultyProfile.name.split(' ')[0]}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openBackupModal()" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition-colors"><i class="fa-solid fa-database text-xs"></i></button>
                        <button onclick="logoutFaculty()" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition-colors"><i class="fa-solid fa-power-off text-xs"></i></button>
                    </div>
                </header>
                
                <div class="px-4 mt-4">
                    <div class="flex bg-slate-200 p-1 rounded-xl">
                        <button onclick="switchFacTab('session')" id="ft-session" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-600 transition-all">Sessions</button>
                        <button onclick="switchFacTab('students')" id="ft-students" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-600 transition-all">Students</button>
                        <button onclick="switchFacTab('reports')" id="ft-reports" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-600 transition-all">Reports</button>
                    </div>
                </div>

                <div id="fac-content" class="p-4 space-y-6 min-h-[500px]"></div>
            `;
            switchFacTab('session');
        }
        
        // --- NEW: Faculty Photo Update ---
        window.updateFacultyPhoto = () => {
             openCamera('enroll', async (desc, score, img) => {
                try {
                    // Update Faculty Profile
                    await updateDoc(getFacultyProfileDoc(window.appState.userId), { photoUrl: img });
                    window.appState.facultyProfile.photoUrl = img;
                    showToast("Profile Photo Updated", "success");
                    renderView(); // Refresh header
                } catch(e) { showToast("Update Failed", "error"); }
            });
        };

        window.switchFacTab = (tab) => {
            ['session','students','reports'].forEach(t => {
                const btn = document.getElementById(`ft-${t}`);
                if(t === tab) { btn.classList.add('bg-white', 'text-blue-600', 'shadow-sm'); btn.classList.remove('text-slate-600'); }
                else { btn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm'); btn.classList.add('text-slate-600'); }
            });
            const content = document.getElementById('fac-content');
            content.innerHTML = '<div class="flex justify-center py-10"><div class="loader"></div></div>';
            if(tab === 'session') renderSessionPanel(content);
            else if(tab === 'students') renderStudentList(content);
            else if(tab === 'reports') renderReports(content);
        };

        // 1. Session Panel
        function renderSessionPanel(container) {
            container.innerHTML = `
                <div id="create-session-panel" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 tab-content">
                    <div class="flex justify-between mb-4"><h2 class="font-bold text-slate-800">New Session</h2><select id="quick-load" onchange="loadTemplate(this.value)" class="text-[10px] border border-slate-200 rounded-lg px-2 bg-slate-50 text-slate-600"><option value="">Load Template...</option></select></div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" id="f-date" class="w-full p-3 border border-slate-200 rounded-xl text-xs font-medium text-slate-600 bg-slate-50 outline-none focus:border-blue-500" value="${new Date().toISOString().split('T')[0]}">
                            <select id="f-section" class="w-full p-3 border border-slate-200 rounded-xl text-xs font-medium text-slate-600 bg-slate-50 outline-none focus:border-blue-500"><option value="A">Section A</option><option value="B">Section B</option><option value="C">Section C</option><option value="D">Section D</option></select>
                        </div>
                        <select id="f-subject" class="w-full p-3 border border-slate-200 rounded-xl text-xs font-medium text-slate-600 bg-slate-50 outline-none focus:border-blue-500"><option>Optimization Techniques</option><option>Probability & Statistics</option><option>Machine Learning</option><option>ML Lab</option><option>Database Management Systems</option><option>DBMS Lab</option><option>Digital Logic & CO</option><option>Full Stack Development</option><option>Design Thinking & Innovation</option></select>
                        <select id="f-slot" class="w-full p-3 border border-slate-200 rounded-xl text-xs font-medium text-slate-600 bg-slate-50 outline-none focus:border-blue-500"><option>09:00 AM - 10:40 AM</option><option>11:00 AM - 12:40 PM</option><option>01:50 PM - 02:40 PM</option><option>02:40 PM - 04:20 PM</option></select>
                        
                        <div class="flex items-center justify-between pt-2">
                            <label class="flex items-center gap-2 text-xs font-bold text-slate-500"><input type="checkbox" id="save-template" class="rounded text-blue-600 focus:ring-0"> Save as Template</label>
                            <button onclick="createSession()" id="create-btn" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all">Start Class</button>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-2">Import Master List</label><div class="flex gap-2"><input type="file" id="csv-upload" accept=".csv" class="text-xs w-full text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-slate-100 file:text-slate-600 hover:file:bg-slate-200"><button onclick="handleCSVUpload()" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold">Import</button></div></div>
                </div>

                <div id="live-monitor" class="hidden tab-content">
                    <div class="bg-indigo-600 text-white p-6 rounded-2xl shadow-xl shadow-indigo-200 relative overflow-hidden mb-4">
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider">LIVE SESSION</span>
                                <button onclick="endSession()" class="bg-white text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-50">STOP</button>
                            </div>
                            <div class="text-center my-4">
                                <p class="text-indigo-200 text-xs font-medium uppercase mb-1">Session OTP</p>
                                <div id="display-otp" class="text-5xl font-mono font-bold tracking-widest drop-shadow-md">----</div>
                            </div>
                            <div class="flex justify-between items-end text-indigo-100 text-xs">
                                <div><p class="font-bold text-white text-sm truncate w-40" id="display-sub">Subject</p><p id="display-sec">Sec A</p></div>
                                <div class="text-right"><i class="fa-regular fa-clock"></i> <span id="display-slot">Time</span></div>
                            </div>
                        </div>
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="absolute bottom-0 left-0 h-1 bg-white/30 w-full"><div id="otp-bar" class="h-full bg-green-400 otp-progress" style="width: 100%"></div></div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="bg-green-50 rounded-xl p-2 text-center border border-green-100">
                            <p class="text-[9px] uppercase font-bold text-green-500">Present</p>
                            <p id="live-present" class="text-xl font-extrabold text-green-700">0</p>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-2 text-center border border-orange-100">
                            <p class="text-[9px] uppercase font-bold text-orange-500">Pending</p>
                            <p id="live-pending" class="text-xl font-extrabold text-orange-600">0</p>
                        </div>
                        <div class="bg-slate-100 rounded-xl p-2 text-center border border-slate-200">
                            <p class="text-[9px] uppercase font-bold text-slate-400">Absent</p>
                            <p id="live-absent" class="text-xl font-extrabold text-slate-600">-</p>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> Live Attendees</h3>
                        <div id="attendee-list" class="flex flex-wrap content-start gap-2 max-h-64 overflow-y-auto pr-1"></div>
                    </div>
                </div>
            `;
            populateTemplates();
            checkActiveSession(); // --- ADDED: Auto-resume check ---
        }
        
        // --- NEW: Check Active Session ---
        async function checkActiveSession() {
             try {
                const q = query(getSessionPath(), where("facultyId", "==", window.appState.userId), where("active", "==", true));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const d = snap.docs[0];
                    const s = d.data();
                    currentSessionId = d.id;
                    // Switch UI
                    document.getElementById('create-session-panel').classList.add('hidden');
                    document.getElementById('live-monitor').classList.remove('hidden');
                    // Resume Monitor
                    monitorSession(d.id, s.subject, s.section, s.timeSlot, s.otp);
                    showToast("Restored active session", "info");
                }
             } catch(e) { console.error("Resume failed", e); }
        }

        // 2. Students & Approvals
        async function renderStudentList(container) {
            container.innerHTML = `<div class="space-y-4 tab-content">
                <div id="approvals-section" class="hidden bg-orange-50 p-4 rounded-2xl border border-orange-100">
                    <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-orange-800 text-sm">Pending Requests</h3><button onclick="bulkApprove()" class="text-[10px] font-bold bg-white text-orange-600 px-3 py-1 rounded border border-orange-200 hover:bg-orange-100">Approve All</button></div>
                    <div id="approval-list" class="space-y-2"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800 text-sm" id="approved-header">Enrolled Students</h3>
                        <div class="flex gap-2">
                            <button onclick="bulkLockStudents(true)" class="text-[9px] font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded border border-slate-200 hover:bg-slate-200">Lock All</button>
                            <button onclick="bulkLockStudents(false)" class="text-[9px] font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded border border-slate-200 hover:bg-slate-200">Unlock All</button>
                        </div>
                    </div>
                    <div class="relative mb-4"><i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i><input type="text" id="student-search" onkeyup="filterStudents()" placeholder="Search Roll No..." class="w-full pl-8 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:outline-none focus:border-blue-500"></div>
                    <div id="student-list" class="space-y-3"></div>
                </div>
            </div>`;

            // Fetch Pending
            const qPending = query(getStudentsPath(), where("status", "==", "pending"));
            const snapPending = await getDocs(qPending);
            if (!snapPending.empty) {
                document.getElementById('approvals-section').classList.remove('hidden');
                const pList = document.getElementById('approval-list');
                snapPending.forEach(d => {
                    const s = d.data();
                    pList.innerHTML += `<div class="flex justify-between items-center bg-white p-2 rounded-lg border border-orange-100 shadow-sm">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center font-bold text-xs">${s.rollNo.slice(-2)}</div><div><p class="font-bold text-xs text-slate-800">${s.rollNo}</p><p class="text-[10px] text-slate-500">${s.name}</p></div></div>
                        <div class="flex gap-1"><button onclick="decision('${d.id}', 'approved')" class="w-6 h-6 rounded bg-green-50 text-green-600 hover:bg-green-100"><i class="fa-solid fa-check text-xs"></i></button><button onclick="decision('${d.id}', 'rejected')" class="w-6 h-6 rounded bg-red-50 text-red-600 hover:bg-red-100"><i class="fa-solid fa-xmark text-xs"></i></button></div>
                    </div>`;
                });
            }

            // Fetch Approved
            const qApproved = query(getStudentsPath(), where("status", "==", "approved"));
            const snapApproved = await getDocs(qApproved);
            
            // UPDATED: Show Count of Approved Students
            document.getElementById('approved-header').innerHTML = `Enrolled Students <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-[10px] ml-2">${snapApproved.size}</span>`;

            const sList = document.getElementById('student-list');
            if (snapApproved.empty) { sList.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">No students found.</p>'; return; }

            snapApproved.forEach(d => {
                const s = d.data();
                const photoSrc = s.enrolledPhoto ? s.enrolledPhoto : null;
                const safePhoto = s.enrolledPhoto ? s.enrolledPhoto.replace(/'/g, "\\'") : '';
                const avatar = photoSrc ? `<img onclick="event.stopPropagation(); viewEnrolledImage('${safePhoto}', '${s.name}')" src="${photoSrc}" class="w-10 h-10 rounded-full object-cover border border-slate-200 cursor-pointer hover:scale-110 transition-transform">` : `<div onclick="event.stopPropagation()" class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center font-bold text-xs">${s.rollNo.slice(0,2)}</div>`;
                
                // Determine Lock Icon status
                const isLocked = s.profileLocked === true;
                const lockIcon = isLocked ? 'fa-lock text-red-400' : 'fa-lock-open text-slate-300';
                
                // UPDATED: Removed outer click event, moved it to the image only
                sList.innerHTML += `
                <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded-lg transition-colors group">
                    <div class="flex items-center gap-3">
                        ${avatar}
                        <div><p class="font-bold text-xs text-slate-800">${s.rollNo}</p><p class="text-[10px] text-slate-500 font-medium">${s.name}</p></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); toggleLock('${d.id}', ${isLocked})" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100 transition-colors"><i class="fa-solid ${lockIcon} text-xs"></i></button>
                        <button onclick="event.stopPropagation(); revokeStudent('${d.id}', '${s.rollNo}')" class="text-xs text-slate-300 hover:text-red-500 group-hover:text-slate-400 transition-colors px-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }

        window.toggleLock = async (uid, currentStatus) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', uid), { profileLocked: !currentStatus });
                renderStudentList(document.getElementById('fac-content'));
                showToast(currentStatus ? "Unlocked" : "Locked", "success");
            } catch(e) { showToast("Error updating lock", "error"); }
        }

        window.bulkLockStudents = async (shouldLock) => {
            if(!confirm(`${shouldLock ? 'Lock' : 'Unlock'} all student profiles?`)) return;
            try {
                const q = query(getStudentsPath(), where("status", "==", "approved"));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(d => {
                    batch.update(d.ref, { profileLocked: shouldLock });
                });
                await batch.commit();
                renderStudentList(document.getElementById('fac-content'));
                showToast(`All profiles ${shouldLock ? 'Locked' : 'Unlocked'}`, "success");
            } catch(e) { showToast("Bulk action failed", "error"); }
        }

        window.filterStudents = () => {
            const term = document.getElementById('student-search').value.toLowerCase();
            const rows = document.querySelectorAll('#student-list > div');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? 'flex' : 'none';
            });
        }

        window.viewEnrolledImage = (photoUrl, name) => {
            if(!photoUrl) return showToast("No registered photo", "info");
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('viewer-img');
            const caption = document.getElementById('viewer-caption');
            img.src = photoUrl;
            caption.innerText = name;
            modal.classList.remove('hidden');
        }

        // 3. Reports (Enhanced with Analytics)
        async function renderReports(container) {
            // Initialize filters if not set
            if (!window.currentReportFilter) window.currentReportFilter = 'week';
            if (!window.currentReportView) window.currentReportView = 'subject';
            if (!window.currentReportSection) window.currentReportSection = 'all'; // NEW State

            container.innerHTML = '<div class="flex justify-center py-10"><div class="loader"></div></div>';

            try {
                // 1. Fetch Unique Sections dynamically from Sessions
                // We do this first so we know which Capsules to draw
                const qSess = query(getSessionPath());
                const snap = await getDocs(qSess);
                const uniqueSections = new Set();
                snap.forEach(d => {
                    const sec = d.data().section;
                    if(sec) uniqueSections.add(sec);
                });
                const sortedSections = Array.from(uniqueSections).sort();

                // 2. Build Capsule HTML
                let sectionCapsules = `
                    <button onclick="filterReportsBySection('all')" id="rs-all" class="sec-cap ${window.currentReportSection === 'all' ? 'active-cap' : ''} px-3 py-1 rounded-full text-[10px] font-bold border transition-all whitespace-nowrap ${window.currentReportSection === 'all' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200'}">
                        All Sections
                    </button>
                `;
                
                sortedSections.forEach(sec => {
                    const isActive = window.currentReportSection === sec;
                    const activeClass = isActive ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200';
                    sectionCapsules += `
                        <button onclick="filterReportsBySection('${sec}')" id="rs-${sec}" class="sec-cap px-3 py-1 rounded-full text-[10px] font-bold border transition-all whitespace-nowrap ${activeClass}">
                            Section ${sec}
                        </button>`;
                });

                // 3. Render Dashboard UI
                container.innerHTML = `
                <div class="tab-content space-y-4">
                    <div id="analytics-dash" class="space-y-4 flex-1 min-h-[200px]"></div>
                    
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 pt-1">
                        ${sectionCapsules}
                    </div>

                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 pt-2 border-t border-slate-100">
                        <button onclick="filterReports('week')" class="rep-filter ${window.currentReportFilter === 'week' ? 'active' : ''} px-4 py-1.5 rounded-full text-[10px] font-bold bg-blue-600 text-white shadow-md shadow-blue-200 transition-all whitespace-nowrap">This Week</button>
                        <button onclick="filterReports('month')" class="rep-filter ${window.currentReportFilter === 'month' ? 'active' : ''} px-4 py-1.5 rounded-full text-[10px] font-bold bg-white text-slate-500 border border-slate-200 hover:bg-slate-50 transition-all whitespace-nowrap">This Month</button>
                        <button onclick="filterReports('all')" class="rep-filter ${window.currentReportFilter === 'all' ? 'active' : ''} px-4 py-1.5 rounded-full text-[10px] font-bold bg-white text-slate-500 border border-slate-200 hover:bg-slate-50 transition-all whitespace-nowrap">All Time</button>
                    </div>
                    
                    <div class="bg-white rounded-xl p-1 border border-slate-200 flex">
                        <button onclick="toggleRepView('subject')" id="rv-subject" class="flex-1 py-1.5 rounded-lg text-xs font-bold ${window.currentReportView === 'subject' ? 'bg-slate-100 text-slate-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'} transition-all">By Subject</button>
                        <button onclick="toggleRepView('session')" id="rv-session" class="flex-1 py-1.5 rounded-lg text-xs font-bold ${window.currentReportView === 'session' ? 'bg-slate-100 text-slate-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'} transition-all">By Session</button>
                    </div>
                    
                    <div id="report-body" class="min-h-[300px]"></div>
                </div>`;
                
                // 4. Load Data
                loadReportData();

            } catch(e) { console.error(e); showToast("Error loading filters", "error"); }
        }

        // NEW: Helper for Section Clicking
        window.filterReportsBySection = (sec) => {
            window.currentReportSection = sec;
            
            // Update UI Styles manually for speed
            document.querySelectorAll('.sec-cap').forEach(b => {
                b.className = "sec-cap px-3 py-1 rounded-full text-[10px] font-bold border transition-all whitespace-nowrap bg-white text-slate-500 border-slate-200";
            });
            const activeBtn = document.getElementById(`rs-${sec}`);
            if(activeBtn) activeBtn.className = "sec-cap px-3 py-1 rounded-full text-[10px] font-bold border transition-all whitespace-nowrap bg-slate-800 text-white border-slate-800";
            
            loadReportData();
        };

        window.filterReports = (f) => {
            window.currentReportFilter = f;
            document.querySelectorAll('.rep-filter').forEach(b => {
                if(b.textContent.toLowerCase().includes(f === 'all' ? 'all' : f)) b.className = "rep-filter active px-4 py-1.5 rounded-full text-[10px] font-bold bg-blue-600 text-white shadow-md shadow-blue-200 transition-all whitespace-nowrap";
                else b.className = "rep-filter px-4 py-1.5 rounded-full text-[10px] font-bold bg-white text-slate-500 border border-slate-200 hover:bg-slate-50 transition-all whitespace-nowrap";
            });
            loadReportData();
        };

        window.toggleRepView = (v) => {
            window.currentReportView = v;
            const subBtn = document.getElementById('rv-subject');
            const sesBtn = document.getElementById('rv-session');
            if(v === 'subject') { subBtn.className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-700 shadow-sm transition-all"; sesBtn.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-400 hover:text-slate-600 transition-all"; }
            else { sesBtn.className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-700 shadow-sm transition-all"; subBtn.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-400 hover:text-slate-600 transition-all"; }
            loadReportData();
        };

        async function loadReportData() {
            const container = document.getElementById('report-body');
            const analyticsContainer = document.getElementById('analytics-dash');
            
            container.innerHTML = '<div class="flex justify-center py-8"><div class="loader"></div></div>';

            try {
                // Fetch Sessions
                const qSess = query(getSessionPath()); 
                const snapSess = await getDocs(qSess);
                const sessions = [];
                const now = new Date();
                const limit = new Date();
                
                // Time Filter Logic
                if(window.currentReportFilter === 'week') limit.setDate(now.getDate() - 7);
                else if(window.currentReportFilter === 'month') limit.setDate(now.getDate() - 30);
                else limit.setFullYear(2000);

                // --- DATA FILTERING LOOP ---
                snapSess.forEach(d => {
                    const data = d.data();
                    const sessDate = data.timestamp ? data.timestamp.toDate() : new Date(data.date);
                    
                    // 1. Time Check
                    if (sessDate >= limit) {
                        // 2. NEW: Section Check
                        if (window.currentReportSection === 'all' || data.section === window.currentReportSection) {
                            sessions.push({id: d.id, ...data});
                        }
                    }
                });

                if (sessions.length === 0) { 
                    container.innerHTML = '<div class="text-center py-10 text-slate-400 text-xs">No records found for this selection.</div>'; 
                    analyticsContainer.innerHTML = ''; 
                    return; 
                }

                // ... The rest of your existing logic remains exactly the same ...
                // Fetching master list, calculating stats, rendering charts, etc.
                
                const masterSnap = await getDocs(getMasterPath());
                const totalStudents = masterSnap.size;
                const snapAtt = await getDocs(getAttPath());
                const attendance = [];
                snapAtt.forEach(d => attendance.push({id: d.id, ...d.data()}));

                // ... (Keep the rest of your original loadReportData code below this line) ...
                
                // --- ANALYTICS DASHBOARD LOGIC ---
                if (window.currentReportView === 'subject') {
                    const subjectStats = {};
                    const studentStats = {}; 
                    
                    sessions.forEach(s => {
                        if(!subjectStats[s.subject]) subjectStats[s.subject] = { sessions: [], attendance: [] };
                        subjectStats[s.subject].sessions.push(s);
                    });
                    
                    sessions.forEach(s => {
                        const sessAtt = attendance.filter(a => a.sessionId === s.id);
                        if(subjectStats[s.subject]) subjectStats[s.subject].attendance.push(...sessAtt);
                    });
                    
                    masterSnap.forEach(d => {
                         const s = d.data();
                         // Only track students belonging to current section filter (if applicable)
                         if(window.currentReportSection === 'all' || s.section === window.currentReportSection) {
                             studentStats[s.rollNo] = { name: s.name, total: sessions.length, present: 0 };
                         }
                    });
                    
                    attendance.forEach(a => {
                         if(sessions.find(s => s.id === a.sessionId) && studentStats[a.studentRoll]) {
                             studentStats[a.studentRoll].present++;
                         }
                    });

                    // 1. Chart Data
                    const labels = Object.keys(subjectStats);
                    const avgData = labels.map(sub => {
                        const data = subjectStats[sub];
                        // Calc total possible based on filtered students
                        const filteredMasterSize = Object.keys(studentStats).length; 
                        // If 'all', use totalStudents. If filtered, use filtered count.
                        const baseSize = window.currentReportSection === 'all' ? totalStudents : filteredMasterSize;
                        
                        const totalPossible = data.sessions.length * baseSize;
                        const actual = data.attendance.length;
                        return totalPossible > 0 ? Math.round((actual / totalPossible) * 100) : 0;
                    });
                    
                    // 2. Irregular Students
                    const irregulars = Object.values(studentStats).filter(s => {
                         const pct = s.total > 0 ? (s.present / s.total) * 100 : 0;
                         return pct < 75 && s.total > 0;
                    }).sort((a,b) => (a.present/a.total) - (b.present/b.total));

                    analyticsContainer.innerHTML = `
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex flex-col h-64">
                             <h3 class="font-bold text-slate-800 text-sm mb-3">Analytics (${window.currentReportSection === 'all' ? 'All Sections' : 'Section ' + window.currentReportSection})</h3>
                             <div class="flex-1 relative min-h-0">
                                <canvas id="chartCanvas"></canvas>
                             </div>
                        </div>
                        
                        ${irregulars.length > 0 ? `
                        <div class="bg-red-50 rounded-xl p-4 border border-red-100">
                            <h3 class="font-bold text-red-800 text-sm mb-2 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Irregular Students <span class="bg-red-200 text-red-700 px-1.5 py-0.5 rounded text-[9px]">${irregulars.length}</span></h3>
                            <div class="max-h-40 overflow-y-auto pr-1 space-y-2">
                                ${irregulars.map(s => {
                                    const pct = Math.round((s.present/s.total)*100);
                                    let remark = "Low Attendance";
                                    if(pct < 50) remark = "Critical";
                                    return `<div class="bg-white p-2 rounded-lg border border-red-100 flex justify-between items-center">
                                        <div><p class="font-bold text-xs text-slate-700">${s.name}</p><p class="text-[9px] text-slate-400">${s.present}/${s.total} Classes</p></div>
                                        <div class="text-right"><p class="font-bold text-xs text-red-600">${pct}%</p><p class="text-[8px] font-bold text-red-400 uppercase tracking-wide">${remark}</p></div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>` : ''}
                    `;
                    
                    setTimeout(() => {
                        if (typeof Chart !== 'undefined' && document.getElementById('chartCanvas')) {
                            new Chart(document.getElementById('chartCanvas'), { 
                                type: 'bar', 
                                data: { 
                                    labels: labels.map(l => l.substring(0, 10) + '..'), 
                                    datasets: [{ label: 'Avg %', data: avgData, backgroundColor: '#3b82f6', borderRadius: 4 }] 
                                }, 
                                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } } 
                            });
                        }
                    }, 100);
                } else {
                    analyticsContainer.innerHTML = ''; 
                }

                // Render Original Views (Session / Subject Tables)
                if (window.currentReportView === 'session') {
                    let html = '<div class="space-y-3">';
                    sessions.sort((a,b) => b.timestamp - a.timestamp).forEach(s => {
                        const attendees = attendance.filter(a => a.sessionId === s.id);
                        const pCount = attendees.length;
                        // Use accurate total based on filter
                        const baseSize = window.currentReportSection === 'all' ? totalStudents : totalStudents; // Simplification, ideally filter master list by section
                        
                        const pPercent = baseSize > 0 ? Math.round((pCount/baseSize)*100) : 0;
                        html += `<div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-800 text-sm">${s.subject}</h4><p class="text-[10px] text-slate-500 font-mono mt-0.5">${s.date} | ${s.timeSlot}</p><span class="bg-slate-100 text-slate-600 px-1.5 rounded text-[9px] font-bold mt-1 inline-block">Sec ${s.section}</span></div><div class="text-right"><span class="text-xs font-bold ${pPercent > 75 ? 'text-green-600' : 'text-orange-500'}">${pPercent}%</span></div></div><div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden mb-2"><div class="h-full bg-green-500 rounded-full" style="width: ${pPercent}%"></div></div><button onclick="viewSessionDetails('${s.id}')" class="w-full py-1.5 rounded-lg border border-slate-100 text-[10px] font-bold text-blue-600 hover:bg-blue-50">View Details</button></div>`;
                    });
                    container.innerHTML = html + '</div>';
                } else {
                    // SUBJECT VIEW TABLE (Updates automatically because 'sessions' array is already filtered)
                    const subjectStats = {}; 
                    sessions.forEach(s => {
                        if(!subjectStats[s.subject]) subjectStats[s.subject] = { sessions: [], attendance: [] };
                        subjectStats[s.subject].sessions.push(s);
                    });
                    attendance.forEach(a => {
                        const sess = sessions.find(s => s.id === a.sessionId);
                        if(sess && subjectStats[sess.subject]) subjectStats[sess.subject].attendance.push(a);
                    });

                    let html = '<div class="space-y-6">';
                    for(const [sub, data] of Object.entries(subjectStats)) {
                        const totalSessions = data.sessions.length;
                        const maxScore = totalSessions * 2;
                        
                        // Calculate per student stats
                        const studentMap = {};
                        masterSnap.forEach(m => {
                            const s = m.data();
                            // Filter students in table by section too
                            if(window.currentReportSection === 'all' || s.section === window.currentReportSection) {
                                studentMap[s.rollNo] = { name: s.name, count: 0 };
                            }
                        });
                        
                        data.attendance.forEach(a => {
                            if(studentMap[a.studentRoll]) studentMap[a.studentRoll].count++;
                        });

                        html += `
                          <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                             <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                                 <div><h3 class="font-bold text-slate-800 text-sm">${sub}</h3><p class="text-[10px] text-slate-500 mt-1">Held: ${totalSessions}</p></div>
                                 <button onclick="downloadSubjectReport('${sub}')" class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 shadow-sm"><i class="fa-solid fa-file-csv"></i></button>
                             </div>
                             <div class="max-h-64 overflow-y-auto">
                                 <table class="w-full text-left border-collapse">
                                     <thead class="bg-white text-[9px] text-slate-400 font-bold uppercase sticky top-0 z-10 shadow-sm"><tr><th class="p-3 bg-white">Roll No</th><th class="p-3 bg-white">Name</th><th class="p-3 bg-white text-center">Score</th><th class="p-3 bg-white text-right">%</th></tr></thead>
                                     <tbody class="text-xs text-slate-700 divide-y divide-slate-50">
                                         ${Object.entries(studentMap).map(([roll, s]) => {
                                             const score = s.count * 2;
                                             const pct = maxScore > 0 ? Math.round((score/maxScore)*100) : 0;
                                             let color = pct >= 75 ? 'text-green-600' : (pct >= 60 ? 'text-orange-500' : 'text-red-500');
                                             return `<tr class="hover:bg-slate-50"><td class="p-3 font-mono font-bold">${roll}</td><td class="p-3">${s.name}</td><td class="p-3 text-center font-bold">${score}</td><td class="p-3 text-right font-bold ${color}">${pct}%</td></tr>`;
                                         }).join('')}
                                     </tbody>
                                 </table>
                             </div>
                          </div>`;
                    }
                    container.innerHTML += html + '</div>';
                }

            } catch(e) { console.error(e); container.innerHTML = '<p class="text-red-500 text-xs text-center">Error loading data.</p>'; }
        }

        // --- NEW: Download Subject Report ---
        window.downloadSubjectReport = async (subject) => {
            showToast("Generating Report...", "info");
            try {
                // 0. Get Current Filters
                const currentSection = window.currentReportSection || 'all';
                const timeFilter = window.currentReportFilter || 'all';

                // 1. Determine Date Range
                const now = new Date();
                let startDate = new Date(0); // Default All Time
                let headerText = `Attendance Report - ${subject}`;
                
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const currentMonthStr = `${monthNames[now.getMonth()]}-${now.getFullYear()}`;

                if (timeFilter === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    headerText += ` (Month: ${currentMonthStr})`;
                } else if (timeFilter === 'week') {
                    startDate = new Date();
                    startDate.setDate(now.getDate() - 7);
                    headerText += ` (Last 7 Days)`;
                }

                // Add Section to Header
                headerText += ` [Section: ${currentSection === 'all' ? 'All' : currentSection}]`;

                // 2. Fetch & Filter Sessions (By Subject, Date, AND Section)
                const qAllSess = query(getSessionPath());
                const snapSess = await getDocs(qAllSess);
                let sessions = [];
                
                snapSess.forEach(doc => {
                    const data = doc.data();
                    const sessDate = data.timestamp ? data.timestamp.toDate() : new Date(data.date);
                    
                    // Filter: Subject + Date + Section
                    if (data.subject === subject && sessDate >= startDate) {
                        if (currentSection === 'all' || data.section === currentSection) {
                            sessions.push({ id: doc.id, ...data, trueDate: sessDate });
                        }
                    }
                });
                
                sessions.sort((a, b) => a.trueDate - b.trueDate);

                if (sessions.length === 0) return showToast("No sessions found for this selection.", "error");

                // 3. Fetch Students (Filtered by Section)
                const studentMap = new Map();

                // 3a. Master List
                const masterSnap = await getDocs(getMasterPath());
                masterSnap.forEach(doc => {
                    const d = doc.data();
                    // FILTER STUDENTS BY SECTION
                    if (d.rollNo) {
                        if (currentSection === 'all' || d.section === currentSection) {
                            studentMap.set(d.rollNo.toUpperCase(), { rollNo: d.rollNo.toUpperCase(), name: d.name });
                        }
                    }
                });

                // 3b. Enrolled List (Fallback if not in master)
                const enrolledSnap = await getDocs(getStudentsPath());
                enrolledSnap.forEach(doc => {
                    const d = doc.data();
                    if (d.rollNo && !studentMap.has(d.rollNo.toUpperCase())) {
                        // We can't strictly filter enrolled if they aren't in master with a section, 
                        // but usually, we include them or check if we can infer section. 
                        // For safety, we include them if 'all' or exclude if we are strict.
                        // Here: We include them only if currentSection is ALL, otherwise we might miss section data.
                        if(currentSection === 'all') {
                            studentMap.set(d.rollNo.toUpperCase(), { rollNo: d.rollNo.toUpperCase(), name: d.name });
                        }
                    }
                });

                let students = Array.from(studentMap.values());
                students.sort((a, b) => a.rollNo.localeCompare(b.rollNo));

                if (students.length === 0) return showToast("No students found in this section.", "error");

                // 4. Optimized Attendance Fetch
                const attendancePromises = sessions.map(session => 
                    getDocs(query(getAttPath(), where("sessionId", "==", session.id)))
                );
                
                const attendanceSnapshots = await Promise.all(attendancePromises);
                
                const attendanceMap = {}; 
                attendanceSnapshots.forEach(snap => {
                    snap.forEach(doc => {
                        const d = doc.data();
                        const rollKey = d.studentRoll ? d.studentRoll.toUpperCase() : "UNKNOWN";
                        if (d.status === 'present') {
                            attendanceMap[`${d.sessionId}_${rollKey}`] = true;
                        }
                    });
                });

                // 5. Build CSV
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Top Headline
                csvContent += `${headerText}\r\n`;

                // Columns
                let header = ["Sl.No", "Roll No", "Name"];
                sessions.forEach((s, i) => {
                    const dateStr = s.trueDate.toISOString().split('T')[0];
                    header.push(`Class ${i + 1} (${dateStr})`);
                });
                header.push("Total Score");
                header.push("Percentage");
                header.push("Present/Total");
                csvContent += header.join(",") + "\r\n";

                // Rows
                students.forEach((stud, index) => {
                    const safeName = stud.name ? `"${stud.name}"` : "Unknown";
                    let row = [index + 1, stud.rollNo, safeName];
                    let presentCount = 0;
                    let totalScore = 0;

                    sessions.forEach(sess => {
                        const key = `${sess.id}_${stud.rollNo}`;
                        if (attendanceMap[key]) {
                            row.push("2");
                            presentCount++;
                            totalScore += 2;
                        } else {
                            row.push("A");
                        }
                    });

                    const totalClasses = sessions.length;
                    const percentage = totalClasses > 0 ? Math.round((presentCount / totalClasses) * 100) : 0;
                    
                    row.push(totalScore);
                    row.push(`${percentage}%`);
                    row.push(`${presentCount}/${totalClasses}`);

                    csvContent += row.join(",") + "\r\n";
                });

                // 6. Download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                
                // Filename: DBMS_SecA_Month_Report.csv
                const safeSub = subject.replace(/[^a-z0-9]/gi, '_');
                const secTag = currentSection === 'all' ? 'AllSec' : `Sec${currentSection}`;
                
                link.setAttribute("download", `${safeSub}_${secTag}_${timeFilter}_Report.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("Report Downloaded", "success");

            } catch (e) {
                console.error(e);
                showToast("Report Generation Failed", "error");
            }
        };

        // --- SESSION LOGIC ---
        let otpInterval = null; let currentSessionId = null;
        async function populateTemplates() {
            const sel = document.getElementById('quick-load'); if(!sel) return;
            try { const snap = await getDocs(getTemplatesPath()); snap.forEach(doc => { const opt = document.createElement('option'); opt.value = JSON.stringify(doc.data()); opt.text = `${doc.data().subject} (${doc.data().timeSlot})`; sel.appendChild(opt); }); } catch(e) {}
        }
        window.loadTemplate = (val) => { if(!val) return; const data = JSON.parse(val); document.getElementById('f-subject').value = data.subject; document.getElementById('f-slot').value = data.timeSlot; };
        
        window.createSession = async () => {
            const btn = document.getElementById('create-btn'); btn.innerText = "Starting...";
            try {
                const pos = await getCurrentLocation();
                const otp = Math.floor(1000 + Math.random() * 9000).toString();
                const subject = document.getElementById('f-subject').value;
                const section = document.getElementById('f-section').value;
                const slot = document.getElementById('f-slot').value;
                const date = document.getElementById('f-date').value;

                if(document.getElementById('save-template').checked) await addDoc(getTemplatesPath(), { subject, timeSlot: slot });
                const sessionRef = await addDoc(getSessionPath(), { subject, section, timeSlot: slot, date, otp, active: true, facultyId: window.appState.userId, facultyName: window.appState.facultyProfile.name, lat: pos.lat, lng: pos.lng, timestamp: serverTimestamp() });
                
                currentSessionId = sessionRef.id;
                monitorSession(sessionRef.id, subject, section, slot, otp);
            } catch (e) { console.error(e); showToast("Start Failed: " + e, "error"); btn.innerText = "Start Class"; }
        };

        function monitorSession(sessionId, subject, section, slot, initialOtp) {
            // Clear previous generic intervals if any
            if(otpInterval) clearInterval(otpInterval);

            document.getElementById('create-session-panel').classList.add('hidden');
            document.getElementById('live-monitor').classList.remove('hidden');
            document.getElementById('display-sub').innerText = subject;
            document.getElementById('display-sec').innerText = "Sec " + section;
            document.getElementById('display-slot').innerText = slot;
            document.getElementById('display-otp').innerText = initialOtp;

            let timeLeft = OTP_REFRESH_RATE; const bar = document.getElementById('otp-bar');
            
            // ADDED: Track OTP Interval
            otpInterval = setInterval(() => { 
                timeLeft--; 
                if(bar) bar.style.width = `${(timeLeft / OTP_REFRESH_RATE) * 100}%`; 
                if (timeLeft <= 0) { timeLeft = OTP_REFRESH_RATE; updateOTP(sessionId); } 
            }, 1000);
            window.appState.activeIntervals.push(otpInterval);
            
            // --- Fetch Total Count ---
            let totalStudents = 0;
            getDocs(query(getMasterPath(), where("section", "==", section))).then(snap => {
               totalStudents = snap.size; 
               // Fallback if master empty
               if(totalStudents === 0) getDocs(getStudentsPath()).then(s=>totalStudents = s.size);
            });

            // ADDED: Track Snapshot Listener
            const unsub = onSnapshot(query(getAttPath(), where("sessionId", "==", sessionId)), (snap) => {
                const list = document.getElementById('attendee-list');
                if(!list) return; // Safety check
                list.innerHTML = ''; 
                
                let attendees = [];
                snap.forEach(d => attendees.push({id: d.id, ...d.data()}));
                
                // Update Dashboard Counts
                const presentCount = attendees.filter(a => a.status === 'present').length;
                const pendingCount = attendees.filter(a => a.status === 'pending').length;
                const absentCount = Math.max(0, totalStudents - presentCount - pendingCount);
                
                document.getElementById('live-present').innerText = presentCount;
                document.getElementById('live-pending').innerText = pendingCount;
                document.getElementById('live-absent').innerText = absentCount;

                // Sort by timestamp descending
                attendees.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                attendees.forEach(r => {
                    const timeStr = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now';
                    
                    // Visual Cue for Pending/Not Verified
                    const isPending = r.status === 'pending' || r.verified === false;
                    const borderClass = isPending ? 'border-orange-300 bg-orange-50' : 'border-green-100 bg-white';
                    const icon = isPending ? '<i class="fa-solid fa-triangle-exclamation text-[8px] text-orange-500 absolute -top-1 -right-1"></i>' : '';

                    list.innerHTML += `
                    <div onclick="reviewAttendanceFromBubble('${r.id}')" class="inline-flex items-center gap-2 ${borderClass} border rounded-full pl-1 pr-3 py-1 shadow-sm animate-pop transition-transform hover:scale-105 cursor-pointer select-none relative">
                        <img src="${r.capturedPhoto || 'https://ui-avatars.com/api/?name=' + r.studentName}" class="w-8 h-8 rounded-full object-cover border border-slate-200 bg-slate-100">
                        ${icon}
                        <div>
                            <p class="text-[10px] font-bold text-slate-700 leading-tight">${r.studentRoll}</p>
                            <p class="text-[8px] text-slate-400 leading-tight tracking-wide">${timeStr}</p>
                        </div>
                    </div>`;
                });
            });
            
            // ADDED: Push listener to active array
            window.appState.activeListeners.push(unsub);
        }
        
        // --- NEW: Open review from bubble ---
        window.reviewAttendanceFromBubble = async (attId) => {
             // Find record in cached attendees
             try {
                 const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', attId));
                 if(!snap.exists()) return;
                 const record = snap.data();
                 record.id = snap.id;
                 
                 // Reuse review modal logic (simplified manual setup)
                 document.getElementById('review-modal').classList.remove('hidden');
                 document.getElementById('review-enrolled-loader').classList.remove('hidden');
                 document.getElementById('review-name').innerText = record.studentName;
                 document.getElementById('review-roll').innerText = record.studentRoll;
                 document.getElementById('review-time').innerText = record.timestamp ? new Date(record.timestamp.seconds*1000).toLocaleString() : 'N/A';
                 document.getElementById('review-live-img').src = record.capturedPhoto || '';
                 
                 // Update badge and buttons based on status
                 const badge = document.getElementById('review-badge');
                 const approveBtn = document.getElementById('approve-btn');
                 
                 if(record.status === 'pending' || record.verified === false) {
                     badge.className = "bg-orange-50 text-orange-700 px-3 py-2 rounded-lg text-xs font-bold w-full text-center border border-orange-200";
                     badge.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> Manual Request';
                     approveBtn.classList.remove('hidden');
                     approveBtn.classList.add('flex'); // Show Approve
                     approveBtn.onclick = () => approveAttendance(record.id, record.sessionId);
                 } else {
                     badge.className = "bg-green-50 text-green-700 px-3 py-2 rounded-lg text-xs font-bold w-full text-center border border-green-200";
                     badge.innerHTML = '<i class="fa-solid fa-check-circle mr-1"></i> Biometric Verified';
                     approveBtn.classList.add('hidden'); // Hide Approve
                 }

                 const rejectBtn = document.getElementById('reject-btn');
                 rejectBtn.onclick = () => rejectAttendance(record.id, record.sessionId);

                 // Fetch Enrolled with Finally block for Spinner Fix
                 try {
                     const sSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', record.studentId));
                     if(sSnap.exists() && sSnap.data().enrolledPhoto) {
                        document.getElementById('review-enrolled-img').src = sSnap.data().enrolledPhoto;
                     } else {
                        document.getElementById('review-enrolled-img').src = ''; 
                     }
                 } catch(err) {
                     console.error("Enrolled fetch err", err);
                 } finally {
                     document.getElementById('review-enrolled-loader').classList.add('hidden');
                 }

             } catch(e) { console.error(e); }
        };
        
        //async function updateOTP(sessionId) { const newOtp = Math.floor(1000 + Math.random() * 9000).toString(); document.getElementById('display-otp').innerText = newOtp; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId), { otp: newOtp }); }
        
        //new otp logic
        window.updateOTP = async (sessionId) => {
            // 1. SAFETY CHECK: Is the OTP element actually on the screen?
            const otpDisplay = document.getElementById('display-otp');
            
            // If the element is missing (user switched tabs), STOP here.
            if (!otpDisplay) {
                console.log("User left session screen. Skipping OTP update.");
                return; 
            }

            // 2. Generate New OTP
            const newOtp = Math.floor(1000 + Math.random() * 9000).toString();
            
            // 3. Update UI (Safe now because we checked existence above)
            otpDisplay.innerText = newOtp;
            
            // 4. Update Database
            try {
                // Only update if session is still valid/active
                if(window.appState.verifiedSessionId === sessionId) {
                    window.appState.verifiedOTP = newOtp;
                }
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId), { 
                    otp: newOtp,
                    lastUpdated: serverTimestamp() 
                });
                
            } catch(e) {
                console.error("Failed to sync OTP to DB", e);
            }
        };

        window.endSession = async () => {
            // Check for pending requests first
            const q = query(getAttPath(), where("sessionId", "==", currentSessionId), where("status", "==", "pending"));
            const pendingSnap = await getDocs(q);
            
            if(!pendingSnap.empty) {
                // Show Review Modal
                const modal = document.getElementById('pending-review-modal');
                const list = document.getElementById('pending-list-container');
                list.innerHTML = '';
                
                pendingSnap.forEach(d => {
                    const r = d.data();
                    list.innerHTML += `
                    <div class="bg-white p-3 rounded-xl border border-orange-100 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3">
                            <img src="${r.capturedPhoto}" class="w-10 h-10 rounded-lg object-cover bg-slate-100">
                            <div>
                                <p class="font-bold text-xs text-slate-800">${r.studentRoll}</p>
                                <p class="text-[10px] text-slate-500">${r.studentName}</p>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="approveAttendance('${d.id}', '${currentSessionId}'); this.closest('div.bg-white').remove()" class="w-8 h-8 rounded-full bg-green-50 text-green-600 hover:bg-green-100"><i class="fa-solid fa-check"></i></button>
                            <button onclick="rejectAttendance('${d.id}', '${currentSessionId}'); this.closest('div.bg-white').remove()" class="w-8 h-8 rounded-full bg-red-50 text-red-600 hover:bg-red-100"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>`;
                });
                
                modal.classList.remove('hidden');
                return; // Stop close
            }
            
            // Normal Close
            if(confirm("End class?")) { 
                // 1. Stop the Timer
                if(otpInterval) clearInterval(otpInterval); 
                
                // 2. Mark session as inactive in DB
                if(currentSessionId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', currentSessionId), { active: false }); 
                }

                // 3. FIX: Reset UI instead of Reloading Page
                currentSessionId = null;
                switchFacTab('session'); // This re-renders the Session Panel
                showToast("Session Ended", "success");
            } 
        }
        
        window.forceCloseSession = async () => {
             if(confirm("Close without resolving pending requests?")) {
                // 1. Stop the Timer
                if(otpInterval) clearInterval(otpInterval); 
                
                // 2. Mark session as inactive in DB
                if(currentSessionId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', currentSessionId), { active: false }); 
                }

                // 3. FIX: Reset UI instead of Reloading Page
                document.getElementById('pending-review-modal').classList.add('hidden');
                currentSessionId = null;
                switchFacTab('session'); // Re-renders the Session Panel
                showToast("Session Closed (Pending Ignored)", "orange");
             }
        }

        // --- LOGIN/REG ---
        function renderFacultyRegistration(container) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8"><div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mb-6"><i class="fa-solid fa-user-shield text-2xl text-blue-600"></i></div><h2 class="text-2xl font-bold text-slate-800 mb-6">Faculty Setup</h2><div class="w-full space-y-4"><input type="text" id="reg-name" placeholder="Full Name" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-medium outline-none focus:border-blue-500"><input type="password" id="reg-pin" placeholder="Set 6-digit PIN" maxlength="6" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-medium outline-none focus:border-blue-500"><input type="password" id="reg-master" placeholder="Master Key" class="w-full p-4 bg-white border border-red-100 rounded-xl text-sm font-medium outline-none focus:border-red-500"><button onclick="registerFaculty()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-black transition-transform active:scale-95">Complete Setup</button></div></div>`; }
        function renderFacultyLogin(container) { 
            // Get Faculty Photo
            const facPhoto = window.appState.facultyProfile.photoUrl || null;
            const avatarHtml = facPhoto 
                ? `<img src="${facPhoto}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg mb-6">` 
                : `<div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-6 shadow-inner"><i class="fa-solid fa-user-tie text-3xl text-indigo-500"></i></div>`;

            container.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full p-8 bg-slate-50">
                ${avatarHtml}
                <h2 class="text-2xl font-extrabold text-slate-800 mb-1">Welcome Back</h2>
                <p class="text-slate-500 text-xs font-medium mb-8 uppercase tracking-widest">${window.appState.facultyProfile.name}</p>
                
                <input type="password" id="login-pin" class="w-48 text-center text-3xl font-bold tracking-widest border-b-2 border-slate-200 focus:border-indigo-600 outline-none pb-2 mb-8 bg-transparent text-slate-800 transition-colors" maxlength="6" placeholder="••••••">            
                
                <div class="flex justify-center pt-4">
                    <button onclick="loginFaculty()" 
                            class="w-14 h-14 flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition duration-200 shadow-lg shadow-indigo-200 active:scale-90"
                            aria-label="Proceed">
                        <i class="fa-solid fa-arrow-right text-lg"></i>
                    </button>
                </div>
            </div>`; 
        }
        //<button onclick="loginFaculty()" class="w-full max-w-xs bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-transform active:scale-95">Access Dashboard</button>
        // SECURED REGISTRATION WITH HASH
        window.registerFaculty = async () => {
            const name = document.getElementById('reg-name').value, pin = document.getElementById('reg-pin').value, master = document.getElementById('reg-master').value;
            
            // Hash the input master key
            const masterHash = await sha256(master);
            
            if (masterHash !== MASTER_KEY_HASH) return showToast("Invalid Master Key", "error");
            if (pin.length !== 6) return showToast("PIN must be 6 digits", "error");
            try { await setDoc(getFacultyProfileDoc(window.appState.userId), { name, pin, createdAt: serverTimestamp() }); window.appState.facultyProfile = { name, pin }; window.appState.isFacultyLoggedIn = true; renderView(); } catch(e) { showToast("Error", "error"); }
        };
        window.loginFaculty = () => { if (document.getElementById('login-pin').value === window.appState.facultyProfile.pin) { window.appState.isFacultyLoggedIn = true; renderView(); } else showToast("Incorrect PIN", "error"); };
        window.logoutFaculty = () => { window.appState.isFacultyLoggedIn = false; renderView(); }

        // --- STUDENT ---
        function renderStudentFlow(container) {
            const p = window.appState.studentProfile;
            if (!p) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8"><div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-6"><i class="fa-solid fa-user-plus text-3xl text-indigo-600"></i></div><h2 class="text-2xl font-bold text-slate-800 mb-2">Student Register</h2><p class="text-xs text-slate-500 mb-8">This device will be linked to your Roll No.</p><div class="w-full space-y-4"><input type="text" id="s-roll" placeholder="Roll No (e.g. CS101)" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-bold font-mono outline-none focus:border-indigo-500 uppercase"><input type="text" id="s-name" placeholder="Full Name" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-medium outline-none focus:border-indigo-500 uppercase"><button onclick="registerStudent()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-transform">Submit Request</button></div></div>`; return; }
            if (p.status === 'pending') { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8 text-center"><div class="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mb-6 animate-pulse"><i class="fa-solid fa-hourglass-half text-3xl text-orange-500"></i></div><h2 class="text-xl font-bold text-slate-800">Verification Pending</h2><p class="text-sm text-slate-500 mt-2">Your registration is waiting for Faculty approval.</p><button onclick="location.reload()" class="mt-8 text-blue-600 font-bold text-sm bg-blue-50 px-6 py-2 rounded-full">Refresh Status</button></div>`; return; }
            renderStudentDashboard(container, p);
        }

        // --- Expose function to window explicitly to fix ReferenceError ---
        window.renderStudentFlow = function(container) {
            const p = window.appState.studentProfile;
            if (!p) { 
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8"><div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-6"><i class="fa-solid fa-user-plus text-3xl text-indigo-600"></i></div><h2 class="text-2xl font-bold text-slate-800 mb-2">Student Register</h2><p class="text-xs text-slate-500 mb-8">This device will be linked to your Roll No.</p><div class="w-full space-y-4"><input type="text" id="s-roll" placeholder="Roll No (e.g. CS101)" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-bold font-mono outline-none focus:border-indigo-500 uppercase"><input type="text" id="s-name" placeholder="Full Name" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-medium outline-none focus:border-indigo-500 uppercase"><button onclick="registerStudent()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-transform">Submit Request</button></div></div>`; 
                return; 
            }
            if (p.status === 'pending') { 
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8 text-center"><div class="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mb-6 animate-pulse"><i class="fa-solid fa-hourglass-half text-3xl text-orange-500"></i></div><h2 class="text-xl font-bold text-slate-800">Verification Pending</h2><p class="text-sm text-slate-500 mt-2">Your registration is waiting for Faculty approval.</p><button onclick="location.reload()" class="mt-8 text-blue-600 font-bold text-sm bg-blue-50 px-6 py-2 rounded-full">Refresh Status</button></div>`; 
                return; 
            }
            renderStudentDashboard(container, p);
        };

        window.registerStudent = async () => {
            const roll = document.getElementById('s-roll').value.toUpperCase().replace(/[^A-Z0-9]/g, ''), name = document.getElementById('s-name').value.toUpperCase();
            if (!roll || !name) return showToast("Invalid Input", "error");
            try {
                const q = query(getStudentsPath(), where("rollNo", "==", roll));
                if(!(await getDocs(q)).empty) return showToast("Roll Number taken", "error");
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', window.appState.userId), { rollNo: roll, name: name, uid: window.appState.userId, status: 'pending', createdAt: serverTimestamp(), deviceLocked: true });
                window.appState.studentProfile = { rollNo: roll, name: name, status: 'pending' }; renderView();
            } catch(e) { showToast("Error", "error"); }
        };

        function renderStudentDashboard(container, p) {
            const hasFace = !!window.appState.faceDescriptor;
            
            container.innerHTML = `
                <div class="p-6 space-y-8">
                    <header class="flex justify-between items-center">
                        <div><h1 class="text-2xl font-bold text-slate-800">Hi, ${p.name.split(' ')[0]}</h1><p class="text-xs font-mono text-slate-400 tracking-wider">${p.rollNo}</p></div>
                        <button onclick="renderProfile(document.getElementById('main-view'), true)" class="w-10 h-10 bg-white border border-slate-100 rounded-full flex items-center justify-center shadow-sm text-slate-600 hover:text-blue-600 transition-colors"><i class="fa-solid fa-user-gear"></i></button>
                    </header>
                    
                    ${!hasFace ? `<div onclick="renderProfile(document.getElementById('main-view'), true)" class="bg-red-50 border border-red-100 p-4 rounded-xl flex items-center justify-between cursor-pointer active:scale-95 transition-transform"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center"><i class="fa-solid fa-face-frown text-xl"></i></div><div><h3 class="text-sm font-bold text-red-700">Setup Face ID</h3><p class="text-[10px] text-red-500">Required for attendance</p></div></div><i class="fa-solid fa-chevron-right text-red-300"></i></div>` : ''}

                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 grid grid-cols-3 gap-2 text-center">
                        <div class="p-2"><p class="text-[10px] font-bold text-slate-400 uppercase">Present</p><p class="text-2xl font-bold text-green-600" id="stat-present">-</p></div>
                        <div class="p-2 border-l border-slate-50"><p class="text-[10px] font-bold text-slate-400 uppercase">Absent</p><p class="text-2xl font-bold text-red-500" id="stat-absent">-</p></div>
                        <div class="p-2 border-l border-slate-50"><p class="text-[10px] font-bold text-slate-400 uppercase">Total</p><p class="text-2xl font-bold text-slate-800" id="stat-total">-</p></div>
                    </div>
                    <div><h2 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div> Active Classes</h2><div id="active-sessions-list" class="space-y-4"></div></div>
                    <div><h2 class="font-bold text-slate-800 mb-4 text-sm">Attendance History</h2><div id="history-list" class="space-y-2 max-h-48 overflow-y-auto"></div></div>
                </div>
            `;
            loadStudentStats(); listenForActiveSessions(); loadStudentHistory();
        }

        // --- ADDED MISSING FUNCTION: loadStudentStats ---
        async function loadStudentStats() {
            try {
                 // 1. Get Attendance Records
                 const attSnap = await getDocs(query(getAttPath(), where("studentId", "==", window.appState.userId)));
                 let p = 0;
                 attSnap.forEach(d => {
                     if(d.data().status === 'present') p++;
                 });
                 
                 // 2. Get Total Sessions Count (Assuming Section 'A' default or from Master)
                 // NOTE: Since student profile structure doesn't save section on register, we will check master list
                 let section = 'A';
                 const mSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master_students', window.appState.studentProfile.rollNo));
                 if(mSnap.exists()) section = mSnap.data().section || 'A';
                 
                 const sessSnap = await getDocs(query(getSessionPath(), where("section", "==", section)));
                 const total = sessSnap.size;
                 const absent = Math.max(0, total - p);

                 // Update DOM
                 const presentEl = document.getElementById('stat-present');
                 if(presentEl) presentEl.innerText = p;
                 
                 const absentEl = document.getElementById('stat-absent');
                 if(absentEl) absentEl.innerText = absent; 
                 
                 const totalEl = document.getElementById('stat-total');
                 if(totalEl) totalEl.innerText = total;

            } catch(e) { console.error(e); }
        }

        // --- ADDED MISSING FUNCTION: listenForActiveSessions ---
        function listenForActiveSessions() {
             const q = query(getSessionPath(), where("active", "==", true));
             
             const unsub = onSnapshot(q, (snap) => {
                 const list = document.getElementById('active-sessions-list');
                 if (!list) return;
                 list.innerHTML = '';

                 // NEW: Get the student's assigned section
                 const mySection = window.appState.studentProfile?.section;

                 if (snap.empty) {
                     list.innerHTML = '<p class="text-xs text-slate-400 text-center py-4">No active classes right now.</p>';
                     return;
                 }
                 
                 let visibleCount = 0;

                 snap.forEach(d => {
                     const s = d.data();
                     
                     // NEW: FILTER LOGIC
                     // If student has a section, ONLY show sessions matching that section.
                     // (If student is not in master list/has no section, they see everything as a fallback)
                     if (mySection && s.section && s.section !== mySection) return;

                     visibleCount++;
                     const safeSubject = s.subject.replace(/'/g, "\\'");
                     
                     list.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border border-blue-100 shadow-sm flex justify-between items-center group hover:border-blue-300 transition-colors">
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">${s.subject}</h4>
                                <p class="text-[10px] text-slate-500 flex items-center gap-1"><span class="bg-blue-100 text-blue-600 px-1.5 rounded text-[9px] font-bold">SEC ${s.section}</span> ${s.facultyName}</p>
                            </div>
                            <button onclick="startAttendanceFlow('${d.id}', ${s.lat}, ${s.lng}, '${safeSubject}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all">
                                Mark
                            </button>
                        </div>
                     `;
                 });

                 // NEW: Empty state check after filtering
                 if (visibleCount === 0) {
                     list.innerHTML = `<p class="text-xs text-slate-400 text-center py-4">No active classes for Section ${mySection || 'yours'} right now.</p>`;
                 }
             });
             
             window.appState.activeListeners.push(unsub);
        }

        async function loadStudentHistory() {
            try {
                const q = query(getAttPath(), where("studentId", "==", window.appState.userId));
                const snap = await getDocs(q);
                const list = document.getElementById('history-list');
                if (snap.empty) { list.innerHTML = '<p class="text-center text-xs text-slate-400">No history available.</p>'; return; }
                const sessionsSnap = await getDocs(getSessionPath());
                const sessionMap = {}; sessionsSnap.forEach(s => sessionMap[s.id] = s.data());
                let html = '';
                snap.forEach(d => {
                    const r = d.data();
                    // SHOW ALL IN HISTORY, but differentiate
                    const session = sessionMap[r.sessionId];
                    const dateStr = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    const badge = r.status === 'present' 
                        ? '<span class="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-1 rounded">Present</span>' 
                        : '<span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded">Pending</span>';

                    html += `<div class="bg-white p-3 rounded-xl border border-slate-50 flex justify-between items-center shadow-sm"><div><p class="font-bold text-xs text-slate-700">${session ? session.subject : 'Unknown Subject'}</p><p class="text-[10px] text-slate-400">${dateStr} | ${session ? session.timeSlot : ''}</p></div>${badge}</div>`;
                });
                list.innerHTML = html;
            } catch(e) { console.error("History Error", e); }
        }

        // --- CAMERA & LIVENESS ---
        let videoStream = null; let activeMode = null; let onCaptureCallback = null;

        window.openCamera = async (mode, callback) => {
            activeMode = mode; onCaptureCallback = callback;
            const modal = document.getElementById('camera-modal'), video = document.getElementById('video-feed');
            modal.classList.remove('hidden');
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 320 }, height: { ideal: 240 } } });
                video.srcObject = videoStream; 
                video.onloadedmetadata = () => { video.play(); startLivenessLoop(video); };
            } catch (err) { showToast("Camera Access Denied", "error"); closeCamera(); }
        };

        window.closeCamera = () => {
            const modal = document.getElementById('camera-modal'), video = document.getElementById('video-feed');
            modal.classList.add('hidden'); if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; }
            video.srcObject = null; activeMode = null;
        };

        async function startLivenessLoop(video) {
            const canvas = document.getElementById('overlay-canvas');
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);
            
            const btn = document.getElementById('capture-btn'), status = document.getElementById('camera-status'), challengeBox = document.getElementById('liveness-challenge');
            let state = 'WAIT', challengeType = Math.floor(Math.random() * 3); 
            const challengeNames = ["Blink Eyes", "Turn Head", "Nod (Up/Down)"];
            let stabilizationCounter = 0; // NEW: Counter for stable alignment

            // RECURSIVE LOOP for better control than setInterval
            const loop = async () => {
                if (!activeMode) return;
                
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const detections = await faceapi.detectSingleFace(video, options).withFaceLandmarks(true).withFaceDescriptor();
                const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detections) {
                    const dims = faceapi.resizeResults(detections, displaySize); faceapi.draw.drawDetections(canvas, dims);
                    if (state === 'WAIT') {
                        status.innerText = "Face Detected";
                        if (detections.detection.score > 0.7) {
                            state = 'CHALLENGE'; challengeBox.classList.remove('hidden');
                            document.getElementById('challenge-text').innerText = challengeNames[challengeType];
                        }
                    } else if (state === 'CHALLENGE') {
                        const lm = detections.landmarks;
                        const leftEye = lm.getLeftEye(), rightEye = lm.getRightEye(), nose = lm.getNose(), jaw = lm.getJawOutline();
                        let passed = false;
                        
                        // --- IMPROVED LOGIC ---
                        if (challengeType === 0) { // BLINK
                            // Calculate EAR (Eye Aspect Ratio)
                            const lEAR = (getDist(leftEye[1], leftEye[5]) + getDist(leftEye[2], leftEye[4])) / (2 * getDist(leftEye[0], leftEye[3]));
                            const rEAR = (getDist(rightEye[1], rightEye[5]) + getDist(rightEye[2], rightEye[4])) / (2 * getDist(rightEye[0], rightEye[3]));
                            const avgEAR = (lEAR + rEAR) / 2;
                            if (avgEAR < 0.30) passed = true; // Relaxed threshold
                        } else if (challengeType === 1) { // TURN HEAD
                            const noseX = nose[0].x, boxW = detections.detection.box.width, center = detections.detection.box.x + boxW/2;
                            if (Math.abs(noseX - center) > boxW * 0.12) passed = true; // Slightly more sensitive
                        } else if (challengeType === 2) { // NOD
                            const noseTip = nose[6], chinTip = jaw[8], verticalDist = chinTip.y - noseTip.y, boxH = detections.detection.box.height, ratio = verticalDist / boxH;
                            // Widen range for "Action"
                            if(ratio < 0.28 || ratio > 0.45) passed = true; 
                        }
                        
                        if (passed) {
                            challengeBox.classList.add('challenge-success');
                            document.getElementById('challenge-icon').innerHTML = '<i class="fa-solid fa-check"></i>';
                            document.getElementById('challenge-text').innerText = "Verified";
                            setTimeout(() => {
                                state = 'ALIGN';
                                challengeBox.classList.remove('challenge-success'); 
                                challengeBox.classList.remove('hidden');
                                document.getElementById('challenge-icon').innerHTML = '<i class="fa-solid fa-camera"></i>';
                                document.getElementById('challenge-text').innerText = "Look Straight";
                                stabilizationCounter = 0;
                            }, 500); 
                        }
                    } else if (state === 'ALIGN') {
                        // Strict Pose Check Logic
                        const lm = detections.landmarks;
                        const nose = lm.positions[30]; // Tip of nose
                        const jaw = lm.getJawOutline();
                        const jawLeft = jaw[0];
                        const jawRight = jaw[16];
                        const leftEye = lm.getLeftEye();
                        const rightEye = lm.getRightEye();

                        // 1. YAW: Symmetry Check (Nose centered horizontally on face)
                        const distToLeft = Math.abs(nose.x - jawLeft.x);
                        const distToRight = Math.abs(nose.x - jawRight.x);
                        const ratio = distToLeft / (distToRight || 1);
                        const isFacingFront = ratio > 0.8 && ratio < 1.25;

                        // 2. ROLL: Tilt Check (Eyes horizontal)
                        const leftEyeCenter = { x: (leftEye[0].x + leftEye[3].x)/2, y: (leftEye[0].y + leftEye[3].y)/2 };
                        const rightEyeCenter = { x: (rightEye[0].x + rightEye[3].x)/2, y: (rightEye[0].y + rightEye[3].y)/2 };
                        const dY = rightEyeCenter.y - leftEyeCenter.y;
                        const dX = rightEyeCenter.x - leftEyeCenter.x;
                        const angle = Math.atan2(dY, dX) * (180 / Math.PI);
                        const isLevel = Math.abs(angle) < 10; // Max 10 degree tilt

                        // 3. CENTERING: Face centered in camera frame
                        const box = detections.detection.box;
                        const boxCenter = box.x + box.width / 2;
                        const frameCenter = displaySize.width / 2;
                        const isCentered = Math.abs(boxCenter - frameCenter) < (displaySize.width * 0.15); // Within 15% center

                        // 4. NOD CHECK (Heuristic via score): High confidence usually means frontal face
                        const isHighQuality = detections.detection.score > 0.85;

                        if (isFacingFront && isLevel && isCentered && isHighQuality) {
                            stabilizationCounter++;
                            document.getElementById('challenge-text').innerText = "Hold Still...";
                            document.getElementById('challenge-icon').innerHTML = '<i class="fa-solid fa-camera"></i>';
                            status.innerText = "Perfect. Hold it.";
                            
                            // Require 5 consecutive stable frames (~500ms)
                            if (stabilizationCounter > 5) { 
                                state = 'CAPTURE';
                            }
                        } else {
                            stabilizationCounter = 0; // Reset if user moves
                            document.getElementById('challenge-text').innerText = "Look Straight";
                            document.getElementById('challenge-icon').innerHTML = '<i class="fa-solid fa-user"></i>';
                            
                            // Specific feedback
                            if(!isFacingFront) status.innerText = "Turn Face Forward";
                            else if(!isLevel) status.innerText = "Keep Head Straight";
                            else if(!isCentered) status.innerText = "Center Your Face";
                            else if(!isHighQuality) status.innerText = "Look Straight (No Nod)";
                        }

                    } else if (state === 'CAPTURE') {
                        status.innerText = "Processing..."; 
                        // Capture Logic
                        const capCanvas = document.createElement('canvas'); capCanvas.width = 300; capCanvas.height = 300;
                        const ctx2 = capCanvas.getContext('2d'); ctx2.translate(300, 0); ctx2.scale(-1, 1); 
                        ctx2.drawImage(video, 0, 0, 300, 300);
                        const imgData = capCanvas.toDataURL('image/jpeg', 0.6);
                        
                        closeCamera(); 
                        if (onCaptureCallback) onCaptureCallback(detections.descriptor, detections.detection.score, imgData);
                        return; // Stop Loop
                    }
                } else { status.innerText = "Position face in frame"; }
                
                // Run loop again in 100ms
                setTimeout(loop, 100);
            };
            
            loop(); // Start loop
        }

        // --- OTP & EXPORT/IMPORT ---
        let otpResolve = null;
        window.openOtpModal = () => { return new Promise((res) => { otpResolve = res; const m = document.getElementById('otp-modal'), i = document.getElementById('otp-input'); i.value=''; m.classList.remove('hidden'); setTimeout(()=>i.focus(), 100); }); };
        window.closeOtpModal = () => { document.getElementById('otp-modal').classList.add('hidden'); if(otpResolve) otpResolve(null); };
        window.submitOtp = () => { const v = document.getElementById('otp-input').value; if(v.length===4) { document.getElementById('otp-modal').classList.add('hidden'); if(otpResolve) otpResolve(v); } else showToast("Enter 4 digits", "error"); };

        window.openBackupModal = () => document.getElementById('backup-modal').classList.remove('hidden');
        window.closeBackupModal = () => document.getElementById('backup-modal').classList.add('hidden');
        window.exportAttendanceToJSON = async () => {
            try {
                const snap = await getDocs(getAttPath());
                const data = []; snap.forEach(d => { const r = d.data(); if(r.timestamp?.toDate) r.timestamp = r.timestamp.toDate().toISOString(); data.push(r); });
                const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `attendance_backup.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); showToast("Downloaded", "success");
            } catch(e) { showToast("Export Failed", "error"); }
        };
        window.importAttendanceFromJSON = async () => {
            const f = document.getElementById('backup-upload').files[0]; if(!f) return;
            const r = new FileReader(); r.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result); const snap = await getDocs(getAttPath());
                    const existing = new Set(); snap.forEach(d => existing.add(`${d.data().sessionId}_${d.data().studentId}`));
                    let b = writeBatch(db), c = 0;
                    for(const rec of data) {
                        if(!existing.has(`${rec.sessionId}_${rec.studentId}`)) {
                            if(rec.timestamp) rec.timestamp = Timestamp.fromDate(new Date(rec.timestamp));
                            b.set(doc(getAttPath()), rec); c++; if(c%450===0) { await b.commit(); b = writeBatch(db); }
                        }
                    }
                    if(c>0) await b.commit(); showToast(`Synced ${c} records`, "success"); window.closeBackupModal();
                } catch(e) { showToast("Import Failed", "error"); }
            }; r.readAsText(f);
        };

        // Profile & Enrollment
        window.renderProfile = (container, showBack = false) => {
            const isEnrolled = !!window.appState.faceDescriptor;
            const isLocked = window.appState.studentProfile?.profileLocked === true;
            
            const backBtn = showBack ? `<button onclick="renderStudentFlow(document.getElementById('main-view'))" class="absolute top-6 left-6 w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors z-10 shadow-sm"><i class="fa-solid fa-arrow-left"></i></button>` : '';
            
            // Logic for Lock State
            const btnState = isLocked ? 'opacity-50 cursor-not-allowed bg-slate-400' : 'bg-slate-900 hover:bg-black active:scale-95';
            const btnText = isLocked ? '<i class="fa-solid fa-lock"></i> Profile Locked' : `<i class="fa-solid fa-face-viewfinder"></i> ${isEnrolled ? 'Update Face' : 'Register Now'}`;
            const btnAction = isLocked ? '' : 'onclick="startEnrollment()"';
            
            container.innerHTML = `<div class="p-8 flex flex-col items-center bg-white min-h-screen relative">
                ${backBtn}
                <div class="relative mb-8 mt-10">
                    <div class="w-32 h-32 rounded-full p-1 border-4 ${isEnrolled ? 'border-green-500' : 'border-slate-200'} bg-white shadow-2xl">
                        <div class="w-full h-full rounded-full overflow-hidden bg-slate-100 flex items-center justify-center relative">
                            ${isEnrolled && window.appState.enrolledPhoto ? `<img src="${window.appState.enrolledPhoto}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-user text-5xl text-slate-300"></i>`}
                        </div>
                    </div>
                    ${isEnrolled ? `<div class="absolute bottom-1 right-1 bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center border-2 border-white shadow-lg"><i class="fa-solid fa-check text-sm"></i></div>` : ''}
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">${isEnrolled ? 'Verified ID' : 'Not Registered'}</h2>
                <p class="text-xs text-slate-500 mb-8 flex items-center gap-2">${isEnrolled ? '<i class="fa-solid fa-shield-halved text-green-500"></i> Biometric Data Secured' : 'Register face to attend classes'}</p>
                
                <button ${btnAction} class="w-full max-w-xs text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-all ${btnState}">
                    ${btnText}
                </button>
                
                ${isLocked ? '<p class="text-[10px] text-red-400 mt-3 font-medium">Contact faculty to unlock profile.</p>' : ''}
                
                <div class="mt-8 p-4 bg-slate-50 rounded-xl text-center border border-slate-100 w-full max-w-xs"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">User ID</p><p class="text-xs font-mono text-slate-600 truncate">${window.appState.userId}</p></div>
            </div>`;

            function renderStudentFlow(container) {
            const p = window.appState.studentProfile;
            if (!p) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8"><div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-6"><i class="fa-solid fa-user-plus text-3xl text-indigo-600"></i></div><h2 class="text-2xl font-bold text-slate-800 mb-2">Student Register</h2><p class="text-xs text-slate-500 mb-8">This device will be linked to your Roll No.</p><div class="w-full space-y-4"><input type="text" id="s-roll" placeholder="Roll No (e.g. CS101)" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-bold font-mono outline-none focus:border-indigo-500 uppercase"><input type="text" id="s-name" placeholder="Full Name" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-medium outline-none focus:border-indigo-500 uppercase"><button onclick="registerStudent()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-transform">Submit Request</button></div></div>`; return; }
            if (p.status === 'pending') { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8 text-center"><div class="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mb-6 animate-pulse"><i class="fa-solid fa-hourglass-half text-3xl text-orange-500"></i></div><h2 class="text-xl font-bold text-slate-800">Verification Pending</h2><p class="text-sm text-slate-500 mt-2">Your registration is waiting for Faculty approval.</p><button onclick="location.reload()" class="mt-8 text-blue-600 font-bold text-sm bg-blue-50 px-6 py-2 rounded-full">Refresh Status</button></div>`; return; }
            renderStudentDashboard(container, p);
        }
        }

        window.startEnrollment = () => {
            openCamera('enroll', async (desc, score, img) => {
                try {
                    const dArr = Array.from(desc);
                    await setDoc(getUserProfileDoc(window.appState.userId), { descriptor: {...dArr}, enrolledPhoto: img, updatedAt: serverTimestamp() });
                    // Sync to public student doc
                    const studRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', window.appState.userId);
                    const snap = await getDoc(studRef);
                    if(snap.exists()) await updateDoc(studRef, { enrolledPhoto: img });
                    
                    window.appState.faceDescriptor = desc; window.appState.enrolledPhoto = img;
                    showToast("Enrolled!", "success"); renderView();
                } catch(e) { showToast("Save Failed", "error"); }
            });
        };

        // Attendance Flow (UPDATED)
        window.startAttendanceFlow = async (sessionId, lat, lng, subjectName) => {
            // 0. Pre-checks
            if(!window.appState.faceDescriptor) return showToast("Enroll Face First", "error");
            showToast("Verifying...", "info");
            
            // 1. DUPLICATE CHECK (First, save resources)
            try {
                const qDup = query(getAttPath(), where("sessionId", "==", sessionId), where("studentId", "==", window.appState.userId));
                const dupSnap = await getDocs(qDup);
                if (!dupSnap.empty) return showToast("Attendance already marked.", "error");
            } catch(e) { console.error("Dup check error", e); }

            // 2. OTP CHECK (CRITICAL: Must happen BEFORE GPS to prevent bypass)
            let otp = window.appState.verifiedOTP;
            
            // If we haven't verified OTP for *this* session yet, ask for it now
            if (window.appState.verifiedSessionId !== sessionId) {
                otp = await openOtpModal(); 
                if (!otp) return; // User cancelled OTP
                
                // Verify against DB
                const sessRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId);
                const sessSnap = await getDoc(sessRef);
                
                if (!sessSnap.exists() || !sessSnap.data().active) { 
                    showToast("Session Closed", "error"); 
                    return; 
                }
                
                if (sessSnap.data().otp !== otp) {
                    return showToast("Invalid OTP", "error");
                }
                
                // Success: Cache it so we don't ask again if GPS fails/retries
                window.appState.verifiedSessionId = sessionId;
                window.appState.verifiedOTP = otp;
            }
            
            // 3. GPS CHECK (Now safe to run, as OTP is confirmed)
            try {
                showToast("Checking GPS...", "info");
                const pos = await getCurrentLocation();
                const dist = getDistanceFromLatLonInM(pos.lat, pos.lng, lat, lng);
                
                // --- CASE A: GPS TOO FAR ---
                if (dist > ATTENDANCE_RADIUS_METERS) {
                    if (confirm(`You are too far (${Math.round(dist)}m). Request manual attendance with photo evidence?`)) {
                        
                        // Open Camera to capture proof AND verify face
                        openCamera('manual', async (desc, score, img) => {
                            try {
                                // Verify Face Matches (Even if GPS failed)
                                const faceDist = faceapi.euclideanDistance(desc, window.appState.faceDescriptor);
                                const isFaceVerified = faceDist < FACE_MATCH_THRESHOLD;

                                const attData = { 
                                    sessionId, 
                                    studentId: window.appState.userId, 
                                    studentName: window.appState.studentProfile.name, 
                                    studentRoll: window.appState.studentProfile.rollNo, 
                                    timestamp: serverTimestamp(), 
                                    status: 'pending',        // PENDING (Needs Faculty Approval)
                                    verified: isFaceVerified, // TRUE if face matches (Helpful for faculty)
                                    capturedPhoto: img,
                                    gpsDistance: Math.round(dist) // Log the distance
                                }; 
                                
                                await addDoc(getAttPath(), attData);
                                showToast("Request Sent (Pending Approval)", "info"); 
                                switchTab('student');
                            } catch(e) { 
                                showToast("Request Failed", "error"); 
                            }
                        });
                        return; // Stop here, don't run standard flow
                    } else {
                        return showToast(`Too far (${Math.round(dist)}m)`, "error");
                    }
                }
            } catch (e) { 
                // Handle GPS Errors (Timeout/Permission)
                if(confirm("GPS Signal Failed. Request manual attendance?")) {
                     // ... Reuse manual flow logic here if desired ...
                }
                return showToast("GPS Error", "error"); 
            }

            // 4. STANDARD FLOW (GPS & OTP Passed)
            const runVerification = () => {
                openCamera('verify', async (desc, score, img) => {
                    const dist = faceapi.euclideanDistance(desc, window.appState.faceDescriptor);
                    
                    if (dist < FACE_MATCH_THRESHOLD) {
                        // SUCCESS: Face + GPS + OTP all good
                        try {
                            const attData = { sessionId, studentId: window.appState.userId, studentName: window.appState.studentProfile.name, studentRoll: window.appState.studentProfile.rollNo, timestamp: serverTimestamp(), status: 'present', verified: true, capturedPhoto: img };
                            await addDoc(getAttPath(), attData);
                            showSuccessModal(img, window.appState.studentProfile.name, subjectName || 'this class', new Date().toLocaleString());
                        } catch(e) { showToast("Save Failed", "error"); }
                    } else {
                        // FAIL: Face Mismatch
                        if (confirm("Face verification failed. Request manual attendance?")) {
                             try {
                                const attData = { sessionId, studentId: window.appState.userId, studentName: window.appState.studentProfile.name, studentRoll: window.appState.studentProfile.rollNo, timestamp: serverTimestamp(), status: 'pending', verified: false, capturedPhoto: img }; 
                                await addDoc(getAttPath(), attData);
                                showToast("Request Sent", "info"); 
                                switchTab('student');
                            } catch(e) { showToast("Request Failed", "error"); }
                        }
                    }
                });
            };

            runVerification(); 
        };

        // NEW: Success Modal Helper Functions
        window.showSuccessModal = (img, name, className, time) => {
            document.getElementById('success-img').src = img;
            document.getElementById('success-name').innerText = `Thank you ${name}!`;
            document.getElementById('success-class').innerText = `for this class ${className}`;
            document.getElementById('success-time').innerText = `with ${time}`;
            document.getElementById('success-modal').classList.remove('hidden');
        }

        window.closeSuccessModal = () => {
            document.getElementById('success-modal').classList.add('hidden');
            switchTab('student');
        }

        // Faculty Helpers (Global)
        window.decision = async (uid, status) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', uid), { status }); renderStudentList(document.getElementById('fac-content')); };
        window.bulkApprove = async () => { if(confirm("Approve All?")) { const q = query(getStudentsPath(), where("status","==","pending")); const s = await getDocs(q); const b = writeBatch(db); s.forEach(d => b.update(d.ref, {status:'approved'})); await b.commit(); renderStudentList(document.getElementById('fac-content')); }};
        window.revokeStudent = async (uid, roll) => { if(confirm(`Revoke ${roll}?`)) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', uid)); renderStudentList(document.getElementById('fac-content')); }};
        
        // --- ADDED: Session Detail View & Audit ---
        window.viewSessionDetails = async (id) => {
            const modal = document.getElementById('session-details-modal');
            modal.classList.remove('hidden');
            
            // Set Loading state
            document.getElementById('sd-subject').innerText = "Loading...";
            document.getElementById('sd-attendee-list').innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>';
            
            try {
                // 1. Fetch Session
                const sSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id));
                if (!sSnap.exists()) { showToast("Session not found", "error"); closeSessionModal(); return; }
                const s = sSnap.data();
                
                document.getElementById('sd-subject').innerText = s.subject;
                document.getElementById('sd-meta').innerText = `${s.date} | ${s.timeSlot} | Sec ${s.section}`;
                
                // 2. Fetch Attendees (UPDATED to include ID)
                const aSnap = await getDocs(query(getAttPath(), where("sessionId", "==", id)));
                window.currentSessionAttendees = [];
                aSnap.forEach(d => window.currentSessionAttendees.push({id: d.id, ...d.data()}));
                
                // 3. Fetch Master List (for absentees)
                let qMaster = query(getMasterPath());
                if(s.section) qMaster = query(getMasterPath(), where("section", "==", s.section));
                
                const mSnap = await getDocs(qMaster);
                const allStudents = [];
                mSnap.forEach(d => allStudents.push(d.data()));
                
                // Calculate Stats
                const attendees = window.currentSessionAttendees;
                // FILTER: ONLY COUNT PRESENT
                const presentList = attendees.filter(a => a.status === 'present');
                const pendingList = attendees.filter(a => a.status === 'pending'); // NEW
                const presentRolls = new Set(presentList.map(a => a.studentRoll));
                
                const presentCount = presentList.length;
                const pendingCount = pendingList.length; // NEW
                const totalCount = allStudents.length > 0 ? allStudents.length : attendees.length; 
                // Updated Absent Count: Total - (Present + Pending)
                const absentCount = Math.max(0, totalCount - presentCount - pendingCount);
                
                document.getElementById('sd-present-count').innerText = presentCount;
                document.getElementById('sd-pending-count').innerText = pendingCount; // NEW
                document.getElementById('sd-absent-count').innerText = absentCount;
                document.getElementById('sd-total-count').innerText = totalCount;
                
                // Populate Lists
                const attList = document.getElementById('sd-attendee-list');
                attList.innerHTML = '';
                if(attendees.length === 0) attList.innerHTML = '<p class="text-xs text-slate-400 italic">No attendees yet.</p>';
                
                attendees.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                attendees.forEach((a, index) => {
                   const time = a.timestamp ? new Date(a.timestamp.seconds*1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                   // NEW: Indicator for Pending
                   const isPending = a.status === 'pending';
                   const statusColor = isPending ? 'text-orange-500' : 'text-green-600';
                   const statusIcon = isPending ? '<i class="fa-solid fa-clock text-xs"></i>' : '<i class="fa-solid fa-camera"></i>';
                   const bgClass = isPending ? 'bg-orange-50 border-orange-200' : 'bg-green-100 text-green-600';

                   attList.innerHTML += `
                    <div onclick="reviewAttendance(${index})" class="flex justify-between items-center py-1.5 border-b border-slate-50 last:border-0 cursor-pointer hover:bg-slate-50 transition-colors rounded px-1 active:scale-95">
                        <div class="flex items-center gap-2">
                             <div class="w-6 h-6 rounded-full ${bgClass} flex items-center justify-center text-[8px] font-bold">${statusIcon}</div>
                             <div><p class="text-[10px] font-bold text-slate-700">${a.studentRoll}</p><p class="text-[9px] text-slate-400 uppercase">${a.studentName.split(' ')[0]}</p></div>
                        </div>
                        <span class="text-[9px] font-mono text-slate-400 bg-slate-50 px-1 rounded">${time}</span>
                    </div>
                   `; 
                });
                
                const absList = document.getElementById('sd-absentee-list');
                absList.innerHTML = '';
                // Absentee logic: not present AND not pending
                // We assume `attendees` contains all attempts including pending.
                // So if a student roll exists in `attendees` (either present or pending), they are not absent.
                const markedRolls = new Set(attendees.map(a => a.studentRoll));
                const absentees = allStudents.filter(s => !markedRolls.has(s.rollNo));
                
                if(absentees.length === 0 && totalCount > 0) absList.innerHTML = '<p class="text-xs text-green-500 font-bold">100% Attendance!</p>';
                else if (totalCount === 0) absList.innerHTML = '<p class="text-xs text-slate-400 italic">Master list empty.</p>';
                
                absentees.forEach(ab => {
                    absList.innerHTML += `<span class="px-2 py-1 rounded bg-red-50 text-red-500 text-[10px] font-bold border border-red-100">${ab.rollNo}</span>`;
                });

            } catch(e) { console.error(e); showToast("Error loading details", "error"); }
        };
        
        window.closeSessionModal = () => document.getElementById('session-details-modal').classList.add('hidden');
        window.closeReviewModal = () => document.getElementById('review-modal').classList.add('hidden');

        // --- NEW: Review Logic ---
        window.reviewAttendance = async (index) => {
            const record = window.currentSessionAttendees[index];
            if(!record) return;
            
            document.getElementById('review-modal').classList.remove('hidden');
            document.getElementById('review-enrolled-loader').classList.remove('hidden');
            
            // Set text details
            document.getElementById('review-name').innerText = record.studentName;
            document.getElementById('review-roll').innerText = record.studentRoll;
            document.getElementById('review-time').innerText = record.timestamp ? new Date(record.timestamp.seconds*1000).toLocaleString() : 'N/A';
            
            // Set Captured Image
            document.getElementById('review-live-img').src = record.capturedPhoto || '';
            
            // Buttons logic
            const approveBtn = document.getElementById('approve-btn');
            const badge = document.getElementById('review-badge');

            if(record.status === 'pending' || record.verified === false) {
                 badge.className = "bg-orange-50 text-orange-700 px-3 py-2 rounded-lg text-xs font-bold w-full text-center border border-orange-200";
                 badge.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> Manual Request';
                 approveBtn.classList.remove('hidden');
                 approveBtn.classList.add('flex');
                 approveBtn.onclick = () => approveAttendance(record.id, record.sessionId);
            } else {
                 badge.className = "bg-green-50 text-green-700 px-3 py-2 rounded-lg text-xs font-bold w-full text-center border border-green-200";
                 badge.innerHTML = '<i class="fa-solid fa-check-circle mr-1"></i> Biometric Verified';
                 approveBtn.classList.add('hidden');
                 approveBtn.classList.remove('flex');
            }

            // Set Reject Button Action
            const rejectBtn = document.getElementById('reject-btn');
            rejectBtn.onclick = () => rejectAttendance(record.id, record.sessionId);

            // Fetch Enrolled Image
            try {
                // First try Public Student Profile
                const sSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', record.studentId));
                if(sSnap.exists() && sSnap.data().enrolledPhoto) {
                    document.getElementById('review-enrolled-img').src = sSnap.data().enrolledPhoto;
                } else {
                    document.getElementById('review-enrolled-img').src = ''; // Or placeholder
                }
            } catch(e) { console.error(e); }
            finally {
                document.getElementById('review-enrolled-loader').classList.add('hidden');
            }
        };

        // --- NEW: Approve Logic ---
        window.approveAttendance = async (attId, sessionId) => {
            if(confirm("Approve this manual attendance?")) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', attId), {
                        status: 'present',
                        verified: true // Mark as verified now
                    });
                    showToast("Attendance Approved", "success");
                    closeReviewModal();
                    // Refresh view based on context (Session Details or Live Monitor)
                    // If Session Details modal is open, refresh it
                    if(!document.getElementById('session-details-modal').classList.contains('hidden')) {
                        viewSessionDetails(sessionId);
                    }
                } catch(e) {
                    console.error(e);
                    showToast("Approval Failed", "error");
                }
            }
        };

        // --- NEW: Reject Logic ---
        window.rejectAttendance = async (attId, sessionId) => {
            if(confirm("Are you sure you want to reject this attendance? This cannot be undone.")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', attId));
                    showToast("Attendance Rejected", "success");
                    closeReviewModal();
                    if(!document.getElementById('session-details-modal').classList.contains('hidden')) {
                        viewSessionDetails(sessionId); 
                    }
                } catch(e) {
                    console.error(e);
                    showToast("Failed to reject", "error");
                }
            }
        };

        window.handleCSVUpload = async () => {
            const f = document.getElementById('csv-upload').files[0]; if(!f) return showToast("Select CSV", "error");
            const r = new FileReader(); r.onload = async (e) => {
                const t = e.target.result; const l = t.split('\n'); const b = writeBatch(db); let c=0;
                for(let ln of l) { const [no, nm, sc] = ln.split(',').map(s=>s?.trim()); if(no&&nm) { b.set(doc(db, 'artifacts', appId, 'public', 'data', 'master_students', no), { rollNo: no, name: nm, section: sc||'A' }); c++; }}
                if(c>0) { await b.commit(); showToast(`Imported ${c}`, "success"); }
            }; r.readAsText(f);
        };

        initFirebase();
    </script>
</body>
</html>
