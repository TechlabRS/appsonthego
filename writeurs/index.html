<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIGHT Intellectual Mind Tracker</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Used for visual components) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style for the AI report to correctly render list items */
        #analysis-result ul {
            list-style-type: disc;
            margin-left: 1.25rem;
            padding-left: 0.25rem;
        }
        #analysis-result li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app-container" class="p-4 sm:p-6 flex flex-col items-center">
        <div id="loading-screen" class="flex items-center justify-center min-h-[50vh]">
            <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="ml-3 text-gray-600">Initializing local app...</p>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION REQUIRED FOR GITHUB HOSTING (REPLACE PLACEHOLDERS) ---
        // 1. Your own Gemini API Key
        const GEMINI_API_KEY = ""; // Set your key here for analysis to work
        const apiKey = GEMINI_API_KEY; 
        
        // --- Application Constants ---
        const LOCAL_STORAGE_KEY = 'intellectual_mind_tracker_data';
        const PREDEFINED_TAGS = [
            'Philosophy', 'Technology', 'Work', 'PersonalGrowth', 'Emotion',
            'CreativeIdea', 'Science', 'Finance', 'Health'
        ];

        // --- Application State ---
        let thoughts = [];
        let selectedTags = [];
        let isLoading = false;
        let analysisResult = null;
        let analysisError = null;
        let saveError = null;
        let filterTag = null;
        let searchTerm = ''; // NEW: State for text search term
        
        // --- Utility Functions ---

        /** Loads state from localStorage */
        const loadThoughts = () => {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    thoughts = JSON.parse(data).map(t => ({
                        ...t,
                        // Convert stored string date back to Date object for sorting
                        timestamp: new Date(t.timestamp) 
                    }));
                    // Sort by timestamp descending
                    thoughts.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
                } else {
                    thoughts = [];
                }
            } catch (e) {
                console.error("Error loading from local storage:", e);
                saveError = "Could not load saved data from browser storage.";
                thoughts = [];
            }
        };

        /** Saves state to localStorage */
        const saveThoughts = () => {
            try {
                // Prepare data for storage (convert Date objects to string for JSON serialization)
                const serializableThoughts = thoughts.map(t => ({
                    ...t,
                    timestamp: t.timestamp.toISOString() 
                }));
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(serializableThoughts));
                saveError = null;
            } catch (e) {
                console.error("Error saving to local storage:", e);
                saveError = "Could not save data to browser storage. Storage may be full.";
            }
        };

        /** Implements exponential backoff for fetching data. */
        const retryFetch = async (fetcher, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetcher();
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error("API call failed after multiple retries.");
                    }
                }
            }
        };

        const formatDate = (date) => {
            return date.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // --- DOM Rendering Functions ---

        const renderApp = () => {
            const container = document.getElementById('app-container');
            if (!container) return;
            
            // Set isAuthReady to true as we don't need authentication for local storage
            const isReady = true; 

            if (!isReady) {
                container.innerHTML = document.getElementById('loading-screen').outerHTML;
                return;
            }

            // Main app HTML structure
            container.innerHTML = `
                <header class="w-full max-w-2xl text-center mb-6">
                    <h1 class="text-3xl font-extrabold text-indigo-700 flex items-center justify-center">
                        <i data-lucide="brain" class="w-8 h-8 mr-2"></i>RIGHT Intellectual Mind Tracker
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">
                        Log detailed thoughts and categorize them. Data is saved locally in your browser.
                    </p>
                </header>

                <main class="w-full max-w-2xl space-y-8">
                    <section id="input-section" class="bg-white p-5 rounded-xl shadow-lg border border-gray-200"></section>
                    <section id="analysis-section" class="bg-indigo-50 p-5 rounded-xl shadow-inner border border-indigo-200"></section>
                    <section id="data-management-section" class="bg-gray-100 p-5 rounded-xl shadow border border-gray-300"></section>
                    <section id="list-section" class="pt-4"></section>
                </main>
            `;
            
            // Render specific sections
            renderInputSection();
            renderAnalysisSection();
            renderDataManagementSection();
            renderListSection();

            // Replace Lucide icons
            lucide.createIcons();
        };

        const renderInputSection = () => {
            const section = document.getElementById('input-section');
            if (!section) return;

            const thoughtInput = document.getElementById('thought-input');
            const thoughtText = thoughtInput ? thoughtInput.value : '';
            
            const isSubmitDisabled = isLoading || !thoughtText.trim();
            const tagButtons = PREDEFINED_TAGS.map(tag => `
                <button
                    type="button"
                    data-tag="${tag}"
                    class="tag-button text-xs font-medium px-3 py-1 rounded-full transition duration-150 border 
                        ${selectedTags.includes(tag) 
                            ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' 
                            : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-indigo-100 hover:text-indigo-700'
                        }
                        ${selectedTags.length >= 3 && !selectedTags.includes(tag) ? 'opacity-50 cursor-not-allowed' : ''}
                    "
                    ${selectedTags.length >= 3 && !selectedTags.includes(tag) ? 'disabled' : ''}
                >
                    <i data-lucide="tag" class="w-3 h-3 inline mr-1"></i> ${tag}
                </button>
            `).join('');

            section.innerHTML = `
                <form id="add-thought-form" class="space-y-4">
                    <label for="thought-input" class="block text-lg font-semibold text-gray-700">
                        What's on your mind? (Tag up to 3)
                    </label>
                    <textarea
                        id="thought-input"
                        rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 resize-y"
                        placeholder="Detail your concept, argument, or breakthrough idea..."
                        ${isLoading ? 'disabled' : ''}
                    >${thoughtText}</textarea>

                    <div class="flex flex-wrap gap-2 pt-2" id="tag-selection">
                        ${tagButtons}
                    </div>

                    ${saveError ? `<div class="text-red-600 text-sm p-2 bg-red-50 rounded-lg">Error: ${saveError}</div>` : ''}

                    <button
                        type="submit"
                        class="w-full flex items-center justify-center px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400"
                        ${isSubmitDisabled ? 'disabled' : ''}
                    >
                        ${isLoading ? `<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i>` : `<i data-lucide="plus" class="w-5 h-5 mr-2"></i>`}
                        Record Thought
                    </button>
                </form>
            `;

            // Re-attach event listeners
            document.getElementById('thought-input').addEventListener('input', (e) => {
                const submitButton = section.querySelector('button[type="submit"]');
                const isInputEmpty = !e.target.value.trim();
                if (isInputEmpty || isLoading) {
                    submitButton.setAttribute('disabled', 'disabled');
                } else {
                    submitButton.removeAttribute('disabled');
                }
            });
            document.getElementById('thought-input').value = thoughtText; // Restore value after innerHTML update

            document.getElementById('add-thought-form').addEventListener('submit', addThought);
            section.querySelectorAll('.tag-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent form submission
                    toggleTag(button.dataset.tag);
                });
            });
            
            lucide.createIcons();
        };

        const renderAnalysisSection = () => {
            const section = document.getElementById('analysis-section');
            if (!section) return;

            const isAnalysisDisabled = isLoading || thoughts.length < 5;
            const apiKeyMissing = !apiKey;

            section.innerHTML = `
                <h2 class="text-xl font-bold text-indigo-700 flex items-center mb-3">
                    <i data-lucide="trending-up" class="w-6 h-6 mr-2 text-indigo-500"></i> Intellectual Trend Analysis
                </h2>
                ${apiKeyMissing ? `
                    <p class="text-sm text-red-600 font-semibold mb-4 bg-red-100 p-2 rounded-lg">
                        <i data-lucide="zap" class="w-4 h-4 inline mr-1"></i> API Key Missing! Please set the GEMINI_API_KEY variable in the script to enable AI analysis.
                    </p>
                ` : `
                    <p class="text-sm text-gray-600 mb-4">
                        Analyze your most recent 20 thoughts and tags to identify deep intellectual patterns and thematic growth using Gemini.
                    </p>
                `}
                <button
                    id="analyze-button"
                    class="w-full flex items-center justify-center px-4 py-3 bg-fuchsia-600 text-white font-semibold rounded-lg shadow-lg hover:bg-fuchsia-700 transition duration-150 disabled:bg-fuchsia-400"
                    ${isAnalysisDisabled || apiKeyMissing ? 'disabled' : ''}
                >
                    ${isLoading ? `<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i>` : `<i data-lucide="bot" class="w-5 h-5 mr-2"></i>`}
                    ${isLoading ? 'Generating Report...' : 'Generate Trend Report'}
                </button>

                <div id="analysis-messages">
                    ${analysisError ? `<div class="mt-4 text-red-600 text-sm p-3 bg-red-100 rounded-lg border border-red-300">Error: ${analysisError}</div>` : ''}
                </div>

                ${analysisResult && typeof analysisResult === 'string' ? `
                    <div id="analysis-result" class="mt-5 p-4 bg-white rounded-lg shadow-md border border-gray-300 whitespace-pre-wrap">
                        <h3 class="font-bold text-indigo-700 mb-2 border-b pb-1">AI Analyst Report:</h3>
                        <div class='text-gray-800'>${analysisResult.replace(/\n\*/g, '<ul><li>').replace(/\*\*/g, '<strong>').replace(/<ul><li>/g, '</li></ul><ul><li>').replace(/<ul><li>/g, '<ul><li>')}</div>
                    </div>
                ` : ''}
                
                ${analysisResult && analysisResult.successMessage ? `
                    <div id="analysis-result" class="mt-5 p-4 bg-green-100 rounded-lg shadow-md border border-green-300">
                        <h3 class="font-bold text-green-700 mb-2 border-b pb-1">Success:</h3>
                        <p class='text-green-800'>${analysisResult.successMessage}</p>
                    </div>
                ` : ''}
            `;

            if (!isAnalysisDisabled && !apiKeyMissing) {
                document.getElementById('analyze-button').addEventListener('click', analyzeThoughts);
            }
            lucide.createIcons();
        };
        
        const renderDataManagementSection = () => {
            const section = document.getElementById('data-management-section');
            if (!section) return;

            section.innerHTML = `
                <h2 class="text-xl font-bold text-gray-700 flex items-center mb-3">
                    <i data-lucide="database" class="w-6 h-6 mr-2 text-gray-500"></i> Data Management
                </h2>
                <p class="text-sm text-gray-600 mb-4">
                    Export your thoughts as a JSON file, or import and merge new data with your existing local entries.
                </p>
                <div class="flex space-x-3">
                    <button
                        id="export-button"
                        class="flex-1 flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition duration-150 disabled:bg-blue-400"
                        ${isLoading ? 'disabled' : ''}
                    >
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export (${thoughts.length} thoughts)
                    </button>
                    <button
                        id="import-button"
                        class="flex-1 flex items-center justify-center px-4 py-2 bg-emerald-600 text-white font-medium rounded-lg shadow-md hover:bg-emerald-700 transition duration-150 disabled:bg-emerald-400"
                        ${isLoading ? 'disabled' : ''}
                    >
                        <i data-lucide="upload" class="w-5 h-5 mr-2"></i> Import & Merge
                    </button>
                    <input type="file" id="file-input-import" accept=".json" style="display:none;" />
                </div>
            `;
            
            // Attach listeners
            document.getElementById('export-button').addEventListener('click', exportThoughts);
            document.getElementById('import-button').addEventListener('click', triggerImport);
            document.getElementById('file-input-import').addEventListener('change', handleImport);

            lucide.createIcons();
        };


        const renderListSection = () => {
            const section = document.getElementById('list-section');
            if (!section) return;

            // 1. Filter by Tag (if filterTag is set)
            let filtered = filterTag
                ? thoughts.filter(t => t.tags && t.tags.includes(filterTag))
                : thoughts;
            
            // 2. Filter by Search Term (if searchTerm is set)
            const normalizedSearchTerm = searchTerm.toLowerCase().trim();
            if (normalizedSearchTerm) {
                filtered = filtered.filter(t => 
                    t.description.toLowerCase().includes(normalizedSearchTerm) || 
                    t.tags.some(tag => tag.toLowerCase().includes(normalizedSearchTerm))
                );
            }


            const thoughtItems = filtered.length === 0 ? `
                <div class="p-5 text-center text-gray-500 bg-white rounded-xl shadow-inner">
                    ${(filterTag || searchTerm) ? 
                        `No thoughts match your current filter/search criteria.` : 
                        'No thoughts recorded yet. Start logging your mind!'}
                </div>
            ` : filtered.map((thought, index) => {
                // Generate a unique ID for the thought
                const thoughtId = thought.id || `local-${index}`; 

                const tagButtons = thought.tags.map(tag => `
                    <button
                        data-tag-filter="${tag}"
                        class="filter-tag-button text-[10px] font-semibold px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition duration-150"
                    >
                        #${tag}
                    </button>
                `).join('');

                return `
                    <div class="p-4 bg-white rounded-xl shadow border border-gray-100 transition duration-150 hover:shadow-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-xs font-mono text-indigo-500">${formatDate(thought.timestamp)}</div>
                            <div class="flex flex-wrap gap-1">${tagButtons}</div>
                        </div>
                        <p class="text-gray-800 leading-relaxed">${thought.description}</p>
                    </div>
                `;
            }).join('');

            // NEW: Search Input Markup
            const searchInputMarkup = `
                <div class="relative mb-4">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search by keyword or tag..."
                        value="${searchTerm}"
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                        aria-label="Search thoughts"
                    />
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                    ${searchTerm ? `
                        <button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                             <i data-lucide="x-circle" class="w-5 h-5"></i>
                        </button>
                    ` : ''}
                </div>
            `;

            section.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-gray-700 flex items-center">
                        <i data-lucide="clock" class="w-6 h-6 mr-2 text-gray-500"></i> Thoughts (${filtered.length}/${thoughts.length})
                    </h2>
                    <div class="flex items-center space-x-2">
                        ${filterTag ? `
                            <span class="text-sm text-gray-600">Filtering by:</span>
                            <button
                                id="clear-filter"
                                class="flex items-center text-xs font-medium px-2 py-1 bg-fuchsia-100 text-fuchsia-700 rounded-full hover:bg-fuchsia-200 transition duration-150"
                            >
                                #${filterTag} <i data-lucide="x" class="w-3 h-3 ml-1"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
                ${searchInputMarkup}
                <div class="space-y-3">
                    ${thoughtItems}
                </div>
            `;
            
            // Re-attach filter listeners
            section.querySelectorAll('.filter-tag-button').forEach(button => {
                button.addEventListener('click', () => setFilter(button.dataset.tagFilter));
            });

            if (filterTag) {
                document.getElementById('clear-filter')?.addEventListener('click', () => setFilter(null));
            }
            
            // NEW: Search Listener
            document.getElementById('search-input').addEventListener('input', (e) => setSearchTerm(e.target.value));
            if (searchTerm) {
                document.getElementById('clear-search')?.addEventListener('click', () => setSearchTerm(''));
            }

            lucide.createIcons();
        };

        // NEW: Function to handle search input
        const setSearchTerm = (newTerm) => {
            searchTerm = newTerm;
            renderListSection();
        };


        // --- State/Event Handlers (I/O) ---

        const exportThoughts = () => {
            if (thoughts.length === 0) {
                analysisError = "No thoughts to export. Record some thoughts first!";
                renderAnalysisSection();
                return;
            }

            // Prepare data for export
            const serializableThoughts = thoughts.map(t => ({
                id: t.id, // Include existing ID
                description: t.description,
                tags: t.tags,
                timestamp: t.timestamp.toISOString() 
            }));
            
            const json = JSON.stringify(serializableThoughts, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // Trigger download
            const a = document.createElement('a');
            a.href = url;
            a.download = `mind_tracker_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            analysisError = null;
            analysisResult = { successMessage: "Successfully exported all thoughts to a JSON file." };
            renderAnalysisSection();
            setTimeout(() => { analysisResult = null; renderAnalysisSection(); }, 5000);
        };
        
        const triggerImport = () => {
            document.getElementById('file-input-import').click();
        };
        
        const handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            isLoading = true;
            renderApp();

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error("Invalid file format. Expected a JSON array.");
                    }

                    const importedThoughts = importedData.map(t => {
                        // Validate essential fields and assign a new UUID to ensure merging works 
                        // and prevents accidental overwrite if original IDs conflict.
                        const description = t.description || 'Imported thought (description missing)';
                        const tags = Array.isArray(t.tags) ? t.tags.filter(tag => typeof tag === 'string') : [];
                        const timestamp = new Date(t.timestamp || Date.now());

                        return {
                            description,
                            tags,
                            timestamp,
                            // Assign a unique ID to ensure merging works correctly
                            id: crypto.randomUUID(), 
                        };
                    });
                    
                    // MERGE: Append imported thoughts to existing thoughts
                    thoughts = [...thoughts, ...importedThoughts];
                    thoughts.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
                    saveThoughts();

                    analysisError = null; 
                    analysisResult = { successMessage: `Successfully imported and merged ${importedThoughts.length} new thoughts.` }; 

                } catch (error) {
                    console.error("Import error:", error);
                    analysisError = `Import failed: ${error.message}. Please ensure the file is a valid JSON export.`;
                } finally {
                    isLoading = false;
                    // Clear the file input so the user can import the same file again if needed
                    e.target.value = null; 
                    renderApp();
                    // Clear success message after a few seconds
                    setTimeout(() => { analysisResult = null; renderAnalysisSection(); }, 5000); 
                }
            };
            reader.onerror = function() {
                analysisError = "Error reading file.";
                isLoading = false;
                e.target.value = null;
                renderApp();
            };

            reader.readAsText(file);
        };


        // --- State/Event Handlers (Local Logic) ---

        const toggleTag = (tag) => {
            saveError = null;
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
            } else if (selectedTags.length < 3) {
                selectedTags = [...selectedTags, tag];
            }
            renderInputSection(); // Quick re-render of tag buttons
        };

        const setFilter = (tag) => {
            filterTag = tag;
            renderListSection();
        };

        const addThought = (e) => {
            e.preventDefault();
            const thoughtInput = document.getElementById('thought-input');
            const newThoughtText = thoughtInput.value.trim();

            if (!newThoughtText) return;

            isLoading = true;
            saveError = null;
            renderApp(); 

            // Create new thought object
            const newThought = {
                description: newThoughtText,
                tags: selectedTags,
                timestamp: new Date(), // Local timestamp
                id: crypto.randomUUID() // Use UUID for robustness
            };

            // Add to the front of the array and save
            thoughts.unshift(newThought);
            saveThoughts();
            
            // Clear input and state
            thoughtInput.value = ''; 
            selectedTags = [];
            isLoading = false;
            
            renderApp();
        };

        const analyzeThoughts = async () => {
            if (thoughts.length < 5) {
                analysisResult = "Record at least 5 thoughts to generate a meaningful intellectual trend analysis.";
                analysisError = null;
                renderAnalysisSection();
                return;
            }
            
            if (!apiKey) {
                 analysisError = "GEMINI_API_KEY is not configured. Please set it in the script to run analysis.";
                 analysisResult = null;
                 renderAnalysisSection();
                 return;
            }

            isLoading = true;
            analysisError = null;
            analysisResult = null;
            renderAnalysisSection();

            // Format the last 20 thoughts for a deeper analysis
            const recentThoughts = thoughts.slice(0, 20);
            const thoughtText = recentThoughts.map((t, index) =>
                `${index + 1}. [${formatDate(t.timestamp)}] ${t.description} (Tags: ${t.tags.join(', ')})`
            ).join('\n');

            const systemPrompt = "You are a professional intellectual trend analyst and cognitive profiler. Review the provided journal entries, timestamps, and categories (tags). Identify 3 key intellectual trends, recurring complex topics, and potential cross-topic connections. Present the findings as a cohesive report, using clear markdown list format.";
            const userQuery = `Generate an Intellectual Trend Report based on the following journal entries. Focus on intellectual patterns and thematic coherence across entries:\n\n${thoughtText}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }],
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const fetcher = () => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const response = await retryFetch(fetcher);
                const result = await response.json();

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    analysisResult = text;
                } else {
                    throw new Error("Received empty or malformed response.");
                }

            } catch (error) {
                console.error("Gemini API error:", error);
                analysisError = "Failed to generate intellectual analysis. Please check your API key and connection.";
            } finally {
                isLoading = false;
                renderAnalysisSection();
            }
        };


        // --- Initialization ---

        const initialize = () => {
            loadThoughts();
            renderApp();
        };

        window.onload = initialize;
    </script>
</body>
</html>


