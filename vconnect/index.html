<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V Connect AI Pulse - Pro Broadcast v2.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Poster Themes */
        .bg-gradient-urgent { background: linear-gradient(135deg, #ef4444 0%, #7f1d1d 100%); }
        .bg-gradient-info { background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%); }
        .bg-gradient-success { background: linear-gradient(135deg, #10b981 0%, #064e3b 100%); }
        .bg-gradient-festive { background: linear-gradient(135deg, #a855f7 0%, #db2777 100%); }
        .bg-gradient-warning { background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%); }
        .bg-gradient-alumni { background: linear-gradient(135deg, #475569 0%, #0f172a 100%); }
        .bg-gradient-sos { background: radial-gradient(circle, #ff0000 0%, #990000 100%); animation: pulse-red 2s infinite; }
        .bg-gradient-calendar { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); }

        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,0,0,0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(255,0,0,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,0,0,0); }
        }

        .poster-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 420px;
            margin: 0 auto;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.05);
            z-index: 100;
        }

        .capsule-item {
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 99px;
            border: 2px solid #f1f5f9;
            background: white;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #64748b;
        }
        .capsule-item.active {
            border-color: #4f46e5;
            background: #eef2ff;
            color: #4f46e5;
        }

        .animate-in { animation: slide-up 0.4s ease-out forwards; }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        #camera-preview { transform: scaleX(-1); }
        
        #ai-loader {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .nav-btn.active { color: #4f46e5; transform: scale(1.1); }
        .nav-btn { color: #94a3b8; transition: all 0.3s; }
    </style>
</head>
<body class="flex flex-col items-center justify-center">

    <div id="ai-loader">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 rounded-full border-4 border-indigo-100"></div>
            <div class="absolute inset-0 rounded-full border-4 border-indigo-600 border-t-transparent animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center text-indigo-600"><i data-lucide="brain-circuit" size="32"></i></div>
        </div>
        <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter">AI Node Processing</h2>
        <p class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mt-2" id="ai-loader-text">Analyzing Signal Patterns...</p>
    </div>

    <div class="w-full max-w-6xl h-full bg-white shadow-2xl flex flex-col relative overflow-hidden md:h-[95vh] md:rounded-[3rem] md:my-4 border border-slate-100">
        
        <div id="sos-bar" class="hidden bg-red-600 text-white p-2 text-center font-black animate-pulse uppercase tracking-[0.3em] text-[9px] z-[60]">
            ⚠️ Security Node Active - Emergency Protocol Enabled ⚠️
        </div>

        <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 z-[200] w-[90%] max-w-sm bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex items-center space-x-3 opacity-0 pointer-events-none transition-all duration-500 transform translate-y-[-20px]">
            <div class="p-2 bg-indigo-500 rounded-xl" id="toast-icon"></div>
            <p class="text-xs font-bold" id="toast-msg"></p>
        </div>

        <header class="pt-6 pb-4 px-8 flex justify-between items-center bg-white/70 backdrop-blur-md z-40 shrink-0 border-b border-slate-50">
            <div class="flex items-center space-x-2 text-indigo-600">
                <i data-lucide="zap" size="24" class="fill-current"></i>
                <h1 class="text-xl font-purple text-slate-800 tracking-tighter uppercase">V Connect <span class="text-indigo-600">AI Pulse</span></h1>
            </div>
            <div id="header-user" class="flex items-center space-x-3"></div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50/30 p-4 pb-32"></main>

        <nav id="bottom-nav" class="glass px-6">
            <button onclick="switchTab('feed')" id="nav-feed" class="nav-btn w-20 flex flex-col items-center space-y-1">
                <i data-lucide="layout-grid" size="26"></i>
                <span class="text-[8px] font-black uppercase tracking-widest">Feed</span>
            </button>
            
            <div id="nav-center-container" class="flex-1 flex items-center justify-center">
                <!-- Dynamic Post/SOS Button injected here -->
            </div>
            
            <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn w-20 flex flex-col items-center space-y-1">
                <i data-lucide="layout-dashboard" size="26"></i>
                <span class="text-[8px] font-black uppercase tracking-widest">Dashboard</span>
            </button>
        </nav>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 z-[150] hidden bg-black/95 backdrop-blur-2xl flex flex-col items-center justify-center p-6">
        <div class="relative w-full max-w-sm aspect-square overflow-hidden rounded-[3rem] bg-slate-800 shadow-2xl border border-white/10">
            <video id="camera-preview" autoplay playsinline class="w-full h-full object-cover"></video>
        </div>
        <div class="flex space-x-8 mt-10">
            <button onclick="closeCamera()" class="p-5 bg-white/10 text-white rounded-full"><i data-lucide="x"></i></button>
            <button onclick="capturePhoto()" class="p-8 bg-white text-black rounded-full shadow-2xl active:scale-75 transition-all"><i data-lucide="camera" size="32"></i></button>
        </div>
        <canvas id="photo-canvas" class="hidden"></canvas>
    </div>

    <input type="file" id="calendar-upload" class="hidden" accept="image/*,application/pdf" onchange="processCalendar(event)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

         const firebaseConfig = {apiKey: "AIzaSyBXECIZa45dq-o8Ka4G9Y1N7nll7cyli2U",
		  authDomain: "stuattnd.firebaseapp.com",
		  projectId: "stuattnd",
		  storageBucket: "stuattnd.firebasestorage.app",
		  messagingSenderId: "511533506488",
		  appId: "1:511533506488:web:aca4de3d513915d012f94d",
		  measurementId: "G-9PZZM5LFKX"};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'omnipulse-pro-v1.0';
        const apiKey = ""; // API key is handled by the execution environment
        const ADMIN_SECRET = "2026";

        const GLOBAL_CALENDAR = [
            { id: 'ny', date: '01-01', title: 'Happy New Year!', msg: 'Welcome to 2026! A year of infinite possibilities.', theme: 'festive' },
            { id: 'rp', date: '01-26', title: 'Republic Day', msg: 'Celebrating the constitutional strength of our nation.', theme: 'urgent' },
            { id: 'holi', date: '03-14', title: 'Happy Holi!', msg: 'May colors of joy fill your life today.', theme: 'festive' },
            { id: 'idp', date: '08-15', title: 'Independence Day', msg: 'Honoring the spirit of freedom.', theme: 'urgent' },
            { id: 'gj', date: '10-02', title: 'Gandhi Jayanti', msg: 'Remembering values of non-violence and truth.', theme: 'info' },
            { id: 'dwl', date: '10-31', title: 'Happy Diwali!', msg: 'May light brighten your path with knowledge.', theme: 'festive' },
            { id: 'xmas', date: '12-25', title: 'Merry Christmas!', msg: 'Wishing the community holiday cheer.', theme: 'festive' },
            { id: 'love', date: '02-14', title: 'Happy Valentimes!', msg: 'A fresh start, a new chapter. Happy Valentimes Day!', theme: 'festive' },
            { id: 'CelebL', date: '02-13', title: 'Love Forever!', msg: '1 Day to Go for A fresh start, a new chapter. Happy Valentimes Day!', theme: 'festive' }
        ];

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userProfile = null;
        let currentTab = 'feed';
        let pulses = [];
        let selectedTarget = 'All';
        let cameraStream = null;
        let editMode = false;

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
                const snap = await getDoc(profileRef);
                if (snap.exists()) {
                    userProfile = snap.data();
                    editMode = false;
                    startSync();
                } else {
                    userProfile = { role: 'Students', name: '', pfp: null, dept: '', gender: 'Other', mobile: '', dob: '', generatedId: '' };
                    editMode = true;
                    switchTab('settings');
                }
            } else { initAuth(); }
        });

        async function startSync() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'pulses');
            onSnapshot(q, (snapshot) => {
                pulses = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            });

            runDailyAIGenerator();
        }

        async function runDailyAIGenerator() {
            const now = new Date();
            const todayKey = now.toISOString().split('T')[0];
            const todayMMDD = todayKey.substring(5);
            
            const checkRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_check', todayKey);
            const checkSnap = await getDoc(checkRef);

            if (checkSnap.exists()) return; 

            await setDoc(checkRef, { processed: true, at: serverTimestamp() });

            const calendarMatch = GLOBAL_CALENDAR.find(item => item.date === todayMMDD);
            if (calendarMatch) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pulses'), {
                    title: calendarMatch.title,
                    theme: calendarMatch.theme,
                    category: "GLOBAL EVENT",
                    content: calendarMatch.msg,
                    audience: "All",
                    createdAt: serverTimestamp(),
                    sender: "SYSTEM-CALENDAR",
                    meta: { date: todayKey, time: "00:00 AM" }
                });
            }

				
            const prompt = `Today is ${todayKey}. 
            1. Are there any major festivals today (Indian context preferred)?
            2. Generate a celebratory text for it.
            3. Check if any student got "offers" or "placements" (mock some if you find keywords in recent context).
            Output VALID JSON Array of pulses: [{"title":"EVENT NAME","theme":"festive|success","category":"WISHES|PLACEMENT","content":"Wishing...","audience":"All"}]
            If no major festival or nothing new, return empty array [].`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const aiResp = await res.json();
                const items = JSON.parse(aiResp.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim());
                
                for (const item of items) {
                    if (calendarMatch && item.title.toLowerCase().includes(calendarMatch.title.toLowerCase().split(' ')[0])) continue;

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pulses'), {
                        ...item,
                        createdAt: serverTimestamp(),
                        sender: "SYSTEM-AI",
                        meta: { date: todayKey, time: "00:01 AM" }
                    });
                }
            } catch (e) { console.error("AI Daily Sync Failed", e); }
        }

        window.render = () => {
            const main = document.getElementById('main-content');
            if (!userProfile) return;

            document.getElementById('nav-feed').classList.toggle('active', currentTab === 'feed');
            document.getElementById('nav-settings').classList.toggle('active', currentTab === 'settings');

            if (currentTab === 'feed') {
                const filtered = pulses.filter(p => 
                    userProfile.role === 'Examination' || userProfile.role === 'Faculty' ||
                    p.audience === 'All' || 
                    p.audience?.toLowerCase() === userProfile.role?.toLowerCase() ||
                    p.theme === 'sos'
                );
                main.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-10">${filtered.length ? filtered.map(p => createPulsePoster(p)).join('') : '<div class="col-span-full py-20 text-center text-slate-400 font-bold uppercase tracking-widest text-xs">No Signal Detected</div>'}</div>`;
            } 
            else if (currentTab === 'create') {
                main.innerHTML = `
                    <div class="max-w-2xl mx-auto space-y-6 animate-in">
                        <div class="flex items-center space-x-4 mb-4">
                            <button onclick="switchTab('feed')" class="p-3 bg-white rounded-2xl shadow-sm border border-slate-100"><i data-lucide="arrow-left" size="18"></i></button>
                            <h2 class="text-lg font-black uppercase tracking-tighter">Draft Transmission</h2>
                        </div>
                        <div class="bg-white p-6 rounded-[3rem] shadow-xl border border-slate-100">
                            <div class="flex justify-between items-center mb-6">
                                <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Node Signal</label>
                                <button onclick="document.getElementById('calendar-upload').click()" class="flex items-center space-x-2 text-[10px] font-black text-indigo-600 uppercase bg-indigo-50 px-4 py-2 rounded-full border border-indigo-100">
                                    <i data-lucide="file-up" size="14"></i><span>Scan Document</span>
                                </button>
                            </div>
                            <textarea id="pulse-input" class="w-full h-40 bg-transparent text-slate-800 font-bold text-xl focus:outline-none resize-none" placeholder="E.g. Congrats Rahul for offer from Google, or Happy Diwali..."></textarea>
                            <div class="pt-6 border-t border-slate-50">
                                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3">Target Node</p>
                                <div class="flex flex-wrap gap-2">
                                    ${['All', 'Students', 'Faculty', 'Examination', 'Security'].map(target => `
                                        <button onclick="setTarget('${target}')" class="px-4 py-2 rounded-full border-2 text-[9px] font-black uppercase tracking-widest transition-all ${target === selectedTarget ? 'border-indigo-600 text-indigo-600 bg-indigo-50' : 'border-slate-100 text-slate-400'}">${target}</button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <button onclick="broadcastPulse()" id="btn-post" class="w-full py-6 bg-slate-900 text-white rounded-[2.5rem] font-black uppercase tracking-widest shadow-2xl flex items-center justify-center space-x-3 active:scale-95 transition-all"><span>Push Pulse</span><i data-lucide="zap"></i></button>
                    </div>`;
            } 
            else if (currentTab === 'settings') {
                if (editMode) {
                    main.innerHTML = `
                    <div class="max-w-xl mx-auto space-y-6 animate-in">
                        <div class="bg-white p-6 rounded-[3rem] shadow-xl border border-slate-100 overflow-y-auto max-h-[75vh] hide-scrollbar">
                            <div class="text-center mb-6">
                                <div class="relative inline-block cursor-pointer" onclick="openCamera()">
                                    <div class="w-28 h-28 rounded-full border-4 border-indigo-500 overflow-hidden bg-slate-100 mx-auto shadow-xl">
                                        <img id="pfp-preview" src="${userProfile.pfp || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + auth.currentUser.uid}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="absolute bottom-1 right-1 p-2 bg-indigo-600 text-white rounded-full border-4 border-white"><i data-lucide="camera" size="14"></i></div>
                                </div>
                                <h3 class="mt-4 font-black text-slate-800 text-lg uppercase tracking-tighter">Identity Registration</h3>
                            </div>
                            <div class="space-y-3">
                                <input id="reg-name" type="text" value="${userProfile.name || ''}" placeholder="Full Legal Name" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <input id="reg-mobile" type="tel" value="${userProfile.mobile || ''}" placeholder="Mobile Number" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-sm">
                                    <input id="reg-dob" type="date" value="${userProfile.dob || ''}" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-sm">
                                </div>
                                <div>
                                    <p class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-2 ml-2">Gender Identity</p>
                                    <div class="flex gap-2">
                                        ${['Male', 'Female', 'Other'].map(g => `<button onclick="setGender('${g}')" class="flex-1 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest border-2 transition-all ${userProfile.gender === g ? 'bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-slate-50 border-transparent text-slate-400'}">${g}</button>`).join('')}
                                    </div>
                                </div>
                                <div>
                                    <p class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-2 ml-2">Assigned Role</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${['Faculty', 'Examination', 'Security', 'All other Staff', 'Students'].map(r => `<div onclick="setRole('${r}')" class="capsule-item ${userProfile.role === r ? 'active' : ''}">${r}</div>`).join('')}
                                    </div>
                                </div>
                                <input id="reg-dept" type="text" value="${userProfile.dept || ''}" placeholder="Department / Year" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-sm">
                                ${userProfile.role !== 'Students' ? `<div class="space-y-2"><p class="text-[9px] font-black uppercase tracking-widest text-amber-600 ml-2">Authorization Required</p><input id="reg-key" type="password" placeholder="System Auth Key" class="w-full p-4 bg-amber-50 rounded-2xl font-bold outline-none border border-amber-200 text-sm"></div>` : ''}
                                <button onclick="saveProfile()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all mt-4">Confirm Identity</button>
                            </div>
                        </div>
                    </div>`;
                } else {
                    main.innerHTML = `
                    <div class="max-w-xl mx-auto space-y-4 animate-in">
                        <div class="bg-indigo-600 p-8 rounded-[3rem] shadow-2xl relative overflow-hidden text-white">
                            <div class="relative z-10 flex items-start justify-between">
                                <div class="w-20 h-20 rounded-2xl border-2 border-white/30 overflow-hidden shadow-2xl bg-white/10">
                                    <img src="${userProfile.pfp || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + auth.currentUser.uid}" class="w-full h-full object-cover">
                                </div>
                                <div class="text-right">
                                    <div class="text-[9px] font-black uppercase tracking-[0.3em] opacity-60">Status: Verified</div>
                                    <div class="text-lg font-black uppercase tracking-tighter">${userProfile.role}</div>
                                </div>
                            </div>
                            <div class="mt-8 relative z-10">
                                <div class="text-2xl font-black uppercase tracking-tighter mb-1">${userProfile.name}</div>
                                <div class="text-[10px] font-bold uppercase tracking-widest opacity-70">${userProfile.dept || 'No Department'} • ${userProfile.mobile || 'No Mobile'}</div>
                                <div class="text-[11px] font-black uppercase tracking-[0.2em] mt-2 py-1 px-3 bg-white/20 inline-block rounded-lg">ID: ${userProfile.generatedId || 'TBC'}</div>
                                <div class="mt-4 flex gap-4 text-[9px] font-black uppercase tracking-widest opacity-50"><span>DOB: ${userProfile.dob || '--'}</span><span>GENDER: ${userProfile.gender}</span></div>
                            </div>
                            <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 text-center"><div class="text-2xl font-black text-indigo-600">${pulses.filter(p => p.sender === auth.currentUser.uid).length}</div><div class="text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1">Transmissions</div></div>
                            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 text-center"><div class="text-2xl font-black text-emerald-500">Online</div><div class="text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1">Node Connectivity</div></div>
                        </div>
                        <button onclick="editProfile()" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-black uppercase tracking-widest hover:bg-slate-200 transition-all text-xs">Edit User Profile</button>
                    </div>`;
                }
            }
            lucide.createIcons();
            updateHeaderUI();
            updateNavUI();
        };

        window.openCamera = async () => {
            document.getElementById('camera-modal').classList.remove('hidden');
            try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); document.getElementById('camera-preview').srcObject = cameraStream; }
            catch (e) { showToast("Camera Access Error", "camera-off"); closeCamera(); }
        };
        window.closeCamera = () => { if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); document.getElementById('camera-modal').classList.add('hidden'); };
        window.capturePhoto = () => {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('photo-canvas');
            canvas.width = 600; canvas.height = 600;
            const ctx = canvas.getContext('2d');
            ctx.scale(-1, 1); ctx.drawImage(video, -600, 0, 600, 600);
            userProfile.pfp = canvas.toDataURL('image/jpeg', 0.8);
            const preview = document.getElementById('pfp-preview');
            if (preview) preview.src = userProfile.pfp;
            closeCamera();
        };

        window.processCalendar = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('ai-loader').style.display = 'flex';
            document.getElementById('ai-loader-text').innerText = "Scanning Document Intelligence...";
            const reader = new FileReader();
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                const now = new Date();
                const today = now.toLocaleDateString();
                const prompt = `Today is ${today}. Task: Extract all events from this document. Output VALID JSON array: [{"title": "NAME/EVENT", "theme": "calendar|festive|success", "category": "TYPE", "date": "DD MMM YYYY", "time": "ALL DAY", "content": "desc"}]`;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64 } }] }] })
                    });
                    const data = await res.json();
                    const schedules = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim());
                    for (const ev of schedules) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pulses'), { ...ev, audience: 'All', createdAt: serverTimestamp(), sender: auth.currentUser.uid, meta: { date: ev.date, time: ev.time } }); }
                    showToast(`${schedules.length} Items Synced`, "calendar-check");
                    switchTab('feed');
                } catch (err) { showToast("AI Scan Error", "alert-circle"); }
                finally { document.getElementById('ai-loader').style.display = 'none'; }
            };
            reader.readAsDataURL(file);
        };

        window.broadcastPulse = async () => {
            const input = document.getElementById('pulse-input').value.trim();
            if(!input) return;
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const prompt = `System Ref: ${dateStr} ${timeStr}. User says: "${input}". 
            Task: Categorize this transmission. 
            Return JSON: {"title":"UPPERCASE","theme":"festive|urgent|info|success|warning","category":"CAT","date":"date","time":"time"}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const ai = JSON.parse((await res.json()).candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim());
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pulses'), { 
                    ...ai, content: input, audience: selectedTarget, createdAt: serverTimestamp(), sender: auth.currentUser.uid, meta: { date: ai.date, time: ai.time } 
                });
                showToast("Pulse Broadcasted", "zap");
                switchTab('feed');
            } catch (e) { showToast("AI Transmission Error", "alert-circle"); }
        };

        function createPulsePoster(data) {
            const themes = { urgent: 'bg-gradient-urgent', info: 'bg-gradient-info', festive: 'bg-gradient-festive', warning: 'bg-gradient-warning', success: 'bg-gradient-success', alumni: 'bg-gradient-alumni', calendar: 'bg-gradient-calendar', sos: 'bg-gradient-sos' };
            const icons = { urgent: 'siren', festive: 'party-popper', calendar: 'calendar', warning: 'alert-triangle', success: 'trophy', info: 'info', alumni: 'graduation-cap', sos: 'zap' };
            return `<div class="poster-card w-full aspect-[3/4.2] rounded-[3rem] ${themes[data.theme] || themes.info} p-10 text-white flex flex-col shadow-2xl relative overflow-hidden animate-in">
                    <div class="flex justify-between items-start mb-auto z-10">
                        <div class="bg-white/20 p-4 rounded-3xl backdrop-blur-xl border border-white/20"><i data-lucide="${icons[data.theme] || 'info'}" size="34"></i></div>
                        <div class="text-right">
                            <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-60">${data.category}</p>
                            <span class="text-[9px] font-black bg-black/20 px-3 py-1 rounded-full uppercase">${data.audience}</span>
                        </div>
                    </div>
                    <div class="z-10 space-y-4 mb-8">
                        <h3 class="text-4xl font-black leading-[0.9] uppercase drop-shadow-xl tracking-tighter">${data.title}</h3>
                        <div class="text-[10px] font-black opacity-60">${data.meta?.date} • ${data.meta?.time}</div>
                        <p class="text-xl font-medium opacity-90 line-clamp-5 tracking-tight">${data.content}</p>
                    </div>
                    <div class="mt-auto pt-6 border-t border-white/10 text-[9px] font-black uppercase opacity-40">Authorized Node Broadcast</div>
                </div>`;
        }

        window.saveProfile = async () => {
            const name = document.getElementById('reg-name').value.trim();
            const mobile = document.getElementById('reg-mobile').value.trim();
            const dob = document.getElementById('reg-dob').value;
            const dept = document.getElementById('reg-dept').value.trim();
            if (!name || !mobile || !dob) return showToast("All Fields Required", "user-x");
            const uniqueHash = Date.now().toString().slice(-6);
            if (userProfile.role !== 'Students') {
                const key = document.getElementById('reg-key').value;
                if (key !== ADMIN_SECRET) return showToast("Invalid System Key", "shield-off");
                if (!userProfile.generatedId) userProfile.generatedId = `STF-${uniqueHash}`;
            } else {
                if (!userProfile.generatedId) userProfile.generatedId = `STU-${uniqueHash}`;
            }
            userProfile = { ...userProfile, name, mobile, dob, dept };
            await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'profile', 'info'), userProfile, { merge: true });
            editMode = false; showToast("Identity Verified", "check-circle"); render();
        };

        window.editProfile = () => { editMode = true; render(); };
        window.switchTab = (t) => { currentTab = t; render(); };
        window.setTarget = (t) => { selectedTarget = t; render(); };
        window.setRole = (r) => { userProfile.role = r; render(); };
        window.setGender = (g) => { userProfile.gender = g; render(); };

        function updateHeaderUI() {
            const el = document.getElementById('header-user');
            if (userProfile?.name) {
                el.innerHTML = `<div class="text-right hidden sm:block"><p class="text-[10px] font-black uppercase tracking-tighter">${userProfile.name.split(' ')[0]}</p><p class="text-[8px] font-black text-indigo-500 uppercase">${userProfile.role}</p></div>
                    <div class="w-11 h-11 rounded-full border-2 border-slate-100 overflow-hidden shadow-lg"><img src="${userProfile.pfp || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + auth.currentUser.uid}" class="w-full h-full object-cover"></div>`;
            }
        }
        
        function updateNavUI() {
            const container = document.getElementById('nav-center-container');
            const isRegistered = !editMode && userProfile?.name;
            const isAuthorized = ['Faculty', 'Examination', 'Security', 'All other Staff'].includes(userProfile?.role);
            const isSecurity = userProfile?.role === 'Security';
            
            // Clear current container content
            container.innerHTML = '';

            // Only show action button if registered AND (is authorized admin or is security)
            if (isRegistered) {
                if (isSecurity) {
                    container.innerHTML = `<button onclick="triggerSOS()" class="p-6 rounded-[2.2rem] bg-red-600 text-white shadow-2xl -translate-y-8 active:scale-90 transition-all shadow-red-200 flex items-center justify-center"><i data-lucide="zap" size="32" class="fill-current"></i></button>`;
                } else if (isAuthorized) {
                    container.innerHTML = `<button onclick="switchTab('create')" class="p-6 rounded-[2.2rem] bg-slate-900 text-white shadow-2xl -translate-y-8 active:scale-90 transition-all flex items-center justify-center ${currentTab === 'create' ? 'bg-indigo-600' : ''}"><i data-lucide="plus" size="32"></i></button>`;
                }
            }
            
            document.getElementById('sos-bar').classList.toggle('hidden', !isSecurity);
            lucide.createIcons();
        }

        window.triggerSOS = async () => {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pulses'), { title: "EMERGENCY SIGNAL", theme: "sos", category: "SECURITY", content: `Priority alert from ${userProfile.name}.`, audience: "All", createdAt: serverTimestamp(), sender: auth.currentUser.uid, meta: { date: "LIVE", time: "NOW" } });
            showToast("SOS ALERT BROADCASTED", "zap"); switchTab('feed');
        };

        function showToast(msg, icon) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').innerHTML = `<i data-lucide="${icon}" size="18"></i>`;
            lucide.createIcons();
            t.style.opacity = "1"; t.style.transform = "translate(-50%, 0)";
            setTimeout(() => { t.style.opacity = "0"; t.style.transform = "translate(-50%, -20px)"; }, 4000);
        }

        initAuth();
    </script>
</body>
</html>
